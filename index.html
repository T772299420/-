<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1" />
Â  <title>ğŸ’¬ Ø¯Ø±Ø¯Ø´Ø© ÙÙˆØ±ÙŠØ© - ChatPro</title>
Â  <link rel="manifest" href="manifest.json">
Â  <style>
Â Â Â  * {
Â Â Â Â Â  margin: 0;
Â Â Â Â Â  padding: 0;
Â Â Â Â Â  box-sizing: border-box;
Â Â Â  }

Â Â Â  body {
Â Â Â Â Â  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
Â Â Â Â Â  direction: rtl;
Â Â Â Â Â  text-align: right;
Â Â Â Â Â  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
Â Â Â Â Â  height: 100vh;
Â Â Â Â Â  overflow: hidden;
Â Â Â  }

Â Â Â  /* Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
Â Â Â  #authContainer {
Â Â Â Â Â  position: fixed;
Â Â Â Â Â  top: 50%;
Â Â Â Â Â  left: 50%;
Â Â Â Â Â  transform: translate(-50%, -50%);
Â Â Â Â Â  background: white;
Â Â Â Â Â  padding: 40px;
Â Â Â Â Â  border-radius: 20px;
Â Â Â Â Â  box-shadow: 0 20px 40px rgba(0,0,0,0.1);
Â Â Â Â Â  width: 400px;
Â Â Â Â Â  z-index: 1000;
Â Â Â  }

Â Â Â  #authContainer h2 {
Â Â Â Â Â  text-align: center;
Â Â Â Â Â  margin-bottom: 30px;
Â Â Â Â Â  color: #6a11cb;
Â Â Â Â Â  font-size: 28px;
Â Â Â  }

Â Â Â  input, button {
Â Â Â Â Â  width: 100%;
Â Â Â Â Â  padding: 15px;
Â Â Â Â Â  margin: 10px 0;
Â Â Â Â Â  border: 2px solid #e0e0e0;
Â Â Â Â Â  border-radius: 10px;
Â Â Â Â Â  font-size: 16px;
Â Â Â Â Â  transition: all 0.3s ease;
Â Â Â  }

Â Â Â  input:focus {
Â Â Â Â Â  border-color: #6a11cb;
Â Â Â Â Â  outline: none;
Â Â Â Â Â  box-shadow: 0 0 10px rgba(106, 17, 203, 0.2);
Â Â Â  }

Â Â Â  button {
Â Â Â Â Â  background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
Â Â Â Â Â  color: white;
Â Â Â Â Â  border: none;
Â Â Â Â Â  cursor: pointer;
Â Â Â Â Â  font-weight: bold;
Â Â Â Â Â  text-transform: uppercase;
Â Â Â  }

Â Â Â  button:hover {
Â Â Â Â Â  transform: translateY(-2px);
Â Â Â Â Â  box-shadow: 0 10px 20px rgba(106, 17, 203, 0.3);
Â Â Â  }

Â Â Â  #toggleFormBtn {
Â Â Â Â Â  background: transparent;
Â Â Â Â Â  color: #6a11cb;
Â Â Â Â Â  border: 2px solid #6a11cb;
Â Â Â  }

Â Â Â  #errorMsg {
Â Â Â Â Â  color: #e74c3c;
Â Â Â Â Â  text-align: center;
Â Â Â Â Â  min-height: 20px;
Â Â Â Â Â  font-weight: bold;
Â Â Â  }

Â Â Â  /* Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
Â Â Â  #app {
Â Â Â Â Â  display: none;
Â Â Â Â Â  height: 100vh;
Â Â Â Â Â  background: white;
Â Â Â Â Â  flex-direction: column;
Â Â Â  }

Â Â Â  /* Ø´Ø±ÙŠØ· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ù„ÙˆÙŠ */
Â Â Â  #appHeader {
Â Â Â Â Â  background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
Â Â Â Â Â  color: white;
Â Â Â Â Â  padding: 15px 20px;
Â Â Â Â Â  display: flex;
Â Â Â Â Â  justify-content: space-between;
Â Â Â Â Â  align-items: center;
Â Â Â Â Â  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
Â Â Â  }

Â Â Â  #appLogo {
Â Â Â Â Â  display: flex;
Â Â Â Â Â  align-items: center;
Â Â Â Â Â  gap: 10px;
Â Â Â Â Â  font-size: 24px;
Â Â Â Â Â  font-weight: bold;
Â Â Â  }

Â Â Â  #appLogo::before {
Â Â Â Â Â  content: "ğŸ’¬";
Â Â Â Â Â  font-size: 30px;
Â Â Â  }

Â Â Â  #userInfo {
Â Â Â Â Â  display: flex;
Â Â Â Â Â  align-items: center;
Â Â Â Â Â  gap: 15px;
Â Â Â  }

Â Â Â  #userAvatar {
Â Â Â Â Â  width: 40px;
Â Â Â Â Â  height: 40px;
Â Â Â Â Â  border-radius: 50%;
Â Â Â Â Â  border: 2px solid white;
Â Â Â Â Â  object-fit: cover;
Â Â Â  }

Â Â Â  #installBtn {
Â Â Â Â Â  background: rgba(255,255,255,0.9);
Â Â Â Â Â  color: #6a11cb;
Â Â Â Â Â  border: none;
Â Â Â Â Â  padding: 8px 12px;
Â Â Â Â Â  border-radius: 8px;
Â Â Â Â Â  cursor: pointer;
Â Â Â Â Â  font-size: 14px;
Â Â Â Â Â  font-weight: 600;
Â Â Â Â Â  display: none;
Â Â Â  }

Â Â Â  #menuBtn {
Â Â Â Â Â  background: rgba(255,255,255,0.2);
Â Â Â Â Â  border: none;
Â Â Â Â Â  color: white;
Â Â Â Â Â  padding: 10px;
Â Â Â Â Â  border-radius: 10px;
Â Â Â Â Â  cursor: pointer;
Â Â Â Â Â  font-size: 18px;
Â Â Â  }

Â Â Â  /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† */
Â Â Â  #usersListContainer {
Â Â Â Â Â  width: 100%;
Â Â Â Â Â  flex: 1;
Â Â Â Â Â  background: #f8f9fa;
Â Â Â Â Â  padding: 20px;
Â Â Â Â Â  overflow-y: auto;
Â Â Â  }

Â Â Â  #searchContainer {
Â Â Â Â Â  position: relative;
Â Â Â Â Â  margin-bottom: 20px;
Â Â Â  }

Â Â Â  #searchInput {
Â Â Â Â Â  width: 100%;
Â Â Â Â Â  padding: 15px 50px 15px 15px;
Â Â Â Â Â  border: 2px solid #e0e0e0;
Â Â Â Â Â  border-radius: 25px;
Â Â Â Â Â  font-size: 16px;
Â Â Â Â Â  background: white;
Â Â Â  }

Â Â Â  #searchContainer::after {
Â Â Â Â Â  content: "ğŸ”";
Â Â Â Â Â  position: absolute;
Â Â Â Â Â  right: 15px;
Â Â Â Â Â  top: 50%;
Â Â Â Â Â  transform: translateY(-50%);
Â Â Â Â Â  font-size: 18px;
Â Â Â  }

Â Â Â  .user-card {
Â Â Â Â Â  background: white;
Â Â Â Â Â  border-radius: 15px;
Â Â Â Â Â  padding: 15px;
Â Â Â Â Â  margin: 10px 0;
Â Â Â Â Â  cursor: pointer;
Â Â Â Â Â  transition: all 0.3s ease;
Â Â Â Â Â  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
Â Â Â Â Â  display: flex;
Â Â Â Â Â  align-items: center;
Â Â Â Â Â  gap: 15px;
Â Â Â Â Â  position: relative;
Â Â Â  }

Â Â Â  .user-card:hover {
Â Â Â Â Â  transform: translateY(-2px);
Â Â Â Â Â  box-shadow: 0 10px 25px rgba(0,0,0,0.1);
Â Â Â  }

Â Â Â  .user-card.blocked {
Â Â Â Â Â  opacity: 0.5;
Â Â Â Â Â  background: #ffebee;
Â Â Â  }

Â Â Â  .user-avatar {
Â Â Â Â Â  width: 50px;
Â Â Â Â Â  height: 50px;
Â Â Â Â Â  border-radius: 50%;
Â Â Â Â Â  position: relative;
Â Â Â Â Â  overflow: hidden;
Â Â Â  }

Â Â Â  .user-avatar img {
Â Â Â Â Â  width: 100%;
Â Â Â Â Â  height: 100%;
Â Â Â Â Â  object-fit: cover;
Â Â Â Â Â  border-radius: 50%;
Â Â Â  }

Â Â Â  .online-indicator {
Â Â Â Â Â  position: absolute;
Â Â Â Â Â  bottom: 2px;
Â Â Â Â Â  right: 2px;
Â Â Â Â Â  width: 12px;
Â Â Â Â Â  height: 12px;
Â Â Â Â Â  background: #4caf50;
Â Â Â Â Â  border: 2px solid white;
Â Â Â Â Â  border-radius: 50%;
Â Â Â Â Â  display: none;
Â Â Â  }

Â Â Â  .online-indicator.online {
Â Â Â Â Â  display: block;
Â Â Â  }

Â Â Â  .user-info {
Â Â Â Â Â  flex: 1;
Â Â Â  }

Â Â Â  .user-info h4 {
Â Â Â Â Â  margin: 0;
Â Â Â Â Â  color: #333;
Â Â Â Â Â  font-size: 16px;
Â Â Â  }

Â Â Â  .user-status {
Â Â Â Â Â  color: #666;
Â Â Â Â Â  font-size: 14px;
Â Â Â Â Â  margin-top: 2px;
Â Â Â  }

Â Â Â  .last-seen {
Â Â Â Â Â  color: #999;
Â Â Â Â Â  font-size: 12px;
Â Â Â Â Â  margin-top: 2px;
Â Â Â  }

Â Â Â  .unread-count {
Â Â Â Â Â  position: absolute;
Â Â Â Â Â  top: 10px;
Â Â Â Â Â  left: 10px;
Â Â Â Â Â  background: #e74c3c;
Â Â Â Â Â  color: white;
Â Â Â Â Â  border-radius: 50%;
Â Â Â Â Â  min-width: 20px;
Â Â Â Â Â  height: 20px;
Â Â Â Â Â  padding: 0 5px;
Â Â Â Â Â  display: none;
Â Â Â Â Â  align-items: center;
Â Â Â Â Â  justify-content: center;
Â Â Â Â Â  font-size: 12px;
Â Â Â Â Â  font-weight: bold;
Â Â Â  }

Â Â Â  .unread-count.show {
Â Â Â Â Â  display: flex;
Â Â Â  }

Â Â Â  /* Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© */
Â Â Â  #chatContainer {
Â Â Â Â Â  display: none;
Â Â Â Â Â  position: fixed;
Â Â Â Â Â  top: 0;
Â Â Â Â Â  left: 0;
Â Â Â Â Â  width: 100%;
Â Â Â Â Â  height: 100%;
Â Â Â Â Â  background: white;
Â Â Â Â Â  z-index: 1000;
Â Â Â Â Â  flex-direction: column;
Â Â Â  }

Â Â Â  #chatHeader {
Â Â Â Â Â  background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
Â Â Â Â Â  color: white;
Â Â Â Â Â  padding: 15px 20px;
Â Â Â Â Â  display: flex;
Â Â Â Â Â  justify-content: space-between;
Â Â Â Â Â  align-items: center;
Â Â Â Â Â  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
Â Â Â  }

Â Â Â  #chatUserInfo {
Â Â Â Â Â  display: flex;
Â Â Â Â Â  align-items: center;
Â Â Â Â Â  gap: 15px;
Â Â Â  }

Â Â Â  #chatUserAvatar {
Â Â Â Â Â  width: 40px;
Â Â Â Â Â  height: 40px;
Â Â Â Â Â  border-radius: 50%;
Â Â Â Â Â  border: 2px solid white;
Â Â Â Â Â  object-fit: cover;
Â Â Â  }

Â Â Â  #chatUserName {
Â Â Â Â Â  font-size: 18px;
Â Â Â Â Â  font-weight: bold;
Â Â Â  }

Â Â Â  #chatUserStatus {
Â Â Â Â Â  font-size: 14px;
Â Â Â Â Â  opacity: 0.8;
Â Â Â  }

Â Â Â  #chatControls {
Â Â Â Â Â  display: flex;
Â Â Â Â Â  gap: 10px;
Â Â Â  }

Â Â Â  .chat-btn, #backBtn {
Â Â Â Â Â  background: rgba(255,255,255,0.2);
Â Â Â Â Â  border: none;
Â Â Â Â Â  color: white;
Â Â Â Â Â  padding: 8px 12px;
Â Â Â Â Â  border-radius: 8px;
Â Â Â Â Â  cursor: pointer;
Â Â Â Â Â  font-size: 16px;
Â Â Â  }

Â Â Â  /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
Â Â Â  #messagesArea {
Â Â Â Â Â  flex: 1;
Â Â Â Â Â  overflow-y: auto;
Â Â Â Â Â  padding: 20px;
Â Â Â Â Â  background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
Â Â Â  }

Â Â Â  .message-wrapper {
Â Â Â Â Â  display: flex;
Â Â Â Â Â  margin: 10px 0;
Â Â Â Â Â  position: relative;
Â Â Â  }

Â Â Â  .message-wrapper.sent {
Â Â Â Â Â  justify-content: flex-end;
Â Â Â  }

Â Â Â  .message-wrapper.received {
Â Â Â Â Â  justify-content: flex-start;
Â Â Â  }

Â Â Â  .message {
Â Â Â Â Â  max-width: 70%;
Â Â Â Â Â  padding: 12px 16px;
Â Â Â Â Â  border-radius: 18px;
Â Â Â Â Â  position: relative;
Â Â Â Â Â  word-wrap: break-word;
Â Â Â Â Â  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
Â Â Â  }

Â Â Â  .message.sent {
Â Â Â Â Â  background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
Â Â Â Â Â  color: white;
Â Â Â Â Â  border-bottom-right-radius: 5px;
Â Â Â  }

Â Â Â  .message.received {
Â Â Â Â Â  background: white;
Â Â Â Â Â  color: #333;
Â Â Â Â Â  border: 1px solid #e0e0e0;
Â Â Â Â Â  border-bottom-left-radius: 5px;
Â Â Â  }

Â Â Â  .message-time {
Â Â Â Â Â  font-size: 11px;
Â Â Â Â Â  opacity: 0.7;
Â Â Â Â Â  margin-top: 5px;
Â Â Â Â Â  text-align: left;
Â Â Â  }

Â Â Â  .message-media {
Â Â Â Â Â  border-radius: 10px;
Â Â Â Â Â  overflow: hidden;
Â Â Â Â Â  position: relative;
Â Â Â Â Â  margin-bottom: 5px;
Â Â Â  }

Â Â Â  .message-media img,
Â Â Â  .message-media video,
Â Â Â  .message-media audio {
Â Â Â Â Â  width: 100%;
Â Â Â Â Â  max-width: 300px;
Â Â Â Â Â  height: auto;
Â Â Â Â Â  border-radius: 10px;
Â Â Â  }

Â Â Â  .message-options {
Â Â Â Â Â  position: absolute;
Â Â Â Â Â  top: 0;
Â Â Â Â Â  right: -30px;
Â Â Â Â Â  display: none;
Â Â Â Â Â  flex-direction: column;
Â Â Â Â Â  gap: 5px;
Â Â Â  }

Â Â Â  .message-wrapper.received .message-options {
Â Â Â Â Â  left: -30px;
Â Â Â Â Â  right: auto;
Â Â Â  }

Â Â Â  .message-wrapper:hover .message-options {
Â Â Â Â Â  display: flex;
Â Â Â  }

Â Â Â  .message-option {
Â Â Â Â Â  background: rgba(0,0,0,0.7);
Â Â Â Â Â  color: white;
Â Â Â Â Â  border: none;
Â Â Â Â Â  padding: 5px;
Â Â Â Â Â  border-radius: 50%;
Â Â Â Â Â  cursor: pointer;
Â Â Â Â Â  font-size: 12px;
Â Â Â Â Â  width: 25px;
Â Â Â Â Â  height: 25px;
Â Â Â  }

Â Â Â  /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
Â Â Â  #inputContainer {
Â Â Â Â Â  background: white;
Â Â Â Â Â  padding: 15px 20px;
Â Â Â Â Â  border-top: 1px solid #e0e0e0;
Â Â Â Â Â  display: flex;
Â Â Â Â Â  align-items: center;
Â Â Â Â Â  gap: 10px;
Â Â Â  }

Â Â Â  #messageInput {
Â Â Â Â Â  flex: 1;
Â Â Â Â Â  padding: 12px 15px;
Â Â Â Â Â  border: 2px solid #e0e0e0;
Â Â Â Â Â  border-radius: 25px;
Â Â Â Â Â  font-size: 16px;
Â Â Â Â Â  resize: none;
Â Â Â Â Â  max-height: 100px;
Â Â Â  }

Â Â Â  .input-btn {
Â Â Â Â Â  background: white;
Â Â Â Â Â  color: #6a11cb;
Â Â Â Â Â  border: 2px solid #e0e0e0;
Â Â Â Â Â  padding: 12px;
Â Â Â Â Â  border-radius: 50%;
Â Â Â Â Â  cursor: pointer;
Â Â Â Â Â  font-size: 18px;
Â Â Â Â Â  width: 45px;
Â Â Â Â Â  height: 45px;
Â Â Â Â Â  display: flex;
Â Â Â Â Â  align-items: center;
Â Â Â Â Â  justify-content: center;
Â Â Â Â Â  transition: all 0.3s ease;
Â Â Â  }

Â Â Â  .input-btn:hover {
Â Â Â Â Â  transform: translateY(-2px);
Â Â Â Â Â  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
Â Â Â  }

Â Â Â  /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª */
Â Â Â  #attachMenu {
Â Â Â Â Â  position: absolute;
Â Â Â Â Â  bottom: 60px;
Â Â Â Â Â  right: 20px;
Â Â Â Â Â  background: white;
Â Â Â Â Â  border-radius: 10px;
Â Â Â Â Â  box-shadow: 0 5px 20px rgba(0,0,0,0.2);
Â Â Â Â Â  display: none;
Â Â Â Â Â  flex-direction: column;
Â Â Â Â Â  overflow: hidden;
Â Â Â Â Â  z-index: 100;
Â Â Â  }

Â Â Â  .attach-option {
Â Â Â Â Â  padding: 12px 15px;
Â Â Â Â Â  border: none;
Â Â Â Â Â  background: transparent;
Â Â Â Â Â  text-align: right;
Â Â Â Â Â  cursor: pointer;
Â Â Â Â Â  font-size: 14px;
Â Â Â Â Â  transition: background 0.2s ease;
Â Â Â Â Â  display: flex;
Â Â Â Â Â  align-items: center;
Â Â Â Â Â  gap: 10px;
Â Â Â Â Â  min-width: 180px;
Â Â Â  }

Â Â Â  .attach-option:hover {
Â Â Â Â Â  background: #f0f0f0;
Â Â Â  }

Â Â Â  /* ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª */
Â Â Â  .recording-indicator {
Â Â Â Â Â  display: none;
Â Â Â Â Â  align-items: center;
Â Â Â Â Â  gap: 10px;
Â Â Â Â Â  padding: 8px 15px;
Â Â Â Â Â  background: #ffebee;
Â Â Â Â Â  border-radius: 20px;
Â Â Â Â Â  color: #e74c3c;
Â Â Â Â Â  font-size: 14px;
Â Â Â  }

Â Â Â  .recording-dot {
Â Â Â Â Â  width: 8px;
Â Â Â Â Â  height: 8px;
Â Â Â Â Â  background: #e74c3c;
Â Â Â Â Â  border-radius: 50%;
Â Â Â Â Â  animation: pulse 1s infinite;
Â Â Â  }

Â Â Â  @keyframes pulse {
Â Â Â Â Â  0% { opacity: 1; }
Â Â Â Â Â  50% { opacity: 0.5; }
Â Â Â Â Â  100% { opacity: 1; }
Â Â Â  }

Â Â Â  /* Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© ÙˆØ§Ù„Ù…ÙˆØ¯Ø§Ù„ */
Â Â Â  #dropdownMenu {
Â Â Â Â Â  position: fixed;
Â Â Â Â Â  top: 70px;
Â Â Â Â Â  right: 20px;
Â Â Â Â Â  background: white;
Â Â Â Â Â  border-radius: 10px;
Â Â Â Â Â  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
Â Â Â Â Â  display: none;
Â Â Â Â Â  flex-direction: column;
Â Â Â Â Â  min-width: 200px;
Â Â Â Â Â  z-index: 2000;
Â Â Â Â Â  overflow: hidden;
Â Â Â  }

Â Â Â  .dropdown-item {
Â Â Â Â Â  padding: 15px 20px;
Â Â Â Â Â  border: none;
Â Â Â Â Â  background: transparent;
Â Â Â Â Â  text-align: right;
Â Â Â Â Â  cursor: pointer;
Â Â Â Â Â  font-size: 16px;
Â Â Â Â Â  transition: background 0.3s ease;
Â Â Â Â Â  display: flex;
Â Â Â Â Â  align-items: center;
Â Â Â Â Â  gap: 10px;
Â Â Â  }

Â Â Â  .dropdown-item:hover {
Â Â Â Â Â  background: #f8f9fa;
Â Â Â  }

Â Â Â  .dropdown-item.danger {
Â Â Â Â Â  color: #e74c3c;
Â Â Â  }

Â Â Â  .dropdown-item.danger:hover {
Â Â Â Â Â  background: #ffebee;
Â Â Â  }

Â Â Â  .modal {
Â Â Â Â Â  display: none;
Â Â Â Â Â  position: fixed;
Â Â Â Â Â  top: 0;
Â Â Â Â Â  left: 0;
Â Â Â Â Â  width: 100%;
Â Â Â Â Â  height: 100%;
Â Â Â Â Â  background: rgba(0,0,0,0.5);
Â Â Â Â Â  justify-content: center;
Â Â Â Â Â  align-items: center;
Â Â Â Â Â  z-index: 3000;
Â Â Â  }

Â Â Â  .modal-content {
Â Â Â Â Â  background: white;
Â Â Â Â Â  border-radius: 20px;
Â Â Â Â Â  padding: 30px;
Â Â Â Â Â  width: 90%;
Â Â Â Â Â  max-width: 400px;
Â Â Â Â Â  position: relative;
Â Â Â Â Â  box-shadow: 0 10px 20px rgba(0,0,0,0.2);
Â Â Â  }

Â Â Â  .modal h3 {
Â Â Â Â Â  margin-bottom: 20px;
Â Â Â Â Â  text-align: center;
Â Â Â Â Â  color: #333;
Â Â Â  }

Â Â Â  .modal-buttons {
Â Â Â Â Â  display: flex;
Â Â Â Â Â  gap: 10px;
Â Â Â Â Â  justify-content: center;
Â Â Â Â Â  margin-top: 20px;
Â Â Â  }

Â Â Â  .modal label {
Â Â Â Â Â  display: flex;
Â Â Â Â Â  align-items: center;
Â Â Â Â Â  gap: 10px;
Â Â Â Â Â  margin-bottom: 10px;
Â Â Â Â Â  font-size: 16px;
Â Â Â Â Â  color: #555;
Â Â Â  }

Â Â Â  .modal input[type="checkbox"] {
Â Â Â Â Â  width: auto;
Â Â Â Â Â  margin: 0;
Â Â Â  }

Â Â Â  /* Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙˆØ³Ø§Ø¦Ø· */
Â Â Â  #mediaPreview {
Â Â Â Â Â  position: fixed;
Â Â Â Â Â  top: 0;
Â Â Â Â Â  left: 0;
Â Â Â Â Â  width: 100%;
Â Â Â Â Â  height: 100%;
Â Â Â Â Â  background: rgba(0,0,0,0.9);
Â Â Â Â Â  display: none;
Â Â Â Â Â  justify-content: center;
Â Â Â Â Â  align-items: center;
Â Â Â Â Â  z-index: 4000;
Â Â Â  }

Â Â Â  #mediaPreview img,
Â Â Â  #mediaPreview video,
Â Â Â  #mediaPreview audio {
Â Â Â Â Â  max-width: 90%;
Â Â Â Â Â  max-height: 90%;
Â Â Â Â Â  border-radius: 10px;
Â Â Â  }

Â Â Â  .preview-controls {
Â Â Â Â Â  position: absolute;
Â Â Â Â Â  bottom: 50px;
Â Â Â Â Â  left: 50%;
Â Â Â Â Â  transform: translateX(-50%);
Â Â Â Â Â  display: flex;
Â Â Â Â Â  gap: 15px;
Â Â Â  }

Â Â Â  .preview-btn {
Â Â Â Â Â  background: rgba(255,255,255,0.2);
Â Â Â Â Â  border: none;
Â Â Â Â Â  color: white;
Â Â Â Â Â  padding: 15px 25px;
Â Â Â Â Â  border-radius: 25px;
Â Â Â Â Â  cursor: pointer;
Â Â Â Â Â  font-size: 16px;
Â Â Â Â Â  backdrop-filter: blur(10px);
Â Â Â  }

Â Â Â  /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø¬ÙˆØ§Ù„ */
Â Â Â  @media (max-width: 768px) {
Â Â Â Â Â  #authContainer {
Â Â Â Â Â Â Â  width: 90%;
Â Â Â Â Â Â Â  padding: 30px 20px;
Â Â Â Â Â  }

Â Â Â Â Â  .message {
Â Â Â Â Â Â Â  max-width: 85%;
Â Â Â Â Â  }

Â Â Â Â Â  #inputContainer {
Â Â Â Â Â Â Â  padding: 10px;
Â Â Â Â Â  }

Â Â Â Â Â  .user-card {
Â Â Â Â Â Â Â  padding: 12px;
Â Â Â Â Â  }

Â Â Â Â Â  #appLogo {
Â Â Â Â Â Â Â  font-size: 20px;
Â Â Â Â Â  }
Â Â Â  }

Â Â Â  /* Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© */
Â Â Â  .fade-in {
Â Â Â Â Â  animation: fadeIn 0.3s ease-in;
Â Â Â  }

Â Â Â  @keyframes fadeIn {
Â Â Â Â Â  from { opacity: 0; transform: translateY(20px); }
Â Â Â Â Â  to { opacity: 1; transform: translateY(0); }
Â Â Â  }

Â Â Â  .slide-in {
Â Â Â Â Â  animation: slideIn 0.3s ease-out;
Â Â Â  }

Â Â Â  @keyframes slideIn {
Â Â Â Â Â  from { transform: translateX(100%); }
Â Â Â Â Â  to { transform: translateX(0); }
Â Â Â  }

Â Â Â  .loading {
Â Â Â Â Â  display: inline-block;
Â Â Â Â Â  width: 20px;
Â Â Â Â Â  height: 20px;
Â Â Â Â Â  border: 2px solid #f3f3f3;
Â Â Â Â Â  border-top: 2px solid #6a11cb;
Â Â Â Â Â  border-radius: 50%;
Â Â Â Â Â  animation: spin 1s linear infinite;
Â Â Â  }

Â Â Â  @keyframes spin {
Â Â Â Â Â  0% { transform: rotate(0deg); }
Â Â Â Â Â  100% { transform: rotate(360deg); }
Â Â Â  }

Â Â Â  /* ØªØ­Ø³ÙŠÙ† Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
Â Â Â  ::-webkit-scrollbar {
Â Â Â Â Â  width: 6px;
Â Â Â  }

Â Â Â  ::-webkit-scrollbar-track {
Â Â Â Â Â  background: #f1f1f1;
Â Â Â Â Â  border-radius: 10px;
Â Â Â  }

Â Â Â  ::-webkit-scrollbar-thumb {
Â Â Â Â Â  background: #6a11cb;
Â Â Â Â Â  border-radius: 10px;
Â Â Â  }

Â Â Â  ::-webkit-scrollbar-thumb:hover {
Â Â Â Â Â  background: #2575fc;
Â Â Â  }
Â  </style>
</head>
<body>

<!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="authContainer">
Â  <h2 id="formTitle">ğŸ’¬ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ChatPro</h2>
Â  <input type="email" id="email" placeholder="ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" />
Â  <input type="password" id="password" placeholder="ğŸ”’ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
Â  <input type="text" id="username" placeholder="ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…" style="display: none;" />
Â  <input type="text" id="status" placeholder="âœ¨ Ø§Ù„Ø­Ø§Ù„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="display: none;" />
Â  <div id="errorMsg"></div>
Â  <button id="submitBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
Â  <button id="toggleFormBtn">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
</div>

<!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
<div id="app">
Â  <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
Â  <div id="appHeader">
Â Â Â  <div style="display: flex; align-items: center; gap: 10px;">
Â Â Â Â Â  <div id="appLogo">ChatPro</div>
Â Â Â Â Â  <button id="installBtn">â¬‡ï¸ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>
Â Â Â  </div>
Â Â Â  <div id="userInfo">
Â Â Â Â Â  <img id="userAvatar" src="" alt="Avatar" />
Â Â Â Â Â  <div>
Â Â Â Â Â Â Â  <div id="currentUsername"></div>
Â Â Â Â Â Â Â  <div id="currentUserStatus" style="font-size: 12px; opacity: 0.8;"></div>
Â Â Â Â Â  </div>
Â Â Â Â Â  <button id="menuBtn">âš™ï¸</button>
Â Â Â  </div>
Â  </div>

Â  <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
Â  <div id="usersListContainer">
Â Â Â  <div id="searchContainer">
Â Â Â Â Â  <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…..." />
Â Â Â  </div>
Â Â Â  <div id="usersList"></div>
Â  </div>
</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
<div id="chatContainer">
Â  <div id="chatHeader">
Â Â Â  <div style="display: flex; align-items: center; gap: 15px;">
Â Â Â Â Â  <button id="backBtn">â†</button>
Â Â Â Â Â  <div id="chatUserInfo">
Â Â Â Â Â Â Â  <img id="chatUserAvatar" src="" alt="Avatar" />
Â Â Â Â Â Â Â  <div>
Â Â Â Â Â Â Â Â Â  <div id="chatUserName"></div>
Â Â Â Â Â Â Â Â Â  <div id="chatUserStatus"></div>
Â Â Â Â Â Â Â  </div>
Â Â Â Â Â  </div>
Â Â Â  </div>
Â Â Â  <div id="chatControls">
Â Â Â Â Â  <button class="chat-btn" id="blockUserBtn" title="Ø­Ø¸Ø±/Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">ğŸš«</button>
Â Â Â Â Â  <button class="chat-btn" id="clearChatBtn" title="Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©">ğŸ—‘ï¸</button>
Â Â Â  </div>
Â  </div>

Â  <div id="messagesArea"></div>

Â  <div id="inputContainer">
Â Â Â  <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª -->
Â Â Â  <div id="attachMenu">
Â Â Â Â Â  <button class="attach-option" id="attachImageBtn">ğŸ“· Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø©</button>
Â Â Â Â Â  <button class="attach-option" id="attachGalleryBtn">ğŸ–¼ï¸ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ø¶</button>
Â Â Â Â Â  <button class="attach-option" id="attachVideoBtn">ğŸ¥ Ø§Ø®ØªÙŠØ§Ø± ÙÙŠØ¯ÙŠÙˆ</button>
Â Â Â  </div>
Â Â Â  
Â Â Â  <!-- Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
Â Â Â  <div class="recording-indicator" id="recordingIndicator">
Â Â Â Â Â  <div class="recording-dot"></div>
Â Â Â Â Â  <span id="recordingTime">00:00</span>
Â Â Â Â Â  <button class="input-btn" id="stopRecordingBtn">â¹ï¸</button>
Â Â Â  </div>

Â Â Â  <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ -->
Â Â Â  <button class="input-btn" id="attachBtn" title="Ù…Ø±ÙÙ‚Ø§Øª">ğŸ“</button>
Â Â Â  <button class="input-btn" id="recordBtn" title="ØªØ³Ø¬ÙŠÙ„ ØµÙˆØª">ğŸ¤</button>
Â Â Â  <textarea id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." rows="1"></textarea>
Â Â Â  <button class="input-btn" id="sendBtn" title="Ø¥Ø±Ø³Ø§Ù„">ğŸ“¤</button>
Â  </div>
</div>

<!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© -->
<div id="dropdownMenu">
Â  <button class="dropdown-item" id="editProfileBtn">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</button>
Â  <button class="dropdown-item" id="notificationSettingsBtn">ğŸ”” Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>
Â  <button class="dropdown-item" id="blockedUsersBtn">ğŸš« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†</button>
Â  <button class="dropdown-item" id="aboutBtn">â„¹ï¸ Ø¹Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>
Â  <button class="dropdown-item danger" id="logoutBtn">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
Â  <button class="dropdown-item danger" id="deleteAccountBtn">âŒ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨</button>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
<div class="modal" id="editProfileModal">
Â  <div class="modal-content">
Â Â Â  <h3>âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>
Â Â Â  <input type="text" id="editUsername" placeholder="ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…" />
Â Â Â  <input type="text" id="editStatus" placeholder="âœ¨ Ø§Ù„Ø­Ø§Ù„Ø©" />
Â Â Â  <div class="modal-buttons">
Â Â Â Â Â  <button id="saveProfileBtn">ğŸ’¾ Ø­ÙØ¸</button>
Â Â Â Â Â  <button id="cancelProfileBtn">âŒ Ø¥Ù„ØºØ§Ø¡</button>
Â Â Â  </div>
Â  </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
<div class="modal" id="notificationModal">
Â  <div class="modal-content">
Â Â Â  <h3>ğŸ”” Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3>
Â Â Â  <label>
Â Â Â Â Â  <input type="checkbox" id="enableNotifications" checked /> ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
Â Â Â  </label>
Â Â Â  <label>
Â Â Â Â Â  <input type="checkbox" id="enableSounds" checked /> ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£ØµÙˆØ§Øª
Â Â Â  </label>
Â Â Â  <div class="modal-buttons">
Â Â Â Â Â  <button id="saveNotificationBtn">ğŸ’¾ Ø­ÙØ¸</button>
Â Â Â Â Â  <button id="cancelNotificationBtn">âŒ Ø¥Ù„ØºØ§Ø¡</button>
Â Â Â  </div>
Â  </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ† -->
<div class="modal" id="blockedUsersModal">
Â  <div class="modal-content">
Â Â Â  <h3>ğŸš« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙˆÙ†</h3>
Â Â Â  <div id="blockedUsersList" style="max-height: 300px; overflow-y: auto;"></div>
Â Â Â  <div class="modal-buttons">
Â Â Â Â Â  <button id="closeBlockedUsersBtn">Ø¥ØºÙ„Ø§Ù‚</button>
Â Â Â  </div>
Â  </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø¹Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
<div class="modal" id="aboutModal">
Â  <div class="modal-content">
Â Â Â  <h3>â„¹ï¸ Ø¹Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h3>
Â Â Â  <p style="text-align: center; line-height: 1.6;">
Â Â Â Â Â  ØªØ·Ø¨ÙŠÙ‚ ChatPro Ù‡Ùˆ ØªØ·Ø¨ÙŠÙ‚ Ø¯Ø±Ø¯Ø´Ø© ÙÙˆØ±ÙŠ Ù…ØªØ·ÙˆØ± ÙŠØ¯Ø¹Ù… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†ØµÙŠØ© ÙˆØ§Ù„ÙˆØ³Ø§Ø¦Ø· Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
Â Â Â Â Â  Ù…Ø¹ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙˆØ±ÙŠØ© ÙˆØ¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ØªØ«Ø¨ÙŠØª ÙƒØªØ·Ø¨ÙŠÙ‚ ÙˆÙŠØ¨ ØªÙ‚Ø¯Ù…ÙŠ (PWA).
Â Â Â Â Â  <br><br>
Â Â Â Â Â  <strong>Ø§Ù„Ù…ÙŠØ²Ø§Øª:</strong><br>
Â Â Â Â Â  â€¢ Ø¯Ø±Ø¯Ø´Ø© ÙÙˆØ±ÙŠØ© Ø¢Ù…Ù†Ø©<br>
Â Â Â Â Â  â€¢ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ù„ØµÙˆØª<br>
Â Â Â Â Â  â€¢ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ©<br>
Â Â Â Â Â  â€¢ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†<br>
Â Â Â Â Â  â€¢ ØªØ·Ø¨ÙŠÙ‚ Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ«Ø¨ÙŠØª
Â Â Â  </p>
Â Â Â  <div class="modal-buttons">
Â Â Â Â Â  <button id="closeAboutBtn">Ø¥ØºÙ„Ø§Ù‚</button>
Â Â Â  </div>
Â  </div>
</div>

<!-- Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙˆØ³Ø§Ø¦Ø· -->
<div id="mediaPreview">
Â  <div id="previewContent"></div>
Â  <div class="preview-controls">
Â Â Â  <button class="preview-btn" id="sendMediaBtn">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„</button>
Â Â Â  <button class="preview-btn" id="cancelMediaBtn">âŒ Ø¥Ù„ØºØ§Ø¡</button>
Â  </div>
</div>

<!-- Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø®ÙÙŠØ© -->
<input type="file" id="imageInput" accept="image/*" style="display: none;" />
<input type="file" id="videoInput" accept="video/*" style="display: none;" />
<input type="file" id="cameraInput" accept="image/*" capture="camera" style="display: none;" />

<!-- ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
<audio id="notificationSound" preload="auto">
Â  <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMeBC2I0fPTgjEGHm7A7+OZURE" type="audio/wav">
</audio>

<script type="module">
Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
Â  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, deleteUser } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
Â  import { 
Â Â Â  getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, 
Â Â Â  getDocs, doc, setDoc, deleteDoc, where, getDoc, updateDoc, increment 
Â  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
Â  import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
Â  import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js";

Â  const firebaseConfig = {
Â Â Â  apiKey: "AIzaSyAm0hh9I6i58ywW1D2gZg09liG-wG-tBsU",
Â Â Â  authDomain: "chat-fat-4f082.firebaseapp.com",
Â Â Â  projectId: "chat-fat-4f082",
Â Â Â  storageBucket: "chat-fat-4f082.appspot.com",
Â Â Â  messagingSenderId: "297367474930",
Â Â Â  appId: "1:297367474930:web:a05b983e05a0ba257fb66b",
Â Â Â  measurementId: "G-MBGC7KZ8H0"
Â  };

Â  const app = initializeApp(firebaseConfig);
Â  const auth = getAuth(app);
Â  const db = getFirestore(app);
Â  const storage = getStorage(app);
Â  
Â  let messaging = null;
Â  try {
Â Â Â  messaging = getMessaging(app);
Â  } catch (error) {
Â Â Â  console.warn("FCM ØºÙŠØ± Ù…ØªØ§Ø­:", error);
Â  }

Â  // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
Â  let currentUser = null;
Â  let currentChatUser = null;
Â  let unsubscribeMessages = null;
Â  let unsubscribeUsers = null;
Â  let unsubscribeUnreadCounts = null;
Â  let isLogin = true;
Â  let blockedUsers = new Set();
Â  let notificationsEnabled = localStorage.getItem('notificationsEnabled') !== 'false';
Â  let soundsEnabled = localStorage.getItem('soundsEnabled') !== 'false';
Â  let selectedMedia = null;
Â  let deferredPrompt = null;
Â  let mediaRecorder = null;
Â  let recordingStartTime = null;
Â  let recordingInterval = null;

Â  // Ø¹Ù†Ø§ØµØ± DOM
Â  const authContainer = document.getElementById('authContainer');
Â  const app_div = document.getElementById('app');
Â  const chatContainer = document.getElementById('chatContainer');
Â  const formTitle = document.getElementById('formTitle');
Â  const submitBtn = document.getElementById('submitBtn');
Â  const toggleFormBtn = document.getElementById('toggleFormBtn');
Â  const errorMsg = document.getElementById('errorMsg');
Â  const emailInput = document.getElementById('email');
Â  const passwordInput = document.getElementById('password');
Â  const usernameInput = document.getElementById('username');
Â  const statusInput = document.getElementById('status');
Â  const usersList = document.getElementById('usersList');
Â  const searchInput = document.getElementById('searchInput');
Â  const messagesArea = document.getElementById('messagesArea');
Â  const messageInput = document.getElementById('messageInput');
Â  const sendBtn = document.getElementById('sendBtn');
Â  const backBtn = document.getElementById('backBtn');
Â  const menuBtn = document.getElementById('menuBtn');
Â  const dropdownMenu = document.getElementById('dropdownMenu');
Â  const notificationSound = document.getElementById('notificationSound');
Â  const installBtn = document.getElementById('installBtn');

Â  // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ³Ø§Ø¦Ø· ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„
Â  const attachBtn = document.getElementById('attachBtn');
Â  const attachMenu = document.getElementById('attachMenu');
Â  const recordBtn = document.getElementById('recordBtn');
Â  const recordingIndicator = document.getElementById('recordingIndicator');
Â  const recordingTime = document.getElementById('recordingTime');
Â  const stopRecordingBtn = document.getElementById('stopRecordingBtn');

Â  // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
Â  async function updateUserPresence(online) {
Â Â Â  if (!currentUser) return;
Â Â Â  try {
Â Â Â Â Â  const userRef = doc(db, "users", currentUser.uid);
Â Â Â Â Â  await updateDoc(userRef, {
Â Â Â Â Â Â Â  online: online,
Â Â Â Â Â Â Â  lastSeen: online ? null : serverTimestamp()
Â Â Â Â Â  });
Â Â Â  } catch (error) {
Â Â Â Â Â  console.warn("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„:", error);
Â Â Â  }
Â  }

Â  // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø§ÙØ°Ø©
Â  document.addEventListener('visibilitychange', () => {
Â Â Â  if (currentUser) {
Â Â Â Â Â  updateUserPresence(!document.hidden);
Â Â Â  }
Â  });

Â  window.addEventListener('beforeunload', () => {
Â Â Â  if (currentUser) {
Â Â Â Â Â  updateUserPresence(false);
Â Â Â  }
Â  });

Â  // ØªØ¨Ø¯ÙŠÙ„ Ù†Ù…Ø§Ø°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
Â  toggleFormBtn.addEventListener('click', () => {
Â Â Â  isLogin = !isLogin;
Â Â Â  errorMsg.textContent = '';
Â Â Â  
Â Â Â  if (isLogin) {
Â Â Â Â Â  formTitle.innerHTML = 'ğŸ’¬ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ChatPro';
Â Â Â Â Â  submitBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
Â Â Â Â Â  toggleFormBtn.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯';
Â Â Â Â Â  usernameInput.style.display = 'none';
Â Â Â Â Â  statusInput.style.display = 'none';
Â Â Â  } else {
Â Â Â Â Â  formTitle.innerHTML = 'ğŸš€ Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ ChatPro';
Â Â Â Â Â  submitBtn.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨';
Â Â Â Â Â  toggleFormBtn.textContent = 'Ù„Ø¯ÙŠ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„';
Â Â Â Â Â  usernameInput.style.display = 'block';
Â Â Â Â Â  statusInput.style.display = 'block';
Â Â Â  }
Â  });

Â  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨
Â  submitBtn.addEventListener('click', async () => {
Â Â Â  errorMsg.textContent = '';
Â Â Â  const email = emailInput.value.trim();
Â Â Â  const password = passwordInput.value.trim();
Â Â Â  const username = usernameInput.value.trim();
Â Â Â  const status = statusInput.value.trim() || "Ù…ØªØ§Ø­ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø© ğŸ’¬";

Â Â Â  if (!email || !password || (!isLogin && !username)) {
Â Â Â Â Â  errorMsg.textContent = 'âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©';
Â Â Â Â Â  return;
Â Â Â  }

Â Â Â  try {
Â Â Â Â Â  submitBtn.innerHTML = '<div class="loading"></div>';
Â Â Â Â Â  
Â Â Â Â Â  if (isLogin) {
Â Â Â Â Â Â Â  await signInWithEmailAndPassword(auth, email, password);
Â Â Â Â Â  } else {
Â Â Â Â Â Â Â  const userCredential = await createUserWithEmailAndPassword(auth, email, password);
Â Â Â Â Â Â Â  const user = userCredential.user;
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  await setDoc(doc(db, "users", user.uid), {
Â Â Â Â Â Â Â Â Â  email: user.email,
Â Â Â Â Â Â Â Â Â  username,
Â Â Â Â Â Â Â Â Â  status,
Â Â Â Â Â Â Â Â Â  photoURL: `https://ui-avatars.com/api/?name=${encodeURIComponent(username)}&background=6a11cb&color=fff&rounded=true&size=128`,
Â Â Â Â Â Â Â Â Â  online: true,
Â Â Â Â Â Â Â Â Â  lastSeen: null,
Â Â Â Â Â Â Â Â Â  createdAt: serverTimestamp(),
Â Â Â Â Â Â Â Â Â  blockedUsers: [],
Â Â Â Â Â Â Â Â Â  fcmToken: null
Â Â Â Â Â Â Â  });
Â Â Â Â Â  }
Â Â Â  } catch (error) {
Â Â Â Â Â  errorMsg.textContent = getErrorMessage(error.code);
Â Â Â Â Â  console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©:", error);
Â Â Â  } finally {
Â Â Â Â Â  submitBtn.textContent = isLogin ? 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„' : 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨';
Â Â Â  }
Â  });

Â  function getErrorMessage(errorCode) {
Â Â Â  const errors = {
Â Â Â Â Â  'auth/email-already-in-use': 'ğŸ“§ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹',
Â Â Â Â Â  'auth/weak-password': 'ğŸ”’ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© (ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)',
Â Â Â Â Â  'auth/user-not-found': 'ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯',
Â Â Â Â Â  'auth/wrong-password': 'ğŸ”’ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©',
Â Â Â Â Â  'auth/invalid-email': 'ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­',
Â Â Â Â Â  'auth/network-request-failed': 'ğŸŒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©'
Â Â Â  };
Â Â Â  return errors[errorCode] || 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + errorCode;
Â  }

Â  // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
Â  onAuthStateChanged(auth, async (user) => {
Â Â Â  if (user) {
Â Â Â Â Â  currentUser = user;
Â Â Â Â Â  await initializeApp_();
Â Â Â Â Â  updateUserPresence(true);
Â Â Â Â Â  setupFCM();
Â Â Â  } else {
Â Â Â Â Â  currentUser = null;
Â Â Â Â Â  showAuthScreen();
Â Â Â Â Â  cleanup();
Â Â Â  }
Â  });

Â  function cleanup() {
Â Â Â  if (unsubscribeMessages) unsubscribeMessages();
Â Â Â  if (unsubscribeUsers) unsubscribeUsers();
Â Â Â  if (unsubscribeUnreadCounts) unsubscribeUnreadCounts();
Â Â Â  usersList.innerHTML = '';
Â Â Â  messagesArea.innerHTML = '';
Â Â Â  blockedUsers.clear();
Â Â Â  currentChatUser = null;
Â  }

Â  async function initializeApp_() {
Â Â Â  authContainer.style.display = 'none';
Â Â Â  app_div.style.display = 'flex';
Â Â Â  
Â Â Â  const userDoc = await getDoc(doc(db, "users", currentUser.uid));
Â Â Â  if (userDoc.exists()) {
Â Â Â Â Â  const userData = userDoc.data();
Â Â Â Â Â  document.getElementById('currentUsername').textContent = userData.username;
Â Â Â Â Â  document.getElementById('currentUserStatus').textContent = userData.status;
Â Â Â Â Â  document.getElementById('userAvatar').src = userData.photoURL;
Â Â Â Â Â  
Â Â Â Â Â  // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
Â Â Â Â Â  if (userData.notificationsEnabled !== undefined) {
Â Â Â Â Â Â Â  notificationsEnabled = userData.notificationsEnabled;
Â Â Â Â Â Â Â  localStorage.setItem('notificationsEnabled', notificationsEnabled);
Â Â Â Â Â  }
Â Â Â Â Â  if (userData.soundsEnabled !== undefined) {
Â Â Â Â Â Â Â  soundsEnabled = userData.soundsEnabled;
Â Â Â Â Â Â Â  localStorage.setItem('soundsEnabled', soundsEnabled);
Â Â Â Â Â  }
Â Â Â  }

Â Â Â  await loadBlockedUsers();
Â Â Â  loadUsers();
Â Â Â  listenForUnreadCounts();
Â  }

Â  function showAuthScreen() {
Â Â Â  authContainer.style.display = 'block';
Â Â Â  app_div.style.display = 'none';
Â Â Â  chatContainer.style.display = 'none';
Â  }

Â  function loadUsers() {
Â Â Â  if (unsubscribeUsers) unsubscribeUsers();
Â Â Â  
Â Â Â  const usersRef = collection(db, "users");
Â Â Â  unsubscribeUsers = onSnapshot(usersRef, (snapshot) => {
Â Â Â Â Â  usersList.innerHTML = '';
Â Â Â Â Â  const usersData = [];
Â Â Â Â Â  
Â Â Â Â Â  snapshot.forEach((doc) => {
Â Â Â Â Â Â Â  const userData = doc.data();
Â Â Â Â Â Â Â  if (userData.email !== currentUser.email) {
Â Â Â Â Â Â Â Â Â  usersData.push({ id: doc.id, ...userData });
Â Â Â Â Â Â Â  }
Â Â Â Â Â  });

Â Â Â Â Â  // ÙØ±Ø² Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† Ø£ÙˆÙ„Ø§Ù‹
Â Â Â Â Â  usersData.sort((a, b) => {
Â Â Â Â Â Â Â  if (a.online && !b.online) return -1;
Â Â Â Â Â Â Â  if (!a.online && b.online) return 1;
Â Â Â Â Â Â Â  return a.username.localeCompare(b.username);
Â Â Â Â Â  });

Â Â Â Â Â  usersData.forEach(userData => createUserCard(userData));
Â Â Â  });
Â  }

Â  function createUserCard(userData) {
Â Â Â  const userCard = document.createElement('div');
Â Â Â  userCard.className = 'user-card fade-in';
Â Â Â  userCard.dataset.email = userData.email;
Â Â Â  userCard.dataset.uid = userData.id;
Â Â Â  
Â Â Â  if (blockedUsers.has(userData.email)) {
Â Â Â Â Â  userCard.classList.add('blocked');
Â Â Â  }

Â Â Â  const isOnline = userData.online;
Â Â Â  const lastSeenDate = userData.lastSeen ? userData.lastSeen.toDate() : new Date();
Â Â Â  
Â Â Â  userCard.innerHTML = `
Â Â Â Â Â  <div class="user-avatar">
Â Â Â Â Â Â Â  <img src="${userData.photoURL}" alt="${userData.username}" />
Â Â Â Â Â Â Â  <div class="online-indicator ${isOnline ? 'online' : ''}"></div>
Â Â Â Â Â  </div>
Â Â Â Â Â  <div class="user-info">
Â Â Â Â Â Â Â  <h4>${userData.username}</h4>
Â Â Â Â Â Â Â  <div class="user-status">${userData.status || ''}</div>
Â Â Â Â Â Â Â  ${!isOnline ? `<div class="last-seen">Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±: ${formatLastSeen(lastSeenDate)}</div>` : ''}
Â Â Â Â Â  </div>
Â Â Â Â Â  <div class="unread-count" id="unread-${userData.id}">0</div>
Â Â Â  `;

Â Â Â  userCard.addEventListener('click', () => {
Â Â Â Â Â  if (blockedUsers.has(userData.email)) {
Â Â Â Â Â Â Â  if (confirm(`${userData.username} Ù…Ø­Ø¸ÙˆØ± Ø­Ø§Ù„ÙŠØ§Ù‹. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø±Ù‡ØŸ`)) {
Â Â Â Â Â Â Â Â Â  toggleBlockUser(userData.email);
Â Â Â Â Â Â Â  }
Â Â Â Â Â  } else {
Â Â Â Â Â Â Â  openChat(userData);
Â Â Â Â Â  }
Â Â Â  });

Â Â Â  usersList.appendChild(userCard);
Â  }

Â  function formatLastSeen(date) {
Â Â Â  const now = new Date();
Â Â Â  const diff = now.getTime() - date.getTime();
Â Â Â  const minutes = Math.floor(diff / 60000);
Â Â Â  const hours = Math.floor(diff / 3600000);
Â Â Â  const days = Math.floor(diff / 86400000);

Â Â Â  if (minutes < 1) return 'Ø§Ù„Ø¢Ù†';
Â Â Â  if (minutes < 60) return `Ù…Ù†Ø° ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
Â Â Â  if (hours < 24) return `Ù…Ù†Ø° ${hours} Ø³Ø§Ø¹Ø©`;
Â Â Â  if (days < 7) return `Ù…Ù†Ø° ${days} ÙŠÙˆÙ…`;
Â Â Â  return date.toLocaleDateString('ar-EG');
Â  }

Â  async function openChat(userData) {
Â Â Â  currentChatUser = userData;
Â Â Â  
Â Â Â  app_div.style.display = 'none';
Â Â Â  chatContainer.style.display = 'flex';
Â Â Â  chatContainer.classList.add('slide-in');
Â Â Â  
Â Â Â  document.getElementById('chatUserName').textContent = userData.username;
Â Â Â  document.getElementById('chatUserAvatar').src = userData.photoURL;
Â Â Â  
Â Â Â  // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
Â Â Â  const chatUserDoc = await getDoc(doc(db, "users", userData.id));
Â Â Â  if (chatUserDoc.exists()) {
Â Â Â Â Â  const chatUserData = chatUserDoc.data();
Â Â Â Â Â  document.getElementById('chatUserStatus').textContent = 
Â Â Â Â Â Â Â  chatUserData.online ? 'Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù† ğŸŸ¢' : `Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±: ${formatLastSeen(chatUserData.lastSeen?.toDate() || new Date())}`;
Â Â Â  }

Â Â Â  // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø­Ø¸Ø±
Â Â Â  document.getElementById('blockUserBtn').textContent = 
Â Â Â Â Â  blockedUsers.has(userData.email) ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±' : 'Ø­Ø¸Ø±';
Â Â Â  
Â Â Â  loadMessages();
Â Â Â  resetUnreadCount(userData.id);
Â  }

Â  // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©
Â  function listenForUnreadCounts() {
Â Â Â  if (unsubscribeUnreadCounts) unsubscribeUnreadCounts();

Â Â Â  const unreadRef = collection(db, `users/${currentUser.uid}/unreadCounts`);
Â Â Â  unsubscribeUnreadCounts = onSnapshot(unreadRef, (snapshot) => {
Â Â Â Â Â  snapshot.docChanges().forEach(change => {
Â Â Â Â Â Â Â  const senderId = change.doc.id;
Â Â Â Â Â Â Â  const count = change.doc.data().count || 0;
Â Â Â Â Â Â Â  updateUnreadCountDisplay(senderId, count);
Â Â Â Â Â  });
Â Â Â  });
Â  }

Â  function updateUnreadCountDisplay(userId, count) {
Â Â Â  const unreadElement = document.getElementById(`unread-${userId}`);
Â Â Â  if (unreadElement) {
Â Â Â Â Â  if (count > 0) {
Â Â Â Â Â Â Â  unreadElement.textContent = count > 99 ? '99+' : count;
Â Â Â Â Â Â Â  unreadElement.classList.add('show');
Â Â Â Â Â  } else {
Â Â Â Â Â Â Â  unreadElement.textContent = '0';
Â Â Â Â Â Â Â  unreadElement.classList.remove('show');
Â Â Â Â Â  }
Â Â Â  }
Â  }

Â  async function resetUnreadCount(senderId) {
Â Â Â  try {
Â Â Â Â Â  const unreadRef = doc(db, `users/${currentUser.uid}/unreadCounts`, senderId);
Â Â Â Â Â  await setDoc(unreadRef, { count: 0 }, { merge: true });
Â Â Â  } catch (error) {
Â Â Â Â Â  console.warn("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø¯Ø§Ø¯:", error);
Â Â Â  }
Â  }

Â  function loadMessages() {
Â Â Â  if (unsubscribeMessages) unsubscribeMessages();
Â Â Â  
Â Â Â  messagesArea.innerHTML = '';
Â Â Â  
Â Â Â  const messagesRef = collection(db, "messages");
Â Â Â  const messagesQuery = query(messagesRef, orderBy("timestamp"));

Â Â Â  unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
Â Â Â Â Â  let newMessagesReceived = false;
Â Â Â Â Â  
Â Â Â Â Â  snapshot.docChanges().forEach(change => {
Â Â Â Â Â Â Â  const messageData = change.doc.data();
Â Â Â Â Â Â Â  const messageId = change.doc.id;
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  if (isMessageBetweenUsers(messageData, currentUser.email, currentChatUser.email)) {
Â Â Â Â Â Â Â Â Â  if (change.type === 'added') {
Â Â Â Â Â Â Â Â Â Â Â  displayMessage(messageData, messageId);
Â Â Â Â Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â Â Â Â Â  if (messageData.to === currentUser.email && !messageData.read) {
Â Â Â Â Â Â Â Â Â Â Â Â Â  markMessageAsRead(messageId);
Â Â Â Â Â Â Â Â Â Â Â Â Â  newMessagesReceived = true;
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â  } else if (change.type === 'removed') {
Â Â Â Â Â Â Â Â Â Â Â  const existingMessage = messagesArea.querySelector(`[data-message-id="${messageId}"]`);
Â Â Â Â Â Â Â Â Â Â Â  if (existingMessage) {
Â Â Â Â Â Â Â Â Â Â Â Â Â  existingMessage.remove();
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  }
Â Â Â Â Â  });
Â Â Â Â Â  
Â Â Â Â Â  scrollToBottom();

Â Â Â Â Â  if (newMessagesReceived && document.hidden && soundsEnabled) {
Â Â Â Â Â Â Â  playNotificationSound();
Â Â Â Â Â  }
Â Â Â  });
Â  }

Â  function isMessageBetweenUsers(message, user1Email, user2Email) {
Â Â Â  return (message.from === user1Email && message.to === user2Email) ||
Â Â Â Â Â Â Â Â Â Â  (message.from === user2Email && message.to === user1Email);
Â  }

Â  function displayMessage(messageData, messageId) {
Â Â Â  const messageWrapper = document.createElement('div');
Â Â Â  messageWrapper.className = `message-wrapper ${messageData.from === currentUser.email ? 'sent' : 'received'}`;
Â Â Â  messageWrapper.dataset.messageId = messageId;
Â Â Â  
Â Â Â  const message = document.createElement('div');
Â Â Â  message.className = `message ${messageData.from === currentUser.email ? 'sent' : 'received'}`;
Â Â Â  
Â Â Â  // Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Ø­Ø°Ù)
Â Â Â  if (messageData.from === currentUser.email) {
Â Â Â Â Â  const messageOptions = document.createElement('div');
Â Â Â Â Â  messageOptions.className = 'message-options';
Â Â Â Â Â  messageOptions.innerHTML = `
Â Â Â Â Â Â Â  <button class="message-option" title="Ø­Ø°Ù Ù„Ø¯ÙŠ">ğŸ—‘ï¸</button>
Â Â Â Â Â Â Â  <button class="message-option" title="Ø­Ø°Ù Ù„Ù„Ø¬Ù…ÙŠØ¹">âŒ</button>
Â Â Â Â Â  `;
Â Â Â Â Â  
Â Â Â Â Â  const [deleteForMe, deleteForAll] = messageOptions.querySelectorAll('button');
Â Â Â Â Â  deleteForMe.addEventListener('click', () => deleteMessage(messageId, 'me'));
Â Â Â Â Â  deleteForAll.addEventListener('click', () => deleteMessage(messageId, 'all'));
Â Â Â Â Â  
Â Â Â Â Â  messageWrapper.appendChild(messageOptions);
Â Â Â  }

Â Â Â  let messageContent = '';
Â Â Â  
Â Â Â  if (messageData.type === 'image') {
Â Â Â Â Â  messageContent = `
Â Â Â Â Â Â Â  <div class="message-media">
Â Â Â Â Â Â Â Â Â  <img src="${messageData.mediaURL}" alt="ØµÙˆØ±Ø©" />
Â Â Â Â Â Â Â  </div>
Â Â Â Â Â  `;
Â Â Â Â Â  message.addEventListener('click', () => openMediaPreview(messageData.mediaURL, 'image'));
Â Â Â  } else if (messageData.type === 'video') {
Â Â Â Â Â  messageContent = `
Â Â Â Â Â Â Â  <div class="message-media">
Â Â Â Â Â Â Â Â Â  <video src="${messageData.mediaURL}" controls></video>
Â Â Â Â Â Â Â  </div>
Â Â Â Â Â  `;
Â Â Â  } else if (messageData.type === 'audio') {
Â Â Â Â Â  messageContent = `
Â Â Â Â Â Â Â  <div class="message-media">
Â Â Â Â Â Â Â Â Â  <audio src="${messageData.mediaURL}" controls></audio>
Â Â Â Â Â Â Â  </div>
Â Â Â Â Â  `;
Â Â Â  } else {
Â Â Â Â Â  messageContent = escapeHtml(messageData.text || '');
Â Â Â  }
Â Â Â  
Â Â Â  const timestamp = messageData.timestamp ? messageData.timestamp.toDate() : new Date();
Â Â Â  
Â Â Â  message.innerHTML = `
Â Â Â Â Â  ${messageContent}
Â Â Â Â Â  ${messageData.text && messageData.type !== 'text' ? `<div style="margin-top: 5px;">${escapeHtml(messageData.text)}</div>` : ''}
Â Â Â Â Â  <div class="message-time">${formatTime(timestamp)}</div>
Â Â Â  `;
Â Â Â  
Â Â Â  messageWrapper.appendChild(message);
Â Â Â  messagesArea.appendChild(messageWrapper);
Â  }

Â  function escapeHtml(str) {
Â Â Â  const div = document.createElement('div');
Â Â Â  div.textContent = str;
Â Â Â  return div.innerHTML;
Â  }

Â  function formatTime(date) {
Â Â Â  return date.toLocaleTimeString('ar-EG', {
Â Â Â Â Â  hour: '2-digit',
Â Â Â Â Â  minute: '2-digit'
Â Â Â  });
Â  }

Â  function scrollToBottom() {
Â Â Â  messagesArea.scrollTop = messagesArea.scrollHeight;
Â  }

Â  async function markMessageAsRead(messageId) {
Â Â Â  try {
Â Â Â Â Â  const messageRef = doc(db, "messages", messageId);
Â Â Â Â Â  await updateDoc(messageRef, { read: true });
Â Â Â  } catch (error) {
Â Â Â Â Â  console.warn("Ø®Ø·Ø£ ÙÙŠ ÙˆØ³Ù… Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø©:", error);
Â Â Â  }
Â  }

Â  async function sendMessage(text = '', type = 'text', mediaURL = '') {
Â Â Â  if ((!text.trim() && !mediaURL) || !currentChatUser) return;
Â Â Â  
Â Â Â  const messageData = {
Â Â Â Â Â  from: currentUser.email,
Â Â Â Â Â  fromUid: currentUser.uid,
Â Â Â Â Â  to: currentChatUser.email,
Â Â Â Â Â  toUid: currentChatUser.id,
Â Â Â Â Â  text: text.trim(),
Â Â Â Â Â  type,
Â Â Â Â Â  timestamp: serverTimestamp(),
Â Â Â Â Â  read: false
Â Â Â  };
Â Â Â  
Â Â Â  if (mediaURL) {
Â Â Â Â Â  messageData.mediaURL = mediaURL;
Â Â Â  }
Â Â Â  
Â Â Â  try {
Â Â Â Â Â  await addDoc(collection(db, "messages"), messageData);
Â Â Â Â Â  messageInput.value = '';
Â Â Â Â Â  messageInput.style.height = 'auto';
Â Â Â Â Â  
Â Â Â Â Â  // Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø© Ù„Ù„Ù…Ø³ØªÙ‚Ø¨Ù„
Â Â Â Â Â  const unreadRef = doc(db, `users/${currentChatUser.id}/unreadCounts`, currentUser.uid);
Â Â Â Â Â  await setDoc(unreadRef, { count: increment(1) }, { merge: true });

Â Â Â  } catch (error) {
Â Â Â Â Â  console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', error);
Â Â Â Â Â  alert('ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
Â Â Â  }
Â  }

Â  async function uploadFile(file, progressCallback) {
Â Â Â  const fileExtension = file.name.split('.').pop();
Â Â Â  const fileName = `${Date.now()}_${Math.random().toString(36).substring(2, 15)}.${fileExtension}`;
Â Â Â  const fileRef = ref(storage, `media/${fileName}`);
Â Â Â  
Â Â Â  return new Promise((resolve, reject) => {
Â Â Â Â Â  const uploadTask = uploadBytesResumable(fileRef, file);
Â Â Â Â Â  
Â Â Â Â Â  uploadTask.on('state_changed',
Â Â Â Â Â Â Â  (snapshot) => {
Â Â Â Â Â Â Â Â Â  const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
Â Â Â Â Â Â Â Â Â  if (progressCallback) progressCallback(progress);
Â Â Â Â Â Â Â  },
Â Â Â Â Â Â Â  (error) => {
Â Â Â Â Â Â Â Â Â  console.error('Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù:', error);
Â Â Â Â Â Â Â Â Â  reject(error);
Â Â Â Â Â Â Â  },
Â Â Â Â Â Â Â  async () => {
Â Â Â Â Â Â Â Â Â  try {
Â Â Â Â Â Â Â Â Â Â Â  const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
Â Â Â Â Â Â Â Â Â Â Â  resolve(downloadURL);
Â Â Â Â Â Â Â Â Â  } catch (error) {
Â Â Â Â Â Â Â Â Â Â Â  reject(error);
Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  }
Â Â Â Â Â  );
Â Â Â  });
Â  }

Â  function showMediaPreview(file, type) {
Â Â Â  selectedMedia = { file, type };
Â Â Â  const previewContent = document.getElementById('previewContent');
Â Â Â  previewContent.innerHTML = '';
Â Â Â  
Â Â Â  if (type === 'image') {
Â Â Â Â Â  const img = document.createElement('img');
Â Â Â Â Â  img.src = URL.createObjectURL(file);
Â Â Â Â Â  img.alt = "Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©";
Â Â Â Â Â  previewContent.appendChild(img);
Â Â Â  } else if (type === 'video') {
Â Â Â Â Â  const video = document.createElement('video');
Â Â Â Â Â  video.src = URL.createObjectURL(file);
Â Â Â Â Â  video.controls = true;
Â Â Â Â Â  previewContent.appendChild(video);
Â Â Â  } else if (type === 'audio') {
Â Â Â Â Â  const audio = document.createElement('audio');
Â Â Â Â Â  audio.src = URL.createObjectURL(file);
Â Â Â Â Â  audio.controls = true;
Â Â Â Â Â  previewContent.appendChild(audio);
Â Â Â  }
Â Â Â  
Â Â Â  document.getElementById('mediaPreview').style.display = 'flex';
Â  }

Â  window.openMediaPreview = function(url, type) {
Â Â Â  const previewContent = document.getElementById('previewContent');
Â Â Â  previewContent.innerHTML = '';
Â Â Â  
Â Â Â  if (type === 'image') {
Â Â Â Â Â  const img = document.createElement('img');
Â Â Â Â Â  img.src = url;
Â Â Â Â Â  img.alt = "ØµÙˆØ±Ø©";
Â Â Â Â Â  previewContent.appendChild(img);
Â Â Â  } else if (type === 'video') {
Â Â Â Â Â  const video = document.createElement('video');
Â Â Â Â Â  video.src = url;
Â Â Â Â Â  video.controls = true;
Â Â Â Â Â  video.autoplay = true;
Â Â Â Â Â  previewContent.appendChild(video);
Â Â Â  }
Â Â Â  
Â Â Â  document.getElementById('mediaPreview').style.display = 'flex';
Â Â Â  
Â Â Â  document.getElementById('mediaPreview').onclick = (e) => {
Â Â Â Â Â  if (e.target === e.currentTarget) {
Â Â Â Â Â Â Â  document.getElementById('mediaPreview').style.display = 'none';
Â Â Â Â Â  }
Â Â Â  };
Â  };

Â  async function deleteMessage(messageId, deleteType) {
Â Â Â  if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ')) return;
Â Â Â  
Â Â Â  try {
Â Â Â Â Â  if (deleteType === 'all') {
Â Â Â Â Â Â Â  await deleteDoc(doc(db, "messages", messageId));
Â Â Â Â Â Â Â  alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹.');
Â Â Â Â Â  } else {
Â Â Â Â Â Â Â  await updateDoc(doc(db, "messages", messageId), {
Â Â Â Â Â Â Â Â Â  text: 'ğŸš« ØªÙ… Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©',
Â Â Â Â Â Â Â Â Â  type: 'text',
Â Â Â Â Â Â Â Â Â  mediaURL: null,
Â Â Â Â Â Â Â Â Â  deletedBy: currentUser.uid
Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â  alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ø¯ÙŠÙƒ.');
Â Â Â Â Â  }
Â Â Â  } catch (error) {
Â Â Â Â Â  console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', error);
Â Â Â Â Â  alert('ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©.');
Â Â Â  }
Â  }

Â  // Ø¥Ø¹Ø¯Ø§Ø¯ FCM Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
Â  async function setupFCM() {
Â Â Â  if (!messaging || !('Notification' in window)) return;

Â Â Â  try {
Â Â Â Â Â  const permission = await Notification.requestPermission();
Â Â Â Â Â  if (permission === 'granted') {
Â Â Â Â Â Â Â  // Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø¨Ù…ÙØªØ§Ø­ VAPID Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù…Ù† Firebase Console
Â Â Â Â Â Â Â  const vapidKey = 'YOUR_VAPID_KEY_HERE';
Â Â Â Â Â Â Â  const currentToken = await getToken(messaging, { vapidKey });
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  if (currentToken) {
Â Â Â Â Â Â Â Â Â  console.log('FCM Token:', currentToken);
Â Â Â Â Â Â Â Â Â  await setDoc(doc(db, "users", currentUser.uid), { fcmToken: currentToken }, { merge: true });
Â Â Â Â Â Â Â  }
Â Â Â Â Â  }

Â Â Â Â Â  // Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©
Â Â Â Â Â  onMessage(messaging, (payload) => {
Â Â Â Â Â Â Â  console.log('Ø±Ø³Ø§Ù„Ø© FCM ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©:', payload);
Â Â Â Â Â Â Â  if (notificationsEnabled && document.hidden) {
Â Â Â Â Â Â Â Â Â  sendNotification(payload.notification.title, payload.notification.body);
Â Â Â Â Â Â Â  }
Â Â Â Â Â  });

Â Â Â  } catch (error) {
Â Â Â Â Â  console.warn('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ FCM:', error);
Â Â Â  }
Â  }

Â  function sendNotification(title, body) {
Â Â Â  if (notificationsEnabled && document.hidden) {
Â Â Â Â Â  new Notification(`ğŸ’¬ ${title}`, {
Â Â Â Â Â Â Â  body: body,
Â Â Â Â Â Â Â  icon: '/icon-192x192.png'
Â Â Â Â Â  });
Â Â Â  }
Â Â Â  
Â Â Â  if (soundsEnabled) {
Â Â Â Â Â  playNotificationSound();
Â Â Â  }
Â  }

Â  function playNotificationSound() {
Â Â Â  try {
Â Â Â Â Â  notificationSound.currentTime = 0;
Â Â Â Â Â  notificationSound.play();
Â Â Â  } catch (error) {
Â Â Â Â Â  console.warn("Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:", error);
Â Â Â  }
Â  }

Â  async function loadBlockedUsers() {
Â Â Â  try {
Â Â Â Â Â  const userDoc = await getDoc(doc(db, "users", currentUser.uid));
Â Â Â Â Â  if (userDoc.exists() && userDoc.data().blockedUsers) {
Â Â Â Â Â Â Â  blockedUsers = new Set(userDoc.data().blockedUsers);
Â Â Â Â Â  } else {
Â Â Â Â Â Â Â  blockedUsers = new Set();
Â Â Â Â Â  }
Â Â Â  } catch (error) {
Â Â Â Â Â  console.warn("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†:", error);
Â Â Â  }
Â  }

Â  async function toggleBlockUser(userEmail) {
Â Â Â  const userRef = doc(db, "users", currentUser.uid);
Â Â Â  let newBlockedUsers;
Â Â Â  
Â Â Â  if (blockedUsers.has(userEmail)) {
Â Â Â Â Â  blockedUsers.delete(userEmail);
Â Â Â Â Â  newBlockedUsers = Array.from(blockedUsers);
Â Â Â Â Â  alert('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….');
Â Â Â  } else {
Â Â Â Â Â  blockedUsers.add(userEmail);
Â Â Â Â Â  newBlockedUsers = Array.from(blockedUsers);
Â Â Â Â Â  alert('ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­.');
Â Â Â  }
Â Â Â  
Â Â Â  try {
Â Â Â Â Â  await updateDoc(userRef, { blockedUsers: newBlockedUsers });
Â Â Â Â Â  loadUsers();
Â Â Â Â Â  
Â Â Â Â Â  if (currentChatUser) {
Â Â Â Â Â Â Â  document.getElementById('blockUserBtn').textContent = 
Â Â Â Â Â Â Â Â Â  blockedUsers.has(currentChatUser.email) ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±' : 'Ø­Ø¸Ø±';
Â Â Â Â Â  }
Â Â Â  } catch (error) {
Â Â Â Â Â  console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†:", error);
Â Â Â Â Â  alert('ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¸Ø±.');
Â Â Â  }
Â  }

Â  // Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
Â  sendBtn.addEventListener('click', () => sendMessage(messageInput.value));
Â  
Â  messageInput.addEventListener('keypress', (e) => {
Â Â Â  if (e.key === 'Enter' && !e.shiftKey) {
Â Â Â Â Â  e.preventDefault();
Â Â Â Â Â  sendMessage(messageInput.value);
Â Â Â  }
Â  });

Â  messageInput.addEventListener('input', function() {
Â Â Â  this.style.height = 'auto';
Â Â Â  this.style.height = Math.min(this.scrollHeight, 100) + 'px';
Â  });

Â  backBtn.addEventListener('click', () => {
Â Â Â  chatContainer.style.display = 'none';
Â Â Â  app_div.style.display = 'flex';
Â Â Â  currentChatUser = null;
Â Â Â  if (unsubscribeMessages) unsubscribeMessages();
Â  });

Â  // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
Â  attachBtn.addEventListener('click', (e) => {
Â Â Â  e.stopPropagation();
Â Â Â  attachMenu.style.display = attachMenu.style.display === 'flex' ? 'none' : 'flex';
Â  });

Â  document.addEventListener('click', (e) => {
Â Â Â  if (!attachMenu.contains(e.target) && e.target !== attachBtn) {
Â Â Â Â Â  attachMenu.style.display = 'none';
Â Â Â  }
Â  });

Â  document.getElementById('attachImageBtn').addEventListener('click', () => {
Â Â Â  document.getElementById('cameraInput').click();
Â Â Â  attachMenu.style.display = 'none';
Â  });

Â  document.getElementById('attachGalleryBtn').addEventListener('click', () => {
Â Â Â  document.getElementById('imageInput').click();
Â Â Â  attachMenu.style.display = 'none';
Â  });

Â  document.getElementById('attachVideoBtn').addEventListener('click', () => {
Â Â Â  document.getElementById('videoInput').click();
Â Â Â  attachMenu.style.display = 'none';
Â  });

Â  // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„ÙØ§Øª
Â  document.getElementById('imageInput').addEventListener('change', (e) => {
Â Â Â  const file = e.target.files[0];
Â Â Â  if (file) showMediaPreview(file, 'image');
Â Â Â  e.target.value = '';
Â  });

Â  document.getElementById('videoInput').addEventListener('change', (e) => {
Â Â Â  const file = e.target.files[0];
Â Â Â  if (file) showMediaPreview(file, 'video');
Â Â Â  e.target.value = '';
Â  });

Â  document.getElementById('cameraInput').addEventListener('change', (e) => {
Â Â Â  const file = e.target.files[0];
Â Â Â  if (file) showMediaPreview(file, 'image');
Â Â Â  e.target.value = '';
Â  });

Â  // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·
Â  document.getElementById('sendMediaBtn').addEventListener('click', async () => {
Â Â Â  if (!selectedMedia) return;
Â Â Â  
Â Â Â  try {
Â Â Â Â Â  document.getElementById('sendMediaBtn').innerHTML = '<div class="loading"></div>';
Â Â Â Â Â  
Â Â Â Â Â  const mediaURL = await uploadFile(selectedMedia.file, (progress) => {
Â Â Â Â Â Â Â  console.log(`ØªÙ‚Ø¯Ù… Ø§Ù„Ø±ÙØ¹: ${progress}%`);
Â Â Â Â Â  });
Â Â Â Â Â  
Â Â Â Â Â  await sendMessage('', selectedMedia.type, mediaURL);
Â Â Â Â Â  document.getElementById('mediaPreview').style.display = 'none';
Â Â Â Â Â  selectedMedia = null;
Â Â Â  } catch (error) {
Â Â Â Â Â  console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·:", error);
Â Â Â Â Â  alert('ÙØ´Ù„ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
Â Â Â  } finally {
Â Â Â Â Â  document.getElementById('sendMediaBtn').innerHTML = 'ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„';
Â Â Â  }
Â  });

Â  document.getElementById('cancelMediaBtn').addEventListener('click', () => {
Â Â Â  document.getElementById('mediaPreview').style.display = 'none';
Â Â Â  selectedMedia = null;
Â  });

Â  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª
Â  recordBtn.addEventListener('click', async () => {
Â Â Â  if (mediaRecorder && mediaRecorder.state === 'recording') {
Â Â Â Â Â  mediaRecorder.stop();
Â Â Â Â Â  return;
Â Â Â  }

Â Â Â  try {
Â Â Â Â Â  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
Â Â Â Â Â  mediaRecorder = new MediaRecorder(stream);
Â Â Â Â Â  const audioChunks = [];
Â Â Â Â Â  
Â Â Â Â Â  mediaRecorder.ondataavailable = (event) => {
Â Â Â Â Â Â Â  audioChunks.push(event.data);
Â Â Â Â Â  };
Â Â Â Â Â  
Â Â Â Â Â  mediaRecorder.onstop = () => {
Â Â Â Â Â Â Â  const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
Â Â Â Â Â Â Â  const audioFile = new File([audioBlob], `voice_${Date.now()}.webm`, { type: 'audio/webm' });
Â Â Â Â Â Â Â  showMediaPreview(audioFile, 'audio');
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  stream.getTracks().forEach(track => track.stop());
Â Â Â Â Â Â Â  stopRecording();
Â Â Â Â Â  };
Â Â Â Â Â  
Â Â Â Â Â  mediaRecorder.start();
Â Â Â Â Â  startRecording();
Â Â Â Â Â  
Â Â Â  } catch (error) {
Â Â Â Â Â  console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†:', error);
Â Â Â Â Â  alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„.');
Â Â Â  }
Â  });

Â  stopRecordingBtn.addEventListener('click', () => {
Â Â Â  if (mediaRecorder && mediaRecorder.state === 'recording') {
Â Â Â Â Â  mediaRecorder.stop();
Â Â Â  }
Â  });

Â  function startRecording() {
Â Â Â  recordingIndicator.style.display = 'flex';
Â Â Â  recordBtn.style.display = 'none';
Â Â Â  recordingStartTime = Date.now();
Â Â Â  
Â Â Â  recordingInterval = setInterval(() => {
Â Â Â Â Â  const elapsed = Date.now() - recordingStartTime;
Â Â Â Â Â  const minutes = Math.floor(elapsed / 60000);
Â Â Â Â Â  const seconds = Math.floor((elapsed % 60000) / 1000);
Â Â Â Â Â  recordingTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
Â Â Â  }, 1000);
Â  }

Â  function stopRecording() {
Â Â Â  recordingIndicator.style.display = 'none';
Â Â Â  recordBtn.style.display = 'flex';
Â Â Â  if (recordingInterval) {
Â Â Â Â Â  clearInterval(recordingInterval);
Â Â Â Â Â  recordingInterval = null;
Â Â Â  }
Â  }

Â  // Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
Â  menuBtn.addEventListener('click', (e) => {
Â Â Â  e.stopPropagation();
Â Â Â  dropdownMenu.style.display = dropdownMenu.style.display === 'flex' ? 'none' : 'flex';
Â  });

Â  document.addEventListener('click', (e) => {
Â Â Â  if (!menuBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
Â Â Â Â Â  dropdownMenu.style.display = 'none';
Â Â Â  }
Â  });

Â  // Ø§Ù„Ø¨Ø­Ø«
Â  searchInput.addEventListener('input', (e) => {
Â Â Â  const searchTerm = e.target.value.toLowerCase();
Â Â Â  document.querySelectorAll('.user-card').forEach(card => {
Â Â Â Â Â  const username = card.querySelector('h4').textContent.toLowerCase();
Â Â Â Â Â  card.style.display = username.includes(searchTerm) ? 'flex' : 'none';
Â Â Â  });
Â  });

Â  // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
Â  document.getElementById('logoutBtn').addEventListener('click', async () => {
Â Â Â  if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
Â Â Â Â Â  await updateUserPresence(false);
Â Â Â Â Â  await signOut(auth);
Â Â Â  }
Â  });

Â  document.getElementById('deleteAccountBtn').addEventListener('click', async () => {
Â Â Â  const confirmText = prompt('Ù„Ù„ØªØ£ÙƒÙŠØ¯ØŒ Ø§ÙƒØªØ¨ "Ø­Ø°Ù" Ù„Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹:');
Â Â Â  if (confirmText === 'Ø­Ø°Ù') {
Â Â Â Â Â  try {
Â Â Â Â Â Â Â  await deleteDoc(doc(db, "users", currentUser.uid));
Â Â Â Â Â Â Â  await deleteUser(currentUser);
Â Â Â Â Â Â Â  alert('ØªÙ… Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­.');
Â Â Â Â Â  } catch (error) {
Â Â Â Â Â Â Â  console.error("Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨:", error);
Â Â Â Â Â Â Â  alert('ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨. Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.');
Â Â Â Â Â  }
Â Â Â  }
Â  });

Â  document.getElementById('blockUserBtn').addEventListener('click', () => {
Â Â Â  if (currentChatUser) {
Â Â Â Â Â  const isBlocked = blockedUsers.has(currentChatUser.email);
Â Â Â Â Â  if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ ${isBlocked ? 'Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø±' : 'Ø­Ø¸Ø±'} ${currentChatUser.username}ØŸ`)) {
Â Â Â Â Â Â Â  toggleBlockUser(currentChatUser.email);
Â Â Â Â Â  }
Â Â Â  }
Â  });

Â  document.getElementById('clearChatBtn').addEventListener('click', () => {
Â Â Â  if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ù† Ø¬Ù‡Ø§Ø²ÙƒØŸ')) {
Â Â Â Â Â  messagesArea.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø­Ù„ÙŠØ§Ù‹</div>';
Â Â Â  }
Â  });

Â  // Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
Â  document.getElementById('editProfileBtn').addEventListener('click', async () => {
Â Â Â  const userDoc = await getDoc(doc(db, "users", currentUser.uid));
Â Â Â  if (userDoc.exists()) {
Â Â Â Â Â  const userData = userDoc.data();
Â Â Â Â Â  document.getElementById('editUsername').value = userData.username || '';
Â Â Â Â Â  document.getElementById('editStatus').value = userData.status || '';
Â Â Â  }
Â Â Â  document.getElementById('editProfileModal').style.display = 'flex';
Â Â Â  dropdownMenu.style.display = 'none';
Â  });

Â  document.getElementById('saveProfileBtn').addEventListener('click', async () => {
Â Â Â  const newUsername = document.getElementById('editUsername').value.trim();
Â Â Â  const newStatus = document.getElementById('editStatus').value.trim();
Â Â Â  
Â Â Â  if (!newUsername) {
Â Â Â Â Â  alert('Ø§Ù„Ø§Ø³Ù… Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ§Ø±ØºØ§Ù‹.');
Â Â Â Â Â  return;
Â Â Â  }
Â Â Â  
Â Â Â  try {
Â Â Â Â Â  await updateDoc(doc(db, "users", currentUser.uid), {
Â Â Â Â Â Â Â  username: newUsername,
Â Â Â Â Â Â Â  status: newStatus,
Â Â Â Â Â Â Â  photoURL: `https://ui-avatars.com/api/?name=${encodeURIComponent(newUsername)}&background=6a11cb&color=fff&rounded=true&size=128`
Â Â Â Â Â  });
Â Â Â Â Â  
Â Â Â Â Â  document.getElementById('currentUsername').textContent = newUsername;
Â Â Â Â Â  document.getElementById('currentUserStatus').textContent = newStatus;
Â Â Â Â Â  document.getElementById('userAvatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(newUsername)}&background=6a11cb&color=fff&rounded=true&size=128`;
Â Â Â Â Â  
Â Â Â Â Â  document.getElementById('editProfileModal').style.display = 'none';
Â Â Â Â Â  alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø¨Ù†Ø¬Ø§Ø­!');
Â Â Â  } catch (error) {
Â Â Â Â Â  console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ:", error);
Â Â Â Â Â  alert('ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ.');
Â Â Â  }
Â  });

Â  document.getElementById('cancelProfileBtn').addEventListener('click', () => {
Â Â Â  document.getElementById('editProfileModal').style.display = 'none';
Â  });

Â  // Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
Â  document.getElementById('notificationSettingsBtn').addEventListener('click', () => {
Â Â Â  document.getElementById('enableNotifications').checked = notificationsEnabled;
Â Â Â  document.getElementById('enableSounds').checked = soundsEnabled;
Â Â Â  document.getElementById('notificationModal').style.display = 'flex';
Â Â Â  dropdownMenu.style.display = 'none';
Â  });

Â  document.getElementById('saveNotificationBtn').addEventListener('click', async () => {
Â Â Â  notificationsEnabled = document.getElementById('enableNotifications').checked;
Â Â Â  soundsEnabled = document.getElementById('enableSounds').checked;
Â Â Â  
Â Â Â  localStorage.setItem('notificationsEnabled', notificationsEnabled);
Â Â Â  localStorage.setItem('soundsEnabled', soundsEnabled);

Â Â Â  try {
Â Â Â Â Â  await updateDoc(doc(db, "users", currentUser.uid), {
Â Â Â Â Â Â Â  notificationsEnabled,
Â Â Â Â Â Â Â  soundsEnabled
Â Â Â Â Â  });
Â Â Â Â Â  alert('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª.');
Â Â Â  } catch (error) {
Â Â Â Â Â  console.warn("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:", error);
Â Â Â  }
Â Â Â  
Â Â Â  document.getElementById('notificationModal').style.display = 'none';
Â  });

Â  document.getElementById('cancelNotificationBtn').addEventListener('click', () => {
Â Â Â  document.getElementById('notificationModal').style.display = 'none';
Â  });

Â  // Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†
Â  document.getElementById('blockedUsersBtn').addEventListener('click', async () => {
Â Â Â  const blockedUsersList = document.getElementById('blockedUsersList');
Â Â Â  blockedUsersList.innerHTML = '';
Â Â Â  
Â Â Â  if (blockedUsers.size === 0) {
Â Â Â Â Â  blockedUsersList.innerHTML = '<p style="text-align: center; color: #777;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù…Ø­Ø¸ÙˆØ±ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
Â Â Â  } else {
Â Â Â Â Â  const usersCollection = collection(db, "users");
Â Â Â Â Â  
Â Â Â Â Â  for (const email of blockedUsers) {
Â Â Â Â Â Â Â  const q = query(usersCollection, where("email", "==", email));
Â Â Â Â Â Â Â  const querySnapshot = await getDocs(q);
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  if (!querySnapshot.empty) {
Â Â Â Â Â Â Â Â Â  const userData = querySnapshot.docs[0].data();
Â Â Â Â Â Â Â Â Â  const blockedCard = document.createElement('div');
Â Â Â Â Â Â Â Â Â  blockedCard.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee;';
Â Â Â Â Â Â Â Â Â  blockedCard.innerHTML = `
Â Â Â Â Â Â Â Â Â Â Â  <div style="display: flex; align-items: center; gap: 10px;">
Â Â Â Â Â Â Â Â Â Â Â Â Â  <img src="${userData.photoURL}" alt="${userData.username}" style="width: 30px; height: 30px; border-radius: 50%;" />
Â Â Â Â Â Â Â Â Â Â Â Â Â  <div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <div style="font-weight: bold;">${userData.username}</div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <div style="font-size: 12px; color: #666;">${userData.email}</div>
Â Â Â Â Â Â Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â Â Â Â Â  <button style="background: #2575fc; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;" onclick="unblockUser('${userData.email}')">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±</button>
Â Â Â Â Â Â Â Â Â  `;
Â Â Â Â Â Â Â Â Â  blockedUsersList.appendChild(blockedCard);
Â Â Â Â Â Â Â  }
Â Â Â Â Â  }
Â Â Â  }
Â Â Â  
Â Â Â  document.getElementById('blockedUsersModal').style.display = 'flex';
Â Â Â  dropdownMenu.style.display = 'none';
Â  });

Â  window.unblockUser = function(email) {
Â Â Â  toggleBlockUser(email);
Â Â Â  document.getElementById('blockedUsersModal').style.display = 'none';
Â  };

Â  document.getElementById('closeBlockedUsersBtn').addEventListener('click', () => {
Â Â Â  document.getElementById('blockedUsersModal').style.display = 'none';
Â  });

Â  // Ù…ÙˆØ¯Ø§Ù„ Ø¹Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
Â  document.getElementById('aboutBtn').addEventListener('click', () => {
Â Â Â  document.getElementById('aboutModal').style.display = 'flex';
Â Â Â  dropdownMenu.style.display = 'none';
Â  });

Â  document.getElementById('closeAboutBtn').addEventListener('click', () => {
Â Â Â  document.getElementById('aboutModal').style.display = 'none';
Â  });

Â  // PWA - ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
Â  window.addEventListener('beforeinstallprompt', (e) => {
Â Â Â  e.preventDefault();
Â Â Â  deferredPrompt = e;
Â Â Â  installBtn.style.display = 'inline-block';
Â  });

Â  installBtn.addEventListener('click', async () => {
Â Â Â  if (deferredPrompt) {
Â Â Â Â Â  deferredPrompt.prompt();
Â Â Â Â Â  const { outcome } = await deferredPrompt.userChoice;
Â Â Â Â Â  console.log(`Ù†ØªÙŠØ¬Ø© ØªØ«Ø¨ÙŠØª PWA: ${outcome}`);
Â Â Â Â Â  deferredPrompt = null;
Â Â Â Â Â  installBtn.style.display = 'none';
Â Â Â  }
Â  });

Â  window.addEventListener('appinstalled', () => {
Â Â Â  installBtn.style.display = 'none';
Â Â Â  console.log('ØªÙ… ØªØ«Ø¨ÙŠØª PWA');
Â  });

Â  // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø«Ø¨ØªØ§Ù‹ Ø¨Ø§Ù„ÙØ¹Ù„
Â  if (navigator.standalone || window.matchMedia('(display-mode: standalone)').matches) {
Â Â Â  installBtn.style.display = 'none';
Â  }

Â  console.log('ğŸ’¬ ChatPro ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¨Ù†Ø¬Ø§Ø­!');
</script>

</body>
</html>

