<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>💬 ChatPro - دردشة فورية</title>
  <link rel="manifest" href="data:application/json;base64,ewibmFtZSI6ImNoYXRwcm8iLCJzaG9ydF9uYW1lIjoiY2hhdHBybyIsInN0YXJ0X3VybCI6Ii9pbmRleC5odG1sIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzY4Nzk5NSIsInRoZW1lX2NvbG9yIjoiIzY4Nzk5NSIsInByZWZlcnJlZF9kaXNwbGF5X21vZGUiOiJzdGFuZGFsb25lIiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vd3d3LmZhYmVsLnBhaW50L2ljb24vMjU2eDI1Ni9jaGF0cHJvLnBuZyIsInNpemVzIjoiMjU2eDI1NiIsInR5cGUiOiJpbWFnZS9wbmciLCJwdXJwb3NlcyI6ImFueSBtYXNrYWJsZSJ9XX0=">
  <style>
    /* تصميم محسّن يشبه الواتساب */
    :root {
      --whatsapp-green: #25d366;
      --whatsapp-dark-green: #128c7e;
      --whatsapp-light-green: #dcf8c6;
      --whatsapp-blue: #34b7f1;
      --whatsapp-gray: #f0f0f0;
      --whatsapp-dark-gray: #8696a0;
      --whatsapp-bg: #e5ddd5;
      --message-sent: #dcf8c6;
      --message-received: #ffffff;
      --shadow: rgba(0,0,0,0.1);
    }

    html, body {
      height: 100vh;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      direction: rtl;
      background: var(--whatsapp-bg);
      font-size: 14px;
    }

    /* إخفاء الواجهتين بشكل افتراضي */
    #authContainer, #app {
      display: none;
    }

    /* شاشة تسجيل الدخول */
    #authContainer {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 2rem;
      border-radius: 15px;
      box-shadow: 0 10px 30px var(--shadow);
      width: min(350px, 90vw);
      z-index: 1000;
    }

    #authContainer h2 {
      text-align: center;
      margin-bottom: 1.5rem;
      color: var(--whatsapp-dark-green);
      font-size: 1.5rem;
      font-weight: 600;
    }

    input, button, textarea {
      width: 100%;
      padding: 12px 16px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    input:focus, textarea:focus {
      border-color: var(--whatsapp-green);
      outline: none;
      box-shadow: 0 0 0 2px rgba(37, 211, 102, 0.2);
    }

    button {
      background: var(--whatsapp-green);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    button:hover {
      background: var(--whatsapp-dark-green);
    }

    #toggleFormBtn {
      background: transparent;
      color: var(--whatsapp-green);
      border: 1px solid var(--whatsapp-green);
    }

    #toggleFormBtn:hover {
      background: var(--whatsapp-green);
      color: white;
    }

    #errorMsg {
      color: #e53e3e;
      text-align: center;
      min-height: 20px;
      font-size: 12px;
      margin: 8px 0;
    }

    /* التطبيق الرئيسي */
    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: white;
    }

    /* شريط التطبيق العلوي */
    #appHeader {
      background: var(--whatsapp-dark-green);
      color: white;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px var(--shadow);
      min-height: 60px;
    }

    #appLogoContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    #appLogo {
      font-size: 18px;
      font-weight: 600;
    }

    #appLogo::before {
      content: "💬";
      margin-left: 8px;
    }

    #usersCount {
      font-size: 11px;
      opacity: 0.8;
    }

    #userInfo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    #userDetails {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    #currentUsername {
      font-weight: 500;
      font-size: 14px;
    }

    #currentUserStatus {
      font-size: 11px;
      opacity: 0.8;
    }

    #menuBtn {
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      padding: 8px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #menuBtn:hover {
      background: rgba(255,255,255,0.2);
    }

    /* المحتوى الرئيسي */
    #mainContent {
      display: flex;
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    /* قائمة المستخدمين */
    #usersListContainer {
      width: 100%;
      background: white;
      display: flex;
      flex-direction: column;
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      z-index: 150;
      transition: transform 0.3s ease;
    }

    #usersListContainer.hidden {
      transform: translateX(100%);
    }

    #searchContainer {
      padding: 12px 16px;
      background: var(--whatsapp-gray);
      border-bottom: 1px solid #e0e0e0;
    }

    #searchInput {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 18px;
      font-size: 14px;
      background: white;
      margin: 0;
    }

    #usersList {
      flex: 1;
      overflow-y: auto;
      background: white;
    }

    .user-card {
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.2s ease;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid var(--whatsapp-gray);
      position: relative;
    }

    .user-card:hover {
      background: var(--whatsapp-gray);
    }

    .user-card.blocked {
      opacity: 0.5;
      background: #ffebee;
    }

    .user-card.new-message {
      animation: newMessagePulse 0.5s ease-in-out;
    }

    @keyframes newMessagePulse {
      0% { background: var(--whatsapp-light-green); }
      100% { background: white; }
    }

    .user-avatar-container {
      position: relative;
      min-width: 48px;
    }

    .user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--whatsapp-green);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 18px;
    }

    .online-indicator {
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 12px;
      height: 12px;
      background: var(--whatsapp-green);
      border: 2px solid white;
      border-radius: 50%;
      display: none;
    }

    .online-indicator.online {
      display: block;
      animation: onlinePulse 2s infinite;
    }

    @keyframes onlinePulse {
      0% { box-shadow: 0 0 0 0 rgba(37, 211, 102, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(37, 211, 102, 0); }
      100% { box-shadow: 0 0 0 0 rgba(37, 211, 102, 0); }
    }

    .user-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .user-info h4 {
      font-size: 16px;
      font-weight: 500;
      color: #111;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .unread-count {
      background: var(--whatsapp-green);
      color: white;
      font-size: 11px;
      font-weight: bold;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 18px;
      text-align: center;
      display: none;
      animation: bounceIn 0.3s ease;
    }

    .unread-count.show {
      display: inline-block;
    }

    @keyframes bounceIn {
      0% { transform: scale(0); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    .user-status {
      font-size: 13px;
      color: var(--whatsapp-dark-gray);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .last-seen {
      font-size: 12px;
      color: var(--whatsapp-dark-gray);
    }

    .online-text {
      color: var(--whatsapp-green);
      font-size: 12px;
    }

    /* شاشة المحادثة */
    #chatContainer {
      flex: 1;
      display: none;
      flex-direction: column;
      background: var(--whatsapp-bg);
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 200;
    }

    #chatHeader {
      background: var(--whatsapp-dark-green);
      color: white;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px var(--shadow);
      min-height: 60px;
    }

    #chatUserInfo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    #chatUserAvatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--whatsapp-green);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }

    #chatUserDetails {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    #chatUserName {
      font-size: 16px;
      font-weight: 500;
    }

    #chatUserStatus {
      font-size: 12px;
      opacity: 0.8;
    }

    #chatControls {
      display: flex;
      gap: 8px;
    }

    .chat-btn {
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      padding: 8px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 16px;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chat-btn:hover {
      background: rgba(255,255,255,0.2);
    }

    /* منطقة الرسائل */
    #messagesArea {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      background-image: 
        repeating-linear-gradient(
          45deg,
          rgba(0,0,0,0.02),
          rgba(0,0,0,0.02) 1px,
          transparent 1px,
          transparent 10px
        );
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .message-wrapper {
      display: flex;
      margin: 2px 0;
    }

    .message-wrapper.sent {
      justify-content: flex-end;
    }

    .message-wrapper.received {
      justify-content: flex-start;
    }

    .message {
      max-width: 75%;
      padding: 8px 12px 6px 12px;
      border-radius: 8px;
      position: relative;
      word-wrap: break-word;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      animation: messageSlide 0.2s ease;
    }

    @keyframes messageSlide {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.sent {
      background: var(--message-sent);
      color: #111;
      border-bottom-right-radius: 2px;
    }

    .message.received {
      background: var(--message-received);
      color: #111;
      border-bottom-left-radius: 2px;
    }

    .message.new {
      animation: newMessage 0.5s ease-in-out;
    }

    @keyframes newMessage {
      0% { 
        opacity: 0;
        transform: translateY(20px) scale(0.9);
        background: #fff3cd;
      }
      50% {
        transform: translateY(-5px) scale(1.02);
      }
      100% { 
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .message-content {
      margin-bottom: 4px;
      line-height: 1.4;
      font-size: 14px;
    }

    .message-media {
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 4px;
      background: #000;
    }

    .message-media img,
    .message-media video {
      width: 100%;
      max-width: 250px;
      height: auto;
      display: block;
    }

    .message-time {
      font-size: 11px;
      color: var(--whatsapp-dark-gray);
      text-align: left;
      direction: ltr;
      margin-top: 2px;
    }

    /* منطقة الإدخال */
    #inputContainer {
      background: var(--whatsapp-gray);
      padding: 8px 16px;
      display: flex;
      align-items: flex-end;
      gap: 8px;
      min-height: 60px;
    }

    #mediaButtons {
      display: flex;
      gap: 4px;
    }

    .media-btn {
      background: white;
      color: var(--whatsapp-dark-gray);
      border: none;
      padding: 8px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 3px var(--shadow);
    }

    .media-btn:hover {
      background: var(--whatsapp-gray);
    }

    #messageInput {
      flex: 1;
      resize: none;
      min-height: 36px;
      max-height: 120px;
      padding: 8px 12px;
      border: none;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.4;
      margin: 0;
      background: white;
      box-shadow: 0 1px 3px var(--shadow);
    }

    #messageInput:focus {
      outline: none;
    }

    #sendBtn {
      background: var(--whatsapp-green);
      color: white;
      border: none;
      padding: 0;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 3px var(--shadow);
      transition: all 0.2s ease;
    }

    #sendBtn:hover {
      background: var(--whatsapp-dark-green);
      transform: scale(1.05);
    }

    /* معاينة الوسائط */
    #mediaPreview {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 3000;
    }

    #mediaPreview .preview-content {
      max-width: 90%;
      max-height: 90%;
      position: relative;
    }

    #mediaPreview img,
    #mediaPreview video {
      max-width: 100%;
      max-height: 100%;
      border-radius: 8px;
    }

    .preview-controls {
      position: absolute;
      bottom: -60px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 12px;
    }

    .preview-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 12px 20px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }

    .preview-btn.send {
      background: var(--whatsapp-green);
    }

    /* القوائم المنسدلة */
    #dropdownMenu {
      position: absolute;
      top: 60px;
      right: 16px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px var(--shadow);
      display: none;
      flex-direction: column;
      min-width: 200px;
      z-index: 300;
      overflow: hidden;
    }

    .dropdown-item {
      padding: 12px 16px;
      border: none;
      background: transparent;
      text-align: right;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
      color: #111;
    }

    .dropdown-item:hover {
      background: var(--whatsapp-gray);
    }

    .dropdown-item.danger {
      color: #e53e3e;
    }

    .dropdown-item.danger:hover {
      background: #ffebee;
    }

    /* المودال */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 4000;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 24px;
      width: min(350px, 90vw);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .modal h3 {
      margin-bottom: 16px;
      text-align: center;
      color: #111;
      font-size: 18px;
      font-weight: 500;
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 20px;
    }

    .modal-buttons button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }

    .modal-buttons .primary {
      background: var(--whatsapp-green);
      color: white;
    }

    .modal-buttons .secondary {
      background: var(--whatsapp-gray);
      color: #111;
    }

    /* حالة الكتابة */
    #typingIndicator {
      padding: 8px 16px;
      color: var(--whatsapp-dark-gray);
      font-style: italic;
      font-size: 12px;
      background: var(--whatsapp-gray);
      display: none;
      animation: typingPulse 1.5s infinite;
    }

    @keyframes typingPulse {
      0%, 100% { opacity: 0.7; }
      50% { opacity: 1; }
    }

    /* إشعار الرسالة الجديدة */
    .new-message-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--whatsapp-green);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 20px var(--shadow);
      z-index: 5000;
      display: none;
      animation: slideInRight 0.3s ease;
      cursor: pointer;
    }

    .new-message-notification.show {
      display: block;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* مؤشر الاتصال */
    .connection-status {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: #f44336;
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      z-index: 5000;
      display: none;
    }

    .connection-status.connected {
      background: var(--whatsapp-green);
    }

    /* تحسينات الجوال */
    @media (max-width: 768px) {
      body {
        font-size: 14px;
      }

      #appHeader, #chatHeader {
        padding: 10px 12px;
        min-height: 56px;
      }

      .message {
        max-width: 85%;
        font-size: 14px;
      }

      #inputContainer {
        padding: 6px 12px;
      }

      .user-card {
        padding: 10px 12px;
      }

      .new-message-notification {
        top: 10px;
        right: 10px;
        left: 10px;
        transform: none;
      }
    }

    /* شريط التمرير */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: var(--whatsapp-gray);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--whatsapp-dark-gray);
      border-radius: 3px;
    }

    /* إخفاء ملفات الإدخال */
    input[type="file"] {
      display: none;
    }

    /* رسالة ترحيب */
    .welcome-message {
      text-align: center;
      padding: 40px 20px;
      color: var(--whatsapp-dark-gray);
    }

    .welcome-message h3 {
      color: var(--whatsapp-green);
      margin-bottom: 12px;
      font-size: 20px;
    }

    /* حالة فارغة */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--whatsapp-dark-gray);
      font-size: 14px;
    }

    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    /* تنسيق إشعار الترحيب */
    .welcome-content {
      text-align: right;
      line-height: 1.6;
      font-size: 14px;
      color: #555;
    }

    .cute-chat-name {
      font-weight: 600;
      color: var(--whatsapp-green);
    }

    /* إخفاء صور المستخدمين الافتراضية */
    .user-avatar, #chatUserAvatar {
      background: var(--whatsapp-green);
      color: white;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* تحسين الأداء */
    .message-wrapper {
      contain: layout;
    }

    .user-card {
      contain: layout;
    }

    /* Loading spinner */
    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .media-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 12px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body>

<!-- إشعار الرسالة الجديدة -->
<div id="newMessageNotification" class="new-message-notification">
  <div id="notificationContent"></div>
</div>

<!-- مؤشر حالة الاتصال -->
<div id="connectionStatus" class="connection-status">
  غير متصل بالإنترنت
</div>

<div id="authContainer">
  <h2 id="formTitle">💬 مرحباً بك في ChatPro</h2>
  <input type="email" id="email" placeholder="📧 البريد الإلكتروني" />
  <input type="password" id="password" placeholder="🔒 كلمة المرور" />
  <input type="text" id="username" placeholder="👤 الاسم" style="display: none;" />
  <input type="text" id="status" placeholder="✨ الحالة (اختياري)" style="display: none;" />
  <div id="errorMsg"></div>
  <button id="submitBtn">تسجيل الدخول</button>
  <button id="toggleFormBtn">إنشاء حساب جديد</button>
</div>

<div id="app">
  <div id="appHeader">
    <div id="userInfo">
      <button id="menuBtn">⋮</button>
      <div id="userDetails">
        <div id="currentUsername"></div>
        <div id="currentUserStatus"></div>
      </div>
    </div>
    <div id="appLogoContainer">
      <div id="appLogo">ChatPro</div>
      <div id="usersCount"></div>
    </div>
  </div>

  <div id="mainContent">
    <div id="usersListContainer">
      <div id="searchContainer">
        <input type="text" id="searchInput" placeholder="🔍 ابحث عن مستخدم..." />
      </div>
      <div id="usersList">
        <div class="welcome-message">
          <h3>🎉 مرحباً بك!</h3>
          <p>ابدأ محادثة جديدة مع أصدقائك</p>
        </div>
      </div>
    </div>

    <div id="chatContainer">
      <div id="chatHeader">
        <div id="chatUserInfo">
          <div id="chatUserAvatar"></div>
          <div id="chatUserDetails">
            <div id="chatUserName"></div>
            <div id="chatUserStatus"></div>
          </div>
        </div>
        <div id="chatControls">
          <button class="chat-btn" id="blockUserBtn" title="حظر/إلغاء حظر">🚫</button>
          <button class="chat-btn" id="backBtn" title="رجوع">←</button>
        </div>
      </div>

      <div id="messagesArea">
        <div class="empty-state">
          <div class="icon">💬</div>
          <p>اختر محادثة لبدء الدردشة</p>
        </div>
      </div>

      <div id="typingIndicator">
        <span id="typingUser"></span> يكتب...
      </div>

      <div id="inputContainer">
        <div id="mediaButtons">
          <button class="media-btn" id="cameraBtn" title="التقاط صورة">📸</button>
          <button class="media-btn" id="galleryBtn" title="اختيار صورة">🖼️</button>
          <button class="media-btn" id="videoBtn" title="اختيار فيديو">🎥</button>
        </div>
        <textarea id="messageInput" placeholder="اكتب رسالة..." rows="1"></textarea>
        <button id="sendBtn">➤</button>
      </div>
    </div>
  </div>

  <div id="dropdownMenu">
    <button class="dropdown-item" id="editProfileBtn">
      <span>✏️ تعديل الملف الشخصي</span>
    </button>
    <button class="dropdown-item" id="blockedUsersBtn">
      <span>🚫 المستخدمين المحظورين</span>
    </button>
    <button class="dropdown-item" id="notificationSettingsBtn">
      <span>🔔 إعدادات الإشعارات</span>
    </button>
    <button class="dropdown-item" id="aboutBtn">
      <span>ℹ️ عن التطبيق</span>
    </button>
    <button class="dropdown-item danger" id="logoutBtn">
      <span>🚪 تسجيل الخروج</span>
    </button>
    <button class="dropdown-item danger" id="deleteAccountBtn">
      <span>❌ حذف الحساب</span>
    </button>
  </div>
</div>

<div id="mediaPreview">
  <div class="preview-content">
    <div id="previewMedia"></div>
    <div class="preview-controls">
      <button class="preview-btn send" id="sendMediaBtn">📤 إرسال</button>
      <button class="preview-btn" id="cancelMediaBtn">❌ إلغاء</button>
    </div>
  </div>
</div>

<div class="modal" id="editProfileModal">
  <div class="modal-content">
    <h3>✏️ تعديل الملف الشخصي</h3>
    <input type="text" id="editUsername" placeholder="👤 الاسم" />
    <input type="text" id="editStatus" placeholder="✨ الحالة" />
    <div class="modal-buttons">
      <button class="primary" id="saveProfileBtn">💾 حفظ</button>
      <button class="secondary" id="cancelProfileBtn">❌ إلغاء</button>
    </div>
  </div>
</div>

<div class="modal" id="notificationModal">
  <div class="modal-content">
    <h3>🔔 إعدادات الإشعارات</h3>
    <div style="text-align: right; margin: 20px 0;">
      <label style="display: flex; align-items: center; gap: 10px; margin: 15px 0;">
        <input type="checkbox" id="enableNotifications" checked />
        <span>تفعيل الإشعارات</span>
      </label>
      <label style="display: flex; align-items: center; gap: 10px; margin: 15px 0;">
        <input type="checkbox" id="enableSounds" checked />
        <span>تفعيل الأصوات</span>
      </label>
    </div>
    <div class="modal-buttons">
      <button class="primary" id="saveNotificationBtn">💾 حفظ</button>
      <button class="secondary" id="cancelNotificationBtn">❌ إلغاء</button>
    </div>
  </div>
</div>

<div class="modal" id="welcomeModal">
  <div class="modal-content">
    <div class="welcome-content">
      عزيزنا العميل / <span id="welcomeUsername"></span><br>
      نشكرك للانضمام إلى عائلة <span class="cute-chat-name">كيوت شات</span><br><br>
      نلفت انتباهكم إلى أننا نعمل جاهدين لتطوير هذا التطبيق <span class="cute-chat-name">كيوت شات</span><br>
      ليعمل بدون إنترنت أو بيانات هاتف وسيكون التطبيق بإذن الله عز وجل متاحاً في أيدي الجميع، وسيتميز بإضافة الاتصالات الصوتية والمرئية ومكالمات الفيديو المشتركة بإذن الله عز وجل.<br><br>
      <strong>تنويه هام:</strong><br>
      لن نتمكن من بلوغ الهدف إلا بفضل الله علينا وفضلكم.
    </div>
    <div class="modal-buttons">
      <button class="primary" id="welcomeModalOkBtn">موافق</button>
    </div>
  </div>
</div>

<div class="modal" id="blockModal">
  <div class="modal-content">
    <h3 id="blockModalTitle">🚫 حظر المستخدم</h3>
    <p id="blockModalMessage" style="text-align: center; margin: 20px 0;"></p>
    <div class="modal-buttons">
      <button class="primary" id="confirmBlockBtn">تأكيد</button>
      <button class="secondary" id="cancelBlockBtn">إلغاء</button>
    </div>
  </div>
</div>

<input type="file" id="imageInput" accept="image/*" />
<input type="file" id="videoInput" accept="video/*" />
<input type="file" id="cameraInput" accept="image/*" capture="camera" />

<audio id="notificationSound" preload="auto">
  <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMeBC2I0fPTgjEGHm7A7+OZURE" type="audio/wav">
</audio>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, getDocs, doc, setDoc, where, getDoc, updateDoc, limit, startAfter } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAm0hh9I6i58ywW1D2gZg09liG-wG-tBsU",
    authDomain: "chat-fat-4f082.firebaseapp.com",
    projectId: "chat-fat-4f082",
    storageBucket: "chat-fat-4f082.appspot.com",
    messagingSenderId: "297367474930",
    appId: "1:297367474930:web:a05b983e05a0ba257fb66b",
    measurementId: "G-MBGC7KZ8H0"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // متغيرات عامة محسّنة للأداء والتحديث الفوري
  let currentUser = null;
  let currentChatUser = null;
  let unsubscribeMessages = null;
  let unsubscribeUsers = null;
  let unsubscribeTyping = null;
  let unsubscribeGlobalMessages = null;
  let usersData = new Map();
  let unreadCounts = new Map();
  let blockedUsers = new Set();
  let onlineUsers = new Set();
  let typingTimeout = null;
  let notificationsEnabled = localStorage.getItem('notificationsEnabled') !== 'false';
  let soundsEnabled = localStorage.getItem('soundsEnabled') !== 'false';
  let isLogin = true;
  let messagesCache = new Map();
  let lastMessageTimestamp = null;
  let isAppVisible = true;
  let notificationPermission = 'default';

  // عناصر DOM
  const authContainer = document.getElementById('authContainer');
  const app_div = document.getElementById('app');
  const chatContainer = document.getElementById('chatContainer');
  const usersListContainer = document.getElementById('usersListContainer');
  const formTitle = document.getElementById('formTitle');
  const submitBtn = document.getElementById('submitBtn');
  const toggleFormBtn = document.getElementById('toggleFormBtn');
  const errorMsg = document.getElementById('errorMsg');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const usernameInput = document.getElementById('username');
  const statusInput = document.getElementById('status');
  const usersList = document.getElementById('usersList');
  const searchInput = document.getElementById('searchInput');
  const messagesArea = document.getElementById('messagesArea');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const backBtn = document.getElementById('backBtn');
  const menuBtn = document.getElementById('menuBtn');
  const dropdownMenu = document.getElementById('dropdownMenu');
  const notificationSound = document.getElementById('notificationSound');
  const blockUserBtn = document.getElementById('blockUserBtn');
  const imageInput = document.getElementById('imageInput');
  const videoInput = document.getElementById('videoInput');
  const cameraInput = document.getElementById('cameraInput');
  const galleryBtn = document.getElementById('galleryBtn');
  const videoBtn = document.getElementById('videoBtn');
  const cameraBtn = document.getElementById('cameraBtn');
  const mediaPreview = document.getElementById('mediaPreview');
  const previewMedia = document.getElementById('previewMedia');
  const sendMediaBtn = document.getElementById('sendMediaBtn');
  const cancelMediaBtn = document.getElementById('cancelMediaBtn');
  const usersCountElement = document.getElementById('usersCount');
  const editProfileModal = document.getElementById('editProfileModal');
  const editUsername = document.getElementById('editUsername');
  const editStatus = document.getElementById('editStatus');
  const saveProfileBtn = document.getElementById('saveProfileBtn');
  const cancelProfileBtn = document.getElementById('cancelProfileBtn');
  const editProfileBtn = document.getElementById('editProfileBtn');
  const notificationSettingsBtn = document.getElementById('notificationSettingsBtn');
  const notificationModal = document.getElementById('notificationModal');
  const enableNotifications = document.getElementById('enableNotifications');
  const enableSounds = document.getElementById('enableSounds');
  const saveNotificationBtn = document.getElementById('saveNotificationBtn');
  const cancelNotificationBtn = document.getElementById('cancelNotificationBtn');
  const typingIndicator = document.getElementById('typingIndicator');
  const typingUserElement = document.getElementById('typingUser');
  const logoutBtn = document.getElementById('logoutBtn');
  const welcomeModal = document.getElementById('welcomeModal');
  const welcomeModalOkBtn = document.getElementById('welcomeModalOkBtn');
  const welcomeUsername = document.getElementById('welcomeUsername');
  const blockModal = document.getElementById('blockModal');
  const blockModalTitle = document.getElementById('blockModalTitle');
  const blockModalMessage = document.getElementById('blockModalMessage');
  const confirmBlockBtn = document.getElementById('confirmBlockBtn');
  const cancelBlockBtn = document.getElementById('cancelBlockBtn');
  const newMessageNotification = document.getElementById('newMessageNotification');
  const notificationContent = document.getElementById('notificationContent');
  const connectionStatus = document.getElementById('connectionStatus');

  // مراقبة حالة الرؤية والاتصال
  document.addEventListener('visibilitychange', () => {
    isAppVisible = !document.hidden;
    if (isAppVisible) {
      // إخفاء الإشعارات عند العودة للتطبيق
      hideNotification();
    }
  });

  // مراقبة حالة الاتصال بالإنترنت
  window.addEventListener('online', () => {
    connectionStatus.textContent = 'متصل بالإنترنت';
    connectionStatus.classList.add('connected');
    connectionStatus.style.display = 'block';
    setTimeout(() => {
      connectionStatus.style.display = 'none';
    }, 2000);
  });

  window.addEventListener('offline', () => {
    connectionStatus.textContent = 'غير متصل بالإنترنت';
    connectionStatus.classList.remove('connected');
    connectionStatus.style.display = 'block';
  });

  // طلب إذن الإشعارات
  const requestNotificationPermission = async () => {
    if ('Notification' in window) {
      notificationPermission = await Notification.requestPermission();
    }
  };

  // إظهار إشعار الرسالة الجديدة
  const showNewMessageNotification = (senderName, messageText, isInChat = false) => {
    if (!notificationsEnabled || isAppVisible) return;

    // إشعار في التطبيق
    if (!isInChat) {
      notificationContent.innerHTML = `
        <strong>${senderName}</strong><br>
        ${messageText.length > 50 ? messageText.substring(0, 50) + '...' : messageText}
      `;
      newMessageNotification.classList.add('show');
      
      setTimeout(() => {
        hideNotification();
      }, 4000);
      
      newMessageNotification.onclick = () => {
        hideNotification();
        const sender = Array.from(usersData.values()).find(user => user.username === senderName);
        if (sender) {
          openChat(sender);
        }
      };
    }

    // إشعار النظام
    if (notificationPermission === 'granted' && !isAppVisible) {
      const notification = new Notification(`رسالة جديدة من ${senderName}`, {
        body: messageText,
        icon: '/icon-192x192.png',
        badge: '/icon-192x192.png',
        tag: 'new-message',
        requireInteraction: false,
        silent: !soundsEnabled
      });

      notification.onclick = () => {
        window.focus();
        notification.close();
        const sender = Array.from(usersData.values()).find(user => user.username === senderName);
        if (sender) {
          openChat(sender);
        }
      };

      setTimeout(() => {
        notification.close();
      }, 5000);
    }

    // تشغيل الصوت
    if (soundsEnabled) {
      notificationSound.play().catch(e => console.log('Sound play failed:', e));
    }
  };

  const hideNotification = () => {
    newMessageNotification.classList.remove('show');
  };

  // دوال مساعدة محسّنة للتحديث الفوري
  const debounce = (func, wait) => {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  };

  const throttle = (func, limit) => {
    let inThrottle;
    return function() {
      const args = arguments;
      const context = this;
      if (!inThrottle) {
        func.apply(context, args);
        inThrottle = true;
        setTimeout(() => inThrottle = false, limit);
      }
    }
  };

  const getUserInitials = (username) => {
    return username ? username.charAt(0).toUpperCase() : '?';
  };

  const formatTime = (timestamp) => {
    if (!timestamp) return '';
    const date = timestamp.toDate();
    const now = new Date();
    const isToday = date.getDate() === now.getDate() &&
                    date.getMonth() === now.getMonth() &&
                    date.getFullYear() === now.getFullYear();
    
    if (isToday) {
      return date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
    } else {
      const yesterday = new Date(now);
      yesterday.setDate(yesterday.getDate() - 1);
      const isYesterday = date.getDate() === yesterday.getDate() &&
                         date.getMonth() === yesterday.getMonth() &&
                         date.getFullYear() === yesterday.getFullYear();
      
      if (isYesterday) {
        return 'أمس';
      } else {
        return date.toLocaleDateString('ar-EG', { day: 'numeric', month: 'short' });
      }
    }
  };

  const formatLastSeen = (timestamp) => {
    if (!timestamp) return 'غير متاح';
    const date = timestamp.toDate();
    const now = new Date();
    const diffInMinutes = Math.floor((now - date) / (1000 * 60));
    const diffInHours = Math.floor(diffInMinutes / 60);
    const diffInDays = Math.floor(diffInHours / 24);

    if (diffInMinutes < 1) return 'متصل الآن';
    if (diffInMinutes < 60) return `آخر ظهور منذ ${diffInMinutes} د`;
    if (diffInHours < 24) return `آخر ظهور منذ ${diffInHours} س`;
    if (diffInDays < 7) return `آخر ظهور منذ ${diffInDays} أيام`;
    return `آخر ظهور ${date.toLocaleDateString('ar-EG')}`;
  };

  const getChatId = (uid1, uid2) => {
    return uid1 < uid2 ? uid1 + '_' + uid2 : uid2 + '_' + uid1;
  };

  // دالة لعرض/إخفاء الواجهات
  const showAuth = () => {
    app_div.style.display = 'none';
    authContainer.style.display = 'block';
  };

  const showApp = () => {
    authContainer.style.display = 'none';
    app_div.style.display = 'flex';
  };

  const showChat = () => {
    usersListContainer.classList.add('hidden');
    chatContainer.style.display = 'flex';
    messageInput.focus();
    history.pushState({ view: 'chat' }, '', '');
  };

  const showUsersList = () => {
    usersListContainer.classList.remove('hidden');
    chatContainer.style.display = 'none';
    currentChatUser = null;
    if (unsubscribeMessages) {
      unsubscribeMessages();
      unsubscribeMessages = null;
    }
    if (unsubscribeTyping) {
      unsubscribeTyping();
      unsubscribeTyping = null;
    }
    typingIndicator.style.display = 'none';
    history.pushState({ view: 'users' }, '', '');
    renderUsersList();
  };

  // معالجة زر الرجوع في المتصفح/الهاتف
  window.addEventListener('popstate', (event) => {
    event.preventDefault();
    if (chatContainer.style.display === 'flex') {
      showUsersList();
    }
    return false;
  });

  // منع إغلاق التطبيق عند الضغط على زر الرجوع
  window.addEventListener('beforeunload', (event) => {
    if (chatContainer.style.display === 'flex') {
      event.preventDefault();
      showUsersList();
      return false;
    }
  });

  // وظائف واجهة المصادقة
  submitBtn.addEventListener('click', async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    const username = usernameInput.value.trim();
    const status = statusInput.value.trim();

    errorMsg.textContent = '';

    if (!email || !password) {
      errorMsg.textContent = "الرجاء إدخال البريد الإلكتروني وكلمة المرور.";
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'جاري التحميل...';

    try {
      if (isLogin) {
        await signInWithEmailAndPassword(auth, email, password);
      } else {
        if (!username) {
          errorMsg.textContent = "الرجاء إدخال اسم المستخدم.";
          return;
        }
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        await setDoc(doc(db, "users", user.uid), {
          uid: user.uid,
          email: user.email,
          username: username,
          status: status || 'متاح',
          isOnline: true,
          lastSeen: serverTimestamp(),
          lastActive: serverTimestamp(),
          blockedUsers: [],
          createdAt: serverTimestamp()
        });
        welcomeUsername.textContent = username;
        welcomeModal.style.display = 'flex';
      }
    } catch (error) {
      console.error("Auth error:", error);
      if (error.code === 'auth/email-already-in-use') {
        errorMsg.textContent = "هذا البريد الإلكتروني مستخدم بالفعل.";
      } else if (error.code === 'auth/user-not-found') {
        errorMsg.textContent = "المستخدم غير موجود.";
      } else if (error.code === 'auth/wrong-password') {
        errorMsg.textContent = "كلمة المرور غير صحيحة.";
      } else if (error.code === 'auth/invalid-email') {
        errorMsg.textContent = "البريد الإلكتروني غير صحيح.";
      } else {
        errorMsg.textContent = "حدث خطأ. حاول مرة أخرى.";
      }
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = isLogin ? 'تسجيل الدخول' : 'إنشاء حساب';
    }
  });

  toggleFormBtn.addEventListener('click', () => {
    isLogin = !isLogin;
    errorMsg.textContent = '';
    
    if (isLogin) {
      formTitle.textContent = '💬 تسجيل الدخول';
      submitBtn.textContent = 'تسجيل الدخول';
      toggleFormBtn.textContent = 'إنشاء حساب جديد';
      usernameInput.style.display = 'none';
      statusInput.style.display = 'none';
    } else {
      formTitle.textContent = '📝 إنشاء حساب جديد';
      submitBtn.textContent = 'إنشاء حساب';
      toggleFormBtn.textContent = 'تسجيل الدخول';
      usernameInput.style.display = 'block';
      statusInput.style.display = 'block';
    }
  });

  // وظائف التطبيق المحسّنة للتحديث الفوري
  const renderUsersList = debounce(() => {
    const fragment = document.createDocumentFragment();
    const searchTerm = searchInput.value.toLowerCase();
    
    const filteredUsers = Array.from(usersData.values())
      .filter(user => 
        user.uid !== currentUser?.uid && 
        user.username.toLowerCase().includes(searchTerm) &&
        !blockedUsers.has(user.uid)
      )
      .sort((a, b) => {
        const aOnline = onlineUsers.has(a.uid);
        const bOnline = onlineUsers.has(b.uid);
        
        if (aOnline && !bOnline) return -1;
        if (!aOnline && bOnline) return 1;
        
        const aUnread = unreadCounts.get(a.uid) || 0;
        const bUnread = unreadCounts.get(b.uid) || 0;
        
        if (aUnread > 0 && bUnread === 0) return -1;
        if (aUnread === 0 && bUnread > 0) return 1;
        
        return 0;
      });

    if (filteredUsers.length === 0) {
      usersList.innerHTML = `
        <div class="welcome-message">
          <h3>🎉 مرحباً بك!</h3>
          <p>ابدأ محادثة جديدة مع أصدقائك</p>
        </div>
      `;
      return;
    }

    filteredUsers.forEach(user => {
      const isOnline = onlineUsers.has(user.uid);
      const unreadCount = unreadCounts.get(user.uid) || 0;
      
      const userCard = document.createElement('div');
      userCard.className = 'user-card';
      userCard.setAttribute('data-uid', user.uid);
      
      userCard.innerHTML = `
        <div class="user-avatar-container">
          <div class="user-avatar">${getUserInitials(user.username)}</div>
          <div class="online-indicator ${isOnline ? 'online' : ''}"></div>
        </div>
        <div class="user-info">
          <h4>
            ${user.username}
            ${unreadCount > 0 ? `<span class="unread-count show">${unreadCount}</span>` : ''}
          </h4>
          <div class="user-status">
            ${isOnline ? '<span class="online-text">متصل</span>' : formatLastSeen(user.lastSeen)}
          </div>
        </div>
      `;
      
      userCard.addEventListener('click', () => openChat(user));
      fragment.appendChild(userCard);
    });

    usersList.innerHTML = '';
    usersList.appendChild(fragment);
  }, 100);

  const renderMessage = (message, isNew = false) => {
    const isSent = message.senderId === currentUser.uid;
    const messageWrapper = document.createElement('div');
    messageWrapper.className = `message-wrapper ${isSent ? 'sent' : 'received'}`;
    messageWrapper.setAttribute('data-msg-id', message.id);

    const messageElement = document.createElement('div');
    messageElement.className = `message ${isSent ? 'sent' : 'received'} ${isNew ? 'new' : ''}`;
    
    let contentHTML = '';
    
    if (message.type === 'text') {
      contentHTML = `
        <div class="message-content">${message.text}</div>
        <div class="message-time">${formatTime(message.timestamp)}</div>
      `;
    } else if (message.type === 'image') {
      contentHTML = `
        <div class="message-content">
          <div class="message-media">
            <img src="${message.url}" alt="صورة" onclick="showMediaPreview('${message.url}', 'image')" />
          </div>
        </div>
        <div class="message-time">${formatTime(message.timestamp)}</div>
      `;
    } else if (message.type === 'video') {
      contentHTML = `
        <div class="message-content">
          <div class="message-media">
            <video src="${message.url}" controls onclick="showMediaPreview('${message.url}', 'video')"></video>
          </div>
        </div>
        <div class="message-time">${formatTime(message.timestamp)}</div>
      `;
    }
    
    messageElement.innerHTML = contentHTML;
    messageWrapper.appendChild(messageElement);
    messagesArea.appendChild(messageWrapper);
    
    // تمرير تلقائي للأسفل
    requestAnimationFrame(() => {
      messagesArea.scrollTop = messagesArea.scrollHeight;
    });

    // إزالة كلاس الرسالة الجديدة بعد الانيميشن
    if (isNew) {
      setTimeout(() => {
        messageElement.classList.remove('new');
      }, 500);
    }
  };

  // تحديث دالة فتح المحادثة للتحديث الفوري
  const openChat = async (user) => {
    currentChatUser = user;
    
    document.getElementById('chatUserName').textContent = user.username;
    document.getElementById('chatUserAvatar').textContent = getUserInitials(user.username);
    document.getElementById('chatUserStatus').textContent = 
      onlineUsers.has(user.uid) ? 'متصل' : formatLastSeen(user.lastSeen);
    
    const isBlocked = blockedUsers.has(user.uid);
    blockUserBtn.title = isBlocked ? 'إلغاء الحظر' : 'حظر المستخدم';
    blockUserBtn.style.opacity = isBlocked ? '0.5' : '1';
    
    showChat();
    messagesArea.innerHTML = '';
    
    const chatId = getChatId(currentUser.uid, currentChatUser.uid);
    
    try {
      // تحديث الرسائل إلى مقروءة
      const unreadQuery = query(
        collection(db, "chats", chatId, "messages"), 
        where("receiverId", "==", currentUser.uid), 
        where("read", "==", false)
      );
      
      const unreadSnapshot = await getDocs(unreadQuery);
      const updatePromises = unreadSnapshot.docs.map(msgDoc => 
        updateDoc(doc(db, "chats", chatId, "messages", msgDoc.id), { read: true })
      );
      
      await Promise.all(updatePromises);
      
      unreadCounts.set(user.uid, 0);
      renderUsersList();
      
      // الاستماع للرسائل الجديدة مع التحديث الفوري
      if (unsubscribeMessages) {
        unsubscribeMessages();
      }
      
      const messagesQuery = query(
        collection(db, "chats", chatId, "messages"), 
        orderBy("timestamp"),
        limit(50)
      );
      
      let isFirstLoad = true;
      unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
        snapshot.docChanges().forEach(change => {
          const message = { id: change.doc.id, ...change.doc.data() };
          
          if (change.type === "added") {
            const isNewMessage = !isFirstLoad;
            renderMessage(message, isNewMessage);
            
            // تشغيل صوت الإشعار للرسائل الواردة الجديدة فقط
            if (message.senderId !== currentUser.uid && isNewMessage && soundsEnabled) {
              notificationSound.play().catch(e => console.log('Sound play failed:', e));
            }
          }
        });
        
        const emptyState = messagesArea.querySelector('.empty-state');
        if (emptyState && messagesArea.children.length > 1) {
          emptyState.remove();
        }
        
        isFirstLoad = false;
      }, (error) => {
        console.error("Error listening to messages:", error);
      });
      
      listenForTyping(currentChatUser.uid);
      
    } catch (error) {
      console.error("Error opening chat:", error);
    }
  };

  // إعداد مستمع عام للرسائل الجديدة
  const setupGlobalMessageListener = () => {
    if (unsubscribeGlobalMessages) {
      unsubscribeGlobalMessages();
    }

    // مستمع لجميع المحادثات للمستخدم الحالي
    const allChatsQuery = query(
      collection(db, "chats")
    );

    unsubscribeGlobalMessages = onSnapshot(allChatsQuery, (snapshot) => {
      snapshot.docChanges().forEach(async (change) => {
        if (change.type === "added" || change.type === "modified") {
          const chatId = change.doc.id;
          
          // التحقق من أن المحادثة تخص المستخدم الحالي
          if (chatId.includes(currentUser.uid)) {
            const messagesQuery = query(
              collection(db, "chats", chatId, "messages"),
              where("receiverId", "==", currentUser.uid),
              where("read", "==", false),
              orderBy("timestamp", "desc"),
              limit(1)
            );

            const messagesSnapshot = await getDocs(messagesQuery);
            
            messagesSnapshot.forEach(messageDoc => {
              const message = messageDoc.data();
              const senderId = message.senderId;
              
              // التحقق من أن الرسالة جديدة وليست من المستخدم الحالي
              if (senderId !== currentUser.uid) {
                const sender = usersData.get(senderId);
                if (sender) {
                  // تحديث عداد الرسائل غير المقروءة
                  const currentUnread = unreadCounts.get(senderId) || 0;
                  unreadCounts.set(senderId, currentUnread + 1);
                  
                  // تحديث واجهة قائمة المستخدمين
                  const userCard = document.querySelector(`[data-uid="${senderId}"]`);
                  if (userCard) {
                    userCard.classList.add('new-message');
                    setTimeout(() => {
                      userCard.classList.remove('new-message');
                    }, 500);
                  }
                  
                  renderUsersList();
                  
                  // إظهار الإشعار إذا لم تكن المحادثة مفتوحة
                  const isInCurrentChat = currentChatUser && currentChatUser.uid === senderId;
                  if (!isInCurrentChat) {
                    showNewMessageNotification(
                      sender.username, 
                      message.text || 'صورة' || 'فيديو',
                      false
                    );
                  }
                }
              }
            });
          }
        }
      });
    }, (error) => {
      console.error("Error in global message listener:", error);
    });
  };

  const sendMessage = async (type = 'text', content = null) => {
    if (!currentChatUser) return;
    
    const messageText = messageInput.value.trim();
    if (type === 'text' && !messageText) return;
    if (type !== 'text' && !content) return;

    const chatId = getChatId(currentUser.uid, currentChatUser.uid);
    const messageData = {
      senderId: currentUser.uid,
      receiverId: currentChatUser.uid,
      type: type,
      text: type === 'text' ? messageText : '',
      url: type !== 'text' ? content : '',
      timestamp: serverTimestamp(),
      read: false
    };

    try {
      await addDoc(collection(db, "chats", chatId, "messages"), messageData);
      
      if (type === 'text') {
        messageInput.value = '';
        messageInput.style.height = 'auto';
        
        if (typingTimeout) clearTimeout(typingTimeout);
        await setDoc(doc(db, "typing", currentUser.uid), { isTyping: false }, { merge: true });
      }
    } catch (error) {
      console.error("Error sending message:", error);
    }
  };

  const handleMediaUpload = (file) => {
    if (!currentChatUser) return;
    
    const storageRef = ref(storage, `media/${currentUser.uid}/${Date.now()}_${file.name}`);
    const uploadTask = uploadBytesResumable(storageRef, file);

    const loadingWrapper = document.createElement('div');
    loadingWrapper.className = 'message-wrapper sent';
    loadingWrapper.innerHTML = `
      <div class="message sent">
        <div class="message-content">
          <div class="message-media">
            <div class="media-loading">
              <div class="loading-spinner"></div>
            </div>
          </div>
        </div>
        <div class="message-time">جاري الإرسال...</div>
      </div>
    `;
    messagesArea.appendChild(loadingWrapper);
    messagesArea.scrollTop = messagesArea.scrollHeight;
    
    uploadTask.on('state_changed',
      (snapshot) => {
        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
        console.log('Upload progress:', progress + '%');
      },
      (error) => {
        console.error("Upload failed:", error);
        loadingWrapper.remove();
      },
      () => {
        getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => {
          sendMessage(file.type.startsWith('image') ? 'image' : 'video', downloadURL);
          loadingWrapper.remove();
        });
      }
    );
  };

  const showMediaPreview = (content, type) => {
    previewMedia.innerHTML = '';
    if (type === 'image') {
      const img = document.createElement('img');
      img.src = content;
      previewMedia.appendChild(img);
    } else if (type === 'video') {
      const video = document.createElement('video');
      video.src = content;
      video.controls = true;
      previewMedia.appendChild(video);
    }
    mediaPreview.style.display = 'flex';
  };

  const handleTyping = debounce(async () => {
    if (!currentUser || !currentChatUser) return;
    
    try {
      const typingDocRef = doc(db, "typing", currentUser.uid);
      await setDoc(typingDocRef, { 
        isTyping: true, 
        chatId: getChatId(currentUser.uid, currentChatUser.uid),
        timestamp: serverTimestamp()
      }, { merge: true });

      if (typingTimeout) clearTimeout(typingTimeout);
      typingTimeout = setTimeout(async () => {
        await setDoc(typingDocRef, { isTyping: false }, { merge: true });
      }, 2000);
    } catch (error) {
      console.error("Error updating typing status:", error);
    }
  }, 300);

  const listenForTyping = (chatUserId) => {
    if (unsubscribeTyping) {
      unsubscribeTyping();
    }
    
    unsubscribeTyping = onSnapshot(doc(db, "typing", chatUserId), (docSnap) => {
      if (docSnap.exists()) {
        const data = docSnap.data();
        const isTyping = data.isTyping && data.chatId === getChatId(currentUser.uid, currentChatUser.uid);
        
        if (isTyping) {
          typingUserElement.textContent = usersData.get(chatUserId)?.username || 'الطرف الآخر';
          typingIndicator.style.display = 'block';
        } else {
          typingIndicator.style.display = 'none';
        }
      } else {
        typingIndicator.style.display = 'none';
      }
    });
  };

  // معالجة الحظر/إلغاء الحظر
  const handleBlockUser = async () => {
    if (!currentChatUser) return;
    
    const isBlocked = blockedUsers.has(currentChatUser.uid);
    
    blockModalTitle.textContent = isBlocked ? '🔓 إلغاء حظر المستخدم' : '🚫 حظر المستخدم';
    blockModalMessage.textContent = isBlocked 
      ? `هل تريد إلغاء حظر ${currentChatUser.username}؟`
      : `هل تريد حظر ${currentChatUser.username}؟`;
    
    blockModal.style.display = 'flex';
    
    confirmBlockBtn.onclick = async () => {
      try {
        const userRef = doc(db, "users", currentUser.uid);
        const userDoc = await getDoc(userRef);
        
        if (userDoc.exists()) {
          let blockedUsersList = userDoc.data().blockedUsers || [];
          
          if (isBlocked) {
            blockedUsersList = blockedUsersList.filter(uid => uid !== currentChatUser.uid);
            blockedUsers.delete(currentChatUser.uid);
          } else {
            if (!blockedUsersList.includes(currentChatUser.uid)) {
              blockedUsersList.push(currentChatUser.uid);
              blockedUsers.add(currentChatUser.uid);
            }
          }
          
          await updateDoc(userRef, { blockedUsers: blockedUsersList });
          
          blockUserBtn.title = blockedUsers.has(currentChatUser.uid) ? 'إلغاء الحظر' : 'حظر المستخدم';
          blockUserBtn.style.opacity = blockedUsers.has(currentChatUser.uid) ? '0.5' : '1';
          
          renderUsersList();
        }
        
        blockModal.style.display = 'none';
      } catch (error) {
        console.error("Error updating block status:", error);
      }
    };
  };

  // وظائف Firebase محسّنة للتحديث الفوري
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      showApp();

      // طلب إذن الإشعارات
      await requestNotificationPermission();

      try {
        const userRef = doc(db, "users", currentUser.uid);
        await setDoc(userRef, { 
          isOnline: true, 
          lastActive: serverTimestamp() 
        }, { merge: true });

        const handleDisconnect = async () => {
          await updateDoc(userRef, { 
            isOnline: false, 
            lastSeen: serverTimestamp() 
          });
        };

        window.addEventListener('beforeunload', handleDisconnect);
        window.addEventListener('pagehide', handleDisconnect);

        const userDoc = await getDoc(userRef);
        if (userDoc.exists()) {
          const userData = userDoc.data();
          usersData.set(currentUser.uid, userData);
          document.getElementById('currentUsername').textContent = userData.username;
          document.getElementById('currentUserStatus').textContent = userData.status || 'متاح';
          blockedUsers = new Set(userData.blockedUsers || []);
        }

        // إعداد مستمع المستخدمين مع التحديث الفوري
        if (unsubscribeUsers) {
          unsubscribeUsers();
        }

        unsubscribeUsers = onSnapshot(collection(db, "users"), async (snapshot) => {
          onlineUsers.clear();
          
          snapshot.docs.forEach(doc => {
            const userData = { uid: doc.id, ...doc.data() };
            usersData.set(userData.uid, userData);
            
            if (userData.isOnline) {
              onlineUsers.add(userData.uid);
            }
          });

          // حساب الرسائل غير المقروءة
          const unreadPromises = Array.from(usersData.keys())
            .filter(uid => uid !== currentUser.uid)
            .map(async (uid) => {
              const chatId = getChatId(currentUser.uid, uid);
              const unreadQuery = query(
                collection(db, "chats", chatId, "messages"), 
                where("receiverId", "==", currentUser.uid), 
                where("read", "==", false)
              );
              
              try {
                const snapshot = await getDocs(unreadQuery);
                unreadCounts.set(uid, snapshot.size);
              } catch (error) {
                console.error(`Error fetching unread count for ${uid}:`, error);
                unreadCounts.set(uid, 0);
              }
            });

          await Promise.all(unreadPromises);
          
          usersCountElement.textContent = `${onlineUsers.size} متصل / ${snapshot.size} مستخدم`;
          renderUsersList();
        }, (error) => {
          console.error("Error listening to users:", error);
        });

        // إعداد مستمع الرسائل العام
        setupGlobalMessageListener();
        
      } catch (error) {
        console.error("Error setting up user session:", error);
      }
    } else {
      currentUser = null;
      showAuth();
      
      // تنظيف الاشتراكات
      if (unsubscribeUsers) {
        unsubscribeUsers();
        unsubscribeUsers = null;
      }
      if (unsubscribeMessages) {
        unsubscribeMessages();
        unsubscribeMessages = null;
      }
      if (unsubscribeTyping) {
        unsubscribeTyping();
        unsubscribeTyping = null;
      }
      if (unsubscribeGlobalMessages) {
        unsubscribeGlobalMessages();
        unsubscribeGlobalMessages = null;
      }
      
      // تنظيف البيانات
      usersData.clear();
      unreadCounts.clear();
      blockedUsers.clear();
      onlineUsers.clear();
    }
  });

  // Event Listeners محسّنة
  searchInput.addEventListener('input', renderUsersList);

  sendBtn.addEventListener('click', () => sendMessage());

  messageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  messageInput.addEventListener('input', () => {
    handleTyping();
    
    messageInput.style.height = 'auto';
    messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
  });

  backBtn.addEventListener('click', showUsersList);

  menuBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    dropdownMenu.style.display = dropdownMenu.style.display === 'flex' ? 'none' : 'flex';
  });

  document.addEventListener('click', (e) => {
    if (!menuBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
      dropdownMenu.style.display = 'none';
    }
  });

  blockUserBtn.addEventListener('click', handleBlockUser);

  // وظائف الوسائط
  galleryBtn.addEventListener('click', () => imageInput.click());
  videoBtn.addEventListener('click', () => videoInput.click());
  cameraBtn.addEventListener('click', () => cameraInput.click());

  imageInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) handleMediaUpload(file);
    e.target.value = '';
  });

  videoInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) handleMediaUpload(file);
    e.target.value = '';
  });

  cameraInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) handleMediaUpload(file);
    e.target.value = '';
  });

  // معالجة معاينة الوسائط
  cancelMediaBtn.addEventListener('click', () => {
    mediaPreview.style.display = 'none';
  });

  mediaPreview.addEventListener('click', (e) => {
    if (e.target === mediaPreview) {
      mediaPreview.style.display = 'none';
    }
  });

  // وظائف القوائم والمودالات
  editProfileBtn.addEventListener('click', () => {
    dropdownMenu.style.display = 'none';
    const userData = usersData.get(currentUser.uid);
    editUsername.value = userData?.username || '';
    editStatus.value = userData?.status || '';
    editProfileModal.style.display = 'flex';
  });

  saveProfileBtn.addEventListener('click', async () => {
    const newUsername = editUsername.value.trim();
    const newStatus = editStatus.value.trim();
    
    if (newUsername && currentUser) {
      try {
        await updateDoc(doc(db, "users", currentUser.uid), {
          username: newUsername,
          status: newStatus
        });
        
        document.getElementById('currentUsername').textContent = newUsername;
        document.getElementById('currentUserStatus').textContent = newStatus;
        editProfileModal.style.display = 'none';
      } catch (error) {
        console.error("Error updating profile:", error);
      }
    }
  });

  cancelProfileBtn.addEventListener('click', () => {
    editProfileModal.style.display = 'none';
  });

  notificationSettingsBtn.addEventListener('click', () => {
    dropdownMenu.style.display = 'none';
    enableNotifications.checked = notificationsEnabled;
    enableSounds.checked = soundsEnabled;
    notificationModal.style.display = 'flex';
  });

  saveNotificationBtn.addEventListener('click', () => {
    notificationsEnabled = enableNotifications.checked;
    soundsEnabled = enableSounds.checked;
    localStorage.setItem('notificationsEnabled', notificationsEnabled);
    localStorage.setItem('soundsEnabled', soundsEnabled);
    notificationModal.style.display = 'none';
  });

  cancelNotificationBtn.addEventListener('click', () => {
    notificationModal.style.display = 'none';
  });

  logoutBtn.addEventListener('click', async () => {
    dropdownMenu.style.display = 'none';
    try {
      if (currentUser) {
        await updateDoc(doc(db, "users", currentUser.uid), { 
          isOnline: false, 
          lastSeen: serverTimestamp() 
        });
        await signOut(auth);
      }
    } catch (error) {
      console.error("Error during logout:", error);
    }
  });

  welcomeModalOkBtn.addEventListener('click', () => {
    welcomeModal.style.display = 'none';
  });

  cancelBlockBtn.addEventListener('click', () => {
    blockModal.style.display = 'none';
  });

  // إغلاق المودالات عند الضغط خارجها
  [editProfileModal, notificationModal, welcomeModal, blockModal].forEach(modal => {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    });
  });

  // إعداد Service Worker للعمل دون اتصال
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')
        .then((registration) => {
          console.log('SW registered: ', registration);
        })
        .catch((registrationError) => {
          console.log('SW registration failed: ', registrationError);
        });
    });
  }

  // جعل الدوال متاحة عالمياً للاستخدام في HTML
  window.showMediaPreview = showMediaPreview;

</script>
</body>
</html>
