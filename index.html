<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>دردشة فورية</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      direction: rtl;
      text-align: right;
      margin: 0; padding: 0; background: #f0f0f0;
      display: flex; justify-content: center; align-items: flex-start; height: 100vh;
    }
    #authContainer, #app {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    #authContainer {
      width: 350px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    #app {
      display: none;
      height: calc(100vh - 70px);
      width: 900px;
      flex-direction: row;
      gap: 15px;
    }
    input, button {
      padding: 10px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
      outline: none;
      box-sizing: border-box;
      width: 100%;
    }
    button {
      cursor: pointer;
      background: #6a11cb;
      color: white;
      border: none;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #4a07a0;
    }
    #errorMsg {
      color: red;
      min-height: 20px;
    }
    #username, #status {
      display: none;
    }
    /* المحادثات */
    #conversationsList {
      width: 150px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 5px;
      overflow-y: auto;
      height: 100%;
      padding: 10px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }
    #searchInput {
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 16px;
      box-sizing: border-box;
      width: 100%;
    }
    .conversation {
      padding: 1px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      position: relative;
      user-select: none;
    }
    .conversation:hover {
      background-color: #f7f7f7;
    }
    .unread-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      background: red;
      color: white;
      border-radius: 50%;
      font-size: 12px;
      padding: 2px 7px;
      display: none;
    }
    /* نافذة المحادثة */
    #chatWindow {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 5px;
      height: 100%;
      
    }
    #chatHeader {
      padding: 15px;
      font-weight: bold;
      border-bottom: 1px solid #ddd;
      background: #6a11cb;
      color: white;
      font-size: 18px;
    }
    #messages {
      flex-grow: 1;
      padding: 10px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: #f9f9f9;
    }
    .message {
      max-width: 100%;
      padding: 10px;
      border-radius: 10px;
      position: relative;
      word-wrap: break-word;
      
    }
    .sent {
      background-color: #dcf8c6;
      align-self: flex-end;
    }
    .received {
      background-color: #fff;
      align-self: flex-start;
      border: 1px solid #ddd;
    }
    .time {
      font-size: 10px;
      color: gray;
      margin-top: 4px;
      text-align: left;
    }
    #inputArea {
      display: flex;
      padding: 10px;
      border-top: 1px solid #ddd;
      gap: 10px;
      background: #fff;
    }
    #inputArea input {
      flex-grow: 1;
    }
    #logoutBtn, #deleteAccountBtn {
      background: #b22222;
      margin-top: 10px;
    }
    #logoutBtn:hover, #deleteAccountBtn:hover {
      background: #7a1616;
    }
    /* زر القائمة المنسدلة */
    #menuBar {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 50px;
      padding: 10px 15px;
      background: #6a11cb;
      color: white;
      font-weight: bold;
      border-radius: 5px 5px 0 0;
      height: 50px;
    }
    #menuBtn {
      background: #6a11cb;
      color: white;
      border: none;
      padding: 6px;
      font-size: 20px;
      border-radius: 50px;
      cursor: pointer;
      height: 40px;
      width: 40px;
      flex-grow: 0;
      flex-shrink: 0;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #usernameDisplay {
      user-select: none;
      font-size: 18px;
      margin-left: 10px;
    }
    #dropdownMenu {
      position: fixed;
      top: 50px;
      right: 15px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      display: none;
      flex-direction: column;
      min-width: 180px;
      z-index: 1001;
    }
    #dropdownMenu button {
      color: #e74c3c;
      background: transparent;
      border: none;
      padding: 10px 15px;
      text-align: right;
      direction: rtl;
      font-weight: 700;
      font-family: 'Arial Black', Arial, sans-serif;
      width: 100%;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s, color 0.3s;
      border-radius: 0;
    }
    #dropdownMenu button:hover {
      background-color: #f0f0f0;
      color: #c0392b;
    }

    /* مودال تعديل بيانات المستخدم */
    #editProfileModal {
      display:none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    #editProfileModal > div {
      background: white;
      border-radius: 8px;
      padding: 20px;
      width: 320px;
      box-sizing: border-box;
      position: relative;
    }
    #editProfileModal h3 {
      margin-top: 0;
      margin-bottom: 15px;
      text-align: center;
    }
    #editProfileModal label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    #editProfileModal input {
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
      box-sizing: border-box;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    #editProfileModal button {
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    #saveProfileBtn {
      background:#6a11cb;
      color:white;
      margin-right: 10px;
    }
    #saveProfileBtn:hover {
      background:#4a07a0;
    }
    #cancelProfileBtn {
      background:#ccc;
      color:#333;
    }
    #cancelProfileBtn:hover {
      background:#999;
      color:#fff;
    }
  </style>
</head>
<body>

<!-- قسم تسجيل الدخول / إنشاء حساب -->
<div id="authContainer">
  <h2 id="formTitle">تسجيل الدخول</h2>
  <input type="email" id="email" placeholder="البريد الإلكتروني" />
  <input type="password" id="password" placeholder="كلمة المرور" />
  <input type="text" id="username" placeholder="الاسم" />
  <input type="text" id="status" placeholder="الحالة (اختياري)" />
  <div id="errorMsg"></div>
  <button id="submitBtn">تسجيل الدخول</button>
  <button id="toggleFormBtn">إنشاء حساب جديد</button>
</div>

<!-- قسم التطبيق (المحادثات والرسائل) -->
<div id="app">
  <div style="display: flex; flex-direction: column; width: 150px; height: 100%;">
    <div id="menuBar">
      <button id="menuBtn">☰</button>
      <div id="usernameDisplay"></div>
    </div>
    <div id="conversationsList">
      <input type="text" id="searchInput" placeholder="ابحث عن مستخدم..." />
      <!-- قائمة المحادثات -->
    </div>
  </div>

  <div id="chatWindow">
    <div id="chatHeader">اختر محادثة</div>
    <div id="messages"></div>
    <div id="inputArea" style="display:none;">
      <input type="text" id="messageInput" placeholder="اكتب رسالة..." />
      <button id="sendBtn">إرسال</button>
    </div>
  </div>

  <div id="dropdownMenu" role="menu" aria-hidden="true" aria-labelledby="menuBtn">
    <button id="editProfileBtn" role="menuitem">تعديل بيانات المستخدم</button>
    <button id="logoutMenuBtn" role="menuitem">تسجيل الخروج</button>
    <button id="deleteAccountMenuBtn" role="menuitem">حذف الحساب</button>
    <button id="aboutAppBtn" role="menuitem">عن التطبيق</button>
  </div>
</div>

<!-- نافذة تعديل بيانات المستخدم -->
<div id="editProfileModal">
  <div>
    <h3>تعديل بيانات المستخدم</h3>
    <label for="editEmail">البريد الإلكتروني (غير قابل للتعديل):</label>
    <input type="email" id="editEmail" disabled />
    
    <label for="editUsername">اسم المستخدم:</label>
    <input type="text" id="editUsername" />
    
    <label for="editStatus">الحالة:</label>
    <input type="text" id="editStatus" />
    
    <div style="text-align: center;">
      <button id="saveProfileBtn">حفظ</button>
      <button id="cancelProfileBtn">إلغاء</button>
    </div>
  </div>
</div>

<!-- صوت الإشعارات -->
<audio id="notificationSound" src="https://raw.githubusercontent.com/T772299420/-/main/Sms.mp3" preload="auto"></audio>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, deleteUser } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, getDocs, doc, setDoc, deleteDoc, where, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAm0hh9I6i58ywW1D2gZg09liG-wG-tBsU",
    authDomain: "chat-fat-4f082.firebaseapp.com",
    projectId: "chat-fat-4f082",
    storageBucket: "chat-fat-4f082.appspot.com",
    messagingSenderId: "297367474930",
    appId: "1:297367474930:web:a05b983e05a0ba257fb66b",
    measurementId: "G-MBGC7KZ8H0"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // عناصر الصفحة
  const authContainer = document.getElementById('authContainer');
  const appDiv = document.getElementById('app');
  const formTitle = document.getElementById('formTitle');
  const submitBtn = document.getElementById('submitBtn');
  const toggleFormBtn = document.getElementById('toggleFormBtn');
  const errorMsg = document.getElementById('errorMsg');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const usernameInput = document.getElementById('username');
  const statusInput = document.getElementById('status');
  const conversationsList = document.getElementById('conversationsList');
  const chatHeader = document.getElementById('chatHeader');
  const messagesDiv = document.getElementById('messages');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const inputArea = document.getElementById('inputArea');
  const menuBtn = document.getElementById('menuBtn');
  const dropdownMenu = document.getElementById('dropdownMenu');
  const usernameDisplay = document.getElementById('usernameDisplay');
  const editProfileBtn = document.getElementById('editProfileBtn');
  const logoutMenuBtn = document.getElementById('logoutMenuBtn');
  const deleteAccountMenuBtn = document.getElementById('deleteAccountMenuBtn');
  const aboutAppBtn = document.getElementById('aboutAppBtn');
  const searchInput = document.getElementById('searchInput');

  // مودال تعديل الملف الشخصي
  const editProfileModal = document.getElementById('editProfileModal');
  const editEmailInput = document.getElementById('editEmail');
  const editUsernameInput = document.getElementById('editUsername');
  const editStatusInput = document.getElementById('editStatus');
  const saveProfileBtn = document.getElementById('saveProfileBtn');
  const cancelProfileBtn = document.getElementById('cancelProfileBtn');

  let isLogin = true;
  let currentChatEmail = null;
  let currentChatUserData = null;
  let unsubscribeMessages = null;
  const unreadCounts = new Map();

  // متغير لمتابعة آخر رسالة لتشغيل صوت الإشعار مرة واحدة فقط
  let lastMessageId = null;

  // عنصر صوت الإشعارات
  const notificationSound = document.getElementById('notificationSound');

  // تبديل بين تسجيل الدخول وإنشاء حساب
  toggleFormBtn.addEventListener('click', () => {
    isLogin = !isLogin;
    errorMsg.textContent = '';
    if (isLogin) {
      formTitle.textContent = 'تسجيل الدخول';
      submitBtn.textContent = 'تسجيل الدخول';
      toggleFormBtn.textContent = 'إنشاء حساب جديد';
      usernameInput.style.display = 'none';
      statusInput.style.display = 'none';
    } else {
      formTitle.textContent = 'إنشاء حساب جديد';
      submitBtn.textContent = 'إنشاء حساب';
      toggleFormBtn.textContent = 'لدي حساب بالفعل';
      usernameInput.style.display = 'block';
      statusInput.style.display = 'block';
    }
  });

  // تسجيل الدخول أو إنشاء الحساب
  submitBtn.addEventListener('click', async () => {
    errorMsg.textContent = '';
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    const username = usernameInput.value.trim();
    const status = statusInput.value.trim() || "مرحباً!";

    if (!email || !password || (!isLogin && !username)) {
      errorMsg.textContent = 'يرجى تعبئة جميع الحقول المطلوبة.';
      return;
    }

    try {
      if (isLogin) {
        await signInWithEmailAndPassword(auth, email, password);
      } else {
        await createUserWithEmailAndPassword(auth, email, password);
        const user = auth.currentUser;
        if (user) {
          const userDocRef = doc(db, "users", user.uid);
          await setDoc(userDocRef, {
            email: user.email,
            username,
            status,
            photoURL: `https://ui-avatars.com/api/?name=${encodeURIComponent(username)}&background=6a11cb&color=fff&rounded=true&size=128`,
          });
        }
        alert('تم إنشاء الحساب بنجاح!');
      }
    } catch (e) {
      errorMsg.textContent = e.message;
    }
  });

  // حالة الدخول
  onAuthStateChanged(auth, async user => {
    if (user) {
      authContainer.style.display = 'none';
      appDiv.style.display = 'flex';
      await loadConversations();
      listenUnreadMessages();

      // عرض اسم المستخدم في الشريط العلوي
      const userDoc = await getDocs(query(collection(db, "users"), where("email", "==", user.email)));
      userDoc.forEach(docSnap => {
        const data = docSnap.data();
        usernameDisplay.textContent = data.username || user.email;
      });

    } else {
      authContainer.style.display = 'flex';
      appDiv.style.display = 'none';
      clearChat();
      if (unsubscribeMessages) unsubscribeMessages();
      usernameDisplay.textContent = '';
      dropdownMenu.style.display = 'none';
      searchInput.value = '';
      unreadCounts.clear();
      lastMessageId = null;
    }
  });

  // تحميل قائمة المحادثات (كل المستخدمين ما عدا المستخدم الحالي)
  async function loadConversations() {
    conversationsList.querySelectorAll('.conversation').forEach(c => c.remove());
    const usersSnapshot = await getDocs(collection(db, "users"));
    const currentUser = auth.currentUser;
    usersSnapshot.forEach(docSnap => {
      const userData = docSnap.data();
      if (userData.email !== currentUser.email) {
        addConversationToList(userData);
      }
    });
  }

  // إضافة محادثة لقائمة المحادثات
  function addConversationToList(userData) {
    const convDiv = document.createElement('div');
    convDiv.classList.add('conversation');
    convDiv.textContent = userData.username || userData.email;
    convDiv.title = userData.status || "";
    convDiv.dataset.email = userData.email;

    // شارة عدد الرسائل غير المقروءة
    const badge = document.createElement('span');
    badge.classList.add('unread-badge');
    convDiv.appendChild(badge);

    convDiv.addEventListener('click', () => {
      openChat(userData.email, userData);
    });

    conversationsList.appendChild(convDiv);
  }

  // فتح محادثة
  async function openChat(email, userData) {
    currentChatEmail = email;
    currentChatUserData = userData;
    chatHeader.textContent = userData.username || email;
    messagesDiv.innerHTML = '';
    inputArea.style.display = 'flex';
    clearUnreadCount(email);

    if (unsubscribeMessages) unsubscribeMessages();

    // استماع للرسائل بين المستخدم الحالي والمختار
    const currentUserEmail = auth.currentUser.email;
    const messagesRef = collection(db, "messages");
    const messagesQuery = query(messagesRef,
      orderBy("timestamp"));

    unsubscribeMessages = onSnapshot(messagesQuery, snapshot => {
      messagesDiv.innerHTML = '';
      snapshot.forEach(docSnap => {
        const msg = docSnap.data();
        if (
          (msg.from === currentUserEmail && msg.to === email) ||
          (msg.from === email && msg.to === currentUserEmail)
        ) {
          appendMessage(msg);
        } else if (msg.to === currentUserEmail && msg.from === email && !msg.read) {
          // وسم الرسالة كمقروءة
          markMessageAsRead(docSnap.id);
        }
      });
      scrollMessagesToBottom();
    });
  }

  // إظهار رسالة في نافذة الدردشة
  function appendMessage(msg) {
    const div = document.createElement('div');
    div.classList.add('message');
    div.classList.add(msg.from === auth.currentUser.email ? 'sent' : 'received');
    div.textContent = msg.text;

    const timeSpan = document.createElement('div');
    timeSpan.classList.add('time');
    const date = msg.timestamp ? msg.timestamp.toDate() : new Date();
    timeSpan.textContent = date.toLocaleTimeString('ar-EG', {hour: '2-digit', minute: '2-digit'});

    div.appendChild(timeSpan);
    messagesDiv.appendChild(div);

    // تشغيل صوت الإشعار للرسائل المستلمة الجديدة فقط
    if (msg.from !== auth.currentUser.email && doc.id !== lastMessageId) {
      notificationSound.play();
      lastMessageId = doc.id;
    }
  }

  // التمرير لنهاية الرسائل تلقائيًا
  function scrollMessagesToBottom() {
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  // إرسال رسالة جديدة
  sendBtn.addEventListener('click', async () => {
    const text = messageInput.value.trim();
    if (!text || !currentChatEmail) return;
    const currentUserEmail = auth.currentUser.email;
    try {
      await addDoc(collection(db, "messages"), {
        from: currentUserEmail,
        to: currentChatEmail,
        text,
        timestamp: serverTimestamp(),
        read: false,
      });
      messageInput.value = '';
    } catch (e) {
      alert('حدث خطأ أثناء إرسال الرسالة.');
    }
  });

  // علامة الرسالة كمقروءة
  async function markMessageAsRead(messageId) {
    const msgDoc = doc(db, "messages", messageId);
    await setDoc(msgDoc, { read: true }, { merge: true });
    clearUnreadCount(currentChatEmail);
  }

  // الاستماع للرسائل غير المقروءة لتحديث شارات التنبيه
  function listenUnreadMessages() {
    const currentUserEmail = auth.currentUser.email;
    const messagesRef = collection(db, "messages");
    const unreadQuery = query(messagesRef, where("to", "==", currentUserEmail), where("read", "==", false));

    onSnapshot(unreadQuery, snapshot => {
      // تحديث عداد الرسائل لكل محادثة
      const counts = {};
      snapshot.forEach(docSnap => {
        const msg = docSnap.data();
        counts[msg.from] = (counts[msg.from] || 0) + 1;
      });

      // تحديث الواجهة
      document.querySelectorAll('.conversation').forEach(conv => {
        const email = conv.dataset.email;
        const badge = conv.querySelector('.unread-badge');
        if (counts[email]) {
          badge.textContent = counts[email];
          badge.style.display = 'inline-block';
        } else {
          badge.style.display = 'none';
        }
      });
    });
  }

  // مسح عداد الرسائل غير المقروءة
  function clearUnreadCount(email) {
    const convDiv = [...conversationsList.children].find(c => c.dataset.email === email);
    if (!convDiv) return;
    const badge = convDiv.querySelector('.unread-badge');
    badge.style.display = 'none';
  }

  // مسح المحادثة عند تسجيل الخروج
  function clearChat() {
    messagesDiv.innerHTML = '';
    chatHeader.textContent = 'اختر محادثة';
    inputArea.style.display = 'none';
    currentChatEmail = null;
    currentChatUserData = null;
  }

  // زر القائمة العلوية
  menuBtn.addEventListener('click', () => {
    if (dropdownMenu.style.display === 'flex') {
      dropdownMenu.style.display = 'none';
      dropdownMenu.setAttribute('aria-hidden', 'true');
    } else {
      dropdownMenu.style.display = 'flex';
      dropdownMenu.setAttribute('aria-hidden', 'false');
    }
  });

  // إغلاق القائمة عند النقر خارجها
  document.addEventListener('click', e => {
    if (!menuBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
      dropdownMenu.style.display = 'none';
      dropdownMenu.setAttribute('aria-hidden', 'true');
    }
  });

  // زر تسجيل الخروج
  logoutMenuBtn.addEventListener('click', async () => {
    await signOut(auth);
  });

  // زر حذف الحساب
  deleteAccountMenuBtn.addEventListener('click', async () => {
    if (!confirm('هل أنت متأكد من حذف حسابك؟ هذا الإجراء لا يمكن التراجع عنه.')) return;
    const user = auth.currentUser;
    if (user) {
      try {
        // حذف بيانات المستخدم من Firestore
        await deleteDoc(doc(db, "users", user.uid));
        // حذف حساب Firebase Authentication
        await deleteUser(user);
        alert('تم حذف الحساب بنجاح.');
      } catch (e) {
        alert('حدث خطأ أثناء حذف الحساب. حاول تسجيل الخروج وإعادة الدخول.');
      }
    }
  });

  // زر تعديل بيانات المستخدم
  editProfileBtn.addEventListener('click', async () => {
    const user = auth.currentUser;
    if (!user) return;

    const userDocRef = doc(db, "users", user.uid);
    const userDocSnap = await getDoc(userDocRef);
    if (userDocSnap.exists()) {
      const data = userDocSnap.data();
      editEmailInput.value = user.email;
      editUsernameInput.value = data.username || '';
      editStatusInput.value = data.status || '';
      editProfileModal.style.display = 'flex';
    }
  });

  // حفظ تعديل البيانات
  saveProfileBtn.addEventListener('click', async () => {
    const newUsername = editUsernameInput.value.trim();
    const newStatus = editStatusInput.value.trim();

    if (!newUsername) {
      alert('الرجاء إدخال اسم المستخدم.');
      return;
    }

    const user = auth.currentUser;
    if (!user) return;

    try {
      const userDocRef = doc(db, "users", user.uid);
      await setDoc(userDocRef, {
        username: newUsername,
        status: newStatus,
        photoURL: `https://ui-avatars.com/api/?name=${encodeURIComponent(newUsername)}&background=6a11cb&color=fff&rounded=true&size=128`
      }, { merge: true });

      usernameDisplay.textContent = newUsername;

      // تحديث قائمة المحادثات
      await loadConversations();

      editProfileModal.style.display = 'none';
    } catch (e) {
      alert('حدث خطأ أثناء حفظ البيانات.');
    }
  });

  // إلغاء تعديل البيانات
  cancelProfileBtn.addEventListener('click', () => {
    editProfileModal.style.display = 'none';
  });

  // زر "عن التطبيق"
  aboutAppBtn.addEventListener('click', () => {
    alert('تطبيق دردشة فورية مبني باستخدام Firebase وJavaScript.\n\nتم تطويره لمروان.');
  });

  // البحث في قائمة المحادثات
  searchInput.addEventListener('input', () => {
    const filter = searchInput.value.toLowerCase();
    document.querySelectorAll('.conversation').forEach(conv => {
      const text = conv.textContent.toLowerCase();
      if (text.includes(filter)) {
        conv.style.display = 'block';
      } else {
        conv.style.display = 'none';
      }
    });
  });

</script>

</body>
  </html>

