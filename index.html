<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ğŸ’¬ ChatPro - Ø¯Ø±Ø¯Ø´Ø© ÙÙˆØ±ÙŠØ© Ù…Ø­Ø³Ù†Ø©</title>
  <link rel="manifest" href="data:application/json;base64,ewibmFtZSI6ImNoYXRwcm8iLCJzaG9ydF9uYW1lIjoiY2hhdHBybyIsInN0YXJ0X3VybCI6Ii9pbmRleC5odG1sIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzY4Nzk5NSIsInRoZW1lX2NvbG9yIjoiIzY4Nzk5NSIsInByZWZlcnJlZF9kaXNwbGF5X21vZGUiOiJzdGFuZGFsb25lIiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vd3d3LmZhYmVsLnBhaW50L2ljb24vMjU2eDI1Ni9jaGF0cHJvLnBuZyIsInNpemVzIjoiMjU2eDI1NiIsInR5cGUiOiJpbWFnZS9wbmciLCJwdXJwb3NlcyI6ImFueSBtYXNrYWJsZSJ9XX0=">
  
  <style>
    /* Ù…ØªØºÙŠØ±Ø§Øª CSS Ù…Ø­Ø³Ù†Ø© */
    :root {
      --whatsapp-green: #25d366;
      --whatsapp-dark-green: #128c7e;
      --whatsapp-light-green: #dcf8c6;
      --whatsapp-blue: #34b7f1;
      --whatsapp-gray: #f7f7f7;
      --whatsapp-dark-gray: #8696a0;
      --whatsapp-bg: #e5ddd5;
      --message-sent: #dcf8c6;
      --message-received: #ffffff;
      --shadow: rgba(0,0,0,0.1);
      --notification-red: #ff4444; /* Ø´Ø§Ø±Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø­Ù…Ø±Ø§Ø¡ */
      --safe-area-top: env(safe-area-inset-top, 0px);
    }

    /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© Ù…Ø­Ø³Ù†Ø© */
    html, body {
      height: 100vh;
      margin: 0;
      padding: 0;
      overflow: hidden;
      padding-top: var(--safe-area-top); /* Ø¯Ø¹Ù… Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø°Ø§Øª Ø§Ù„Ù†ÙˆØªØ´ */
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      direction: rtl;
      background: var(--whatsapp-bg);
      font-size: 14px;
      /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ */
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
    #authContainer, #app { display: none; }

    /* Ø´Ø§Ø´Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø© */
    #authContainer {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 2.5rem;
      border-radius: 16px;
      box-shadow: 0 12px 40px var(--shadow);
      width: min(380px, 92vw);
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translate(-50%, -60%); }
      to { opacity: 1; transform: translate(-50%, -50%); }
    }

    #authContainer h2 {
      text-align: center;
      margin-bottom: 2rem;
      color: var(--whatsapp-dark-green);
      font-size: 1.6rem;
      font-weight: 700;
    }

    /* Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ù…Ø­Ø³Ù†Ø© */
    input, button, textarea {
      width: 100%;
      padding: 14px 18px;
      margin: 10px 0;
      border: 2px solid #e1e5e9;
      border-radius: 12px;
      font-size: 15px;
      font-family: inherit;
      transition: all 0.3s ease;
    }

    input:focus, textarea:focus {
      border-color: var(--whatsapp-green);
      outline: none;
      box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.1);
      transform: translateY(-1px);
    }

    button {
      background: linear-gradient(135deg, var(--whatsapp-green), var(--whatsapp-dark-green));
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(37, 211, 102, 0.3);
    }

    button:active { transform: translateY(0); }

    #toggleFormBtn {
      background: transparent;
      color: var(--whatsapp-green);
      border: 2px solid var(--whatsapp-green);
    }

    #toggleFormBtn:hover {
      background: var(--whatsapp-green);
      color: white;
    }

    #errorMsg {
      color: #e74c3c;
      text-align: center;
      min-height: 24px;
      font-size: 13px;
      margin: 12px 0;
      padding: 8px;
      border-radius: 8px;
      background: rgba(231, 76, 60, 0.1);
      border: 1px solid rgba(231, 76, 60, 0.2);
    }

    /* Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: white;
    }

    /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø§Ù„Ù…Ø­Ø³Ù† */
    #appHeader {
      background: linear-gradient(135deg, var(--whatsapp-dark-green), #0d7377);
      color: white;
      padding: 18px 20px; /* Ø´Ø±ÙŠØ· Ø£Ø¹Ø±Ø¶ */
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      min-height: 75px; /* Ø§Ø±ØªÙØ§Ø¹ Ø£ÙƒØ¨Ø± */
      position: relative;
      z-index: 100;
    }

    #appLogoContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    #appLogo {
      font-size: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Ù…ÙƒØ§Ù† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø®ØµØµØ© */
    #appLogo img {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      object-fit: cover;
    }

    #usersCount {
      font-size: 12px;
      opacity: 0.9;
      font-weight: 500;
    }

    #userInfo {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    #userDetails {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 2px;
    }

    #currentUsername {
      font-weight: 600;
      font-size: 15px;
    }

    #currentUserStatus {
      font-size: 12px;
      opacity: 0.85;
    }

    #menuBtn {
      background: rgba(255,255,255,0.15);
      border: none;
      color: white;
      padding: 10px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      width: 42px;
      height: 42px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    #menuBtn:hover {
      background: rgba(255,255,255,0.25);
      transform: scale(1.05);
    }

    /* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
    #mainContent {
      display: flex;
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø³Ù†Ø© */
    #usersListContainer {
      width: 100%;
      background: white;
      display: flex;
      flex-direction: column;
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      z-index: 150;
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    #usersListContainer.hidden {
      transform: translateX(100%);
    }

    /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø­Ø³Ù† ÙˆØ§Ù„Ø£Ø¹Ø±Ø¶ */
    #searchContainer {
      padding: 16px 20px; /* Ø­Ø§ÙˆÙŠØ© Ø£Ø¹Ø±Ø¶ */
      background: linear-gradient(135deg, var(--whatsapp-gray), #f0f4f7);
      border-bottom: 1px solid #e1e8ed;
    }

    #searchInput {
      width: 100%;
      padding: 14px 20px; /* Ø´Ø±ÙŠØ· Ø¨Ø­Ø« Ø£Ø¹Ø±Ø¶ */
      border: 2px solid #e1e8ed;
      border-radius: 25px; /* Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ø±ÙŠ Ø£ÙƒØ«Ø± */
      font-size: 15px;
      background: white;
      margin: 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      transition: all 0.3s ease;
    }

    #searchInput:focus {
      border-color: var(--whatsapp-green);
      box-shadow: 0 4px 20px rgba(37, 211, 102, 0.15);
      transform: translateY(-1px);
    }

    #searchInput::placeholder {
      color: var(--whatsapp-dark-gray);
      font-weight: 400;
    }

    #usersList {
      flex: 1;
      overflow-y: auto;
      background: white;
      scroll-behavior: smooth;
    }

    /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø³Ù†Ø© */
    .user-card {
      padding: 14px 18px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 14px;
      border-bottom: 1px solid rgba(0,0,0,0.05);
      position: relative;
      contain: layout;
    }

    .user-card:hover {
      background: linear-gradient(135deg, var(--whatsapp-gray), #f8fafc);
      transform: translateX(-3px);
    }

    .user-card.blocked {
      opacity: 0.6;
      background: linear-gradient(135deg, #ffebee, #fce4ec);
    }

    .user-card.new-message {
      animation: newMessagePulse 0.6s ease-in-out;
    }

    @keyframes newMessagePulse {
      0% { background: rgba(255, 68, 68, 0.1); transform: scale(1); }
      50% { background: rgba(255, 68, 68, 0.2); transform: scale(1.02); }
      100% { background: white; transform: scale(1); }
    }

    .user-avatar-container {
      position: relative;
      min-width: 52px;
    }

    .user-avatar {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--whatsapp-green), var(--whatsapp-dark-green));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 20px;
      box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
    }

    .online-indicator {
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 14px;
      height: 14px;
      background: var(--whatsapp-green);
      border: 3px solid white;
      border-radius: 50%;
      display: none;
      box-shadow: 0 2px 8px rgba(37, 211, 102, 0.4);
    }

    .online-indicator.online {
      display: block;
      animation: onlinePulse 2s infinite;
    }

    @keyframes onlinePulse {
      0% { box-shadow: 0 0 0 0 rgba(37, 211, 102, 0.7); }
      70% { box-shadow: 0 0 0 12px rgba(37, 211, 102, 0); }
      100% { box-shadow: 0 0 0 0 rgba(37, 211, 102, 0); }
    }

    .user-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }

    .user-info h4 {
      font-size: 17px;
      font-weight: 600;
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Ø´Ø§Ø±Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø­Ù…Ø±Ø§Ø¡ Ø§Ù„Ù…Ø­Ø³Ù†Ø© */
    .unread-count {
      background: linear-gradient(135deg, var(--notification-red), #e74c3c);
      color: white;
      font-size: 11px;
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 12px;
      min-width: 22px;
      text-align: center;
      display: none;
      animation: bounceIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      box-shadow: 0 3px 10px rgba(255, 68, 68, 0.4);
    }

    .unread-count.show {
      display: inline-block;
    }

    @keyframes bounceIn {
      0% { transform: scale(0) rotate(180deg); opacity: 0; }
      50% { transform: scale(1.3) rotate(90deg); opacity: 0.8; }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }

    .user-status {
      font-size: 14px;
      color: var(--whatsapp-dark-gray);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 400;
    }

    .online-text {
      color: var(--whatsapp-green);
      font-size: 13px;
      font-weight: 500;
    }

    /* Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø© */
    #chatContainer {
      flex: 1;
      display: none;
      flex-direction: column;
      background: var(--whatsapp-bg);
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 200;
    }

    #chatHeader {
      background: linear-gradient(135deg, var(--whatsapp-dark-green), #0d7377);
      color: white;
      padding: 14px 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      min-height: 68px;
    }

    #chatUserInfo {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    #chatUserAvatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--whatsapp-green), var(--whatsapp-dark-green));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 18px;
      box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
    }

    #chatUserDetails {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    #chatUserName {
      font-size: 17px;
      font-weight: 600;
    }

    #chatUserStatus {
      font-size: 13px;
      opacity: 0.9;
    }

    #chatControls {
      display: flex;
      gap: 10px;
    }

    .chat-btn {
      background: rgba(255,255,255,0.15);
      border: none;
      color: white;
      padding: 10px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 16px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .chat-btn:hover {
      background: rgba(255,255,255,0.25);
      transform: scale(1.1);
    }

    /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø­Ø³Ù†Ø© */
    #messagesArea {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      background: 
        radial-gradient(circle at 25% 25%, rgba(37, 211, 102, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 75% 75%, rgba(52, 183, 241, 0.03) 0%, transparent 50%),
        var(--whatsapp-bg);
      display: flex;
      flex-direction: column;
      gap: 12px;
      scroll-behavior: smooth;
    }

    .message-wrapper {
      display: flex;
      margin: 3px 0;
      contain: layout;
    }

    .message-wrapper.sent { justify-content: flex-end; }
    .message-wrapper.received { justify-content: flex-start; }

    .message {
      max-width: 80%;
      padding: 12px 16px 8px 16px;
      border-radius: 12px;
      position: relative;
      word-wrap: break-word;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      animation: messageSlide 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-size: 15px;
      line-height: 1.4;
    }

    @keyframes messageSlide {
      from { opacity: 0; transform: translateY(15px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .message.sent {
      background: linear-gradient(135deg, var(--message-sent), #d4edda);
      color: #2c3e50;
      border-bottom-right-radius: 4px;
    }

    .message.received {
      background: linear-gradient(135deg, var(--message-received), #f8f9fa);
      color: #2c3e50;
      border-bottom-left-radius: 4px;
    }

    .message.new {
      animation: newMessage 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes newMessage {
      0% { 
        opacity: 0;
        transform: translateY(30px) scale(0.8);
        background: linear-gradient(135deg, #fff3cd, #ffeaa7);
      }
      50% { transform: translateY(-8px) scale(1.05); }
      100% { 
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .message-content {
      margin-bottom: 6px;
      line-height: 1.5;
    }

    .message-media {
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 6px;
      background: #000;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .message-media img,
    .message-media video {
      width: 100%;
      max-width: 280px;
      height: auto;
      display: block;
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    .message-media img:hover,
    .message-media video:hover {
      transform: scale(1.02);
    }

    .message-time {
      font-size: 11px;
      color: var(--whatsapp-dark-gray);
      text-align: left;
      direction: ltr;
      margin-top: 4px;
      font-weight: 400;
    }

    /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø­Ø³Ù†Ø© ÙˆØ§Ù„Ø£Ø¹Ø±Ø¶ */
    #inputContainer {
      background: linear-gradient(135deg, var(--whatsapp-gray), #f8fafc);
      padding: 12px 20px; /* Ø­Ø§ÙˆÙŠØ© Ø£Ø¹Ø±Ø¶ */
      display: flex;
      align-items: flex-end;
      gap: 12px;
      min-height: 70px; /* Ø§Ø±ØªÙØ§Ø¹ Ø£ÙƒØ¨Ø± */
      border-top: 1px solid rgba(0,0,0,0.05);
    }

    #mediaButtons {
      display: flex;
      gap: 6px;
    }

    .media-btn {
      background: white;
      color: var(--whatsapp-dark-gray);
      border: none;
      padding: 10px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      width: 42px;
      height: 42px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }

    .media-btn:hover {
      background: var(--whatsapp-green);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
    }

    #messageInput {
      flex: 1;
      resize: none;
      min-height: 42px;
      max-height: 140px;
      padding: 12px 18px;
      border: 2px solid #e1e8ed;
      border-radius: 22px;
      font-size: 15px;
      line-height: 1.5;
      margin: 0;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      transition: all 0.3s ease;
    }

    #messageInput:focus {
      outline: none;
      border-color: var(--whatsapp-green);
      box-shadow: 0 4px 20px rgba(37, 211, 102, 0.15);
      transform: translateY(-1px);
    }

    #sendBtn {
      background: linear-gradient(135deg, var(--whatsapp-green), var(--whatsapp-dark-green));
      color: white;
      border: none;
      padding: 0;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      width: 42px;
      height: 42px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
      transition: all 0.3s ease;
    }

    #sendBtn:hover {
      transform: translateY(-2px) scale(1.1);
      box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4);
    }

    #sendBtn:active {
      transform: translateY(0) scale(1.05);
    }

    /* Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙˆØ³Ø§Ø¦Ø· Ø§Ù„Ù…Ø­Ø³Ù†Ø© */
    #mediaPreview {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 3000;
      backdrop-filter: blur(10px);
    }

    #mediaPreview .preview-content {
      max-width: 90%;
      max-height: 90%;
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    #mediaPreview img,
    #mediaPreview video {
      max-width: 100%;
      max-height: 100%;
      border-radius: 12px;
    }

    .preview-controls {
      position: absolute;
      bottom: -70px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 15px;
    }

    .preview-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 14px 24px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .preview-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }

    .preview-btn.send {
      background: var(--whatsapp-green);
    }

    .preview-btn.send:hover {
      background: var(--whatsapp-dark-green);
    }

    /* Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø© */
    #dropdownMenu {
      position: absolute;
      top: 75px; /* ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¹Ø±Ø¶ */
      right: 18px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.15);
      display: none;
      flex-direction: column;
      min-width: 220px;
      z-index: 300;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.05);
    }

    .dropdown-item {
      padding: 14px 18px;
      border: none;
      background: transparent;
      text-align: right;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
      color: #2c3e50;
    }

    .dropdown-item:hover {
      background: linear-gradient(135deg, var(--whatsapp-gray), #f8fafc);
      transform: translateX(-3px);
    }

    .dropdown-item.danger {
      color: #e74c3c;
    }

    .dropdown-item.danger:hover {
      background: linear-gradient(135deg, #ffebee, #fce4ec);
    }

    /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù†Ø© */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      z-index: 4000;
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 28px;
      width: min(400px, 92vw);
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes modalSlideIn {
      from { opacity: 0; transform: scale(0.9) translateY(20px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }

    .modal h3 {
      margin-bottom: 20px;
      text-align: center;
      color: #2c3e50;
      font-size: 20px;
      font-weight: 700;
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 24px;
    }

    .modal-buttons button {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .modal-buttons .primary {
      background: linear-gradient(135deg, var(--whatsapp-green), var(--whatsapp-dark-green));
      color: white;
    }

    .modal-buttons .primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(37, 211, 102, 0.3);
    }

    .modal-buttons .secondary {
      background: var(--whatsapp-gray);
      color: #2c3e50;
    }

    .modal-buttons .secondary:hover {
      background: #e9ecef;
      transform: translateY(-1px);
    }

    .modal-buttons .danger {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: white;
    }

    .modal-buttons .danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(231, 76, 60, 0.3);
    }

    /* Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø© */
    #typingIndicator {
      padding: 10px 18px;
      color: var(--whatsapp-dark-gray);
      font-style: italic;
      font-size: 13px;
      background: rgba(240, 240, 240, 0.8);
      display: none;
      animation: typingPulse 1.5s infinite;
      border-top: 1px solid rgba(0,0,0,0.05);
    }

    @keyframes typingPulse {
      0%, 100% { opacity: 0.7; }
      50% { opacity: 1; }
    }

    /* Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ø­Ø³Ù†Ø© */
    .new-message-notification {
      position: fixed;
      top: calc(25px + var(--safe-area-top));
      right: 25px;
      background: linear-gradient(135deg, var(--whatsapp-green), var(--whatsapp-dark-green));
      color: white;
      padding: 15px 22px;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(37, 211, 102, 0.4);
      z-index: 5000;
      display: none;
      animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }

    .new-message-notification.show { display: block; }

    @keyframes slideInRight {
      from { transform: translateX(120%) scale(0.8); opacity: 0; }
      to { transform: translateX(0) scale(1); opacity: 1; }
    }

    .new-message-notification:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(37, 211, 102, 0.5);
    }

    /* Ù…Ø¤Ø´Ø± Ø§Ù„Ø§ØªØµØ§Ù„ */
    .connection-status {
      position: fixed;
      top: calc(15px + var(--safe-area-top));
      left: 50%;
      transform: translateX(-50%);
      background: #e74c3c;
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 13px;
      font-weight: 600;
      z-index: 5000;
      display: none;
      box-shadow: 0 4px 20px rgba(231, 76, 60, 0.3);
    }

    .connection-status.connected {
      background: var(--whatsapp-green);
      box-shadow: 0 4px 20px rgba(37, 211, 102, 0.3);
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø¬ÙˆØ§Ù„ */
    @media (max-width: 768px) {
      #appHeader, #chatHeader {
        padding: 12px 16px;
        min-height: 64px;
      }

      #searchContainer, #inputContainer {
        padding: 12px 16px;
      }

      .message { max-width: 88%; }
      .user-card { padding: 12px 16px; }
      
      .new-message-notification {
        top: calc(15px + var(--safe-area-top));
        right: 15px;
        left: 15px;
        transform: none;
      }

      .modal-content {
        padding: 20px;
        margin: 20px;
      }
    }

    /* ØªØ­Ø³ÙŠÙ† Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { 
      background: linear-gradient(135deg, var(--whatsapp-green), var(--whatsapp-dark-green));
      border-radius: 4px; 
    }
    ::-webkit-scrollbar-thumb:hover { background: var(--whatsapp-dark-green); }

    /* Ø¥Ø®ÙØ§Ø¡ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
    input[type="file"] { display: none; }

    /* Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ */
    .welcome-message {
      text-align: center;
      padding: 50px 25px;
      color: var(--whatsapp-dark-gray);
    }

    .welcome-message h3 {
      color: var(--whatsapp-green);
      margin-bottom: 15px;
      font-size: 22px;
      font-weight: 700;
    }

    .welcome-message p {
      font-size: 16px;
      line-height: 1.5;
    }

    /* Ø­Ø§Ù„Ø© ÙØ§Ø±ØºØ© */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--whatsapp-dark-gray);
      font-size: 16px;
    }

    .empty-state .icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.6;
    }

    /* Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ±Ø­ÙŠØ¨ */
    .welcome-content {
      text-align: right;
      line-height: 1.8;
      font-size: 15px;
      color: #555;
    }

    .cute-chat-name {
      font-weight: 700;
      color: var(--whatsapp-green);
    }

    /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ */
    .message-wrapper, .user-card { contain: layout style; }

    /* Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
    .loading-spinner {
      width: 24px;
      height: 24px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .media-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 15px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø£Ø¯Ø§Ø¡ */
    * {
      -webkit-tap-highlight-color: transparent;
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body>

<!-- Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
<div id="newMessageNotification" class="new-message-notification">
  <div id="notificationContent"></div>
</div>

<!-- Ù…Ø¤Ø´Ø± Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ -->
<div id="connectionStatus" class="connection-status">
  ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© -->
<div id="authContainer">
  <h2 id="formTitle">ğŸ’¬ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ChatPro</h2>
  <input type="email" id="email" placeholder="ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" />
  <input type="password" id="password" placeholder="ğŸ”’ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
  <input type="text" id="username" placeholder="ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…" style="display: none;" />
  <input type="text" id="status" placeholder="âœ¨ Ø§Ù„Ø­Ø§Ù„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="display: none;" />
  <div id="errorMsg"></div>
  <button id="submitBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
  <button id="toggleFormBtn">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
</div>

<!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
<div id="app">
  <div id="appHeader">
    <div id="userInfo">
      <button id="menuBtn">â‹®</button>
      <div id="userDetails">
        <div id="currentUsername"></div>
        <div id="currentUserStatus"></div>
      </div>
    </div>
    <div id="appLogoContainer">
      <div id="appLogo">
        <!-- Ù…ÙƒØ§Ù† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø®ØµØµØ© -->
        <!-- <img src="Ø±Ø§Ø¨Ø·-Ø§Ù„ØµÙˆØ±Ø©-Ø§Ù„Ù…Ø¨Ø§Ø´Ø±.jpg" alt="ChatPro" /> -->
        ChatPro
      </div>
      <div id="usersCount"></div>
    </div>
  </div>

  <div id="mainContent">
    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
    <div id="usersListContainer">
      <div id="searchContainer">
        <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…..." />
      </div>
      <div id="usersList">
        <div class="welcome-message">
          <h3>ğŸ‰ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ!</h3>
          <p>Ø§Ø¨Ø¯Ø£ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ</p>
        </div>
      </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
    <div id="chatContainer">
      <div id="chatHeader">
        <div id="chatUserInfo">
          <div id="chatUserAvatar"></div>
          <div id="chatUserDetails">
            <div id="chatUserName"></div>
            <div id="chatUserStatus"></div>
          </div>
        </div>
        <div id="chatControls">
          <button class="chat-btn" id="blockUserBtn" title="Ø­Ø¸Ø±/Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø±">ğŸš«</button>
          <button class="chat-btn" id="backBtn" title="Ø±Ø¬ÙˆØ¹">â†</button>
        </div>
      </div>

      <div id="messagesArea">
        <div class="empty-state">
          <div class="icon">ğŸ’¬</div>
          <p>Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¯Ø«Ø© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</p>
        </div>
      </div>

      <div id="typingIndicator">
        <span id="typingUser"></span> ÙŠÙƒØªØ¨...
      </div>

      <div id="inputContainer">
        <div id="mediaButtons">
          <button class="media-btn" id="cameraBtn" title="Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø©">ğŸ“¸</button>
          <button class="media-btn" id="galleryBtn" title="Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©">ğŸ–¼ï¸</button>
          <button class="media-btn" id="videoBtn" title="Ø§Ø®ØªÙŠØ§Ø± ÙÙŠØ¯ÙŠÙˆ">ğŸ¥</button>
        </div>
        <textarea id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." rows="1"></textarea>
        <button id="sendBtn">â¤</button>
      </div>
    </div>
  </div>

  <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© -->
  <div id="dropdownMenu">
    <button class="dropdown-item" id="editProfileBtn">
      <span>âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</span>
    </button>
    <button class="dropdown-item" id="blockedUsersBtn">
      <span>ğŸš« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†</span>
    </button>
    <button class="dropdown-item" id="notificationSettingsBtn">
      <span>ğŸ”” Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span>
    </button>
    <button class="dropdown-item" id="aboutBtn">
      <span>â„¹ï¸ Ø¹Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</span>
    </button>
    <button class="dropdown-item danger" id="logoutBtn">
      <span>ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
    </button>
    <button class="dropdown-item danger" id="deleteAccountBtn">
      <span>âŒ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨</span>
    </button>
  </div>
</div>

<!-- Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙˆØ³Ø§Ø¦Ø· -->
<div id="mediaPreview">
  <div class="preview-content">
    <div id="previewMedia"></div>
    <div class="preview-controls">
      <button class="preview-btn send" id="sendMediaBtn">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„</button>
      <button class="preview-btn" id="cancelMediaBtn">âŒ Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª -->
<!-- ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
<div class="modal" id="editProfileModal">
  <div class="modal-content">
    <h3>âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>
    <input type="text" id="editUsername" placeholder="ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…" />
    <input type="text" id="editStatus" placeholder="âœ¨ Ø§Ù„Ø­Ø§Ù„Ø©" />
    <div class="modal-buttons">
      <button class="primary" id="saveProfileBtn">ğŸ’¾ Ø­ÙØ¸</button>
      <button class="secondary" id="cancelProfileBtn">âŒ Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
<div class="modal" id="notificationModal">
  <div class="modal-content">
    <h3>ğŸ”” Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3>
    <div style="text-align: right; margin: 20px 0;">
      <label style="display: flex; align-items: center; gap: 12px; margin: 18px 0; cursor: pointer;">
        <input type="checkbox" id="enableNotifications" checked />
        <span style="font-size: 15px;">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span>
      </label>
      <label style="display: flex; align-items: center; gap: 12px; margin: 18px 0; cursor: pointer;">
        <input type="checkbox" id="enableSounds" checked />
        <span style="font-size: 15px;">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£ØµÙˆØ§Øª</span>
      </label>
    </div>
    <div class="modal-buttons">
      <button class="primary" id="saveNotificationBtn">ğŸ’¾ Ø­ÙØ¸</button>
      <button class="secondary" id="cancelNotificationBtn">âŒ Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ -->
<div class="modal" id="welcomeModal">
  <div class="modal-content">
    <div class="welcome-content">
      Ø¹Ø²ÙŠØ²Ù†Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ / <span id="welcomeUsername"></span><br><br>
      Ù†Ø´ÙƒØ±Ùƒ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ Ø¹Ø§Ø¦Ù„Ø© <span class="cute-chat-name">ÙƒÙŠÙˆØª Ø´Ø§Øª</span><br><br>
      Ù†Ù„ÙØª Ø§Ù†ØªØ¨Ø§Ù‡ÙƒÙ… Ø¥Ù„Ù‰ Ø£Ù†Ù†Ø§ Ù†Ø¹Ù…Ù„ Ø¬Ø§Ù‡Ø¯ÙŠÙ† Ù„ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ <span class="cute-chat-name">ÙƒÙŠÙˆØª Ø´Ø§Øª</span><br>
      Ù„ÙŠØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª Ø£Ùˆ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø§ØªÙ ÙˆØ³ÙŠÙƒÙˆÙ† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø¥Ø°Ù† Ø§Ù„Ù„Ù‡ Ø¹Ø² ÙˆØ¬Ù„ Ù…ØªØ§Ø­Ø§Ù‹ ÙÙŠ Ø£ÙŠØ¯ÙŠ Ø§Ù„Ø¬Ù…ÙŠØ¹ØŒ ÙˆØ³ÙŠØªÙ…ÙŠØ² Ø¨Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª Ø§Ù„ØµÙˆØªÙŠØ© ÙˆØ§Ù„Ù…Ø±Ø¦ÙŠØ© ÙˆÙ…ÙƒØ§Ù„Ù…Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© Ø¨Ø¥Ø°Ù† Ø§Ù„Ù„Ù‡ Ø¹Ø² ÙˆØ¬Ù„.<br><br>
      <strong>ØªÙ†ÙˆÙŠÙ‡ Ù‡Ø§Ù…:</strong><br>
      Ù„Ù† Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø¨Ù„ÙˆØº Ø§Ù„Ù‡Ø¯Ù Ø¥Ù„Ø§ Ø¨ÙØ¶Ù„ Ø§Ù„Ù„Ù‡ Ø¹Ù„ÙŠÙ†Ø§ ÙˆÙØ¶Ù„ÙƒÙ….<br><br>
      <strong>Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø±:</strong><br>
      â€¢ ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ù„Ø­Ø§Ù„Ø©<br>
      â€¢ ÙˆØ§Ø¬Ù‡Ø© Ù…Ø­Ø³Ù†Ø© ÙˆØ£ÙƒØ«Ø± Ø¬Ù…Ø§Ù„Ø§Ù‹<br>
      â€¢ Ø£Ø¯Ø§Ø¡ Ø£Ø³Ø±Ø¹ ÙˆØ£ÙƒØ«Ø± Ø§Ø³ØªÙ‚Ø±Ø§Ø±Ø§Ù‹<br>
      â€¢ Ø¥Ø¯Ø§Ø±Ø© Ø´Ø§Ù…Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†
    </div>
    <div class="modal-buttons">
      <button class="primary" id="welcomeModalOkBtn">Ù…ÙˆØ§ÙÙ‚</button>
    </div>
  </div>
</div>

<!-- ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¸Ø± -->
<div class="modal" id="blockModal">
  <div class="modal-content">
    <h3 id="blockModalTitle">ğŸš« Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
    <p id="blockModalMessage" style="text-align: center; margin: 20px 0; font-size: 15px;"></p>
    <div class="modal-buttons">
      <button class="primary" id="confirmBlockBtn">ØªØ£ÙƒÙŠØ¯</button>
      <button class="secondary" id="cancelBlockBtn">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙˆÙ† -->
<div class="modal" id="blockedUsersModal">
  <div class="modal-content">
    <h3>ğŸš« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙˆÙ†</h3>
    <div id="blockedUsersList" style="max-height: 350px; overflow-y: auto; margin: 20px 0; padding: 10px;">
      <p style="text-align: center; color: var(--whatsapp-dark-gray); font-size: 15px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù…Ø­Ø¸ÙˆØ±ÙˆÙ†</p>
    </div>
    <div class="modal-buttons">
      <button class="secondary" id="closeBlockedUsersBtn">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<!-- Ø¹Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
<div class="modal" id="aboutModal">
  <div class="modal-content">
    <h3>â„¹ï¸ Ø¹Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h3>
    <div style="text-align: right; line-height: 1.8; margin: 25px 0; font-size: 15px;">
      <p><strong>ChatPro - ÙƒÙŠÙˆØª Ø´Ø§Øª</strong></p>
      <p style="margin: 10px 0;">Ø§Ù„Ø¥ØµØ¯Ø§Ø±: 2.0 Ø§Ù„Ù…Ø­Ø³Ù†</p>
      <p style="margin: 10px 0;">ØªØ·Ø¨ÙŠÙ‚ Ø¯Ø±Ø¯Ø´Ø© ÙƒÙŠÙˆØª Ø´Ø§Øª Ù…ØªØ·ÙˆØ± Ù…Ø¹ ØªØ­Ø¯ÙŠØ«Ø§Øª Ù„Ø­Ø¸ÙŠØ©</p>
      <br>
      <p><strong>Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:</strong></p>
      <ul style="margin: 10px 0; padding-right: 20px;">
        <li>ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ù„Ø­Ø§Ù„Ø©</li>
        <li>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†</li>
        <li>Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ</li>
        <li>Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø°ÙƒÙŠØ©</li>
        <li>ÙˆØ§Ø¬Ù‡Ø© Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø³Ù†Ø©</li>
      </ul>
      <br>
      <p><strong>Ø§Ù„Ù…Ø·ÙˆØ±:</strong>ÙØ±ÙŠÙ‚ Ø§Ù„Ù…Ù…ÙŠØ² Ø³ÙˆÙØª Ù„Ù„Ø£Ù†Ø¸Ù…Ø©Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©</p>
      <p><strong>Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ØªÙ‚Ù†ÙŠ:</strong> T772299420@gmail.com</p>
      <br>
      <p style="color: var(--whatsapp-green); font-weight: 600;">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© Ù„Ù„Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø±ÙˆØ§Ù† Ø§Ù„Ø°Ù…Ø§Ø±ÙŠ</p>
    </div>
    <div class="modal-buttons">
      <button class="primary" id="closeAboutBtn">Ø­Ø³Ù†Ø§Ù‹</button>
    </div>
  </div>
</div>

<!-- ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ -->
<div class="modal" id="deleteAccountModal">
  <div class="modal-content">
    <h3>âŒ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨</h3>
    <div style="text-align: center; margin: 25px 0; color: #e74c3c; line-height: 1.6;">
      <p style="font-size: 16px; font-weight: 600; margin-bottom: 15px;">âš ï¸ ØªØ­Ø°ÙŠØ± Ù‡Ø§Ù…!</p>
      <p style="margin-bottom: 10px;">Ø³ÙŠØªÙ… Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ ÙˆØ¬Ù…ÙŠØ¹ Ø±Ø³Ø§Ø¦Ù„Ùƒ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</p>
      <p style="margin-bottom: 15px;">Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡</p>
      <input type="password" id="confirmDeletePassword" placeholder="ğŸ”’ Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„ØªØ£ÙƒÙŠØ¯" 
             style="width: 100%; margin: 15px 0; text-align: center;">
    </div>
    <div class="modal-buttons">
      <button class="danger" id="confirmDeleteBtn">Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</button>
      <button class="secondary" id="cancelDeleteBtn">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø®ÙÙŠØ© -->
<input type="file" id="imageInput" accept="image/*" />
<input type="file" id="videoInput" accept="video/*" />
<input type="file" id="cameraInput" accept="image/*" capture="camera" />

<!-- ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± -->
<audio id="notificationSound" preload="auto">
  <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMeBC2I0fPTgjEGHm7A7+OZURE" type="audio/wav">
</audio>

<script type="module">
  // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { 
    getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, 
    signOut, onAuthStateChanged, deleteUser, reauthenticateWithCredential, EmailAuthProvider 
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { 
    getFirestore, collection, addDoc, onSnapshot, query, orderBy, 
    serverTimestamp, getDocs, doc, setDoc, where, getDoc, updateDoc, 
    limit, deleteDoc, writeBatch 
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { 
    getStorage, ref, uploadBytesResumable, getDownloadURL 
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAm0hh9I6i58ywW1D2gZg09liG-wG-tBsU",
    authDomain: "chat-fat-4f082.firebaseapp.com",
    projectId: "chat-fat-4f082",
    storageBucket: "chat-fat-4f082.appspot.com",
    messagingSenderId: "297367474930",
    appId: "1:297367474930:web:a05b983e05a0ba257fb66b",
    measurementId: "G-MBGC7KZ8H0"
  };

  // ØªÙ‡ÙŠØ¦Ø© Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
  let currentUser = null;
  let currentChatUser = null;
  let unsubscribeMessages = null;
  let unsubscribeUsers = null;
  let unsubscribeTyping = null;
  let usersData = new Map();
  let unreadCounts = new Map();
  let blockedUsers = new Set();
  let onlineUsers = new Set();
  let typingTimeout = null;
  let notificationsEnabled = localStorage.getItem('notificationsEnabled') !== 'false';
  let soundsEnabled = localStorage.getItem('soundsEnabled') !== 'false';
  let isLogin = true;
  let isAppVisible = true;
  let notificationPermission = 'default';

  // Ø¹Ù†Ø§ØµØ± DOM Ù…Ø­Ø³Ù†Ø© Ù„Ù„Ø£Ø¯Ø§Ø¡
  const elements = {
    // Ø´Ø§Ø´Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
    authContainer: document.getElementById('authContainer'),
    app: document.getElementById('app'),
    formTitle: document.getElementById('formTitle'),
    submitBtn: document.getElementById('submitBtn'),
    toggleFormBtn: document.getElementById('toggleFormBtn'),
    errorMsg: document.getElementById('errorMsg'),
    emailInput: document.getElementById('email'),
    passwordInput: document.getElementById('password'),
    usernameInput: document.getElementById('username'),
    statusInput: document.getElementById('status'),

    // Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    chatContainer: document.getElementById('chatContainer'),
    usersListContainer: document.getElementById('usersListContainer'),
    usersList: document.getElementById('usersList'),
    searchInput: document.getElementById('searchInput'),
    messagesArea: document.getElementById('messagesArea'),
    messageInput: document.getElementById('messageInput'),
    sendBtn: document.getElementById('sendBtn'),
    backBtn: document.getElementById('backBtn'),
    menuBtn: document.getElementById('menuBtn'),
    dropdownMenu: document.getElementById('dropdownMenu'),
    blockUserBtn: document.getElementById('blockUserBtn'),
    usersCountElement: document.getElementById('usersCount'),
    typingIndicator: document.getElementById('typingIndicator'),
    typingUserElement: document.getElementById('typingUser'),

    // Ø§Ù„ÙˆØ³Ø§Ø¦Ø·
    imageInput: document.getElementById('imageInput'),
    videoInput: document.getElementById('videoInput'),
    cameraInput: document.getElementById('cameraInput'),
    galleryBtn: document.getElementById('galleryBtn'),
    videoBtn: document.getElementById('videoBtn'),
    cameraBtn: document.getElementById('cameraBtn'),
    mediaPreview: document.getElementById('mediaPreview'),
    previewMedia: document.getElementById('previewMedia'),
    sendMediaBtn: document.getElementById('sendMediaBtn'),
    cancelMediaBtn: document.getElementById('cancelMediaBtn'),

    // Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø±
    editProfileModal: document.getElementById('editProfileModal'),
    editUsername: document.getElementById('editUsername'),
    editStatus: document.getElementById('editStatus'),
    saveProfileBtn: document.getElementById('saveProfileBtn'),
    cancelProfileBtn: document.getElementById('cancelProfileBtn'),
    editProfileBtn: document.getElementById('editProfileBtn'),
    
    notificationModal: document.getElementById('notificationModal'),
    enableNotifications: document.getElementById('enableNotifications'),
    enableSounds: document.getElementById('enableSounds'),
    saveNotificationBtn: document.getElementById('saveNotificationBtn'),
    cancelNotificationBtn: document.getElementById('cancelNotificationBtn'),
    notificationSettingsBtn: document.getElementById('notificationSettingsBtn'),

    welcomeModal: document.getElementById('welcomeModal'),
    welcomeModalOkBtn: document.getElementById('welcomeModalOkBtn'),
    welcomeUsername: document.getElementById('welcomeUsername'),

    blockModal: document.getElementById('blockModal'),
    blockModalTitle: document.getElementById('blockModalTitle'),
    blockModalMessage: document.getElementById('blockModalMessage'),
    confirmBlockBtn: document.getElementById('confirmBlockBtn'),
    cancelBlockBtn: document.getElementById('cancelBlockBtn'),

    blockedUsersModal: document.getElementById('blockedUsersModal'),
    blockedUsersList: document.getElementById('blockedUsersList'),
    blockedUsersBtn: document.getElementById('blockedUsersBtn'),
    closeBlockedUsersBtn: document.getElementById('closeBlockedUsersBtn'),

    aboutModal: document.getElementById('aboutModal'),
    aboutBtn: document.getElementById('aboutBtn'),
    closeAboutBtn: document.getElementById('closeAboutBtn'),

    deleteAccountModal: document.getElementById('deleteAccountModal'),
    deleteAccountBtn: document.getElementById('deleteAccountBtn'),
    confirmDeletePassword: document.getElementById('confirmDeletePassword'),
    confirmDeleteBtn: document.getElementById('confirmDeleteBtn'),
    cancelDeleteBtn: document.getElementById('cancelDeleteBtn'),

    logoutBtn: document.getElementById('logoutBtn'),
    newMessageNotification: document.getElementById('newMessageNotification'),
    notificationContent: document.getElementById('notificationContent'),
    connectionStatus: document.getElementById('connectionStatus'),
    notificationSound: document.getElementById('notificationSound')
  };

  // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø¤ÙŠØ© ÙˆØ§Ù„Ø§ØªØµØ§Ù„
  document.addEventListener('visibilitychange', () => {
    isAppVisible = !document.hidden;
    if (isAppVisible) {
      hideNotification();
      if (currentUser) updateOnlineStatus(true);
    } else if (currentUser) {
      updateOnlineStatus(false);
    }
  });

  // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
  const updateConnectionStatus = (isOnline) => {
    if (isOnline) {
      elements.connectionStatus.textContent = 'Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª';
      elements.connectionStatus.classList.add('connected');
      elements.connectionStatus.style.display = 'block';
      setTimeout(() => elements.connectionStatus.style.display = 'none', 3000);
    } else {
      elements.connectionStatus.textContent = 'ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª';
      elements.connectionStatus.classList.remove('connected');
      elements.connectionStatus.style.display = 'block';
    }
  };

  window.addEventListener('online', () => updateConnectionStatus(true));
  window.addEventListener('offline', () => updateConnectionStatus(false));

  // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
  const updateOnlineStatus = async (isOnline) => {
    if (!currentUser) return;
    try {
      await setDoc(doc(db, "users", currentUser.uid), {
        isOnline: isOnline,
        lastActive: serverTimestamp(),
        ...(isOnline ? {} : { lastSeen: serverTimestamp() })
      }, { merge: true });
    } catch (error) {
      console.error("Error updating online status:", error);
    }
  };

  // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
  const requestNotificationPermission = async () => {
    if ('Notification' in window) {
      notificationPermission = await Notification.requestPermission();
    }
  };

  // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
  const showNewMessageNotification = (senderName, messageText, senderId) => {
    if (!notificationsEnabled || (isAppVisible && currentChatUser?.uid === senderId)) return;

    // Ø¥Ø´Ø¹Ø§Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    elements.notificationContent.innerHTML = `
      <strong>${senderName}</strong><br>
      ${messageText.length > 50 ? messageText.substring(0, 50) + '...' : messageText}
    `;
    elements.newMessageNotification.classList.add('show');
    
    setTimeout(hideNotification, 5000);
    
    elements.newMessageNotification.onclick = () => {
      hideNotification();
      const sender = usersData.get(senderId);
      if (sender) openChat(sender);
    };

    // Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…
    if (notificationPermission === 'granted' && !isAppVisible) {
      const notification = new Notification(`Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† ${senderName}`, {
        body: messageText,
        icon: '/icon-192x192.png',
        tag: 'new-message',
        requireInteraction: false,
        silent: !soundsEnabled
      });

      notification.onclick = () => {
        window.focus();
        notification.close();
        const sender = usersData.get(senderId);
        if (sender) openChat(sender);
      };

      setTimeout(() => notification.close(), 5000);
    }

    // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª
    if (soundsEnabled) {
      elements.notificationSound.play().catch(e => console.log('Sound play failed:', e));
    }
  };

  const hideNotification = () => {
    elements.newMessageNotification.classList.remove('show');
  };

  // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù…Ø­Ø³Ù‘Ù†Ø©
  const debounce = (func, wait) => {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  };

  const getUserInitials = (username) => {
    return username ? username.charAt(0).toUpperCase() : '?';
  };

  const formatTime = (timestamp) => {
    if (!timestamp) return '';
    const date = timestamp.toDate();
    const now = new Date();
    const isToday = date.getDate() === now.getDate() &&
                    date.getMonth() === now.getMonth() &&
                    date.getFullYear() === now.getFullYear();
    
    if (isToday) {
      return date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
    } else {
      const yesterday = new Date(now);
      yesterday.setDate(yesterday.getDate() - 1);
      const isYesterday = date.getDate() === yesterday.getDate() &&
                         date.getMonth() === yesterday.getMonth() &&
                         date.getFullYear() === yesterday.getFullYear();
      
      if (isYesterday) return 'Ø£Ù…Ø³';
      return date.toLocaleDateString('ar-EG', { day: 'numeric', month: 'short' });
    }
  };

  const formatLastSeen = (timestamp) => {
    if (!timestamp) return 'ØºÙŠØ± Ù…ØªØ§Ø­';
    const date = timestamp.toDate();
    const now = new Date();
    const diffInMinutes = Math.floor((now - date) / (1000 * 60));
    const diffInHours = Math.floor(diffInMinutes / 60);
    const diffInDays = Math.floor(diffInHours / 24);

    if (diffInMinutes < 1) return 'Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†';
    if (diffInMinutes < 60) return `Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ± Ù…Ù†Ø° ${diffInMinutes} Ø¯`;
    if (diffInHours < 24) return `Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ± Ù…Ù†Ø° ${diffInHours} Ø³`;
    if (diffInDays < 7) return `Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ± Ù…Ù†Ø° ${diffInDays} Ø£ÙŠØ§Ù…`;
    return `Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ± ${date.toLocaleDateString('ar-EG')}`;
  };

  const getChatId = (uid1, uid2) => {
    return uid1 < uid2 ? uid1 + '_' + uid2 : uid2 + '_' + uid1;
  };

  // Ø¯ÙˆØ§Ù„ Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª
  const showAuth = () => {
    elements.app.style.display = 'none';
    elements.authContainer.style.display = 'block';
  };

  const showApp = () => {
    elements.authContainer.style.display = 'none';
    elements.app.style.display = 'flex';
  };

  const showChat = () => {
    elements.usersListContainer.classList.add('hidden');
    elements.chatContainer.style.display = 'flex';
    elements.messageInput.focus();
    history.pushState({ view: 'chat' }, '', '');
  };

  const showUsersList = () => {
    elements.usersListContainer.classList.remove('hidden');
    elements.chatContainer.style.display = 'none';
    currentChatUser = null;
    
    if (unsubscribeMessages) {
      unsubscribeMessages();
      unsubscribeMessages = null;
    }
    if (unsubscribeTyping) {
      unsubscribeTyping();
      unsubscribeTyping = null;
    }
    
    elements.typingIndicator.style.display = 'none';
    history.pushState({ view: 'users' }, '', '');
    renderUsersList();
  };

  // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹
  window.addEventListener('popstate', (event) => {
    event.preventDefault();
    if (elements.chatContainer.style.display === 'flex') {
      showUsersList();
    }
    return false;
  });

  // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
  elements.submitBtn.addEventListener('click', async () => {
    const email = elements.emailInput.value.trim();
    const password = elements.passwordInput.value;
    const username = elements.usernameInput.value.trim();
    const status = elements.statusInput.value.trim();

    elements.errorMsg.textContent = '';

    if (!email || !password) {
      elements.errorMsg.textContent = "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.";
      return;
    }

    elements.submitBtn.disabled = true;
    elements.submitBtn.innerHTML = '<div class="loading-spinner"></div>';

    try {
      if (isLogin) {
        await signInWithEmailAndPassword(auth, email, password);
      } else {
        if (!username) {
          elements.errorMsg.textContent = "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….";
          return;
        }
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        await setDoc(doc(db, "users", user.uid), {
          uid: user.uid,
          email: user.email,
          username: username,
          status: status || 'Ù…ØªØ§Ø­',
          isOnline: true,
          lastSeen: serverTimestamp(),
          lastActive: serverTimestamp(),
          blockedUsers: [],
          createdAt: serverTimestamp()
        });
        elements.welcomeUsername.textContent = username;
        elements.welcomeModal.style.display = 'flex';
      }
    } catch (error) {
      console.error("Auth error:", error);
      const errorMessages = {
        'auth/email-already-in-use': "Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„.",
        'auth/user-not-found': "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.",
        'auth/wrong-password': "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.",
        'auth/invalid-email': "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­.",
        'auth/weak-password': "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹.",
        'auth/invalid-credential': "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ ØºÙŠØ± ØµØ­ÙŠØ­Ø©."
      };
      elements.errorMsg.textContent = errorMessages[error.code] || "Ø­Ø¯Ø« Ø®Ø·Ø£. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
    } finally {
      elements.submitBtn.disabled = false;
      elements.submitBtn.textContent = isLogin ? 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„' : 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨';
    }
  });

  elements.toggleFormBtn.addEventListener('click', () => {
    isLogin = !isLogin;
    elements.errorMsg.textContent = '';
    
    if (isLogin) {
      elements.formTitle.textContent = 'ğŸ’¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
      elements.submitBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
      elements.toggleFormBtn.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯';
      elements.usernameInput.style.display = 'none';
      elements.statusInput.style.display = 'none';
    } else {
      elements.formTitle.textContent = 'ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯';
      elements.submitBtn.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨';
      elements.toggleFormBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
      elements.usernameInput.style.display = 'block';
      elements.statusInput.style.display = 'block';
    }
  });

  // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø³Ù†
  const renderUsersList = debounce(() => {
    const fragment = document.createDocumentFragment();
    const searchTerm = elements.searchInput.value.toLowerCase();
    
    const filteredUsers = Array.from(usersData.values())
      .filter(user => 
        user.uid !== currentUser?.uid && 
        user.username.toLowerCase().includes(searchTerm) &&
        !blockedUsers.has(user.uid)
      )
      .sort((a, b) => {
        const aOnline = onlineUsers.has(a.uid);
        const bOnline = onlineUsers.has(b.uid);
        
        if (aOnline && !bOnline) return -1;
        if (!aOnline && bOnline) return 1;
        
        const aUnread = unreadCounts.get(a.uid) || 0;
        const bUnread = unreadCounts.get(b.uid) || 0;
        
        if (aUnread > 0 && bUnread === 0) return -1;
        if (aUnread === 0 && bUnread > 0) return 1;
        
        return a.username.localeCompare(b.username);
      });

    if (filteredUsers.length === 0) {
      elements.usersList.innerHTML = `
        <div class="welcome-message">
          <h3>ğŸ‰ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ!</h3>
          <p>Ø§Ø¨Ø¯Ø£ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ</p>
        </div>
      `;
      return;
    }

    filteredUsers.forEach(user => {
      const isOnline = onlineUsers.has(user.uid);
      const unreadCount = unreadCounts.get(user.uid) || 0;
      
      const userCard = document.createElement('div');
      userCard.className = 'user-card';
      userCard.setAttribute('data-uid', user.uid);
      
      userCard.innerHTML = `
        <div class="user-avatar-container">
          <div class="user-avatar">${getUserInitials(user.username)}</div>
          <div class="online-indicator ${isOnline ? 'online' : ''}"></div>
        </div>
        <div class="user-info">
          <h4>
            ${user.username}
            ${unreadCount > 0 ? `<span class="unread-count show">${unreadCount}</span>` : ''}
          </h4>
          <div class="user-status">
            ${isOnline ? '<span class="online-text">Ù…ØªØµÙ„</span>' : formatLastSeen(user.lastSeen)}
          </div>
        </div>
      `;
      
      userCard.addEventListener('click', () => openChat(user));
      fragment.appendChild(userCard);
    });

    elements.usersList.innerHTML = '';
    elements.usersList.appendChild(fragment);
  }, 100);

  // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø­Ø³Ù†
  const renderMessage = (message, isNew = false) => {
    const isSent = message.senderId === currentUser.uid;
    const messageWrapper = document.createElement('div');
    messageWrapper.className = `message-wrapper ${isSent ? 'sent' : 'received'}`;
    messageWrapper.setAttribute('data-msg-id', message.id);

    const messageElement = document.createElement('div');
    messageElement.className = `message ${isSent ? 'sent' : 'received'} ${isNew ? 'new' : ''}`;
    
    let contentHTML = '';
    
    if (message.type === 'text') {
      contentHTML = `
        <div class="message-content">${message.text}</div>
        <div class="message-time">${formatTime(message.timestamp)}</div>
      `;
    } else if (message.type === 'image') {
      contentHTML = `
        <div class="message-content">
          <div class="message-media">
            <img src="${message.url}" alt="ØµÙˆØ±Ø©" onclick="showMediaPreview('${message.url}', 'image')" loading="lazy" />
          </div>
        </div>
        <div class="message-time">${formatTime(message.timestamp)}</div>
      `;
    } else if (message.type === 'video') {
      contentHTML = `
        <div class="message-content">
          <div class="message-media">
            <video src="${message.url}" controls preload="metadata" onclick="showMediaPreview('${message.url}', 'video')"></video>
          </div>
        </div>
        <div class="message-time">${formatTime(message.timestamp)}</div>
      `;
    }
    
    messageElement.innerHTML = contentHTML;
    messageWrapper.appendChild(messageElement);
    elements.messagesArea.appendChild(messageWrapper);
    
    // ØªÙ…Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ø­Ø³Ù†
    requestAnimationFrame(() => {
      elements.messagesArea.scrollTop = elements.messagesArea.scrollHeight;
    });

    if (isNew) {
      setTimeout(() => messageElement.classList.remove('new'), 600);
    }
  };

  // ÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù…Ø­Ø³Ù†
  const openChat = async (user) => {
    currentChatUser = user;
    
    document.getElementById('chatUserName').textContent = user.username;
    document.getElementById('chatUserAvatar').textContent = getUserInitials(user.username);
    document.getElementById('chatUserStatus').textContent = 
      onlineUsers.has(user.uid) ? 'Ù…ØªØµÙ„' : formatLastSeen(user.lastSeen);
    
    const isBlocked = blockedUsers.has(user.uid);
    elements.blockUserBtn.title = isBlocked ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±' : 'Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
    elements.blockUserBtn.style.opacity = isBlocked ? '0.5' : '1';
    
    showChat();
    elements.messagesArea.innerHTML = `
      <div class="empty-state">
        <div class="icon">ğŸ’¬</div>
        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯. Ø§Ø¨Ø¯Ø£ Ù…Ø­Ø§Ø¯Ø«ØªÙƒ Ø§Ù„Ø£ÙˆÙ„Ù‰!</p>
      </div>
    `;
    
    const chatId = getChatId(currentUser.uid, currentChatUser.uid);
    
    try {
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¥Ù„Ù‰ Ù…Ù‚Ø±ÙˆØ¡Ø©
      const unreadQuery = query(
        collection(db, "chats", chatId, "messages"), 
        where("receiverId", "==", currentUser.uid), 
        where("read", "==", false)
      );
      
      const unreadSnapshot = await getDocs(unreadQuery);
      
      if (unreadSnapshot.size > 0) {
        const batch = writeBatch(db);
        unreadSnapshot.docs.forEach(msgDoc => {
          batch.update(doc(db, "chats", chatId, "messages", msgDoc.id), { read: true });
        });
        await batch.commit();
      }
      
      unreadCounts.set(user.uid, 0);
      renderUsersList();
      
      // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„
      if (unsubscribeMessages) unsubscribeMessages();
      
      const messagesQuery = query(
        collection(db, "chats", chatId, "messages"), 
        orderBy("timestamp"),
        limit(50)
      );
      
      let isFirstLoad = true;
      unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
        snapshot.docChanges().forEach(change => {
          const message = { id: change.doc.id, ...change.doc.data() };
          
          if (change.type === "added") {
            const emptyState = elements.messagesArea.querySelector('.empty-state');
            if (emptyState) emptyState.remove();
            
            const isNewMessage = !isFirstLoad;
            renderMessage(message, isNewMessage);
            
            if (message.senderId !== currentUser.uid && isNewMessage && soundsEnabled) {
              elements.notificationSound.play().catch(e => console.log('Sound play failed:', e));
            }
          }
        });
        
        isFirstLoad = false;
      }, (error) => console.error("Error listening to messages:", error));
      
      listenForTyping(currentChatUser.uid);
      
    } catch (error) {
      console.error("Error opening chat:", error);
    }
  };

  // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø­Ø³Ù†
  const sendMessage = async (type = 'text', content = null) => {
    if (!currentChatUser) return;
    
    const messageText = elements.messageInput.value.trim();
    if (type === 'text' && !messageText) return;
    if (type !== 'text' && !content) return;

    const chatId = getChatId(currentUser.uid, currentChatUser.uid);
    const messageData = {
      senderId: currentUser.uid,
      receiverId: currentChatUser.uid,
      type: type,
      text: type === 'text' ? messageText : '',
      url: type !== 'text' ? content : '',
      timestamp: serverTimestamp(),
      read: false
    };

    try {
      await addDoc(collection(db, "chats", chatId, "messages"), messageData);
      
      if (type === 'text') {
        elements.messageInput.value = '';
        elements.messageInput.style.height = 'auto';
        
        if (typingTimeout) clearTimeout(typingTimeout);
        await setDoc(doc(db, "typing", currentUser.uid), { isTyping: false }, { merge: true });
      }
    } catch (error) {
      console.error("Error sending message:", error);
    }
  };

  // Ø±ÙØ¹ Ø§Ù„ÙˆØ³Ø§Ø¦Ø· Ø§Ù„Ù…Ø­Ø³Ù†
  const handleMediaUpload = (file) => {
    if (!currentChatUser) return;
    
    const storageRef = ref(storage, `media/${currentUser.uid}/${Date.now()}_${file.name}`);
    const uploadTask = uploadBytesResumable(storageRef, file);

    const loadingWrapper = document.createElement('div');
    loadingWrapper.className = 'message-wrapper sent';
    loadingWrapper.innerHTML = `
      <div class="message sent">
        <div class="message-content">
          <div class="message-media">
            <div class="media-loading">
              <div class="loading-spinner"></div>
            </div>
          </div>
        </div>
        <div class="message-time">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...</div>
      </div>
    `;
    elements.messagesArea.appendChild(loadingWrapper);
    elements.messagesArea.scrollTop = elements.messagesArea.scrollHeight;
    
    uploadTask.on('state_changed',
      (snapshot) => {
        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
        console.log('Upload progress:', progress + '%');
      },
      (error) => {
        console.error("Upload failed:", error);
        loadingWrapper.remove();
      },
      () => {
        getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => {
          sendMessage(file.type.startsWith('image') ? 'image' : 'video', downloadURL);
          loadingWrapper.remove();
        });
      }
    );
  };

  // Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙˆØ³Ø§Ø¦Ø·
  const showMediaPreview = (content, type) => {
    elements.previewMedia.innerHTML = '';
    if (type === 'image') {
      const img = document.createElement('img');
      img.src = content;
      elements.previewMedia.appendChild(img);
    } else if (type === 'video') {
      const video = document.createElement('video');
      video.src = content;
      video.controls = true;
      elements.previewMedia.appendChild(video);
    }
    elements.mediaPreview.style.display = 'flex';
  };

  // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
  const handleTyping = debounce(async () => {
    if (!currentUser || !currentChatUser) return;
    
    try {
      const typingDocRef = doc(db, "typing", currentUser.uid);
      await setDoc(typingDocRef, { 
        isTyping: true, 
        chatId: getChatId(currentUser.uid, currentChatUser.uid),
        timestamp: serverTimestamp()
      }, { merge: true });

      if (typingTimeout) clearTimeout(typingTimeout);
      typingTimeout = setTimeout(async () => {
        await setDoc(typingDocRef, { isTyping: false }, { merge: true });
      }, 2000);
    } catch (error) {
      console.error("Error updating typing status:", error);
    }
  }, 300);

  const listenForTyping = (chatUserId) => {
    if (unsubscribeTyping) unsubscribeTyping();
    
    unsubscribeTyping = onSnapshot(doc(db, "typing", chatUserId), (docSnap) => {
      if (docSnap.exists()) {
        const data = docSnap.data();
        const isTyping = data.isTyping && 
                        data.chatId === getChatId(currentUser.uid, currentChatUser.uid);
        
        if (isTyping) {
          elements.typingUserElement.textContent = usersData.get(chatUserId)?.username || 'Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±';
          elements.typingIndicator.style.display = 'block';
        } else {
          elements.typingIndicator.style.display = 'none';
        }
      } else {
        elements.typingIndicator.style.display = 'none';
      }
    });
  };

  // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø­Ø¸Ø±
  const handleBlockUser = async () => {
    if (!currentChatUser) return;
    
    const isBlocked = blockedUsers.has(currentChatUser.uid);
    
    elements.blockModalTitle.textContent = isBlocked ? 'ğŸ”“ Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…' : 'ğŸš« Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
    elements.blockModalMessage.textContent = isBlocked 
      ? `Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± ${currentChatUser.username}ØŸ`
      : `Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø¸Ø± ${currentChatUser.username}ØŸ`;
    
    elements.blockModal.style.display = 'flex';
    
    elements.confirmBlockBtn.onclick = async () => {
      try {
        const userRef = doc(db, "users", currentUser.uid);
        const userDoc = await getDoc(userRef);
        
        if (userDoc.exists()) {
          let blockedUsersList = userDoc.data().blockedUsers || [];
          
          if (isBlocked) {
            blockedUsersList = blockedUsersList.filter(uid => uid !== currentChatUser.uid);
            blockedUsers.delete(currentChatUser.uid);
          } else {
            if (!blockedUsersList.includes(currentChatUser.uid)) {
              blockedUsersList.push(currentChatUser.uid);
              blockedUsers.add(currentChatUser.uid);
            }
          }
          
          await updateDoc(userRef, { blockedUsers: blockedUsersList });
          
          elements.blockUserBtn.title = blockedUsers.has(currentChatUser.uid) ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±' : 'Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
          elements.blockUserBtn.style.opacity = blockedUsers.has(currentChatUser.uid) ? '0.5' : '1';
          
          renderUsersList();
        }
        
        elements.blockModal.style.display = 'none';
      } catch (error) {
        console.error("Error updating block status:", error);
      }
    };
  };

  // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†
  const renderBlockedUsersList = () => {
    elements.blockedUsersList.innerHTML = '';
    
    if (blockedUsers.size === 0) {
      elements.blockedUsersList.innerHTML = '<p style="text-align: center; color: var(--whatsapp-dark-gray); font-size: 15px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù…Ø­Ø¸ÙˆØ±ÙˆÙ†</p>';
      return;
    }

    blockedUsers.forEach(uid => {
      const user = usersData.get(uid);
      if (user) {
        const blockedUserElement = document.createElement('div');
        blockedUserElement.style.cssText = `
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 15px 0;
          border-bottom: 1px solid #eee;
        `;
        
        blockedUserElement.innerHTML = `
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--whatsapp-green), var(--whatsapp-dark-green)); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
              ${getUserInitials(user.username)}
            </div>
            <span style="font-size: 15px; font-weight: 500;">${user.username}</span>
          </div>
          <button class="secondary" data-uid="${user.uid}" style="padding: 8px 16px; font-size: 13px; border-radius: 8px;">
            Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±
          </button>
        `;
        elements.blockedUsersList.appendChild(blockedUserElement);
      }
    });

    elements.blockedUsersList.querySelectorAll('button').forEach(button => {
      button.addEventListener('click', async (e) => {
        const uidToUnblock = e.target.dataset.uid;
        try {
          const userRef = doc(db, "users", currentUser.uid);
          const userDoc = await getDoc(userRef);
          
          if (userDoc.exists()) {
            let blockedUsersListArray = userDoc.data().blockedUsers || [];
            blockedUsersListArray = blockedUsersListArray.filter(uid => uid !== uidToUnblock);
            await updateDoc(userRef, { blockedUsers: blockedUsersListArray });
            
            blockedUsers.delete(uidToUnblock);
            renderBlockedUsersList();
            renderUsersList();
          }
        } catch (error) {
          console.error("Error unblocking user:", error);
        }
      });
    });
  };

  // Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨
  const deleteAccount = async () => {
    const password = elements.confirmDeletePassword.value;
    
    if (!password) {
      alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
      return;
    }

    try {
      // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
      const credential = EmailAuthProvider.credential(currentUser.email, password);
      await reauthenticateWithCredential(currentUser, credential);
      
      // Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      const batch = writeBatch(db);
      batch.delete(doc(db, "users", currentUser.uid));
      batch.delete(doc(db, "typing", currentUser.uid));
      await batch.commit();
      
      // Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨
      await deleteUser(currentUser);
      
      alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
      
    } catch (error) {
      console.error("Error deleting account:", error);
      const errorMessages = {
        'auth/wrong-password': 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©',
        'auth/requires-recent-login': 'ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø«Ù… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©'
      };
      alert(errorMessages[error.code] || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨');
    }
  };

  // Firebase Auth State Observer
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      showApp();

      await requestNotificationPermission();

      try {
        const userRef = doc(db, "users", currentUser.uid);
        await setDoc(userRef, { 
          isOnline: true, 
          lastActive: serverTimestamp() 
        }, { merge: true });

        const handleDisconnect = async () => {
          if (currentUser) {
            await updateDoc(doc(db, "users", currentUser.uid), { 
              isOnline: false, 
              lastSeen: serverTimestamp() 
            });
          }
        };

        window.addEventListener('beforeunload', handleDisconnect);
        window.addEventListener('pagehide', handleDisconnect);

        const userDoc = await getDoc(userRef);
        if (userDoc.exists()) {
          const userData = userDoc.data();
          usersData.set(currentUser.uid, userData);
          document.getElementById('currentUsername').textContent = userData.username;
          document.getElementById('currentUserStatus').textContent = userData.status || 'Ù…ØªØ§Ø­';
          blockedUsers = new Set(userData.blockedUsers || []);
        }

        // Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙˆØ±ÙŠ
        if (unsubscribeUsers) unsubscribeUsers();

        unsubscribeUsers = onSnapshot(collection(db, "users"), async (snapshot) => {
          onlineUsers.clear();
          
          for (const docChange of snapshot.docChanges()) {
            const userData = { uid: docChange.doc.id, ...docChange.doc.data() };
            usersData.set(userData.uid, userData);
            
            if (userData.isOnline) {
              onlineUsers.add(userData.uid);
            }

            if (docChange.type === "added" || docChange.type === "modified") {
              if (userData.uid !== currentUser.uid) {
                const chatId = getChatId(currentUser.uid, userData.uid);
                const unreadQuery = query(
                  collection(db, "chats", chatId, "messages"), 
                  where("receiverId", "==", currentUser.uid), 
                  where("read", "==", false)
                );
                
                try {
                  const unreadSnapshot = await getDocs(unreadQuery);
                  const prevUnreadCount = unreadCounts.get(userData.uid) || 0;
                  const newUnreadCount = unreadSnapshot.size;
                  unreadCounts.set(userData.uid, newUnreadCount);

                  // Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                  if (newUnreadCount > prevUnreadCount && userData.uid !== currentChatUser?.uid) {
                    const lastUnreadMessageQuery = query(
                      collection(db, "chats", chatId, "messages"),
                      where("receiverId", "==", currentUser.uid),
                      where("read", "==", false),
                      orderBy("timestamp", "desc"),
                      limit(1)
                    );
                    
                    const lastUnreadSnapshot = await getDocs(lastUnreadMessageQuery);
                    if (!lastUnreadSnapshot.empty) {
                      const lastMessage = lastUnreadSnapshot.docs[0].data();
                      showNewMessageNotification(
                        userData.username, 
                        lastMessage.text || (lastMessage.type === 'image' ? 'ØµÙˆØ±Ø©' : 'ÙÙŠØ¯ÙŠÙˆ'),
                        userData.uid
                      );
                    }
                  }
                } catch (error) {
                  console.error(`Error fetching unread count for ${userData.uid}:`, error);
                }
              }
            } else if (docChange.type === "removed") {
              usersData.delete(userData.uid);
              onlineUsers.delete(userData.uid);
              unreadCounts.delete(userData.uid);
            }
          }
          
          elements.usersCountElement.textContent = `${onlineUsers.size} Ù…ØªØµÙ„ / ${usersData.size} Ù…Ø³ØªØ®Ø¯Ù…`;
          renderUsersList();
        }, (error) => {
          console.error("Error listening to users:", error);
        });

      } catch (error) {
        console.error("Error setting up user session:", error);
      }
    } else {
      currentUser = null;
      showAuth();
      
      // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª
      [unsubscribeUsers, unsubscribeMessages, unsubscribeTyping].forEach(unsub => {
        if (unsub) unsub();
      });
      unsubscribeUsers = unsubscribeMessages = unsubscribeTyping = null;
      
      // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      usersData.clear();
      unreadCounts.clear();
      blockedUsers.clear();
      onlineUsers.clear();
    }
  });

  // Event Listeners
  elements.searchInput.addEventListener('input', renderUsersList);
  elements.sendBtn.addEventListener('click', () => sendMessage());

  elements.messageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  elements.messageInput.addEventListener('input', () => {
    handleTyping();
    elements.messageInput.style.height = 'auto';
    elements.messageInput.style.height = Math.min(elements.messageInput.scrollHeight, 140) + 'px';
  });

  elements.backBtn.addEventListener('click', showUsersList);

  elements.menuBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    elements.dropdownMenu.style.display = elements.dropdownMenu.style.display === 'flex' ? 'none' : 'flex';
  });

  document.addEventListener('click', (e) => {
    if (!elements.menuBtn.contains(e.target) && !elements.dropdownMenu.contains(e.target)) {
      elements.dropdownMenu.style.display = 'none';
    }
  });

  elements.blockUserBtn.addEventListener('click', handleBlockUser);

  // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙˆØ³Ø§Ø¦Ø·
  elements.galleryBtn.addEventListener('click', () => elements.imageInput.click());
  elements.videoBtn.addEventListener('click', () => elements.videoInput.click());
  elements.cameraBtn.addEventListener('click', () => elements.cameraInput.click());

  [elements.imageInput, elements.videoInput, elements.cameraInput].forEach(input => {
    input.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) handleMediaUpload(file);
      e.target.value = '';
    });
  });

  // Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙˆØ³Ø§Ø¦Ø·
  elements.cancelMediaBtn.addEventListener('click', () => {
    elements.mediaPreview.style.display = 'none';
  });

  elements.mediaPreview.addEventListener('click', (e) => {
    if (e.target === elements.mediaPreview) {
      elements.mediaPreview.style.display = 'none';
    }
  });

  // Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª ÙˆØ§Ù„Ù‚ÙˆØ§Ø¦Ù…
  elements.editProfileBtn.addEventListener('click', () => {
    elements.dropdownMenu.style.display = 'none';
    const userData = usersData.get(currentUser.uid);
    elements.editUsername.value = userData?.username || '';
    elements.editStatus.value = userData?.status || '';
    elements.editProfileModal.style.display = 'flex';
  });

  elements.saveProfileBtn.addEventListener('click', async () => {
    const newUsername = elements.editUsername.value.trim();
    const newStatus = elements.editStatus.value.trim();
    
    if (newUsername && currentUser) {
      try {
        await updateDoc(doc(db, "users", currentUser.uid), {
          username: newUsername,
          status: newStatus
        });
        
        document.getElementById('currentUsername').textContent = newUsername;
        document.getElementById('currentUserStatus').textContent = newStatus;
        elements.editProfileModal.style.display = 'none';
      } catch (error) {
        console.error("Error updating profile:", error);
      }
    }
  });

  elements.cancelProfileBtn.addEventListener('click', () => {
    elements.editProfileModal.style.display = 'none';
  });

  elements.notificationSettingsBtn.addEventListener('click', () => {
    elements.dropdownMenu.style.display = 'none';
    elements.enableNotifications.checked = notificationsEnabled;
    elements.enableSounds.checked = soundsEnabled;
    elements.notificationModal.style.display = 'flex';
  });

  elements.saveNotificationBtn.addEventListener('click', () => {
    notificationsEnabled = elements.enableNotifications.checked;
    soundsEnabled = elements.enableSounds.checked;
    localStorage.setItem('notificationsEnabled', notificationsEnabled);
    localStorage.setItem('soundsEnabled', soundsEnabled);
    elements.notificationModal.style.display = 'none';
  });

  elements.cancelNotificationBtn.addEventListener('click', () => {
    elements.notificationModal.style.display = 'none';
  });

  // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙˆÙ†
  elements.blockedUsersBtn.addEventListener('click', () => {
    elements.dropdownMenu.style.display = 'none';
    renderBlockedUsersList();
    elements.blockedUsersModal.style.display = 'flex';
  });

  elements.closeBlockedUsersBtn.addEventListener('click', () => {
    elements.blockedUsersModal.style.display = 'none';
  });

  // Ø¹Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
  elements.aboutBtn.addEventListener('click', () => {
    elements.dropdownMenu.style.display = 'none';
    elements.aboutModal.style.display = 'flex';
  });

  elements.closeAboutBtn.addEventListener('click', () => {
    elements.aboutModal.style.display = 'none';
  });

  // Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨
  elements.deleteAccountBtn.addEventListener('click', () => {
    elements.dropdownMenu.style.display = 'none';
    elements.confirmDeletePassword.value = '';
    elements.deleteAccountModal.style.display = 'flex';
  });

  elements.confirmDeleteBtn.addEventListener('click', deleteAccount);
  elements.cancelDeleteBtn.addEventListener('click', () => {
    elements.deleteAccountModal.style.display = 'none';
  });

  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
  elements.logoutBtn.addEventListener('click', async () => {
    elements.dropdownMenu.style.display = 'none';
    try {
      if (currentUser) {
        await updateOnlineStatus(false);
        await signOut(auth);
      }
    } catch (error) {
      console.error("Error during logout:", error);
    }
  });

  // Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ±Ø­ÙŠØ¨
  elements.welcomeModalOkBtn.addEventListener('click', () => {
    elements.welcomeModal.style.display = 'none';
  });

  // Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø­Ø¸Ø±
  elements.cancelBlockBtn.addEventListener('click', () => {
    elements.blockModal.style.display = 'none';
  });

  // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª Ø¨Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§
  [
    elements.editProfileModal, 
    elements.notificationModal, 
    elements.welcomeModal, 
    elements.blockModal,
    elements.blockedUsersModal,
    elements.aboutModal,
    elements.deleteAccountModal
  ].forEach(modal => {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    });
  });

  // Service Worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')
        .then((registration) => {
          console.log('SW registered: ', registration);
        })
        .catch((registrationError) => {
          console.log('SW registration failed: ', registrationError);
        });
    });
  }

  // Ø¬Ø¹Ù„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…ØªØ§Ø­Ø© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹
  window.showMediaPreview = showMediaPreview;

</script>
</body>
</html>
