<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ’¬ Ø¯Ø±Ø¯Ø´Ø© ÙÙˆØ±ÙŠØ© - ChatPro</title>
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQ2hhdFBybyIsInNob3J0X25hbWUiOiJDaGF0UHJvIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiM2YTExY2IiLCJ0aGVtZV9jb2xvciI6IiM2YTExY2IiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTWpRd0lpQm9aV2xuYUhROUlqSTBNQ0lpSUhacFpYZENiM2c5SWpBZ01DQXlOREFnTWpRd0lpQm1hV3hzUFNJaU5tRXhNV05pSWo0OGNtVmpkQ0IzYVdSMGFEMGlNalF3SWlCb1pXbG5hSFE5SWpJME1DSWdabWxzYkQwaWQyaHBkR1VpTHo0OGRHVjRkQ0I0UFNJeE1qQWlJSGs5SWpFeU1DSWdabTl1ZEMxbVlXMXBiSGs5SWtGeWFXRnNJaUJtYjI1MExYTnBlbVU5SWpNd0lpQm1hV3hzUFNJaU5tRXhNV05pSWo0Z1EyaGhkRkJ5Ynp3dmRHVjRkRDQ4TDNOMlp6ND0iLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      direction: rtl;
      text-align: right;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100vh;
      overflow: hidden;
    }

    /* Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
    #authContainer {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      width: 400px;
      z-index: 1000;
    }

    #authContainer h2 {
      text-align: center;
      margin-bottom: 30px;
      color: #6a11cb;
      font-size: 28px;
    }

    input, button {
      width: 100%;
      padding: 15px;
      margin: 10px 0;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    input:focus {
      border-color: #6a11cb;
      outline: none;
      box-shadow: 0 0 10px rgba(106, 17, 203, 0.2);
    }

    button {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      text-transform: uppercase;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(106, 17, 203, 0.3);
    }

    #toggleFormBtn {
      background: transparent;
      color: #6a11cb;
      border: 2px solid #6a11cb;
    }

    #errorMsg {
      color: #e74c3c;
      text-align: center;
      min-height: 20px;
      font-weight: bold;
    }

    /* Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
    #app {
      display: none;
      height: 100vh;
      background: white;
    }

    /* Ø´Ø±ÙŠØ· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ù„ÙˆÙŠ */
    #appHeader {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    #appLogo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 24px;
      font-weight: bold;
    }

    #appLogo::before {
      content: "ğŸ’¬";
      font-size: 30px;
    }

    #userInfo {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    #userAvatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid white;
    }

    #menuBtn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 10px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 18px;
    }

    /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† */
    #usersListContainer {
      width: 100%;
      height: calc(100vh - 70px);
      background: #f8f9fa;
      padding: 20px;
      overflow-y: auto;
    }

    #searchContainer {
      position: relative;
      margin-bottom: 20px;
    }

    #searchInput {
      width: 100%;
      padding: 15px 50px 15px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 25px;
      font-size: 16px;
      background: white;
    }

    #searchInput::placeholder {
      color: #999;
    }

    #searchContainer::after {
      content: "ğŸ”";
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 18px;
    }

    .user-card {
      background: white;
      border-radius: 15px;
      padding: 15px;
      margin: 10px 0;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      gap: 15px;
      position: relative;
    }

    .user-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }

    .user-card.blocked {
      opacity: 0.5;
      background: #ffebee;
    }

    .user-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      position: relative;
    }

    .online-indicator {
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 12px;
      height: 12px;
      background: #4caf50;
      border: 2px solid white;
      border-radius: 50%;
      display: none;
    }

    .online-indicator.online {
      display: block;
    }

    .user-info h4 {
      margin: 0;
      color: #333;
      font-size: 16px;
    }

    .user-status {
      color: #666;
      font-size: 14px;
      margin-top: 2px;
    }

    .last-seen {
      color: #999;
      font-size: 12px;
      margin-top: 2px;
    }

    .unread-count {
      position: absolute;
      top: 10px;
      left: 10px;
      background: #e74c3c;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }

    .unread-count.show {
      display: flex;
    }

    /* Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© */
    #chatContainer {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      z-index: 1000;
      flex-direction: column;
    }

    #chatHeader {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    #chatUserInfo {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    #chatUserAvatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid white;
      position: relative;
    }

    #chatUserName {
      font-size: 18px;
      font-weight: bold;
    }

    #chatUserStatus {
      font-size: 14px;
      opacity: 0.8;
    }

    #chatControls {
      display: flex;
      gap: 10px;
    }

    .chat-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }

    #backBtn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }

    /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
    #messagesArea {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
    }

    .message-wrapper {
      display: flex;
      margin: 10px 0;
      position: relative;
    }

    .message-wrapper.sent {
      justify-content: flex-end;
    }

    .message-wrapper.received {
      justify-content: flex-start;
    }

    .message {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 18px;
      position: relative;
      word-wrap: break-word;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .message.sent {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      border-bottom-right-radius: 5px;
    }

    .message.received {
      background: white;
      color: #333;
      border: 1px solid #e0e0e0;
      border-bottom-left-radius: 5px;
    }

    .message-time {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 5px;
      text-align: left;
    }

    .message-media {
      border-radius: 10px;
      overflow: hidden;
      position: relative;
      margin-bottom: 5px;
    }

    .message-media img,
    .message-media video {
      width: 100%;
      max-width: 300px;
      height: auto;
      border-radius: 10px;
    }

    .media-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      border-radius: 50%;
      font-size: 20px;
    }

    .message-options {
      position: absolute;
      top: 0;
      left: -30px;
      display: none;
      flex-direction: column;
      gap: 5px;
    }

    .message-wrapper:hover .message-options {
      display: flex;
    }

    .message-option {
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      padding: 5px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 12px;
      width: 25px;
      height: 25px;
    }

    /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
    #inputContainer {
      background: white;
      padding: 15px 20px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #messageInput {
      flex: 1;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 25px;
      font-size: 16px;
      resize: none;
      max-height: 100px;
    }

    .input-btn {
      background: #6a11cb;
      color: white;
      border: none;
      padding: 12px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      width: 45px;
      height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .input-btn:hover {
      background: #2575fc;
    }

    /* Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© */
    #dropdownMenu {
      position: fixed;
      top: 70px;
      right: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      display: none;
      flex-direction: column;
      min-width: 200px;
      z-index: 2000;
      overflow: hidden;
    }

    .dropdown-item {
      padding: 15px 20px;
      border: none;
      background: transparent;
      text-align: right;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .dropdown-item:hover {
      background: #f8f9fa;
    }

    .dropdown-item.danger {
      color: #e74c3c;
    }

    .dropdown-item.danger:hover {
      background: #ffebee;
    }

    /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 3000;
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      width: 90%;
      max-width: 400px;
      position: relative;
    }

    .modal h3 {
      margin-bottom: 20px;
      text-align: center;
      color: #333;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }

    /* Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù„ÙØ§Øª */
    #mediaPreview {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 4000;
    }

    #mediaPreview img,
    #mediaPreview video {
      max-width: 90%;
      max-height: 90%;
      border-radius: 10px;
    }

    .preview-controls {
      position: absolute;
      bottom: 50px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 15px;
    }

    .preview-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 15px 25px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      backdrop-filter: blur(10px);
    }

    /* Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© */
    .typing-indicator {
      display: none;
      padding: 10px 20px;
      color: #666;
      font-style: italic;
      font-size: 14px;
    }

    .typing-dots {
      display: inline-block;
      position: relative;
    }

    .typing-dots::after {
      content: '';
      animation: typing 1.5s infinite;
    }

    @keyframes typing {
      0%, 60%, 100% { content: ''; }
      30% { content: '.'; }
      60% { content: '..'; }
      90% { content: '...'; }
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø¬ÙˆØ§Ù„ */
    @media (max-width: 768px) {
      #authContainer {
        width: 90%;
        padding: 30px 20px;
      }

      .message {
        max-width: 85%;
      }

      #inputContainer {
        padding: 10px;
      }

      .user-card {
        padding: 12px;
      }

      #appLogo {
        font-size: 20px;
      }
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© */
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .slide-in {
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }

    /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #6a11cb;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ØªØ­Ø³ÙŠÙ† Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: #6a11cb;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #2575fc;
    }
  </style>
</head>
<body>

<!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="authContainer">
  <h2 id="formTitle">ğŸ’¬ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ChatPro</h2>
  <input type="email" id="email" placeholder="ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" />
  <input type="password" id="password" placeholder="ğŸ”’ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
  <input type="text" id="username" placeholder="ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…" style="display: none;" />
  <input type="text" id="status" placeholder="âœ¨ Ø§Ù„Ø­Ø§Ù„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="display: none;" />
  <div id="errorMsg"></div>
  <button id="submitBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
  <button id="toggleFormBtn">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
</div>

<!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
<div id="app">
  <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
  <div id="appHeader">
    <div id="appLogo">ChatPro</div>
    <div id="userInfo">
      <img id="userAvatar" src="" alt="Avatar" />
      <div>
        <div id="currentUsername"></div>
        <div id="currentUserStatus" style="font-size: 12px; opacity: 0.8;"></div>
      </div>
      <button id="menuBtn">âš™ï¸</button>
    </div>
  </div>

  <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
  <div id="usersListContainer">
    <div id="searchContainer">
      <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…..." />
    </div>
    <div id="usersList"></div>
  </div>
</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
<div id="chatContainer">
  <div id="chatHeader">
    <div style="display: flex; align-items: center; gap: 15px;">
      <button id="backBtn">â†</button>
      <div id="chatUserInfo">
        <img id="chatUserAvatar" src="" alt="Avatar" />
        <div>
          <div id="chatUserName"></div>
          <div id="chatUserStatus"></div>
        </div>
      </div>
    </div>
    <div id="chatControls">
      <button class="chat-btn" id="blockUserBtn" title="Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">ğŸš«</button>
      <button class="chat-btn" id="clearChatBtn" title="Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©">ğŸ—‘ï¸</button>
    </div>
  </div>

  <div id="messagesArea"></div>
  
  <div class="typing-indicator" id="typingIndicator">
    <span id="typingUser"></span> ÙŠÙƒØªØ¨<span class="typing-dots"></span>
  </div>

  <div id="inputContainer">
    <button class="input-btn" id="cameraBtn" title="Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø©">ğŸ“·</button>
    <button class="input-btn" id="galleryBtn" title="Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©">ğŸ–¼ï¸</button>
    <button class="input-btn" id="videoBtn" title="Ø§Ø®ØªÙŠØ§Ø± ÙÙŠØ¯ÙŠÙˆ">ğŸ¥</button>
    <textarea id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." rows="1"></textarea>
    <button class="input-btn" id="sendBtn" title="Ø¥Ø±Ø³Ø§Ù„">ğŸ“¤</button>
  </div>
</div>

<!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© -->
<div id="dropdownMenu">
  <button class="dropdown-item" id="editProfileBtn">
    âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
  </button>
  <button class="dropdown-item" id="notificationSettingsBtn">
    ğŸ”” Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
  </button>
  <button class="dropdown-item" id="blockedUsersBtn">
    ğŸš« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†
  </button>
  <button class="dropdown-item" id="aboutBtn">
    â„¹ï¸ Ø¹Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
  </button>
  <button class="dropdown-item danger" id="logoutBtn">
    ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
  </button>
  <button class="dropdown-item danger" id="deleteAccountBtn">
    âŒ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨
  </button>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
<div class="modal" id="editProfileModal">
  <div class="modal-content">
    <h3>âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>
    <input type="text" id="editUsername" placeholder="ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…" />
    <input type="text" id="editStatus" placeholder="âœ¨ Ø§Ù„Ø­Ø§Ù„Ø©" />
    <div class="modal-buttons">
      <button id="saveProfileBtn">ğŸ’¾ Ø­ÙØ¸</button>
      <button id="cancelProfileBtn">âŒ Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
<div class="modal" id="notificationModal">
  <div class="modal-content">
    <h3>ğŸ”” Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3>
    <label>
      <input type="checkbox" id="enableNotifications" checked /> ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    </label>
    <br><br>
    <label>
      <input type="checkbox" id="enableSounds" checked /> ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£ØµÙˆØ§Øª
    </label>
    <div class="modal-buttons">
      <button id="saveNotificationBtn">ğŸ’¾ Ø­ÙØ¸</button>
      <button id="cancelNotificationBtn">âŒ Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙˆØ³Ø§Ø¦Ø· -->
<div id="mediaPreview">
  <div id="previewContent"></div>
  <div class="preview-controls">
    <button class="preview-btn" id="sendMediaBtn">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„</button>
    <button class="preview-btn" id="cancelMediaBtn">âŒ Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</div>

<!-- Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø®ÙÙŠØ© -->
<input type="file" id="imageInput" accept="image/*" style="display: none;" />
<input type="file" id="videoInput" accept="video/*" style="display: none;" />
<input type="file" id="cameraInput" accept="image/*" capture="camera" style="display: none;" />

<!-- ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
<audio id="notificationSound" preload="auto">
  <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMeBC2I0fPTgjEGHm7A7+OZURE" type="audio/wav">
</audio>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, deleteUser } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, getDocs, doc, setDoc, deleteDoc, where, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAm0hh9I6i58ywW1D2gZg09liG-wG-tBsU",
    authDomain: "chat-fat-4f082.firebaseapp.com",
    projectId: "chat-fat-4f082",
    storageBucket: "chat-fat-4f082.appspot.com",
    messagingSenderId: "297367474930",
    appId: "1:297367474930:web:a05b983e05a0ba257fb66b",
    measurementId: "G-MBGC7KZ8H0"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
  let currentUser = null;
  let currentChatUser = null;
  let unsubscribeMessages = null;
  let unsubscribeUsers = null;
  let isLogin = true;
  let blockedUsers = new Set();
  let onlineUsers = new Set();
  let typingUsers = new Map();
  let typingTimeout = null;
  let notificationsEnabled = true;
  let soundsEnabled = true;
  let selectedMedia = null;

  // Ø¹Ù†Ø§ØµØ± DOM
  const authContainer = document.getElementById('authContainer');
  const app_div = document.getElementById('app');
  const chatContainer = document.getElementById('chatContainer');
  const formTitle = document.getElementById('formTitle');
  const submitBtn = document.getElementById('submitBtn');
  const toggleFormBtn = document.getElementById('toggleFormBtn');
  const errorMsg = document.getElementById('errorMsg');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const usernameInput = document.getElementById('username');
  const statusInput = document.getElementById('status');
  const usersList = document.getElementById('usersList');
  const searchInput = document.getElementById('searchInput');
  const messagesArea = document.getElementById('messagesArea');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const backBtn = document.getElementById('backBtn');
  const menuBtn = document.getElementById('menuBtn');
  const dropdownMenu = document.getElementById('dropdownMenu');
  const notificationSound = document.getElementById('notificationSound');

  // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
  function updateUserPresence(online) {
    if (!currentUser) return;
    
    const userRef = doc(db, "users", currentUser.uid);
    updateDoc(userRef, {
      online: online,
      lastSeen: serverTimestamp()
    });
  }

  // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø§ÙØ°Ø©
  document.addEventListener('visibilitychange', () => {
    if (currentUser) {
      updateUserPresence(!document.hidden);
    }
  });

  // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬
  window.addEventListener('beforeunload', () => {
    if (currentUser) {
      updateUserPresence(false);
    }
  });

  // ØªØ¨Ø¯ÙŠÙ„ Ù†Ù…Ø§Ø°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  toggleFormBtn.addEventListener('click', () => {
    isLogin = !isLogin;
    errorMsg.textContent = '';
    
    if (isLogin) {
      formTitle.innerHTML = 'ğŸ’¬ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ChatPro';
      submitBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
      toggleFormBtn.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯';
      usernameInput.style.display = 'none';
      statusInput.style.display = 'none';
    } else {
      formTitle.innerHTML = 'ğŸš€ Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ ChatPro';
      submitBtn.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨';
      toggleFormBtn.textContent = 'Ù„Ø¯ÙŠ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„';
      usernameInput.style.display = 'block';
      statusInput.style.display = 'block';
    }
  });

  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨
  submitBtn.addEventListener('click', async () => {
    errorMsg.textContent = '';
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    const username = usernameInput.value.trim();
    const status = statusInput.value.trim() || "Ù…ØªØ§Ø­ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø© ğŸ’¬";

    if (!email || !password || (!isLogin && !username)) {
      errorMsg.textContent = 'âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©';
      return;
    }

    try {
      submitBtn.innerHTML = '<div class="loading"></div>';
      
      if (isLogin) {
        await signInWithEmailAndPassword(auth, email, password);
      } else {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        await setDoc(doc(db, "users", user.uid), {
          email: user.email,
          username,
          status,
          photoURL: `https://ui-avatars.com/api/?name=${encodeURIComponent(username)}&background=6a11cb&color=fff&rounded=true&size=128`,
          online: true,
          lastSeen: serverTimestamp(),
          createdAt: serverTimestamp()
        });
      }
    } catch (error) {
      errorMsg.textContent = getErrorMessage(error.code);
      submitBtn.textContent = isLogin ? 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„' : 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨';
    }
  });

  // Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø·Ø£ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
  function getErrorMessage(errorCode) {
    const errors = {
      'auth/email-already-in-use': 'ğŸ“§ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹',
      'auth/weak-password': 'ğŸ”’ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ©',
      'auth/user-not-found': 'ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯',
      'auth/wrong-password': 'ğŸ”’ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©',
      'auth/invalid-email': 'ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­'
    };
    return errors[errorCode] || 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
  }

  // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      await initializeApp_();
      updateUserPresence(true);
      requestNotificationPermission();
    } else {
      currentUser = null;
      showAuthScreen();
      if (unsubscribeMessages) unsubscribeMessages();
      if (unsubscribeUsers) unsubscribeUsers();
    }
  });

  // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
  async function initializeApp_() {
    authContainer.style.display = 'none';
    app_div.style.display = 'block';
    
    // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
    const userDoc = await getDoc(doc(db, "users", currentUser.uid));
    if (userDoc.exists()) {
      const userData = userDoc.data();
      document.getElementById('currentUsername').textContent = userData.username;
      document.getElementById('currentUserStatus').textContent = userData.status;
      document.getElementById('userAvatar').src = userData.photoURL;
    }

    loadUsers();
    loadBlockedUsers();
  }

  // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  function showAuthScreen() {
    authContainer.style.display = 'block';
    app_div.style.display = 'none';
    chatContainer.style.display = 'none';
  }

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
  function loadUsers() {
    if (unsubscribeUsers) unsubscribeUsers();
    
    const usersRef = collection(db, "users");
    unsubscribeUsers = onSnapshot(usersRef, (snapshot) => {
      usersList.innerHTML = '';
      
      snapshot.forEach((doc) => {
        const userData = doc.data();
        if (userData.email !== currentUser.email) {
          createUserCard(userData);
        }
      });
    });
  }

  // Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ù…Ø³ØªØ®Ø¯Ù…
  function createUserCard(userData) {
    const userCard = document.createElement('div');
    userCard.className = 'user-card fade-in';
    userCard.dataset.email = userData.email;
    
    if (blockedUsers.has(userData.email)) {
      userCard.classList.add('blocked');
    }

    const isOnline = userData.online;
    const lastSeen = userData.lastSeen ? userData.lastSeen.toDate() : new Date();
    
    userCard.innerHTML = `
      <div class="user-avatar">
        <img src="${userData.photoURL}" alt="${userData.username}" width="50" height="50" />
        <div class="online-indicator ${isOnline ? 'online' : ''}"></div>
      </div>
      <div class="user-info">
        <h4>${userData.username}</h4>
        <div class="user-status">${userData.status}</div>
        ${!isOnline ? `<div class="last-seen">Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±: ${formatLastSeen(lastSeen)}</div>` : ''}
      </div>
      <div class="unread-count" id="unread-${userData.email}">0</div>
    `;

    userCard.addEventListener('click', () => {
      if (!blockedUsers.has(userData.email)) {
        openChat(userData);
      }
    });

    usersList.appendChild(userCard);
  }

  // ØªÙ†Ø³ÙŠÙ‚ Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±
  function formatLastSeen(date) {
    const now = new Date();
    const diff = now - date;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);

    if (minutes < 1) return 'Ø§Ù„Ø¢Ù†';
    if (minutes < 60) return `Ù…Ù†Ø° ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
    if (hours < 24) return `Ù…Ù†Ø° ${hours} Ø³Ø§Ø¹Ø©`;
    return `Ù…Ù†Ø° ${days} ÙŠÙˆÙ…`;
  }

  // ÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
  function openChat(userData) {
    currentChatUser = userData;
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    app_div.style.display = 'none';
    chatContainer.style.display = 'flex';
    chatContainer.classList.add('slide-in');
    
    // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    document.getElementById('chatUserName').textContent = userData.username;
    document.getElementById('chatUserStatus').textContent = userData.online ? 'Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù† ğŸŸ¢' : `Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±: ${formatLastSeen(userData.lastSeen?.toDate() || new Date())}`;
    document.getElementById('chatUserAvatar').src = userData.photoURL;
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    loadMessages();
    
    // Ù…Ø³Ø­ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©
    clearUnreadCount(userData.email);
  }

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
  function loadMessages() {
    if (unsubscribeMessages) unsubscribeMessages();
    
    messagesArea.innerHTML = '';
    
    const messagesRef = collection(db, "messages");
    const messagesQuery = query(
      messagesRef,
      orderBy("timestamp")
    );

    unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
      messagesArea.innerHTML = '';
      
      snapshot.forEach((doc) => {
        const messageData = doc.data();
        const messageId = doc.id;
        
        if (isMessageBetweenUsers(messageData, currentUser.email, currentChatUser.email)) {
          displayMessage(messageData, messageId);
          
          // ÙˆØ³Ù… Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙˆØ§Ø±Ø¯Ø©
          if (messageData.to === currentUser.email && !messageData.read) {
            markMessageAsRead(messageId);
          }
        }
      });
      
      scrollToBottom();
    });
  }

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
  function isMessageBetweenUsers(message, user1, user2) {
    return (message.from === user1 && message.to === user2) ||
           (message.from === user2 && message.to === user1);
  }

  // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
  function displayMessage(messageData, messageId) {
    const messageWrapper = document.createElement('div');
    messageWrapper.className = `message-wrapper ${messageData.from === currentUser.email ? 'sent' : 'received'}`;
    
    const message = document.createElement('div');
    message.className = `message ${messageData.from === currentUser.email ? 'sent' : 'received'}`;
    
    // Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    if (messageData.from === currentUser.email) {
      const messageOptions = document.createElement('div');
      messageOptions.className = 'message-options';
      messageOptions.innerHTML = `
        <button class="message-option" onclick="deleteMessage('${messageId}', 'me')" title="Ø­Ø°Ù Ù„Ø¯ÙŠ">ğŸ—‘ï¸</button>
        <button class="message-option" onclick="deleteMessage('${messageId}', 'all')" title="Ø­Ø°Ù Ù„Ù„Ø¬Ù…ÙŠØ¹">âŒ</button>
      `;
      messageWrapper.appendChild(messageOptions);
    }

    // Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    let messageContent = '';
    
    if (messageData.type === 'image') {
      messageContent = `
        <div class="message-media">
          <img src="${messageData.mediaURL}" alt="ØµÙˆØ±Ø©" onclick="openMediaPreview('${messageData.mediaURL}', 'image')" />
        </div>
      `;
    } else if (messageData.type === 'video') {
      messageContent = `
        <div class="message-media">
          <video src="${messageData.mediaURL}" controls onclick="openMediaPreview('${messageData.mediaURL}', 'video')"></video>
        </div>
      `;
    } else {
      messageContent = messageData.text || '';
    }
    
    const timestamp = messageData.timestamp ? messageData.timestamp.toDate() : new Date();
    
    message.innerHTML = `
      ${messageContent}
      ${messageData.text && messageData.type !== 'text' ? `<div>${messageData.text}</div>` : ''}
      <div class="message-time">${formatTime(timestamp)}</div>
    `;
    
    messageWrapper.appendChild(message);
    messagesArea.appendChild(messageWrapper);
  }

  // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª
  function formatTime(date) {
    return date.toLocaleTimeString('ar-EG', {
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø³ÙÙ„
  function scrollToBottom() {
    messagesArea.scrollTop = messagesArea.scrollHeight;
  }

  // ÙˆØ³Ù… Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø©
  async function markMessageAsRead(messageId) {
    const messageRef = doc(db, "messages", messageId);
    await updateDoc(messageRef, { read: true });
  }

  // Ù…Ø³Ø­ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©
  function clearUnreadCount(userEmail) {
    const unreadElement = document.getElementById(`unread-${userEmail}`);
    if (unreadElement) {
      unreadElement.classList.remove('show');
      unreadElement.textContent = '0';
    }
  }

  // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
  async function sendMessage(text = '', type = 'text', mediaURL = '') {
    if ((!text.trim() && !mediaURL) || !currentChatUser) return;
    
    const messageData = {
      from: currentUser.email,
      to: currentChatUser.email,
      text: text.trim(),
      type,
      timestamp: serverTimestamp(),
      read: false
    };
    
    if (mediaURL) {
      messageData.mediaURL = mediaURL;
    }
    
    try {
      await addDoc(collection(db, "messages"), messageData);
      messageInput.value = '';
      
      // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±
      if (notificationsEnabled) {
        sendNotification(currentChatUser.username, text || 'ÙˆØ³Ø§Ø¦Ø·');
      }
      
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', error);
    }
  }

  // Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
  async function uploadFile(file) {
    const fileRef = ref(storage, `media/${Date.now()}_${file.name}`);
    const snapshot = await uploadBytes(fileRef, file);
    return await getDownloadURL(snapshot.ref);
  }

  // Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙˆØ³Ø§Ø¦Ø·
  function showMediaPreview(file, type) {
    selectedMedia = { file, type };
    const previewContent = document.getElementById('previewContent');
    
    if (type === 'image') {
      previewContent.innerHTML = `<img src="${URL.createObjectURL(file)}" alt="Ù…Ø¹Ø§ÙŠÙ†Ø©" />`;
    } else if (type === 'video') {
      previewContent.innerHTML = `<video src="${URL.createObjectURL(file)}" controls></video>`;
    }
    
    document.getElementById('mediaPreview').style.display = 'flex';
  }

  // Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©
  window.deleteMessage = async function(messageId, deleteType) {
    if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ')) return;
    
    try {
      if (deleteType === 'all') {
        await deleteDoc(doc(db, "messages", messageId));
      } else {
        // Ø­Ø°Ù Ù…Ø­Ù„ÙŠ ÙÙ‚Ø· - ÙŠÙ…ÙƒÙ† ØªØ·Ø¨ÙŠÙ‚ Ù…Ù†Ø·Ù‚ Ù…Ø®ØªÙ„Ù Ù‡Ù†Ø§
        const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
        if (messageElement) {
          messageElement.style.opacity = '0.3';
          messageElement.innerHTML = '<em>ØªÙ… Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</em>';
        }
      }
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', error);
    }
  };

  // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
  async function requestNotificationPermission() {
    if ('Notification' in window) {
      const permission = await Notification.requestPermission();
      notificationsEnabled = permission === 'granted';
    }
  }

  // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±
  function sendNotification(title, body) {
    if (notificationsEnabled && document.hidden) {
      new Notification(`ğŸ’¬ ${title}`, {
        body,
        icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQwIiBoZWlnaHQ9IjI0MCIgdmlld0JveD0iMCAwIDI0MCAyNDAiIGZpbGw9IiM2YTExY2IiPjxyZWN0IHdpZHRoPSIyNDAiIGhlaWdodD0iMjQwIiBmaWxsPSJ3aGl0ZSIvPjx0ZXh0IHg9IjEyMCIgeT0iMTIwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMzAiIGZpbGw9IiM2YTExY2IiPiBDaGF0UHJvPC90ZXh0Pjwvc3ZnPg=='
      });
    }
    
    if (soundsEnabled) {
      notificationSound.play();
    }
  }

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†
  async function loadBlockedUsers() {
    const userDoc = await getDoc(doc(db, "users", currentUser.uid));
    if (userDoc.exists() && userDoc.data().blockedUsers) {
      blockedUsers = new Set(userDoc.data().blockedUsers);
    }
  }

  // Ø­Ø¸Ø±/Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…
  async function toggleBlockUser(userEmail) {
    const userRef = doc(db, "users", currentUser.uid);
    
    if (blockedUsers.has(userEmail)) {
      blockedUsers.delete(userEmail);
    } else {
      blockedUsers.add(userEmail);
    }
    
    await updateDoc(userRef, {
      blockedUsers: Array.from(blockedUsers)
    });
    
    loadUsers();
  }

  // Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
  sendBtn.addEventListener('click', () => sendMessage(messageInput.value));
  
  messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage(messageInput.value);
    }
  });

  backBtn.addEventListener('click', () => {
    chatContainer.style.display = 'none';
    app_div.style.display = 'block';
    currentChatUser = null;
    if (unsubscribeMessages) unsubscribeMessages();
  });

  // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙˆØ³Ø§Ø¦Ø·
  document.getElementById('galleryBtn').addEventListener('click', () => {
    document.getElementById('imageInput').click();
  });

  document.getElementById('videoBtn').addEventListener('click', () => {
    document.getElementById('videoInput').click();
  });

  document.getElementById('cameraBtn').addEventListener('click', () => {
    document.getElementById('cameraInput').click();
  });

  // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±
  document.getElementById('imageInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      showMediaPreview(file, 'image');
    }
  });

  // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
  document.getElementById('videoInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      showMediaPreview(file, 'video');
    }
  });

  // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±
  document.getElementById('cameraInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      showMediaPreview(file, 'image');
    }
  });

  // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·
  document.getElementById('sendMediaBtn').addEventListener('click', async () => {
    if (selectedMedia) {
      try {
        document.getElementById('sendMediaBtn').innerHTML = '<div class="loading"></div>';
        
        const mediaURL = await uploadFile(selectedMedia.file);
        await sendMessage('', selectedMedia.type, mediaURL);
        
        document.getElementById('mediaPreview').style.display = 'none';
        selectedMedia = null;
      } catch (error) {
        alert('ÙØ´Ù„ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù');
        console.error(error);
      }
      
      document.getElementById('sendMediaBtn').innerHTML = 'ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„';
    }
  });

  // Ø¥Ù„ØºØ§Ø¡ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙˆØ³Ø§Ø¦Ø·
  document.getElementById('cancelMediaBtn').addEventListener('click', () => {
    document.getElementById('mediaPreview').style.display = 'none';
    selectedMedia = null;
  });

  // Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
  menuBtn.addEventListener('click', () => {
    dropdownMenu.style.display = dropdownMenu.style.display === 'flex' ? 'none' : 'flex';
  });

  // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
  document.addEventListener('click', (e) => {
    if (!menuBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
      dropdownMenu.style.display = 'none';
    }
  });

  // Ø§Ù„Ø¨Ø­Ø«
  searchInput.addEventListener('input', (e) => {
    const searchTerm = e.target.value.toLowerCase();
    const userCards = document.querySelectorAll('.user-card');
    
    userCards.forEach(card => {
      const username = card.querySelector('h4').textContent.toLowerCase();
      card.style.display = username.includes(searchTerm) ? 'flex' : 'none';
    });
  });

  // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
      updateUserPresence(false);
      await signOut(auth);
    }
  });

  document.getElementById('deleteAccountBtn').addEventListener('click', async () => {
    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) {
      try {
        await deleteDoc(doc(db, "users", currentUser.uid));
        await deleteUser(currentUser);
      } catch (error) {
        alert('ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨');
      }
    }
  });

  document.getElementById('blockUserBtn').addEventListener('click', () => {
    if (currentChatUser) {
      const isBlocked = blockedUsers.has(currentChatUser.email);
      if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ ${isBlocked ? 'Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø±' : 'Ø­Ø¸Ø±'} ${currentChatUser.username}ØŸ`)) {
        toggleBlockUser(currentChatUser.email);
      }
    }
  });

  document.getElementById('clearChatBtn').addEventListener('click', () => {
    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©ØŸ')) {
      // ÙŠÙ…ÙƒÙ† ØªÙ†ÙÙŠØ° Ù…Ù†Ø·Ù‚ Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù‡Ù†Ø§
      messagesArea.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</div>';
    }
  });

  // Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙˆØ³Ø§Ø¦Ø· ÙÙŠ ÙˆØ¶Ø¹ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©
  window.openMediaPreview = function(url, type) {
    const previewContent = document.getElementById('previewContent');
    
    if (type === 'image') {
      previewContent.innerHTML = `<img src="${url}" alt="ØµÙˆØ±Ø©" />`;
    } else if (type === 'video') {
      previewContent.innerHTML = `<video src="${url}" controls></video>`;
    }
    
    document.getElementById('mediaPreview').style.display = 'flex';
    
    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ©
    document.getElementById('mediaPreview').onclick = (e) => {
      if (e.target === e.currentTarget) {
        document.getElementById('mediaPreview').style.display = 'none';
      }
    };
  };

  // ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„ØªØ¬Ø±Ø¨Ø©
  
  // ØªØ­Ø¯ÙŠØ« Ø­Ø¬Ù… textarea ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
  messageInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 100) + 'px';
  });

  // Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ Ø§ØªØµØ§Ù„/Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„
  window.addEventListener('online', () => {
    if (currentUser) updateUserPresence(true);
  });

  window.addEventListener('offline', () => {
    if (currentUser) updateUserPresence(false);
  });

  console.log('ğŸ’¬ ChatPro ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¨Ù†Ø¬Ø§Ø­!');
</script>

</body>
</html>

