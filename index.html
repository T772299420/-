<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>دردشة فورية</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      direction: rtl;
      text-align: right;
      margin: 0; padding: 0; background: #f0f0f0;
      display: flex; justify-content: center; align-items: center; height: 100vh;
    }
    #authContainer, #app {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      width: 350px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    #app {
      margin-top: 50px; /* ارتفاع الشريط العلوي */
      height: calc(100vh - 50px);
      width: 900px;
      flex-direction: row;
      gap: 15px;
      display: none;
    }
    input, button {
      padding: 10px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
      outline: none;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      cursor: pointer;
      background: #6a11cb;
      color: white;
      border: none;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #4a07a0;
    }
    #errorMsg {
      color: red;
      min-height: 20px;
    }
    #username, #status {
      display: none;
    }
    /* الشريط العلوي */
    #topBar {
      position: fixed;
      top: 0; right: 0; left: 0;
      height: 50px;
      background: #6a11cb;
      color: white;
      display: flex;
      align-items: center;
      justify-content: flex-start; /* زر القائمة على اليمين، اسم المستخدم على يساره */
      gap: 15px;
      padding: 0 15px;
      z-index: 1000;
      box-sizing: border-box;
      font-weight: bold;
      font-size: 16px;
      direction: rtl;
    }
  #menuBtn {
  background: #6a11cb;
  color: white;
  border: none;
  padding: 6px;
  font-size: 20px;
  border-radius: 50px;
  cursor: pointer;
  height: 50px;
  width: 50px;
  flex-grow: 0;
  flex-shrink: 0;
  box-sizing: border-box;
  display: flex;
  align-items: center;
  justify-content: center;
}
    
    #usernameDisplay {
      flex-grow: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    /* القائمة المنسدلة */
    #dropdownMenu {
      position: fixed;
      top: 50px;
      right: 15px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      display: none;
      flex-direction: column;
      min-width: 180px;
      z-index: 1001;
    }
    #dropdownMenu button {
  color: #e74c3c;
  background: transparent;
  border: none;
  padding: 10px 15px;
  text-align: left;    /* النص يبدأ من اليسار */
  direction: ltr;      /* اتجاه النص من اليسار لليمين */
  font-weight: 700;
  font-family: 'Arial Black', Arial, sans-serif;
  width: 100%;
  cursor: pointer;
  font-size: 20px;
  transition: background-color 0.3s, color 0.3s;
  border-radius: 0;
}
#dropdownMenu button:hover {
  background-color: #f0f0f0;
  color: #c0392b; /* لون أغمق عند التمرير */
}
    #dropdownMenu button {
      background: transparent;
      border: none;
      text-align: right;
      padding: 10px 15px;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
      box-sizing: border-box;
      transition: background 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: flex-end;
    }
    #dropdownMenu button:hover {
      background: #f0f0f0;
    }
    #dropdownMenu button:last-child {
      border-bottom-left-radius: 5px;
      border-bottom-right-radius: 5px;
    }
    /* المحادثات */
    #conversationsList {
      width: 250px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 5px;
      overflow-y: auto;
      height: 100%;
      padding: 10px;
      box-sizing: border-box;
    }
    .conversation {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      position: relative;
    }
    .conversation:hover {
      background-color: #f7f7f7;
    }
    .unread-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      background: red;
      color: white;
      border-radius: 50%;
      font-size: 12px;
      padding: 2px 7px;
      display: none;
    }
    /* نافذة المحادثة */
    #chatWindow {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 5px;
      height: 100%;
    }
    #chatHeader {
      padding: 15px;
      font-weight: bold;
      border-bottom: 1px solid #ddd;
      background: #6a11cb;
      color: white;
      font-size: 18px;
    }
    #messages {
      flex-grow: 1;
      padding: 10px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: #f9f9f9;
    }
    .message {
      max-width: 60%;
      padding: 10px;
      border-radius: 10px;
      position: relative;
      word-wrap: break-word;
    }
    .sent {
      background-color: #dcf8c6;
      align-self: flex-end;
    }
    .received {
      background-color: #fff;
      align-self: flex-start;
      border: 1px solid #ddd;
    }
    .time {
      font-size: 10px;
      color: gray;
      margin-top: 4px;
      text-align: left;
    }
    #inputArea {
      display: flex;
      padding: 10px;
      border-top: 1px solid #ddd;
      gap: 10px;
      background: #fff;
    }
    #inputArea input {
      flex-grow: 1;
    }
  </style>
</head>
<body>

<!-- الشريط العلوي -->
<div id="topBar">
  <button id="menuBtn" aria-haspopup="true" aria-expanded="false">☰</button>
  <span id="usernameDisplay"></span>
</div>

<!-- القائمة المنسدلة -->
<div id="dropdownMenu" role="menu" aria-label="قائمة المستخدم">
  <button id="editProfileBtn" role="menuitem">تعديل بيانات المستخدم</button>
  <button id="logoutMenuBtn" role="menuitem">تسجيل الخروج</button>
  <button id="deleteAccountMenuBtn" role="menuitem">حذف الحساب</button>
  <button id="aboutAppBtn" role="menuitem">عن التطبيق</button>
</div>

<!-- قسم تسجيل الدخول / إنشاء حساب -->
<div id="authContainer">
  <h2 id="formTitle">تسجيل الدخول</h2>
  <input type="email" id="email" placeholder="البريد الإلكتروني" />
  <input type="password" id="password" placeholder="كلمة المرور" />
  <input type="text" id="username" placeholder="الاسم" />
  <input type="text" id="status" placeholder="الحالة (اختياري)" />
  <div id="errorMsg"></div>
  <button id="submitBtn">تسجيل الدخول</button>
  <button id="toggleFormBtn">إنشاء حساب جديد</button>
</div>

<!-- قسم التطبيق (المحادثات والرسائل) -->
<div id="app">
  <div id="conversationsList"></div>
  <div id="chatWindow">
    <div id="chatHeader">اختر محادثة</div>
    <div id="messages"></div>
    <div id="inputArea" style="display:none;">
      <input type="text" id="messageInput" placeholder="اكتب رسالة..." />
      <button id="sendBtn">إرسال</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, deleteUser } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, getDocs, doc, setDoc, deleteDoc, where, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAm0hh9I6i58ywW1D2gZg09liG-wG-tBsU",
    authDomain: "chat-fat-4f082.firebaseapp.com",
    projectId: "chat-fat-4f082",
    storageBucket: "chat-fat-4f082.appspot.com",
    messagingSenderId: "297367474930",
    appId: "1:297367474930:web:a05b983e05a0ba257fb66b",
    measurementId: "G-MBGC7KZ8H0"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // عناصر الصفحة
  const authContainer = document.getElementById('authContainer');
  const appDiv = document.getElementById('app');
  const formTitle = document.getElementById('formTitle');
  const submitBtn = document.getElementById('submitBtn');
  const toggleFormBtn = document.getElementById('toggleFormBtn');
  const errorMsg = document.getElementById('errorMsg');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const usernameInput = document.getElementById('username');
  const statusInput = document.getElementById('status');
  const conversationsList = document.getElementById('conversationsList');
  const chatHeader = document.getElementById('chatHeader');
  const messagesDiv = document.getElementById('messages');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const inputArea = document.getElementById('inputArea');

  // عناصر القائمة العلوية
  const menuBtn = document.getElementById('menuBtn');
  const dropdownMenu = document.getElementById('dropdownMenu');
  const editProfileBtn = document.getElementById('editProfileBtn');
  const logoutMenuBtn = document.getElementById('logoutMenuBtn');
  const deleteAccountMenuBtn = document.getElementById('deleteAccountMenuBtn');
  const aboutAppBtn = document.getElementById('aboutAppBtn');
  const usernameDisplay = document.getElementById('usernameDisplay');

  let isLogin = true;
  let currentChatEmail = null;
  let currentChatUserData = null;
  let unsubscribeMessages = null;
  const unreadCounts = new Map();

  // تبديل بين تسجيل الدخول وإنشاء حساب
  toggleFormBtn.addEventListener('click', () => {
    isLogin = !isLogin;
    errorMsg.textContent = '';
    if (isLogin) {
      formTitle.textContent = 'تسجيل الدخول';
      submitBtn.textContent = 'تسجيل الدخول';
      toggleFormBtn.textContent = 'إنشاء حساب جديد';
      usernameInput.style.display = 'none';
      statusInput.style.display = 'none';
    } else {
      formTitle.textContent = 'إنشاء حساب جديد';
      submitBtn.textContent = 'إنشاء حساب';
      toggleFormBtn.textContent = 'لدي حساب بالفعل';
      usernameInput.style.display = 'block';
      statusInput.style.display = 'block';
    }
  });

  // تسجيل الدخول أو إنشاء الحساب
  submitBtn.addEventListener('click', async () => {
    errorMsg.textContent = '';
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    const username = usernameInput.value.trim();
    const status = statusInput.value.trim() || "مرحباً!";

    if (!email || !password || (!isLogin && !username)) {
      errorMsg.textContent = 'يرجى تعبئة جميع الحقول المطلوبة.';
      return;
    }

    try {
      if (isLogin) {
        await signInWithEmailAndPassword(auth, email, password);
      } else {
        await createUserWithEmailAndPassword(auth, email, password);
        const user = auth.currentUser;
        if (user) {
          const userDocRef = doc(db, "users", user.uid);
          await setDoc(userDocRef, {
            email: user.email,
            username,
            status,
            photoURL: `https://ui-avatars.com/api/?name=${encodeURIComponent(username)}&background=6a11cb&color=fff&rounded=true&size=128`,
          });
        }
        alert('تم إنشاء الحساب بنجاح!');
      }
    } catch (e) {
      errorMsg.textContent = e.message;
    }
  });

  // حالة الدخول
  onAuthStateChanged(auth, async user => {
    if (user) {
      authContainer.style.display = 'none';
      appDiv.style.display = 'flex';

      // جلب اسم المستخدم للعرض في الشريط العلوي
      const userDoc = await getDoc(doc(db, "users", user.uid));
      if (userDoc.exists()) {
        usernameDisplay.textContent = userDoc.data().username || user.email;
      } else {
        usernameDisplay.textContent = user.email;
      }

      await loadConversations();
      listenUnreadMessages();
    } else {
      authContainer.style.display = 'flex';
      appDiv.style.display = 'none';
      clearChat();
      usernameDisplay.textContent = '';
      if (unsubscribeMessages) unsubscribeMessages();
    }
  });

  // تحميل قائمة المحادثات (المستخدمين)
  async function loadConversations() {
    conversationsList.innerHTML = '';
    const usersSnapshot = await getDocs(collection(db, "users"));
    usersSnapshot.forEach(docSnap => {
      const userData = docSnap.data();
      if (auth.currentUser && userData.email !== auth.currentUser.email) {
        const div = document.createElement('div');
        div.classList.add('conversation');
        div.textContent = userData.username || userData.email;
        div.dataset.email = userData.email;

        const unreadBadge = document.createElement('span');
        unreadBadge.classList.add('unread-badge');
        div.appendChild(unreadBadge);

        div.addEventListener('click', () => {
          openChat(userData.email, userData);
        });

        conversationsList.appendChild(div);
      }
    });
  }

  // توليد معرف المحادثة بين مستخدمين (بترتيب)
  function getChatId(email1, email2) {
    return [email1, email2].sort().join("_");
  }

  // فتح محادثة مع مستخدم مع تعديل وضع الرسائل كمقروءة
  async function markMessagesAsRead(chatId, senderEmail) {
    const messagesRef = collection(db, "chats", chatId, "messages");
    const q = query(messagesRef, where("sender", "==", senderEmail), where("read", "==", false));
    const snapshot = await getDocs(q);
    snapshot.forEach(async docSnap => {
      await setDoc(doc(db, "chats", chatId, "messages", docSnap.id), { read: true }, { merge: true });
    });
  }

  function openChat(email, userData) {
    currentChatEmail = email;
    currentChatUserData = userData;
    chatHeader.textContent = `محادثة مع ${userData.username || email}`;
    messagesDiv.innerHTML = '';
    inputArea.style.display = 'flex';
    if (unsubscribeMessages) unsubscribeMessages();

    const chatId = getChatId(auth.currentUser.email, email);
    const messagesRef = collection(db, "chats", chatId, "messages");
    const q = query(messagesRef, orderBy("timestamp"));
    unsubscribeMessages = onSnapshot(q, snapshot => {
      messagesDiv.innerHTML = '';
      snapshot.forEach(docSnap => {
        const msg = docSnap.data();
        displayMessage(msg);
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    // تعيين الرسائل كمقروءة عند فتح المحادثة
    markMessagesAsRead(chatId, email);

    unreadCounts.set(email, 0);
    updateUnreadUI();
  }

  // عرض رسالة في نافذة المحادثة
  function displayMessage(msg) {
    const div = document.createElement('div');
    div.classList.add('message');
    div.classList.add(msg.sender === auth.currentUser.email ? 'sent' : 'received');
    div.textContent = msg.text;

    const time = document.createElement('div');
    time.classList.add('time');
    time.textContent = msg.timestamp?.toDate().toLocaleTimeString() || '';
    div.appendChild(time);

    messagesDiv.appendChild(div);
  }

  // إرسال رسالة مع إضافة خاصية read:false وعرضها فوراً
  sendBtn.addEventListener('click', sendMessage);
  messageInput.addEventListener('keypress', e => {
    if (e.key === 'Enter') sendMessage();
  });

  async function sendMessage() {
    const text = messageInput.value.trim();
    if (!text || !currentChatEmail) return;

    const chatId = getChatId(auth.currentUser.email, currentChatEmail);
    const messagesRef = collection(db, "chats", chatId, "messages");

    // عرض الرسالة فوراً (تجربة مستخدم أفضل)
    displayMessage({
      sender: auth.currentUser.email,
      text,
      timestamp: { toDate: () => new Date() }
    });

    messageInput.value = '';

    await addDoc(messagesRef, {
      sender: auth.currentUser.email,
      text,
      timestamp: serverTimestamp(),
      read: false
    });
  }

  // الاستماع لرسائل غير مقروءة لتحديث عداد الإشعارات
  
  function listenUnreadMessages() {
    const usersRef = collection(db, "users");
    onSnapshot(usersRef, snapshot => {
      snapshot.forEach(userDoc => {
        const userData = userDoc.data();
        if (auth.currentUser && userData.email !== auth.currentUser.email) {
          const chatId = getChatId(auth.currentUser.email, userData.email);
          const messagesRef = collection(db, "chats", chatId, "messages");

          const q = query(messagesRef, where("sender", "==", userData.email), where("read", "==", false));

          onSnapshot(q, snapshot => {
            if (!currentChatEmail || currentChatEmail !== userData.email) {
              const count = snapshot.size;
              if (count > 0) {
                unreadCounts.set(userData.email, count);
              } else {
                unreadCounts.set(userData.email, 0);
              }
            }
            updateUnreadUI();
          });
        }
      });
    });
  }

  function updateUnreadUI() {
    const conversationDivs = document.querySelectorAll('.conversation');
    conversationDivs.forEach(div => {
      const email = div.dataset.email;
      const badge = div.querySelector('.unread-badge');
      const count = unreadCounts.get(email) || 0;
      if (count > 0) {
        badge.textContent = count;
        badge.style.display = 'inline-block';
      } else {
        badge.style.display = 'none';
      }
    });
  }

  function clearChat() {
    currentChatEmail = null;
    currentChatUserData = null;
    chatHeader.textContent = 'اختر محادثة';
    messagesDiv.innerHTML = '';
    inputArea.style.display = 'none';
    unreadCounts.clear();
    updateUnreadUI();
  }

  // القائمة المنسدلة - إظهار وإخفاء
  menuBtn.addEventListener('click', () => {
    const isExpanded = menuBtn.getAttribute('aria-expanded') === 'true';
    if (isExpanded) {
      dropdownMenu.style.display = 'none';
      menuBtn.setAttribute('aria-expanded', 'false');
    } else {
      dropdownMenu.style.display = 'flex';
      menuBtn.setAttribute('aria-expanded', 'true');
    }
  });

  // إغلاق القائمة عند النقر خارجها
  document.addEventListener('click', (e) => {
    if (!dropdownMenu.contains(e.target) && e.target !== menuBtn) {
      dropdownMenu.style.display = 'none';
      menuBtn.setAttribute('aria-expanded', 'false');
    }
  });

  // زر تعديل بيانات المستخدم (تفتح نموذج أو alert مؤقت)
  editProfileBtn.addEventListener('click', async () => {
    dropdownMenu.style.display = 'none';
    menuBtn.setAttribute('aria-expanded', 'false');

    // هنا يمكنك فتح نموذج تعديل بيانات - للمثال عرض alert
    alert('هنا يمكنك فتح نموذج تعديل بيانات المستخدم.');
  });

  // زر تسجيل الخروج
  logoutMenuBtn.addEventListener('click', async () => {
    dropdownMenu.style.display = 'none';
    menuBtn.setAttribute('aria-expanded', 'false');
    if (unsubscribeMessages) unsubscribeMessages();
    await signOut(auth);
  });

  // زر حذف الحساب
  deleteAccountMenuBtn.addEventListener('click', async () => {
    dropdownMenu.style.display = 'none';
    menuBtn.setAttribute('aria-expanded', 'false');
    if (!confirm('هل أنت متأكد أنك تريد حذف الحساب نهائياً؟ هذا الإجراء لا يمكن التراجع عنه.')) {
      return;
    }
    try {
      const user = auth.currentUser;
      if (user && user.uid) {
        const userDocRef = doc(db, "users", user.uid);
        await deleteDoc(userDocRef);
      }
      await deleteUser(auth.currentUser);
      alert('تم حذف الحساب بنجاح.');
      location.reload();
    } catch (error) {
      if (error.code === 'auth/requires-recent-login') {
        alert('يجب إعادة تسجيل الدخول قبل حذف الحساب.');
      } else {
        alert('حدث خطأ أثناء حذف الحساب.');
      }
    }
  });

  // زر عن التطبيق
  aboutAppBtn.addEventListener('click', () => {
    dropdownMenu.style.display = 'none';
    menuBtn.setAttribute('aria-expanded', 'false');
    alert('تطبيق دردشة فورية تم تطويره باستخدام Firebase و JavaScript.');
  });
</script>

</body>
  </html>
