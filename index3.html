<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ’¬ Ø¯Ø±Ø¯Ø´Ø© ÙÙˆØ±ÙŠØ© - ChatPro</title>
  <link rel="manifest" href="manifest.json">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      direction: rtl;
      text-align: right;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100vh;
      overflow: hidden;
    }

    /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠØ© */
    #loadingScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 24px;
      z-index: 9999;
    }

    /* Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
    #authContainer {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      width: 400px;
      z-index: 1000;
      display: none;
    }

    #authContainer h2 {
      text-align: center;
      margin-bottom: 30px;
      color: #6a11cb;
      font-size: 28px;
    }

    input, button {
      width: 100%;
      padding: 15px;
      margin: 10px 0;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    input:focus {
      border-color: #6a11cb;
      outline: none;
      box-shadow: 0 0 10px rgba(106, 17, 203, 0.2);
    }

    button {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      text-transform: uppercase;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(106, 17, 203, 0.3);
    }

    #toggleFormBtn {
      background: transparent;
      color: #6a11cb;
      border: 2px solid #6a11cb;
    }

    #errorMsg {
      color: #e74c3c;
      text-align: center;
      min-height: 20px;
      font-weight: bold;
    }

    /* Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
    #app {
      display: none;
      height: 100vh;
      background: white;
      flex-direction: column;
    }

    /* Ø´Ø±ÙŠØ· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ù„ÙˆÙŠ - ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ */
    #appHeader {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    /* Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙÙŠ Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠØ³Ø± */
    #appLogo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 24px;
      font-weight: bold;
      order: 2;
    }

    #appLogo::before {
      content: "ğŸ’¬";
      font-size: 30px;
    }

    /* Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠÙ…Ù† */
    #userInfo {
      display: flex;
      align-items: center;
      gap: 15px;
      order: 1;
    }

    #userAvatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid white;
      object-fit: cover;
    }

    #installBtn {
      background: rgba(255,255,255,0.9);
      color: #6a11cb;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      display: none;
      order: 3;
    }

    #menuBtn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 10px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 18px;
      order: 4;
    }

    /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† */
    #usersListContainer {
      width: 100%;
      flex: 1;
      background: #f8f9fa;
      padding: 20px;
      overflow-y: auto;
      padding-bottom: 80px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„ØªØ°ÙŠÙŠÙ„ */
    }

    #searchContainer {
      position: relative;
      margin-bottom: 20px;
    }

    #searchInput {
      width: 100%;
      padding: 15px 50px 15px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 25px;
      font-size: 16px;
      background: white;
    }

    #searchContainer::after {
      content: "ğŸ”";
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 18px;
    }

    .user-card {
      background: white;
      border-radius: 15px;
      padding: 15px;
      margin: 10px 0;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      gap: 15px;
      position: relative;
    }

    .user-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }

    .user-card.blocked {
      opacity: 0.5;
      background: #ffebee;
    }

    .user-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      position: relative;
      overflow: hidden;
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }

    .online-indicator {
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 12px;
      height: 12px;
      background: #4caf50;
      border: 2px solid white;
      border-radius: 50%;
      display: none;
    }

    .online-indicator.online {
      display: block;
    }

    .user-info {
      flex: 1;
    }

    .user-info h4 {
      margin: 0;
      color: #333;
      font-size: 16px;
    }

    .user-status {
      color: #666;
      font-size: 14px;
      margin-top: 2px;
    }

    .last-seen {
      color: #999;
      font-size: 12px;
      margin-top: 2px;
    }

    .unread-count {
      position: absolute;
      top: 10px;
      left: 10px;
      background: #e74c3c;
      color: white;
      border-radius: 50%;
      min-width: 20px;
      height: 20px;
      padding: 0 5px;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }

    .unread-count.show {
      display: flex;
    }

    /* Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© */
    #chatContainer {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      z-index: 1000;
      flex-direction: column;
    }

    #chatHeader {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    #chatUserInfo {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 2px;
      flex: 1;
      margin-right: 15px;
    }

    #chatUserName {
      font-size: 18px;
      font-weight: bold;
    }

    #chatUserStatus {
      font-size: 14px;
      opacity: 0.8;
    }

    .typing-indicator {
      color: #4caf50;
      font-style: italic;
    }

    #chatControls {
      display: flex;
      gap: 10px;
    }

    .chat-btn, #backBtn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }

    /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
    #messagesArea {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
    }

    .message-wrapper {
      display: flex;
      margin: 10px 0;
      position: relative;
    }

    .message-wrapper.sent {
      justify-content: flex-end;
    }

    .message-wrapper.received {
      justify-content: flex-start;
    }

    .message {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 18px;
      position: relative;
      word-wrap: break-word;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      white-space: pre-wrap;
    }

    .message.sent {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      border-bottom-right-radius: 5px;
    }

    .message.received {
      background: white;
      color: #333;
      border: 1px solid #e0e0e0;
      border-bottom-left-radius: 5px;
    }

    .message-time {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 5px;
      text-align: left;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .message-status {
      font-size: 14px;
      margin-left: 5px;
    }

    .status-sending { color: #e53935; } /* & Ø£Ø­Ù…Ø± */
    .status-sent { color: #333; } /* âœ“ Ø£Ø³ÙˆØ¯ */
    .status-delivered { color: #333; } /* âœ“âœ“ Ø£Ø³ÙˆØ¯ */
    .status-read { color: #2196f3; } /* âœ“âœ“ Ø£Ø²Ø±Ù‚ */

    .message-media {
      border-radius: 10px;
      overflow: hidden;
      position: relative;
      margin-bottom: 5px;
    }

    .message-media img,
    .message-media video,
    .message-media audio {
      width: 100%;
      max-width: 300px;
      height: auto;
      border-radius: 10px;
    }

    /* Ù‚Ø§Ø¦Ù…Ø© Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
    .message-menu {
      position: fixed;
      background: white;
      border-radius: 10px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
      display: none;
      flex-direction: column;
      z-index: 2000;
      overflow: hidden;
      min-width: 150px;
    }

    .message-menu-item {
      padding: 12px 16px;
      border: none;
      background: transparent;
      text-align: right;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s ease;
    }

    .message-menu-item:hover {
      background: #f0f0f0;
    }

    .message-menu-item.danger {
      color: #e74c3c;
    }

    .message-menu-item.danger:hover {
      background: #ffebee;
    }

    /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
    #inputContainer {
      background: white;
      padding: 15px 20px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      align-items: flex-end;
      gap: 10px;
    }

    #messageInput {
      flex: 1;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 25px;
      font-size: 16px;
      resize: none;
      max-height: 100px;
      min-height: 45px;
      font-family: inherit;
    }

    .input-btn {
      background: white;
      color: #6a11cb;
      border: 2px solid #e0e0e0;
      padding: 12px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      width: 45px;
      height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .input-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    /* Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£Ø®Ø¶Ø± Ù…Ø«Ù„ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ */
    #sendBtn {
      background: #25d366;
      color: white;
      border: none;
    }

    #sendBtn svg {
      width: 20px;
      height: 20px;
      fill: white;
    }

    /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª */
    #attachMenu {
      position: absolute;
      bottom: 60px;
      right: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      display: none;
      flex-direction: column;
      overflow: hidden;
      z-index: 100;
    }

    .attach-option {
      padding: 12px 15px;
      border: none;
      background: transparent;
      text-align: right;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 180px;
    }

    .attach-option:hover {
      background: #f0f0f0;
    }

    /* Ù„ÙˆØ­Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ */
    #emojiPanel {
      position: absolute;
      bottom: 60px;
      right: 80px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      display: none;
      padding: 15px;
      max-width: 300px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
    }

    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 5px;
    }

    .emoji-item {
      padding: 8px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 20px;
      border-radius: 5px;
      transition: background 0.2s ease;
    }

    .emoji-item:hover {
      background: #f0f0f0;
    }

    /* ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª */
    .recording-indicator {
      display: none;
      align-items: center;
      gap: 10px;
      padding: 8px 15px;
      background: #ffebee;
      border-radius: 20px;
      color: #e74c3c;
      font-size: 14px;
      flex: 1;
    }

    .recording-dot {
      width: 8px;
      height: 8px;
      background: #e74c3c;
      border-radius: 50%;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    /* Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© ÙˆØ§Ù„Ù…ÙˆØ¯Ø§Ù„ */
    #dropdownMenu, #chatDropdownMenu {
      position: fixed;
      background: white;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      display: none;
      flex-direction: column;
      min-width: 200px;
      z-index: 2000;
      overflow: hidden;
    }

    #dropdownMenu {
      top: 70px;
      right: 20px;
    }

    #chatDropdownMenu {
      top: 70px;
      left: 20px;
    }

    .dropdown-item {
      padding: 15px 20px;
      border: none;
      background: transparent;
      text-align: right;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      color: #000; /* Ù„ÙˆÙ† Ø£Ø³ÙˆØ¯ Ù„Ù„Ù†ØµÙˆØµ */
    }

    .dropdown-item:hover {
      background: #f8f9fa;
    }

    .dropdown-item.danger {
      color: #000; /* ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø­Ù…Ø±Ø§Ø¡ Ø¥Ù„Ù‰ Ø£Ø³ÙˆØ¯ */
    }

    .dropdown-item.danger:hover {
      background: #ffebee;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 3000;
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      width: 90%;
      max-width: 400px;
      position: relative;
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }

    .modal h3 {
      margin-bottom: 20px;
      text-align: center;
      color: #333;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }

    .modal label {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      font-size: 16px;
      color: #555;
    }

    .modal input[type="checkbox"] {
      width: auto;
      margin: 0;
    }

    /* Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙˆØ³Ø§Ø¦Ø· */
    #mediaPreview {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 4000;
    }

    #mediaPreview img,
    #mediaPreview video,
    #mediaPreview audio {
      max-width: 90%;
      max-height: 90%;
      border-radius: 10px;
    }

    .preview-controls {
      position: absolute;
      bottom: 50px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 15px;
    }

    .preview-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 15px 25px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      backdrop-filter: blur(10px);
    }

    /* ØªØ°ÙŠÙŠÙ„ Ø§Ù„ØµÙØ­Ø© */
    #footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #333;
      color: white;
      text-align: center;
      padding: 12px;
      font-size: 14px;
      z-index: 999;
    }

    /* Ù…Ø¤Ø´Ø± Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ø¨ÙƒØ© */
    .network-status {
      position: fixed;
      top: 10px;
      left: 10px;
      background: #f44336;
      color: white;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 12px;
      z-index: 1000;
      display: none;
    }

    .network-status.online {
      background: #4caf50;
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø¬ÙˆØ§Ù„ */
    @media (max-width: 768px) {
      #authContainer {
        width: 90%;
        padding: 30px 20px;
      }

      .message {
        max-width: 85%;
      }

      #inputContainer {
        padding: 10px;
      }

      .user-card {
        padding: 12px;
      }

      #appLogo {
        font-size: 20px;
      }

      #footer {
        font-size: 12px;
        padding: 8px;
      }
    }

    /* Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© */
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .slide-in {
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #6a11cb;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ØªØ­Ø³ÙŠÙ† Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: #6a11cb;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #2575fc;
    }
  </style>
</head>
<body>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
<div id="loadingScreen">
  <div>
    <div class="loading"></div>
    <div style="margin-top: 20px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
  </div>
</div>

<!-- Ù…Ø¤Ø´Ø± Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ø¨ÙƒØ© -->
<div class="network-status" id="networkStatus">ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª</div>

<!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="authContainer">
  <h2 id="formTitle">ğŸ’¬ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ChatPro</h2>
  <input type="email" id="email" placeholder="ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" />
  <input type="password" id="password" placeholder="ğŸ”’ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
  <input type="text" id="username" placeholder="ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…" style="display: none;" />
  <input type="text" id="status" placeholder="âœ¨ Ø§Ù„Ø­Ø§Ù„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="display: none;" />
  <div id="errorMsg"></div>
  <button id="submitBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
  <button id="toggleFormBtn">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
</div>

<!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
<div id="app">
  <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
  <div id="appHeader">
    <div id="userInfo">
      <img id="userAvatar" src="" alt="Avatar" />
      <div>
        <div id="currentUsername"></div>
        <div id="currentUserStatus" style="font-size: 12px; opacity: 0.8;"></div>
      </div>
    </div>
    
    <div id="appLogo">ChatPro</div>
    <button id="installBtn">â¬‡ï¸ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>
    <button id="menuBtn">âš™ï¸</button>
  </div>

  <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
  <div id="usersListContainer">
    <div id="searchContainer">
      <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…..." />
    </div>
    <div id="usersList"></div>
  </div>

  <!-- ØªØ°ÙŠÙŠÙ„ Ø§Ù„ØµÙØ­Ø© -->
  <div id="footer">
    Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ø¯Ù‰ Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ù…ÙŠØ² Ø³ÙˆÙØª Ù„Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø© Â© 2024
  </div>
</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
<div id="chatContainer">
  <div id="chatHeader">
    <div style="display: flex; align-items: center; gap: 15px;">
      <button id="backBtn">â†</button>
      <div id="chatUserInfo">
        <div id="chatUserName"></div>
        <div id="chatUserStatus"></div>
      </div>
    </div>
    <div id="chatControls">
      <button class="chat-btn" id="voiceCallBtn" title="Ø§ØªØµØ§Ù„ ØµÙˆØªÙŠ">ğŸ“</button>
      <button class="chat-btn" id="videoCallBtn" title="Ø§ØªØµØ§Ù„ ÙÙŠØ¯ÙŠÙˆ">ğŸ¥</button>
      <button class="chat-btn" id="chatMenuBtn" title="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">â‹®</button>
    </div>
  </div>

  <div id="messagesArea"></div>

  <div id="inputContainer">
    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª -->
    <div id="attachMenu">
      <button class="attach-option" id="attachImageBtn">ğŸ“· Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø©</button>
      <button class="attach-option" id="attachGalleryBtn">ğŸ–¼ï¸ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ø¶</button>
      <button class="attach-option" id="attachVideoBtn">ğŸ¥ Ø§Ø®ØªÙŠØ§Ø± ÙÙŠØ¯ÙŠÙˆ</button>
    </div>
    
    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ -->
    <div id="emojiPanel">
      <div class="emoji-grid" id="emojiGrid"></div>
    </div>
    
    <!-- Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
    <div class="recording-indicator" id="recordingIndicator">
      <div class="recording-dot"></div>
      <span id="recordingTime">00:00</span>
      <button class="input-btn" id="stopRecordingBtn">â¹ï¸</button>
    </div>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ -->
    <button class="input-btn" id="attachBtn" title="Ù…Ø±ÙÙ‚Ø§Øª">ğŸ“</button>
    <button class="input-btn" id="emojiBtn" title="Ø¥ÙŠÙ…ÙˆØ¬ÙŠ">ğŸ˜Š</button>
    <button class="input-btn" id="recordBtn" title="ØªØ³Ø¬ÙŠÙ„ ØµÙˆØª">ğŸ¤</button>
    <textarea id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." rows="1"></textarea>
    <button class="input-btn" id="sendBtn" title="Ø¥Ø±Ø³Ø§Ù„">
      <svg viewBox="0 0 24 24">
        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
      </svg>
    </button>
  </div>
</div>

<!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
<div id="dropdownMenu">
  <button class="dropdown-item" id="editProfileBtn">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</button>
  <button class="dropdown-item" id="notificationSettingsBtn">ğŸ”” Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>
  <button class="dropdown-item" id="blockedUsersBtn">ğŸš« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†</button>
  <button class="dropdown-item" id="aboutBtn">â„¹ï¸ Ø¹Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>
  <button class="dropdown-item danger" id="logoutBtn">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  <button class="dropdown-item danger" id="deleteAccountBtn">âŒ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨</button>
</div>

<!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© -->
<div id="chatDropdownMenu">
  <button class="dropdown-item" id="clearChatBtn">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</button>
  <button class="dropdown-item" id="blockUserBtn">ğŸš« Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
</div>

<!-- Ù‚Ø§Ø¦Ù…Ø© Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© -->
<div class="message-menu" id="messageMenu">
  <button class="message-menu-item" id="deleteForMeBtn">ğŸ—‘ï¸ Ø­Ø°Ù Ù„Ø¯ÙŠ</button>
  <button class="message-menu-item danger" id="deleteForAllBtn">âŒ Ø­Ø°Ù Ù„Ù„Ø¬Ù…ÙŠØ¹</button>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
<div class="modal" id="editProfileModal">
  <div class="modal-content">
    <h3>âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>
    <input type="text" id="editUsername" placeholder="ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…" />
    <input type="text" id="editStatus" placeholder="âœ¨ Ø§Ù„Ø­Ø§Ù„Ø©" />
    <div class="modal-buttons">
      <button id="saveProfileBtn">ğŸ’¾ Ø­ÙØ¸</button>
      <button id="cancelProfileBtn">âŒ Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
<div class="modal" id="notificationModal">
  <div class="modal-content">
    <h3>ğŸ”” Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3>
    <label>
      <input type="checkbox" id="enableNotifications" checked /> ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    </label>
    <label>
      <input type="checkbox" id="enableSounds" checked /> ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£ØµÙˆØ§Øª
    </label>
    <div class="modal-buttons">
      <button id="saveNotificationBtn">ğŸ’¾ Ø­ÙØ¸</button>
      <button id="cancelNotificationBtn">âŒ Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ† -->
<div class="modal" id="blockedUsersModal">
  <div class="modal-content">
    <h3>ğŸš« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙˆÙ†</h3>
    <div id="blockedUsersList" style="max-height: 300px; overflow-y: auto;"></div>
    <div class="modal-buttons">
      <button id="closeBlockedUsersBtn">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø¹Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
<div class="modal" id="aboutModal">
  <div class="modal-content">
    <h3>â„¹ï¸ Ø¹Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h3>
    <p style="text-align: center; line-height: 1.6;">
      ØªØ·Ø¨ÙŠÙ‚ ChatPro Ù‡Ùˆ ØªØ·Ø¨ÙŠÙ‚ Ø¯Ø±Ø¯Ø´Ø© ÙÙˆØ±ÙŠ Ù…ØªØ·ÙˆØ± ÙŠØ¯Ø¹Ù… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†ØµÙŠØ© ÙˆØ§Ù„ÙˆØ³Ø§Ø¦Ø· Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
      Ù…Ø¹ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙˆØ±ÙŠØ© ÙˆØ¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ØªØ«Ø¨ÙŠØª ÙƒØªØ·Ø¨ÙŠÙ‚ ÙˆÙŠØ¨ ØªÙ‚Ø¯Ù…ÙŠ (PWA).
      <br><br>
      <strong>Ø§Ù„Ù…ÙŠØ²Ø§Øª:</strong><br>
      â€¢ Ø¯Ø±Ø¯Ø´Ø© ÙÙˆØ±ÙŠØ© Ø¢Ù…Ù†Ø©<br>
      â€¢ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ù„ØµÙˆØª<br>
      â€¢ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ©<br>
      â€¢ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†<br>
      â€¢ ØªØ·Ø¨ÙŠÙ‚ Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ«Ø¨ÙŠØª<br>
      â€¢ Ø¯Ø¹Ù… ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„
    </p>
    <div class="modal-buttons">
      <button id="closeAboutBtn">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<!-- Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙˆØ³Ø§Ø¦Ø· -->
<div id="mediaPreview">
  <div id="previewContent"></div>
  <div class="preview-controls">
    <button class="preview-btn" id="sendMediaBtn">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„</button>
    <button class="preview-btn" id="cancelMediaBtn">âŒ Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</div>

<!-- Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø®ÙÙŠØ© -->
<input type="file" id="imageInput" accept="image/*" style="display: none;" />
<input type="file" id="videoInput" accept="video/*" style="display: none;" />
<input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" />

<!-- ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
<audio id="notificationSound" preload="auto">
  <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMeBC2I0fPTgjEGHm7A7+OZURE" type="audio/wav">
</audio>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, deleteUser } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { 
    getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, 
    getDocs, doc, setDoc, deleteDoc, where, getDoc, updateDoc, increment, enableNetwork, disableNetwork
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
  import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAm0hh9I6i58ywW1D2gZg09liG-wG-tBsU",
    authDomain: "chat-fat-4f082.firebaseapp.com",
    projectId: "chat-fat-4f082",
    storageBucket: "chat-fat-4f082.appspot.com",
    messagingSenderId: "297367474930",
    appId: "1:297367474930:web:a05b983e05a0ba257fb66b",
    measurementId: "G-MBGC7KZ8H0"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);
  
  let messaging = null;
  try {
    messaging = getMessaging(app);
  } catch (error) {
    console.warn("FCM ØºÙŠØ± Ù…ØªØ§Ø­:", error);
  }

  // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
  let currentUser = null;
  let currentChatUser = null;
  let unsubscribeMessages = null;
  let unsubscribeUsers = null;
  let unsubscribeUnreadCounts = null;
  let isLogin = true;
  let blockedUsers = new Set();
  let notificationsEnabled = localStorage.getItem('notificationsEnabled') !== 'false';
  let soundsEnabled = localStorage.getItem('soundsEnabled') !== 'false';
  let selectedMedia = null;
  let deferredPrompt = null;
  let mediaRecorder = null;
  let recordingStartTime = null;
  let recordingInterval = null;
  let isOnline = navigator.onLine;
  let offlineMessages = [];
  let selectedMessageId = null;
  let typingTimer = null;
  let isTyping = false;

  // Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø´Ø§Ø¦Ø¹Ø©
  const commonEmojis = [
    'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ¤£', 'ğŸ˜‚',
    'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤©',
    'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜š', 'ğŸ˜™', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ¤ª',
    'ğŸ˜', 'ğŸ¤‘', 'ğŸ¤—', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤”', 'ğŸ¤', 'ğŸ¤¨',
    'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜’', 'ğŸ™„', 'ğŸ˜¬', 'ğŸ¤¥',
    'ğŸ‘', 'ğŸ‘', 'ğŸ‘Œ', 'ğŸ¤', 'âœŒï¸', 'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ‘ˆ',
    'ğŸ‘‰', 'ğŸ‘†', 'ğŸ‘‡', 'â˜ï¸', 'âœ‹', 'ğŸ¤š', 'ğŸ–ï¸', 'ğŸ––',
    'ğŸ‘‹', 'ğŸ¤™', 'ğŸ’ª', 'ğŸ¦¾', 'ğŸ–•', 'âœï¸', 'ğŸ™', 'ğŸ¦¶',
    'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤',
    'ğŸ¤', 'ğŸ’”', 'â£ï¸', 'ğŸ’•', 'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’–',
    'ğŸ’˜', 'ğŸ’', 'ğŸ’Ÿ', 'â˜®ï¸', 'âœï¸', 'â˜ªï¸', 'ğŸ•‰ï¸', 'â˜¸ï¸',
    'ğŸ”¥', 'âœ¨', 'ğŸŒŸ', 'ğŸ’«', 'â­', 'ğŸŒˆ', 'â˜€ï¸', 'ğŸŒ™'
  ];

  // Ø¹Ù†Ø§ØµØ± DOM
  const loadingScreen = document.getElementById('loadingScreen');
  const authContainer = document.getElementById('authContainer');
  const app_div = document.getElementById('app');
  const chatContainer = document.getElementById('chatContainer');
  const formTitle = document.getElementById('formTitle');
  const submitBtn = document.getElementById('submitBtn');
  const toggleFormBtn = document.getElementById('toggleFormBtn');
  const errorMsg = document.getElementById('errorMsg');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const usernameInput = document.getElementById('username');
  const statusInput = document.getElementById('status');
  const usersList = document.getElementById('usersList');
  const searchInput = document.getElementById('searchInput');
  const messagesArea = document.getElementById('messagesArea');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const backBtn = document.getElementById('backBtn');
  const menuBtn = document.getElementById('menuBtn');
  const chatMenuBtn = document.getElementById('chatMenuBtn');
  const dropdownMenu = document.getElementById('dropdownMenu');
  const chatDropdownMenu = document.getElementById('chatDropdownMenu');
  const notificationSound = document.getElementById('notificationSound');
  const installBtn = document.getElementById('installBtn');
  const networkStatus = document.getElementById('networkStatus');
  const messageMenu = document.getElementById('messageMenu');
  const emojiBtn = document.getElementById('emojiBtn');
  const emojiPanel = document.getElementById('emojiPanel');
  const emojiGrid = document.getElementById('emojiGrid');

  // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ³Ø§Ø¦Ø· ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„
  const attachBtn = document.getElementById('attachBtn');
  const attachMenu = document.getElementById('attachMenu');
  const recordBtn = document.getElementById('recordBtn');
  const recordingIndicator = document.getElementById('recordingIndicator');
  const recordingTime = document.getElementById('recordingTime');
  const stopRecordingBtn = document.getElementById('stopRecordingBtn');

  // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ø¨ÙƒØ©
  window.addEventListener('online', () => {
    isOnline = true;
    networkStatus.style.display = 'none';
    enableNetwork(db);
    syncOfflineMessages();
    console.log('Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª');
  });

  window.addEventListener('offline', () => {
    isOnline = false;
    networkStatus.style.display = 'block';
    networkStatus.textContent = 'ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª';
    networkStatus.classList.remove('online');
    disableNetwork(db);
    console.log('ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª');
  });

  // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
  async function updateUserPresence(online) {
    if (!currentUser || !isOnline) return;
    try {
      const userRef = doc(db, "users", currentUser.uid);
      await updateDoc(userRef, {
        online: online,
        lastSeen: online ? null : serverTimestamp()
      });
    } catch (error) {
      console.warn("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„:", error);
    }
  }

  // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø§ÙØ°Ø©
  document.addEventListener('visibilitychange', () => {
    if (currentUser) {
      updateUserPresence(!document.hidden);
    }
  });

  window.addEventListener('beforeunload', () => {
    if (currentUser) {
      updateUserPresence(false);
    }
  });

  // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
  function initializeEmojis() {
    emojiGrid.innerHTML = '';
    commonEmojis.forEach(emoji => {
      const emojiItem = document.createElement('button');
      emojiItem.className = 'emoji-item';
      emojiItem.textContent = emoji;
      emojiItem.addEventListener('click', () => {
        insertEmoji(emoji);
      });
      emojiGrid.appendChild(emojiItem);
    });
  }

  function insertEmoji(emoji) {
    const cursorPos = messageInput.selectionStart;
    const textBefore = messageInput.value.substring(0, cursorPos);
    const textAfter = messageInput.value.substring(cursorPos);
    messageInput.value = textBefore + emoji + textAfter;
    messageInput.focus();
    messageInput.selectionStart = messageInput.selectionEnd = cursorPos + emoji.length;
    emojiPanel.style.display = 'none';
  }

  // ØªØ¨Ø¯ÙŠÙ„ Ù†Ù…Ø§Ø°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  toggleFormBtn.addEventListener('click', () => {
    isLogin = !isLogin;
    errorMsg.textContent = '';
    
    if (isLogin) {
      formTitle.innerHTML = 'ğŸ’¬ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ChatPro';
      submitBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
      toggleFormBtn.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯';
      usernameInput.style.display = 'none';
      statusInput.style.display = 'none';
    } else {
      formTitle.innerHTML = 'ğŸš€ Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ ChatPro';
      submitBtn.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨';
      toggleFormBtn.textContent = 'Ù„Ø¯ÙŠ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„';
      usernameInput.style.display = 'block';
      statusInput.style.display = 'block';
    }
  });

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
  async function checkEmailExists(email) {
    if (!isOnline) return false;
    try {
      const usersRef = collection(db, "users");
      const q = query(usersRef, where("email", "==", email));
      const querySnapshot = await getDocs(q);
      return !querySnapshot.empty;
    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯:", error);
      return false;
    }
  }

  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨
  submitBtn.addEventListener('click', async () => {
    errorMsg.textContent = '';
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    const username = usernameInput.value.trim();
    const status = statusInput.value.trim() || "Ù…ØªØ§Ø­ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø© ğŸ’¬";

    if (!email || !password || (!isLogin && !username)) {
      errorMsg.textContent = 'âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©';
      return;
    }

    try {
      submitBtn.innerHTML = '<div class="loading"></div>';
      
      if (isLogin) {
        await signInWithEmailAndPassword(auth, email, password);
      } else {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
        const emailExists = await checkEmailExists(email);
        if (emailExists) {
          errorMsg.textContent = 'ğŸ“§ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹';
          return;
        }

        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        await setDoc(doc(db, "users", user.uid), {
          email: user.email,
          username,
          status,
          photoURL: `https://ui-avatars.com/api/?name=${encodeURIComponent(username)}&background=6a11cb&color=fff&rounded=true&size=128`,
          online: true,
          lastSeen: null,
          createdAt: serverTimestamp(),
          blockedUsers: [],
          fcmToken: null,
          notificationsEnabled: true,
          soundsEnabled: true
        });
      }
    } catch (error) {
      errorMsg.textContent = getErrorMessage(error.code);
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©:", error);
    } finally {
      submitBtn.textContent = isLogin ? 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„' : 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨';
    }
  });

  function getErrorMessage(errorCode) {
    const errors = {
      'auth/email-already-in-use': 'ğŸ“§ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹',
      'auth/weak-password': 'ğŸ”’ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© (ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)',
      'auth/user-not-found': 'ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯',
      'auth/wrong-password': 'ğŸ”’ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©',
      'auth/invalid-email': 'ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­',
      'auth/network-request-failed': 'ğŸŒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©'
    };
    return errors[errorCode] || 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + errorCode;
  }

  // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
  onAuthStateChanged(auth, async (user) => {
    loadingScreen.style.display = 'none';
    
    if (user) {
      currentUser = user;
      await initializeApp_();
      updateUserPresence(true);
      setupFCM();
      showApp();
    } else {
      currentUser = null;
      showAuthScreen();
      cleanup();
    }
  });

  function showApp() {
    authContainer.style.display = 'none';
    chatContainer.style.display = 'none';
    app_div.style.display = 'flex';
  }

  function showAuthScreen() {
    authContainer.style.display = 'block';
    app_div.style.display = 'none';
    chatContainer.style.display = 'none';
  }

  function cleanup() {
    if (unsubscribeMessages) unsubscribeMessages();
    if (unsubscribeUsers) unsubscribeUsers();
    if (unsubscribeUnreadCounts) unsubscribeUnreadCounts();
    usersList.innerHTML = '';
    messagesArea.innerHTML = '';
    blockedUsers.clear();
    currentChatUser = null;
    clearOfflineData();
  }

  async function initializeApp_() {
    const userDoc = await getDoc(doc(db, "users", currentUser.uid));
    if (userDoc.exists()) {
      const userData = userDoc.data();
      document.getElementById('currentUsername').textContent = userData.username;
      document.getElementById('currentUserStatus').textContent = userData.status;
      document.getElementById('userAvatar').src = userData.photoURL;
      
      // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
      if (userData.notificationsEnabled !== undefined) {
        notificationsEnabled = userData.notificationsEnabled;
        localStorage.setItem('notificationsEnabled', notificationsEnabled);
      }
      if (userData.soundsEnabled !== undefined) {
        soundsEnabled = userData.soundsEnabled;
        localStorage.setItem('soundsEnabled', soundsEnabled);
      }
    }

    await loadBlockedUsers();
    loadUsers();
    listenForUnreadCounts();
    initializeEmojis();
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ø¨ÙƒÙŠØ©
    if (!isOnline) {
      networkStatus.style.display = 'block';
    }
  }

  // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ù„ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„
  function saveOfflineData(key, data) {
    try {
      localStorage.setItem(`offline_${key}`, JSON.stringify(data));
    } catch (error) {
      console.warn("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹:", error);
    }
  }

  function loadOfflineData() {
    try {
      const offlineMsgs = localStorage.getItem(`pending_messages_${currentUser.uid}`);
      if (offlineMsgs) {
        offlineMessages = JSON.parse(offlineMsgs);
      }
    } catch (error) {
      console.warn("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©:", error);
    }
  }

  function clearOfflineData() {
    try {
      const keys = Object.keys(localStorage);
      keys.forEach(key => {
        if (key.startsWith('offline_') || key.startsWith('pending_')) {
          localStorage.removeItem(key);
        }
      });
    } catch (error) {
      console.warn("Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©:", error);
    }
  }

  async function syncOfflineMessages() {
    if (offlineMessages.length === 0) return;

    for (const messageData of offlineMessages) {
      try {
        await addDoc(collection(db, "messages"), messageData);
      } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©:", error);
      }
    }

    offlineMessages = [];
    localStorage.removeItem(`pending_messages_${currentUser.uid}`);
  }

  function loadUsers() {
    if (unsubscribeUsers) unsubscribeUsers();
    
    if (!isOnline) {
      loadOfflineData();
      return;
    }
    
    const usersRef = collection(db, "users");
    unsubscribeUsers = onSnapshot(usersRef, (snapshot) => {
      usersList.innerHTML = '';
      const usersData = [];
      
      snapshot.forEach((doc) => {
        const userData = doc.data();
        if (userData.email !== currentUser.email) {
          usersData.push({ id: doc.id, ...userData });
        }
      });

      // ÙØ±Ø² Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… Ø­Ø³Ø¨ Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±
      usersData.sort((a, b) => {
        if (a.online && !b.online) return -1;
        if (!a.online && b.online) return 1;
        
        const aTime = a.lastSeen ? a.lastSeen.toDate().getTime() : 0;
        const bTime = b.lastSeen ? b.lastSeen.toDate().getTime() : 0;
        return bTime - aTime;
      });

      usersData.forEach(userData => createUserCard(userData));
      
      // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
      saveOfflineData(`users_${currentUser.uid}`, usersData);
    });
  }

  function createUserCard(userData) {
    const userCard = document.createElement('div');
    userCard.className = 'user-card fade-in';
    userCard.dataset.email = userData.email;
    userCard.dataset.uid = userData.id;
    
    if (blockedUsers.has(userData.email)) {
      userCard.classList.add('blocked');
    }

    const isOnlineUser = userData.online;
    const lastSeenDate = userData.lastSeen ? userData.lastSeen.toDate() : new Date();
    
    userCard.innerHTML = `
      <div class="user-avatar">
        <img src="${userData.photoURL}" alt="${userData.username}" />
        <div class="online-indicator ${isOnlineUser ? 'online' : ''}"></div>
      </div>
      <div class="user-info">
        <h4>${userData.username}</h4>
        <div class="user-status">${userData.status || ''}</div>
        ${!isOnlineUser ? `<div class="last-seen">Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±: ${formatLastSeen(lastSeenDate)}</div>` : ''}
      </div>
      <div class="unread-count" id="unread-${userData.id}">0</div>
    `;

    userCard.addEventListener('click', () => {
      if (blockedUsers.has(userData.email)) {
        if (confirm(`${userData.username} Ù…Ø­Ø¸ÙˆØ± Ø­Ø§Ù„ÙŠØ§Ù‹. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø±Ù‡ØŸ`)) {
          toggleBlockUser(userData.email);
        }
      } else {
        openChat(userData);
      }
    });

    usersList.appendChild(userCard);
  }

  function formatLastSeen(date) {
    const now = new Date();
    const diff = now.getTime() - date.getTime();
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);

    if (minutes < 1) return 'Ø§Ù„Ø¢Ù†';
    if (minutes < 60) return `Ù…Ù†Ø° ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
    if (hours < 24) return `Ù…Ù†Ø° ${hours} Ø³Ø§Ø¹Ø©`;
    if (days < 7) return `Ù…Ù†Ø° ${days} ÙŠÙˆÙ…`;
    return date.toLocaleDateString('ar-EG');
  }

  async function openChat(userData) {
    currentChatUser = userData;
    
    app_div.style.display = 'none';
    chatContainer.style.display = 'flex';
    chatContainer.classList.add('slide-in');
    
    document.getElementById('chatUserName').textContent = userData.username;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¸Ø±
    const isBlocked = blockedUsers.has(userData.email);
    const userBlocked = await checkIfUserBlockedMe(userData.id);
    
    if (isBlocked || userBlocked) {
      document.getElementById('chatUserStatus').textContent = 'Ù…Ø­Ø¸ÙˆØ±';
      messageInput.disabled = true;
      messageInput.placeholder = 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
    } else {
      // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
      if (isOnline) {
        const chatUserDoc = await getDoc(doc(db, "users", userData.id));
        if (chatUserDoc.exists()) {
          const chatUserData = chatUserDoc.data();
          document.getElementById('chatUserStatus').textContent = 
            chatUserData.online ? 'Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù† ğŸŸ¢' : `Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±: ${formatLastSeen(chatUserData.lastSeen?.toDate() || new Date())}`;
        }
      } else {
        document.getElementById('chatUserStatus').textContent = 'ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª';
      }
      
      messageInput.disabled = false;
      messageInput.placeholder = 'Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...';
    }

    // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø­Ø¸Ø±
    document.getElementById('blockUserBtn').innerHTML = 
      isBlocked ? 'ğŸ”“ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±' : 'ğŸš« Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
    
    loadMessages();
    resetUnreadCount(userData.id);
  }

  async function checkIfUserBlockedMe(userId) {
    if (!isOnline) return false;
    
    try {
      const userDoc = await getDoc(doc(db, "users", userId));
      if (userDoc.exists()) {
        const userData = userDoc.data();
        return userData.blockedUsers && userData.blockedUsers.includes(currentUser.email);
      }
    } catch (error) {
      console.warn("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¸Ø±:", error);
    }
    return false;
  }

  // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©
  function listenForUnreadCounts() {
    if (unsubscribeUnreadCounts) unsubscribeUnreadCounts();
    if (!isOnline) return;

    const unreadRef = collection(db, `users/${currentUser.uid}/unreadCounts`);
    unsubscribeUnreadCounts = onSnapshot(unreadRef, (snapshot) => {
      snapshot.forEach(docSnap => {
        const senderId = docSnap.id;
        const count = docSnap.data().count || 0;
        updateUnreadCountDisplay(senderId, count);
      });
    });
  }

  function updateUnreadCountDisplay(userId, count) {
    const unreadElement = document.getElementById(`unread-${userId}`);
    if (unreadElement) {
      if (count > 0) {
        unreadElement.textContent = count > 99 ? '99+' : count;
        unreadElement.classList.add('show');
      } else {
        unreadElement.textContent = '0';
        unreadElement.classList.remove('show');
      }
    }
  }

  async function resetUnreadCount(senderId) {
    if (!isOnline) return;
    
    try {
      const unreadRef = doc(db, `users/${currentUser.uid}/unreadCounts`, senderId);
      await setDoc(unreadRef, { count: 0 }, { merge: true });
    } catch (error) {
      console.warn("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø¯Ø§Ø¯:", error);
    }
  }

  // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
  function handleTyping() {
    if (!currentChatUser || !isOnline) return;

    if (typingTimer) clearTimeout(typingTimer);
    
    if (!isTyping) {
      isTyping = true;
      updateTypingStatus(true);
    }

    typingTimer = setTimeout(() => {
      isTyping = false;
      updateTypingStatus(false);
    }, 2000);
  }

  async function updateTypingStatus(typing) {
    if (!currentChatUser || !isOnline) return;
    
    try {
      const typingRef = doc(db, `typing/${currentUser.uid}_${currentChatUser.id}`);
      if (typing) {
        await setDoc(typingRef, {
          userId: currentUser.uid,
          targetId: currentChatUser.id,
          typing: true,
          timestamp: serverTimestamp()
        });
      } else {
        await deleteDoc(typingRef);
      }
    } catch (error) {
      console.warn("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©:", error);
    }
  }

  // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¢Ø®Ø±
  function listenForTyping() {
    if (!currentChatUser || !isOnline) return;

    const typingRef = doc(db, `typing/${currentChatUser.id}_${currentUser.uid}`);
    onSnapshot(typingRef, (doc) => {
      const statusElement = document.getElementById('chatUserStatus');
      if (doc.exists() && doc.data().typing) {
        statusElement.innerHTML = '<span class="typing-indicator">Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙƒØªØ§Ø¨Ø©...</span>';
      } else if (currentChatUser) {
        // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
        const isBlocked = blockedUsers.has(currentChatUser.email);
        if (isBlocked) {
          statusElement.textContent = 'Ù…Ø­Ø¸ÙˆØ±';
        } else {
          statusElement.textContent = 'Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù† ğŸŸ¢';
        }
      }
    });
  }

  function loadMessages() {
    if (unsubscribeMessages) unsubscribeMessages();
    
    messagesArea.innerHTML = '';
    
    if (!isOnline) {
      loadOfflineData();
      return;
    }
    
    const messagesRef = collection(db, "messages");
    const messagesQuery = query(messagesRef, orderBy("timestamp"));

    unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
      let newMessagesReceived = false;
      
      snapshot.docChanges().forEach(change => {
        const messageData = change.doc.data();
        const messageId = change.doc.id;
        
        if (isMessageBetweenUsers(messageData, currentUser.email, currentChatUser.email)) {
          if (change.type === 'added') {
            displayMessage(messageData, messageId);
            
            if (messageData.to === currentUser.email && !messageData.read) {
              markMessageAsRead(messageId);
              newMessagesReceived = true;
            }
          } else if (change.type === 'removed') {
            const existingMessage = messagesArea.querySelector(`[data-message-id="${messageId}"]`);
            if (existingMessage) {
              existingMessage.remove();
            }
          }
        }
      });
      
      scrollToBottom();
      listenForTyping();

      if (newMessagesReceived && document.hidden && soundsEnabled) {
        playNotificationSound();
      }
    });
  }

  function isMessageBetweenUsers(message, user1Email, user2Email) {
    return (message.from === user1Email && message.to === user2Email) ||
           (message.from === user2Email && message.to === user1Email);
  }

  function getMessageStatus(messageData) {
    if (messageData.from !== currentUser.email) return '';
    
    if (messageData.status === 'sending') {
      return '<span class="message-status status-sending">&</span>';
    }
    
    if (!messageData.delivered) {
      return '<span class="message-status status-sent">âœ“</span>';
    }
    
    if (!messageData.read) {
      return '<span class="message-status status-delivered">âœ“âœ“</span>';
    }
    
    return '<span class="message-status status-read">âœ“âœ“</span>';
  }

  function displayMessage(messageData, messageId) {
    // ØªØ¬Ù†Ø¨ Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ÙƒØ±Ø±Ø©
    if (messagesArea.querySelector(`[data-message-id="${messageId}"]`)) {
      return;
    }

    const messageWrapper = document.createElement('div');
    messageWrapper.className = `message-wrapper ${messageData.from === currentUser.email ? 'sent' : 'received'}`;
    messageWrapper.dataset.messageId = messageId;
    
    const message = document.createElement('div');
    message.className = `message ${messageData.from === currentUser.email ? 'sent' : 'received'}`;
    
    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø·ÙˆÙ„
    let pressTimer;
    message.addEventListener('mousedown', (e) => {
      pressTimer = setTimeout(() => {
        showMessageMenu(e, messageId, messageData);
      }, 500);
    });

    message.addEventListener('mouseup', () => {
      clearTimeout(pressTimer);
    });

    message.addEventListener('mouseleave', () => {
      clearTimeout(pressTimer);
    });

    // Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù„Ù…Ø³ÙŠØ©
    message.addEventListener('touchstart', (e) => {
      pressTimer = setTimeout(() => {
        showMessageMenu(e, messageId, messageData);
      }, 500);
    });

    message.addEventListener('touchend', () => {
      clearTimeout(pressTimer);
    });

    let messageContent = '';
    
    if (messageData.type === 'image') {
      messageContent = `
        <div class="message-media">
          <img src="${messageData.mediaURL}" alt="ØµÙˆØ±Ø©" />
        </div>
      `;
      message.addEventListener('click', () => openMediaPreview(messageData.mediaURL, 'image'));
    } else if (messageData.type === 'video') {
      messageContent = `
        <div class="message-media">
          <video src="${messageData.mediaURL}" controls></video>
        </div>
      `;
    } else if (messageData.type === 'audio') {
      messageContent = `
        <div class="message-media">
          <audio src="${messageData.mediaURL}" controls></audio>
        </div>
      `;
    } else {
      messageContent = escapeHtml(messageData.text || '');
    }
    
    const timestamp = messageData.timestamp ? 
      (messageData.timestamp.toDate ? messageData.timestamp.toDate() : new Date(messageData.timestamp)) : 
      new Date();
    
    const statusHtml = getMessageStatus(messageData);
    
    message.innerHTML = `
      ${messageContent}
      ${messageData.text && messageData.type !== 'text' ? `<div style="margin-top: 5px;">${escapeHtml(messageData.text)}</div>` : ''}
      <div class="message-time">
        ${formatTime(timestamp)}
        ${statusHtml}
      </div>
    `;
    
    messageWrapper.appendChild(message);
    messagesArea.appendChild(messageWrapper);
  }

  function showMessageMenu(e, messageId, messageData) {
    e.preventDefault();
    selectedMessageId = messageId;
    
    const menu = messageMenu;
    const deleteForMeBtn = document.getElementById('deleteForMeBtn');
    const deleteForAllBtn = document.getElementById('deleteForAllBtn');
    
    // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø­Ø°Ù Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    if (messageData.from === currentUser.email) {
      deleteForAllBtn.style.display = 'block';
    } else {
      deleteForAllBtn.style.display = 'none';
    }
    
    menu.style.display = 'flex';
    menu.style.left = `${e.pageX}px`;
    menu.style.top = `${e.pageY}px`;
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
    setTimeout(() => {
      document.addEventListener('click', hideMessageMenu);
    }, 100);
  }

  function hideMessageMenu() {
    messageMenu.style.display = 'none';
    document.removeEventListener('click', hideMessageMenu);
  }

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function formatTime(date) {
    return date.toLocaleTimeString('ar-EG', {
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  function scrollToBottom() {
    messagesArea.scrollTop = messagesArea.scrollHeight;
  }

  async function markMessageAsRead(messageId) {
    if (!isOnline) return;
    
    try {
      const messageRef = doc(db, "messages", messageId);
      await updateDoc(messageRef, { 
        read: true,
        delivered: true
      });
    } catch (error) {
      console.warn("Ø®Ø·Ø£ ÙÙŠ ÙˆØ³Ù… Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø©:", error);
    }
  }

  async function sendMessage(text = '', type = 'text', mediaURL = '') {
    if ((!text.trim() && !mediaURL) || !currentChatUser) return;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¸Ø±
    const isBlocked = blockedUsers.has(currentChatUser.email);
    const userBlocked = await checkIfUserBlockedMe(currentChatUser.id);
    
    if (isBlocked || userBlocked) {
      alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
      return;
    }
    
    const messageData = {
      from: currentUser.email,
      fromUid: currentUser.uid,
      to: currentChatUser.email,
      toUid: currentChatUser.id,
      text: text.trim(),
      type,
      timestamp: isOnline ? serverTimestamp() : new Date(),
      read: false,
      delivered: false,
      status: 'sending'
    };
    
    if (mediaURL) {
      messageData.mediaURL = mediaURL;
    }
    
    try {
      if (isOnline) {
        const docRef = await addDoc(collection(db, "messages"), messageData);
        
        // Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø© Ù„Ù„Ù…Ø³ØªÙ‚Ø¨Ù„
        try {
          const unreadRef = doc(db, `users/${currentChatUser.id}/unreadCounts`, currentUser.uid);
          await setDoc(unreadRef, { count: increment(1) }, { merge: true });
        } catch (unreadError) {
          console.warn("Ø®Ø·Ø£ ÙÙŠ Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©:", unreadError);
        }
      } else {
        // Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹
        messageData.id = Date.now().toString();
        offlineMessages.push(messageData);
        localStorage.setItem(`pending_messages_${currentUser.uid}`, JSON.stringify(offlineMessages));
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
        displayMessage(messageData, messageData.id);
      }
      
      messageInput.value = '';
      messageInput.style.height = 'auto';
      
      // Ø¥ÙŠÙ‚Ø§Ù Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
      if (isTyping) {
        isTyping = false;
        updateTypingStatus(false);
      }
      
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', error);
      if (isOnline) {
        alert('ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
      }
    }
  }

  async function uploadFile(file, progressCallback) {
    if (!isOnline) {
      throw new Error('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª');
    }
    
    const fileExtension = file.name.split('.').pop();
    const fileName = `${Date.now()}_${Math.random().toString(36).substring(2, 15)}.${fileExtension}`;
    const fileRef = ref(storage, `media/${fileName}`);
    
    return new Promise((resolve, reject) => {
      const uploadTask = uploadBytesResumable(fileRef, file);
      
      uploadTask.on('state_changed',
        (snapshot) => {
          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          if (progressCallback) progressCallback(progress);
        },
        (error) => {
          console.error('Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù:', error);
          reject(error);
        },
        async () => {
          try {
            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
            resolve(downloadURL);
          } catch (error) {
            reject(error);
          }
        }
      );
    });
  }

  function showMediaPreview(file, type) {
    selectedMedia = { file, type };
    const previewContent = document.getElementById('previewContent');
    previewContent.innerHTML = '';
    
    if (type === 'image') {
      const img = document.createElement('img');
      img.src = URL.createObjectURL(file);
      img.alt = "Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©";
      previewContent.appendChild(img);
    } else if (type === 'video') {
      const video = document.createElement('video');
      video.src = URL.createObjectURL(file);
      video.controls = true;
      previewContent.appendChild(video);
    } else if (type === 'audio') {
      const audio = document.createElement('audio');
      audio.src = URL.createObjectURL(file);
      audio.controls = true;
      previewContent.appendChild(audio);
    }
    
    document.getElementById('mediaPreview').style.display = 'flex';
  }

  window.openMediaPreview = function(url, type) {
    const previewContent = document.getElementById('previewContent');
    previewContent.innerHTML = '';
    
    if (type === 'image') {
      const img = document.createElement('img');
      img.src = url;
      img.alt = "ØµÙˆØ±Ø©";
      previewContent.appendChild(img);
    } else if (type === 'video') {
      const video = document.createElement('video');
      video.src = url;
      video.controls = true;
      video.autoplay = true;
      previewContent.appendChild(video);
    }
    
    document.getElementById('mediaPreview').style.display = 'flex';
    
    document.getElementById('mediaPreview').onclick = (e) => {
      if (e.target === e.currentTarget) {
        document.getElementById('mediaPreview').style.display = 'none';
      }
    };
  };

  async function deleteMessage(messageId, deleteType) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ')) return;
    
    try {
      if (deleteType === 'all' && isOnline) {
        await deleteDoc(doc(db, "messages", messageId));
        alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹.');
      } else {
        // Ø­Ø°Ù Ù…Ø­Ù„ÙŠ Ø£Ùˆ Ø­Ø°Ù Ù„Ø¯ÙŠ
        const messageElement = messagesArea.querySelector(`[data-message-id="${messageId}"]`);
        if (messageElement) {
          messageElement.remove();
        }
        
        if (isOnline && deleteType === 'me') {
          await updateDoc(doc(db, "messages", messageId), {
            [`deletedFor_${currentUser.uid}`]: true
          });
        }
        
        alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ø¯ÙŠÙƒ.');
      }
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', error);
      alert('ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©.');
    }
  }

  // Ø¥Ø¹Ø¯Ø§Ø¯ FCM Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
  async function setupFCM() {
    if (!messaging || !('Notification' in window) || !isOnline) return;

    try {
      const permission = await Notification.requestPermission();
      if (permission === 'granted') {
        const vapidKey = 'wf0M42ddJDLMSFkMst6y8iVaYM5_pk2mJHGG8LRiWhw';
        const currentToken = await getToken(messaging, { vapidKey });
        
        if (currentToken) {
          console.log('FCM Token:', currentToken);
          await setDoc(doc(db, "users", currentUser.uid), { fcmToken: currentToken }, { merge: true });
        }
      }

      // Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©
      onMessage(messaging, (payload) => {
        console.log('Ø±Ø³Ø§Ù„Ø© FCM ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©:', payload);
        if (notificationsEnabled && document.hidden) {
          sendNotification(payload.notification.title, payload.notification.body);
        }
      });

    } catch (error) {
      console.warn('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ FCM:', error);
    }
  }

  function sendNotification(title, body) {
    if (notificationsEnabled && document.hidden && 'Notification' in window) {
      new Notification(`ğŸ’¬ ${title}`, {
        body: body,
        icon: 'icon-192x192.png',
        badge: 'icon-192x192.png'
      });
    }
    
    if (soundsEnabled) {
      playNotificationSound();
    }
  }

  function playNotificationSound() {
    try {
      notificationSound.currentTime = 0;
      notificationSound.play().catch(error => {
        console.warn("Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:", error);
      });
    } catch (error) {
      console.warn("Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:", error);
    }
  }

  async function loadBlockedUsers() {
    if (!isOnline) {
      const blocked = localStorage.getItem(`blocked_users_${currentUser.uid}`);
      if (blocked) {
        blockedUsers = new Set(JSON.parse(blocked));
      }
      return;
    }
    
    try {
      const userDoc = await getDoc(doc(db, "users", currentUser.uid));
      if (userDoc.exists() && userDoc.data().blockedUsers) {
        blockedUsers = new Set(userDoc.data().blockedUsers);
        localStorage.setItem(`blocked_users_${currentUser.uid}`, JSON.stringify(Array.from(blockedUsers)));
      } else {
        blockedUsers = new Set();
      }
    } catch (error) {
      console.warn("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†:", error);
    }
  }

  async function toggleBlockUser(userEmail) {
    if (!isOnline) {
      alert('ÙŠØ¬Ø¨ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¸Ø±');
      return;
    }
    
    const userRef = doc(db, "users", currentUser.uid);
    let newBlockedUsers;
    
    if (blockedUsers.has(userEmail)) {
      blockedUsers.delete(userEmail);
      newBlockedUsers = Array.from(blockedUsers);
      alert('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….');
    } else {
      blockedUsers.add(userEmail);
      newBlockedUsers = Array.from(blockedUsers);
      alert('ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­.');
    }
    
    try {
      await updateDoc(userRef, { blockedUsers: newBlockedUsers });
      localStorage.setItem(`blocked_users_${currentUser.uid}`, JSON.stringify(newBlockedUsers));
      loadUsers();
      
      if (currentChatUser) {
        document.getElementById('blockUserBtn').innerHTML = 
          blockedUsers.has(currentChatUser.email) ? 'ğŸ”“ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±' : 'ğŸš« Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        if (blockedUsers.has(currentChatUser.email)) {
          messageInput.disabled = true;
          messageInput.placeholder = 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
          document.getElementById('chatUserStatus').textContent = 'Ù…Ø­Ø¸ÙˆØ±';
        } else {
          messageInput.disabled = false;
          messageInput.placeholder = 'Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...';
        }
      }
    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†:", error);
      alert('ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¸Ø±.');
    }
  }

  // Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
  sendBtn.addEventListener('click', () => sendMessage(messageInput.value));
  
  messageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø¥Ù†ØªØ± Ù„Ù„Ø³Ø·Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø¥Ø²Ø§Ù„Ø© preventDefault)
      // e.preventDefault();
      // sendMessage(messageInput.value);
    }
  });

  messageInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 100) + 'px';
    
    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
    handleTyping();
  });

  backBtn.addEventListener('click', () => {
    chatContainer.style.display = 'none';
    app_div.style.display = 'flex';
    currentChatUser = null;
    if (unsubscribeMessages) unsubscribeMessages();
    
    // Ø¥ÙŠÙ‚Ø§Ù Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
    if (isTyping) {
      isTyping = false;
      updateTypingStatus(false);
    }
  });

  // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
  attachBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    attachMenu.style.display = attachMenu.style.display === 'flex' ? 'none' : 'flex';
    emojiPanel.style.display = 'none';
  });

  // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
  emojiBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    emojiPanel.style.display = emojiPanel.style.display === 'flex' ? 'none' : 'flex';
    attachMenu.style.display = 'none';
  });

  document.addEventListener('click', (e) => {
    if (!attachMenu.contains(e.target) && e.target !== attachBtn) {
      attachMenu.style.display = 'none';
    }
    if (!emojiPanel.contains(e.target) && e.target !== emojiBtn) {
      emojiPanel.style.display = 'none';
    }
    if (!dropdownMenu.contains(e.target) && e.target !== menuBtn) {
      dropdownMenu.style.display = 'none';
    }
    if (!chatDropdownMenu.contains(e.target) && e.target !== chatMenuBtn) {
      chatDropdownMenu.style.display = 'none';
    }
  });

  document.getElementById('attachImageBtn').addEventListener('click', () => {
    document.getElementById('cameraInput').click();
    attachMenu.style.display = 'none';
  });

  document.getElementById('attachGalleryBtn').addEventListener('click', () => {
    document.getElementById('imageInput').click();
    attachMenu.style.display = 'none';
  });

  document.getElementById('attachVideoBtn').addEventListener('click', () => {
    document.getElementById('videoInput').click();
    attachMenu.style.display = 'none';
  });

  // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„ÙØ§Øª
  document.getElementById('imageInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) showMediaPreview(file, 'image');
    e.target.value = '';
  });

  document.getElementById('videoInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) showMediaPreview(file, 'video');
    e.target.value = '';
  });

  document.getElementById('cameraInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) showMediaPreview(file, 'image');
    e.target.value = '';
  });

  // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·
  document.getElementById('sendMediaBtn').addEventListener('click', async () => {
    if (!selectedMedia) return;
    
    if (!isOnline) {
      alert('ÙŠØ¬Ø¨ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·');
      return;
    }
    
    try {
      const sendButton = document.getElementById('sendMediaBtn');
      const originalText = sendButton.textContent;
      sendButton.innerHTML = '<div class="loading"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...';
      sendButton.disabled = true;
      
      const mediaURL = await uploadFile(selectedMedia.file, (progress) => {
        sendButton.textContent = `${Math.round(progress)}% Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...`;
      });
      
      await sendMessage('', selectedMedia.type, mediaURL);
      document.getElementById('mediaPreview').style.display = 'none';
      selectedMedia = null;
    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·:", error);
      alert('ÙØ´Ù„ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
    } finally {
      const sendButton = document.getElementById('sendMediaBtn');
      sendButton.innerHTML = 'ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„';
      sendButton.disabled = false;
    }
  });

  document.getElementById('cancelMediaBtn').addEventListener('click', () => {
    document.getElementById('mediaPreview').style.display = 'none';
    selectedMedia = null;
  });

  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª
  recordBtn.addEventListener('click', async () => {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
      mediaRecorder.stop();
      return;
    }

    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      const audioChunks = [];
      
      mediaRecorder.ondataavailable = (event) => {
        audioChunks.push(event.data);
      };
      
      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        const audioFile = new File([audioBlob], `voice_${Date.now()}.webm`, { type: 'audio/webm' });
        showMediaPreview(audioFile, 'audio');
        
        stream.getTracks().forEach(track => track.stop());
        stopRecording();
      };
      
      mediaRecorder.start();
      startRecording();
      
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†:', error);
      alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„.');
    }
  });

  stopRecordingBtn.addEventListener('click', () => {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
      mediaRecorder.stop();
    }
  });

  function startRecording() {
    recordingIndicator.style.display = 'flex';
    recordBtn.style.display = 'none';
    recordingStartTime = Date.now();
    
    recordingInterval = setInterval(() => {
      const elapsed = Date.now() - recordingStartTime;
      const minutes = Math.floor(elapsed / 60000);
      const seconds = Math.floor((elapsed % 60000) / 1000);
      recordingTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }, 1000);
  }

  function stopRecording() {
    recordingIndicator.style.display = 'none';
    recordBtn.style.display = 'flex';
    if (recordingInterval) {
      clearInterval(recordingInterval);
      recordingInterval = null;
    }
  }

  // Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
  menuBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    dropdownMenu.style.display = dropdownMenu.style.display === 'flex' ? 'none' : 'flex';
    chatDropdownMenu.style.display = 'none';
  });

  // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
  chatMenuBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    chatDropdownMenu.style.display = chatDropdownMenu.style.display === 'flex' ? 'none' : 'flex';
    dropdownMenu.style.display = 'none';
  });

  // Ø§Ù„Ø¨Ø­Ø«
  searchInput.addEventListener('input', (e) => {
    const searchTerm = e.target.value.toLowerCase();
    document.querySelectorAll('.user-card').forEach(card => {
      const username = card.querySelector('h4').textContent.toLowerCase();
      card.style.display = username.includes(searchTerm) ? 'flex' : 'none';
    });
  });

  // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
      await updateUserPresence(false);
      await signOut(auth);
    }
  });

  document.getElementById('deleteAccountBtn').addEventListener('click', async () => {
    const confirmText = prompt('Ù„Ù„ØªØ£ÙƒÙŠØ¯ØŒ Ø§ÙƒØªØ¨ "Ø­Ø°Ù" Ù„Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹:');
    if (confirmText === 'Ø­Ø°Ù') {
      try {
        // Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const userRef = doc(db, "users", currentUser.uid);
        
        // Ø­Ø°Ù Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©
        const unreadCountsRef = collection(db, `users/${currentUser.uid}/unreadCounts`);
        const unreadSnapshot = await getDocs(unreadCountsRef);
        const deletePromises = [];
        unreadSnapshot.forEach(doc => {
          deletePromises.push(deleteDoc(doc.ref));
        });
        await Promise.all(deletePromises);
        
        // Ø­Ø°Ù Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        await deleteDoc(userRef);
        
        // Ø­Ø°Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
        await deleteUser(currentUser);
        
        // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        clearOfflineData();
        
        alert('ØªÙ… Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ ÙˆØ¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­.');
      } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨:", error);
        alert('ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨. Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.');
      }
    }
  });

  // Ø£Ø­Ø¯Ø§Ø« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
  document.getElementById('blockUserBtn').addEventListener('click', () => {
    if (currentChatUser) {
      const isBlocked = blockedUsers.has(currentChatUser.email);
      if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ ${isBlocked ? 'Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø±' : 'Ø­Ø¸Ø±'} ${currentChatUser.username}ØŸ`)) {
        toggleBlockUser(currentChatUser.email);
      }
    }
    chatDropdownMenu.style.display = 'none';
  });

  document.getElementById('clearChatBtn').addEventListener('click', () => {
    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ØŸ (Ù„Ù† ÙŠØªÙ… Ø­Ø°ÙÙ‡Ø§ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…)')) {
      messagesArea.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø­Ù„ÙŠØ§Ù‹</div>';
    }
    chatDropdownMenu.style.display = 'none';
  });

  // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø·ÙˆÙ„
  document.getElementById('deleteForMeBtn').addEventListener('click', () => {
    if (selectedMessageId) {
      deleteMessage(selectedMessageId, 'me');
    }
    hideMessageMenu();
  });

  document.getElementById('deleteForAllBtn').addEventListener('click', () => {
    if (selectedMessageId) {
      deleteMessage(selectedMessageId, 'all');
    }
    hideMessageMenu();
  });

  // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ (Ù…Ø¤Ù‚ØªØ©)
  document.getElementById('voiceCallBtn').addEventListener('click', () => {
    alert('Ù…ÙŠØ²Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ØµÙˆØªÙŠ Ø³ØªØªÙˆÙØ± Ù‚Ø±ÙŠØ¨Ø§Ù‹');
  });

  document.getElementById('videoCallBtn').addEventListener('click', () => {
    alert('Ù…ÙŠØ²Ø© Ø§ØªØµØ§Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø³ØªØªÙˆÙØ± Ù‚Ø±ÙŠØ¨Ø§Ù‹');
  });

  // Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
  document.getElementById('editProfileBtn').addEventListener('click', async () => {
    if (!isOnline) {
      alert('ÙŠØ¬Ø¨ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ');
      return;
    }
    
    const userDoc = await getDoc(doc(db, "users", currentUser.uid));
    if (userDoc.exists()) {
      const userData = userDoc.data();
      document.getElementById('editUsername').value = userData.username || '';
      document.getElementById('editStatus').value = userData.status || '';
    }
    document.getElementById('editProfileModal').style.display = 'flex';
    dropdownMenu.style.display = 'none';
  });

  document.getElementById('saveProfileBtn').addEventListener('click', async () => {
    const newUsername = document.getElementById('editUsername').value.trim();
    const newStatus = document.getElementById('editStatus').value.trim();
    
    if (!newUsername) {
      alert('Ø§Ù„Ø§Ø³Ù… Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ§Ø±ØºØ§Ù‹.');
      return;
    }
    
    try {
      await updateDoc(doc(db, "users", currentUser.uid), {
        username: newUsername,
        status: newStatus,
        photoURL: `https://ui-avatars.com/api/?name=${encodeURIComponent(newUsername)}&background=6a11cb&color=fff&rounded=true&size=128`
      });
      
      document.getElementById('currentUsername').textContent = newUsername;
      document.getElementById('currentUserStatus').textContent = newStatus;
      document.getElementById('userAvatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(newUsername)}&background=6a11cb&color=fff&rounded=true&size=128`;
      
      document.getElementById('editProfileModal').style.display = 'none';
      alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø¨Ù†Ø¬Ø§Ø­!');
    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ:", error);
      alert('ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ.');
    }
  });

  document.getElementById('cancelProfileBtn').addEventListener('click', () => {
    document.getElementById('editProfileModal').style.display = 'none';
  });

  // Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
  document.getElementById('notificationSettingsBtn').addEventListener('click', () => {
    document.getElementById('enableNotifications').checked = notificationsEnabled;
    document.getElementById('enableSounds').checked = soundsEnabled;
    document.getElementById('notificationModal').style.display = 'flex';
    dropdownMenu.style.display = 'none';
  });

  document.getElementById('saveNotificationBtn').addEventListener('click', async () => {
    notificationsEnabled = document.getElementById('enableNotifications').checked;
    soundsEnabled = document.getElementById('enableSounds').checked;
    
    localStorage.setItem('notificationsEnabled', notificationsEnabled);
    localStorage.setItem('soundsEnabled', soundsEnabled);

    if (isOnline) {
      try {
        await updateDoc(doc(db, "users", currentUser.uid), {
          notificationsEnabled,
          soundsEnabled
        });
        alert('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª.');
      } catch (error) {
        console.warn("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:", error);
      }
    } else {
      alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹. Ø³ÙŠØªÙ… Ù…Ø²Ø§Ù…Ù†ØªÙ‡Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.');
    }
    
    document.getElementById('notificationModal').style.display = 'none';
  });

  document.getElementById('cancelNotificationBtn').addEventListener('click', () => {
    document.getElementById('notificationModal').style.display = 'none';
  });

  // Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†
  document.getElementById('blockedUsersBtn').addEventListener('click', async () => {
    const blockedUsersList = document.getElementById('blockedUsersList');
    blockedUsersList.innerHTML = '';
    
    if (blockedUsers.size === 0) {
      blockedUsersList.innerHTML = '<p style="text-align: center; color: #777;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù…Ø­Ø¸ÙˆØ±ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
    } else {
      if (isOnline) {
        const usersCollection = collection(db, "users");
        
        for (const email of blockedUsers) {
          const q = query(usersCollection, where("email", "==", email));
          const querySnapshot = await getDocs(q);
          
          if (!querySnapshot.empty) {
            const userData = querySnapshot.docs[0].data();
            const blockedCard = document.createElement('div');
            blockedCard.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee;';
            blockedCard.innerHTML = `
              <div style="display: flex; align-items: center; gap: 10px;">
                <img src="${userData.photoURL}" alt="${userData.username}" style="width: 30px; height: 30px; border-radius: 50%;" />
                <div>
                  <div style="font-weight: bold;">${userData.username}</div>
                  <div style="font-size: 12px; color: #666;">${userData.email}</div>
                </div>
              </div>
              <button style="background: #2575fc; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;" data-email="${userData.email}">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±</button>
            `;
            blockedCard.querySelector('button').addEventListener('click', async (ev) => {
              await toggleBlockUser(ev.target.dataset.email);
              document.getElementById('blockedUsersModal').style.display = 'none';
            });
            blockedUsersList.appendChild(blockedCard);
          }
        }
      } else {
        blockedUsersList.innerHTML = '<p style="text-align: center; color: #777;">ÙŠØ¬Ø¨ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†.</p>';
      }
    }
    
    document.getElementById('blockedUsersModal').style.display = 'flex';
    dropdownMenu.style.display = 'none';
  });

  document.getElementById('closeBlockedUsersBtn').addEventListener('click', () => {
    document.getElementById('blockedUsersModal').style.display = 'none';
  });

  // Ù…ÙˆØ¯Ø§Ù„ Ø¹Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
  document.getElementById('aboutBtn').addEventListener('click', () => {
    document.getElementById('aboutModal').style.display = 'flex';
    dropdownMenu.style.display = 'none';
  });

  document.getElementById('closeAboutBtn').addEventListener('click', () => {
    document.getElementById('aboutModal').style.display = 'none';
  });

  // PWA - ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.style.display = 'inline-block';
  });

  installBtn.addEventListener('click', async () => {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      console.log(`Ù†ØªÙŠØ¬Ø© ØªØ«Ø¨ÙŠØª PWA: ${outcome}`);
      deferredPrompt = null;
      installBtn.style.display = 'none';
    }
  });

  window.addEventListener('appinstalled', () => {
    installBtn.style.display = 'none';
    console.log('ØªÙ… ØªØ«Ø¨ÙŠØª PWA');
  });

  // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø«Ø¨ØªØ§Ù‹ Ø¨Ø§Ù„ÙØ¹Ù„
  if (navigator.standalone || window.matchMedia('(display-mode: standalone)').matches) {
    installBtn.style.display = 'none';
  }

  console.log('ğŸ’¬ ChatPro ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¨Ù†Ø¬Ø§Ø­!');
</script>

</body>
</html>

