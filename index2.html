<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üí¨ ChatPro - ÿØÿ±ÿØÿ¥ÿ© ŸÅŸàÿ±Ÿäÿ©</title>
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQ2hhdFBybyIsInNob3J0X25hbWUiOiJDaGF0UHJvIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiM2YTExY2IiLCJ0aGVtZV9jb2xvciI6IiM2YTExY2IifQ==">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      direction: rtl;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100vh;
      overflow: hidden;
    }

    /* ÿ¥ÿßÿ¥ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ */
    #authContainer {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
      width: min(400px, 90vw);
      z-index: 1000;
    }

    #authContainer h2 {
      text-align: center;
      margin-bottom: 30px;
      color: #6a11cb;
      font-size: 28px;
      font-weight: bold;
    }

    input, button, textarea {
      width: 100%;
      padding: 15px;
      margin: 10px 0;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 16px;
      transition: all 0.3s ease;
      font-family: inherit;
    }

    input:focus, textarea:focus {
      border-color: #6a11cb;
      outline: none;
      box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.1);
    }

    button {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(106, 17, 203, 0.3);
    }

    button:active {
      transform: translateY(0);
    }

    #toggleFormBtn {
      background: transparent;
      color: #6a11cb;
      border: 2px solid #6a11cb;
    }

    #toggleFormBtn:hover {
      background: #6a11cb;
      color: white;
    }

    #errorMsg {
      color: #e74c3c;
      text-align: center;
      min-height: 20px;
      font-weight: bold;
      font-size: 14px;
    }

    /* ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä */
    #app {
      display: none;
      height: 100vh;
      background: white;
      flex-direction: column;
    }

    /* ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿπŸÑŸàŸä */
    #appHeader {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      padding: 15px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      position: relative;
      z-index: 100;
    }

    #appLogo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 26px;
      font-weight: bold;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    #appLogo::before {
      content: "üí¨";
      font-size: 32px;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    }

    #userInfo {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    #userAvatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      border: 3px solid rgba(255,255,255,0.3);
      object-fit: cover;
    }

    #userDetails {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    #currentUsername {
      font-weight: bold;
      font-size: 16px;
    }

    #currentUserStatus {
      font-size: 12px;
      opacity: 0.8;
    }

    #menuBtn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 12px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 20px;
      transition: background 0.3s;
    }

    #menuBtn:hover {
      background: rgba(255,255,255,0.3);
    }

    /* ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä */
    #mainContent {
      display: flex;
      height: calc(100vh - 75px);
      position: relative;
    }

    /* ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ */
    #usersListContainer {
      width: 350px;
      background: #f8f9fa;
      border-left: 1px solid #e9ecef;
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease;
    }

    #usersListContainer.hidden {
      transform: translateX(100%);
    }

    #searchContainer {
      padding: 20px;
      background: white;
      border-bottom: 1px solid #e9ecef;
    }

    #searchInput {
      width: 100%;
      padding: 12px 20px;
      border: 2px solid #e9ecef;
      border-radius: 25px;
      font-size: 16px;
      background: #f8f9fa;
      margin: 0;
    }

    #searchInput:focus {
      background: white;
      border-color: #6a11cb;
    }

    #usersList {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .user-card {
      background: white;
      border-radius: 15px;
      padding: 15px;
      margin: 8px 0;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      gap: 15px;
      position: relative;
      border: 2px solid transparent;
    }

    .user-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      border-color: #6a11cb;
    }

    .user-card.active {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
    }

    .user-card.blocked {
      opacity: 0.5;
      background: #ffebee;
    }

    .user-avatar-container {
      position: relative;
    }

    .user-avatar {
      width: 55px;
      height: 55px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid transparent;
    }

    .user-card.active .user-avatar {
      border-color: white;
    }

    .online-indicator {
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 16px;
      height: 16px;
      background: #28a745;
      border: 3px solid white;
      border-radius: 50%;
      display: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .online-indicator.online {
      display: block;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
      100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
    }

    .user-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .user-info h4 {
      margin: 0;
      font-size: 16px;
      font-weight: bold;
    }

    .user-status {
      font-size: 14px;
      opacity: 0.7;
    }

    .last-seen {
      font-size: 12px;
      opacity: 0.6;
      font-style: italic;
    }

    .unread-count {
      position: absolute;
      top: 8px;
      left: 8px;
      background: #e74c3c;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .unread-count.show {
      display: flex;
    }

    /* ÿ¥ÿßÿ¥ÿ© ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ© */
    #chatContainer {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: white;
      position: relative;
    }

    #chatContainer.fullscreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 200;
    }

    #chatHeader {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      padding: 20px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    #chatUserInfo {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    #chatUserAvatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 3px solid rgba(255,255,255,0.3);
      object-fit: cover;
    }

    #chatUserDetails {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    #chatUserName {
      font-size: 20px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #chatUserStatus {
      font-size: 14px;
      opacity: 0.8;
    }

    #chatControls {
      display: flex;
      gap: 10px;
    }

    .chat-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s;
    }

    .chat-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    /* ŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ */
    #messagesArea {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .message-wrapper {
      display: flex;
      position: relative;
    }

    .message-wrapper.sent {
      justify-content: flex-end;
    }

    .message-wrapper.received {
      justify-content: flex-start;
    }

    .message {
      max-width: 70%;
      padding: 15px 20px;
      border-radius: 20px;
      position: relative;
      word-wrap: break-word;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      animation: messageSlide 0.3s ease;
    }

    @keyframes messageSlide {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.sent {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      border-bottom-right-radius: 5px;
    }

    .message.received {
      background: white;
      color: #333;
      border: 1px solid #e9ecef;
      border-bottom-left-radius: 5px;
    }

    .message-content {
      margin-bottom: 8px;
      line-height: 1.4;
    }

    .message-media {
      border-radius: 15px;
      overflow: hidden;
      position: relative;
      margin-bottom: 10px;
      background: #000;
    }

    .message-media img,
    .message-media video {
      width: 100%;
      max-width: 300px;
      height: auto;
      border-radius: 15px;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .message-media img:hover,
    .message-media video:hover {
      transform: scale(1.02);
    }

    .media-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 15px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .loading-spinner {
      width: 30px;
      height: 30px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .message-time {
      font-size: 11px;
      opacity: 0.7;
      text-align: left;
      direction: ltr;
    }

    .message-options {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      display: none;
      flex-direction: column;
      gap: 5px;
    }

    .message-wrapper.sent .message-options {
      left: -40px;
    }

    .message-wrapper.received .message-options {
      right: -40px;
    }

    .message-wrapper:hover .message-options {
      display: flex;
    }

    .message-option {
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      padding: 8px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      width: 32px;
      height: 32px;
      transition: background 0.3s;
    }

    .message-option:hover {
      background: rgba(0,0,0,0.9);
    }

    /* ŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ•ÿØÿÆÿßŸÑ */
    #inputContainer {
      background: white;
      padding: 20px 25px;
      border-top: 1px solid #e9ecef;
      display: flex;
      align-items: flex-end;
      gap: 15px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    }

    #mediaButtons {
      display: flex;
      gap: 8px;
    }

    .media-btn {
      background: #f8f9fa;
      color: #6a11cb;
      border: 2px solid #e9ecef;
      padding: 12px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.3s;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .media-btn:hover {
      background: #6a11cb;
      color: white;
      border-color: #6a11cb;
    }

    #messageInput {
      flex: 1;
      resize: none;
      min-height: 48px;
      max-height: 120px;
      padding: 12px 20px;
      border: 2px solid #e9ecef;
      border-radius: 25px;
      font-size: 16px;
      line-height: 1.4;
      margin: 0;
    }

    #sendBtn {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: transform 0.2s;
      margin: 0;
      min-width: 80px;
    }

    #sendBtn:hover {
      transform: scale(1.05);
    }

    /* ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑŸàÿ≥ÿßÿ¶ÿ∑ */
    #mediaPreview {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 3000;
      backdrop-filter: blur(10px);
    }

    #mediaPreview .preview-content {
      max-width: 90%;
      max-height: 90%;
      position: relative;
    }

    #mediaPreview img,
    #mediaPreview video {
      max-width: 100%;
      max-height: 100%;
      border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
    }

    .preview-controls {
      position: absolute;
      bottom: -80px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 15px;
    }

    .preview-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 15px 25px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      backdrop-filter: blur(10px);
      transition: background 0.3s;
    }

    .preview-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    .preview-btn.send {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    }

    /* ÿßŸÑŸÇŸàÿßÿ¶ŸÖ ÿßŸÑŸÖŸÜÿ≥ÿØŸÑÿ© */
    #dropdownMenu {
      position: absolute;
      top: 75px;
      right: 25px;
      background: white;
      border-radius: 15px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.2);
      display: none;
      flex-direction: column;
      min-width: 220px;
      z-index: 300;
      overflow: hidden;
      border: 1px solid #e9ecef;
    }

    .dropdown-item {
      padding: 15px 20px;
      border: none;
      background: transparent;
      text-align: right;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s;
      display: flex;
      align-items: center;
      gap: 12px;
      justify-content: flex-end;
    }

    .dropdown-item:hover {
      background: #f8f9fa;
    }

    .dropdown-item.danger {
      color: #e74c3c;
    }

    .dropdown-item.danger:hover {
      background: #ffebee;
    }

    /* ÿßŸÑŸÖŸàÿØÿßŸÑ */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 4000;
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      width: min(400px, 90vw);
      position: relative;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
      animation: modalSlide 0.3s ease;
    }

    @keyframes modalSlide {
      from {
        opacity: 0;
        transform: scale(0.9) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .modal h3 {
      margin-bottom: 20px;
      text-align: center;
      color: #333;
      font-size: 24px;
    }

    .modal-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 25px;
    }

    .modal-buttons button {
      padding: 12px 25px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s;
    }

    .modal-buttons .primary {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
    }

    .modal-buttons .secondary {
      background: #f8f9fa;
      color: #6a11cb;
      border: 2px solid #e9ecef;
    }

    /* ÿ≠ÿßŸÑÿ© ÿßŸÑŸÉÿ™ÿßÿ®ÿ© */
    #typingIndicator {
      padding: 10px 25px;
      color: #6a11cb;
      font-style: italic;
      font-size: 14px;
      background: rgba(106, 17, 203, 0.05);
      display: none;
    }

    .typing-dots {
      display: inline-block;
    }

    .typing-dots::after {
      content: '';
      animation: typing 1.5s infinite;
    }

    @keyframes typing {
      0%, 60%, 100% { content: ''; }
      30% { content: '.'; }
      60% { content: '..'; }
      90% { content: '...'; }
    }

    /* ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ÿßŸÑÿ¨ŸàÿßŸÑ */
    @media (max-width: 768px) {
      #appHeader {
        padding: 12px 15px;
      }

      #appLogo {
        font-size: 22px;
      }

      #appLogo::before {
        font-size: 28px;
      }

      #usersListContainer {
        width: 100%;
        position: absolute;
        top: 0;
        right: 0;
        height: 100%;
        z-index: 150;
        transform: translateX(100%);
      }

      #usersListContainer.show {
        transform: translateX(0);
      }

      #chatContainer {
        width: 100%;
      }

      .message {
        max-width: 85%;
      }

      #inputContainer {
        padding: 15px;
      }

      #mediaButtons {
        flex-direction: column;
      }

      .user-card {
        padding: 12px;
      }

      .user-avatar {
        width: 50px;
        height: 50px;
      }
    }

    /* ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© */
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .slide-up {
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ÿßŸÑŸÖÿÆÿµÿµ */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, #2575fc 0%, #6a11cb 100%);
    }

    /* ÿ•ÿÆŸÅÿßÿ° ŸÖŸÑŸÅÿßÿ™ ÿßŸÑÿ•ÿØÿÆÿßŸÑ */
    input[type="file"] {
      display: none;
    }

    /* ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ±ÿ≠Ÿäÿ® */
    .welcome-message {
      text-align: center;
      padding: 50px 20px;
      color: #666;
      font-size: 18px;
    }

    .welcome-message h3 {
      color: #6a11cb;
      margin-bottom: 15px;
      font-size: 24px;
    }

    /* ÿ≠ÿßŸÑÿ© ŸÅÿßÿ±ÿ∫ÿ© */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #666;
      font-size: 16px;
    }

    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 15px;
      opacity: 0.5;
    }
  </style>
</head>
<body>

<!-- ÿ¥ÿßÿ¥ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ -->
<div id="authContainer">
  <h2 id="formTitle">üí¨ ŸÖÿ±ÿ≠ÿ®ÿßŸã ÿ®ŸÉ ŸÅŸä ChatPro</h2>
  <input type="email" id="email" placeholder="üìß ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä" />
  <input type="password" id="password" placeholder="üîí ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±" />
  <input type="text" id="username" placeholder="üë§ ÿßŸÑÿßÿ≥ŸÖ" style="display: none;" />
  <input type="text" id="status" placeholder="‚ú® ÿßŸÑÿ≠ÿßŸÑÿ© (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)" style="display: none;" />
  <div id="errorMsg"></div>
  <button id="submitBtn">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ</button>
  <button id="toggleFormBtn">ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ</button>
</div>

<!-- ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä -->
<div id="app">
  <!-- ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿπŸÑŸàŸä -->
  <div id="appHeader">
    <div id="appLogo">ChatPro</div>
    <div id="userInfo">
      <img id="userAvatar" src="" alt="Avatar" />
      <div id="userDetails">
        <div id="currentUsername"></div>
        <div id="currentUserStatus"></div>
      </div>
      <button id="menuBtn">‚öôÔ∏è</button>
    </div>
  </div>

  <!-- ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä -->
  <div id="mainContent">
    <!-- ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ -->
    <div id="usersListContainer">
      <div id="searchContainer">
        <input type="text" id="searchInput" placeholder="üîç ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖÿ≥ÿ™ÿÆÿØŸÖ..." />
      </div>
      <div id="usersList">
        <div class="welcome-message">
          <h3>üéâ ŸÖÿ±ÿ≠ÿ®ÿßŸã ÿ®ŸÉ!</h3>
          <p>ÿßÿ®ÿØÿ£ ŸÖÿ≠ÿßÿØÿ´ÿ© ÿ¨ÿØŸäÿØÿ© ŸÖÿπ ÿ£ÿµÿØŸÇÿßÿ¶ŸÉ</p>
        </div>
      </div>
    </div>

    <!-- ÿ¥ÿßÿ¥ÿ© ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ© -->
    <div id="chatContainer">
      <div id="chatHeader" style="display: none;">
        <div id="chatUserInfo">
          <img id="chatUserAvatar" src="" alt="Avatar" />
          <div id="chatUserDetails">
            <div id="chatUserName"></div>
            <div id="chatUserStatus"></div>
          </div>
        </div>
        <div id="chatControls">
          <button class="chat-btn" id="blockUserBtn" title="ÿ≠ÿ∏ÿ± ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ">üö´</button>
          <button class="chat-btn" id="backBtn" title="ÿ±ÿ¨Ÿàÿπ" style="display: none;">‚Üê</button>
        </div>
      </div>

      <div id="messagesArea">
        <div class="empty-state">
          <div class="icon">üí¨</div>
          <p>ÿßÿÆÿ™ÿ± ŸÖÿ≠ÿßÿØÿ´ÿ© ŸÑÿ®ÿØÿ° ÿßŸÑÿØÿ±ÿØÿ¥ÿ©</p>
        </div>
      </div>

      <div id="typingIndicator">
        <span id="typingUser"></span> ŸäŸÉÿ™ÿ®<span class="typing-dots"></span>
      </div>

      <div id="inputContainer" style="display: none;">
        <div id="mediaButtons">
          <button class="media-btn" id="cameraBtn" title="ÿßŸÑÿ™ŸÇÿßÿ∑ ÿµŸàÿ±ÿ©">üì∑</button>
          <button class="media-btn" id="galleryBtn" title="ÿßÿÆÿ™Ÿäÿßÿ± ÿµŸàÿ±ÿ©">üñºÔ∏è</button>
          <button class="media-btn" id="videoBtn" title="ÿßÿÆÿ™Ÿäÿßÿ± ŸÅŸäÿØŸäŸà">üé•</button>
        </div>
        <textarea id="messageInput" placeholder="ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ©..." rows="1"></textarea>
        <button id="sendBtn">ÿ•ÿ±ÿ≥ÿßŸÑ</button>
      </div>
    </div>
  </div>

  <!-- ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÜÿ≥ÿØŸÑÿ© -->
  <div id="dropdownMenu">
    <button class="dropdown-item" id="editProfileBtn">
      ‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä
    </button>
    <button class="dropdown-item" id="notificationSettingsBtn">
      üîî ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
    </button>
    <button class="dropdown-item" id="blockedUsersBtn">
      üö´ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÑŸÖÿ≠ÿ∏Ÿàÿ±ŸäŸÜ
    </button>
    <button class="dropdown-item" id="aboutBtn">
      ‚ÑπÔ∏è ÿπŸÜ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
    </button>
    <button class="dropdown-item danger" id="logoutBtn">
      üö™ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨
    </button>
    <button class="dropdown-item danger" id="deleteAccountBtn">
      ‚ùå ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≠ÿ≥ÿßÿ®
    </button>
  </div>
</div>

<!-- ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑŸàÿ≥ÿßÿ¶ÿ∑ -->
<div id="mediaPreview">
  <div class="preview-content">
    <div id="previewMedia"></div>
    <div class="preview-controls">
      <button class="preview-btn send" id="sendMediaBtn">üì§ ÿ•ÿ±ÿ≥ÿßŸÑ</button>
      <button class="preview-btn" id="cancelMediaBtn">‚ùå ÿ•ŸÑÿ∫ÿßÿ°</button>
    </div>
  </div>
</div>

<!-- ŸÖŸàÿØÿßŸÑ ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä -->
<div class="modal" id="editProfileModal">
  <div class="modal-content">
    <h3>‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä</h3>
    <input type="text" id="editUsername" placeholder="üë§ ÿßŸÑÿßÿ≥ŸÖ" />
    <input type="text" id="editStatus" placeholder="‚ú® ÿßŸÑÿ≠ÿßŸÑÿ©" />
    <div class="modal-buttons">
      <button class="primary" id="saveProfileBtn">üíæ ÿ≠ŸÅÿ∏</button>
      <button class="secondary" id="cancelProfileBtn">‚ùå ÿ•ŸÑÿ∫ÿßÿ°</button>
    </div>
  </div>
</div>

<!-- ŸÖŸàÿØÿßŸÑ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ -->
<div class="modal" id="notificationModal">
  <div class="modal-content">
    <h3>üîî ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™</h3>
    <div style="text-align: right; margin: 20px 0;">
      <label style="display: flex; align-items: center; gap: 10px; margin: 15px 0;">
        <input type="checkbox" id="enableNotifications" checked />
        <span>ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™</span>
      </label>
      <label style="display: flex; align-items: center; gap: 10px; margin: 15px 0;">
        <input type="checkbox" id="enableSounds" checked />
        <span>ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ£ÿµŸàÿßÿ™</span>
      </label>
    </div>
    <div class="modal-buttons">
      <button class="primary" id="saveNotificationBtn">üíæ ÿ≠ŸÅÿ∏</button>
      <button class="secondary" id="cancelNotificationBtn">‚ùå ÿ•ŸÑÿ∫ÿßÿ°</button>
    </div>
  </div>
</div>

<!-- ŸÖŸàÿØÿßŸÑ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© -->
<div class="modal" id="deleteMessageModal">
  <div class="modal-content">
    <h3>üóëÔ∏è ÿ≠ÿ∞ŸÅ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©</h3>
    <p style="text-align: center; margin: 20px 0;">ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©ÿü</p>
    <div class="modal-buttons">
      <button class="primary" id="deleteForMeBtn">ÿ≠ÿ∞ŸÅ ŸÑÿØŸä</button>
      <button class="primary" id="deleteForAllBtn" style="display: none;">ÿ≠ÿ∞ŸÅ ŸÑŸÑÿ¨ŸÖŸäÿπ</button>
      <button class="secondary" id="cancelDeleteBtn">ÿ•ŸÑÿ∫ÿßÿ°</button>
    </div>
  </div>
</div>

<!-- ŸÖŸÑŸÅÿßÿ™ ÿßŸÑÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸÖÿÆŸÅŸäÿ© -->
<input type="file" id="imageInput" accept="image/*" />
<input type="file" id="videoInput" accept="video/*" />
<input type="file" id="cameraInput" accept="image/*" capture="camera" />

<!-- ÿµŸàÿ™ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ -->
<audio id="notificationSound" preload="auto">
  <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMeBC2I0fPTgjEGHm7A7+OZURE" type="audio/wav">
</audio>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, deleteUser } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, getDocs, doc, setDoc, deleteDoc, where, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAm0hh9I6i58ywW1D2gZg09liG-wG-tBsU",
    authDomain: "chat-fat-4f082.firebaseapp.com",
    projectId: "chat-fat-4f082",
    storageBucket: "chat-fat-4f082.appspot.com",
    messagingSenderId: "297367474930",
    appId: "1:297367474930:web:a05b983e05a0ba257fb66b",
    measurementId: "G-MBGC7KZ8H0"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿπÿßŸÖÿ©
  let currentUser = null;
  let currentChatUser = null;
  let unsubscribeMessages = null;
  let unsubscribeUsers = null;
  let unsubscribePresence = null;
  let isLogin = true;
  let blockedUsers = new Set();
  let onlineUsers = new Set();
  let typingUsers = new Map();
  let typingTimeout = null;
  let notificationsEnabled = localStorage.getItem('notificationsEnabled') !== 'false';
  let soundsEnabled = localStorage.getItem('soundsEnabled') !== 'false';
  let selectedMedia = null;
  let messageToDelete = null;

  // ÿπŸÜÿßÿµÿ± DOM
  const authContainer = document.getElementById('authContainer');
  const app_div = document.getElementById('app');
  const chatContainer = document.getElementById('chatContainer');
  const usersListContainer = document.getElementById('usersListContainer');
  const formTitle = document.getElementById('formTitle');
  const submitBtn = document.getElementById('submitBtn');
  const toggleFormBtn = document.getElementById('toggleFormBtn');
  const errorMsg = document.getElementById('errorMsg');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const usernameInput = document.getElementById('username');
  const statusInput = document.getElementById('status');
  const usersList = document.getElementById('usersList');
  const searchInput = document.getElementById('searchInput');
  const messagesArea = document.getElementById('messagesArea');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const backBtn = document.getElementById('backBtn');
  const menuBtn = document.getElementById('menuBtn');
  const dropdownMenu = document.getElementById('dropdownMenu');
  const notificationSound = document.getElementById('notificationSound');

  // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ
  function updateUserPresence(online) {
    if (!currentUser) return;
    
    const userRef = doc(db, "users", currentUser.uid);
    updateDoc(userRef, {
      online: online,
      lastSeen: serverTimestamp()
    }).catch(console.error);
  }

  // ŸÖÿ±ÿßŸÇÿ®ÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
  document.addEventListener('visibilitychange', () => {
    if (currentUser) {
      updateUserPresence(!document.hidden);
    }
  });

  // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿπŸÜÿØ ÿßŸÑÿÆÿ±Ÿàÿ¨
  window.addEventListener('beforeunload', () => {
    if (currentUser) {
      updateUserPresence(false);
    }
  });

  // ÿ™ÿ®ÿØŸäŸÑ ŸÜŸÖÿßÿ∞ÿ¨ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
  toggleFormBtn.addEventListener('click', () => {
    isLogin = !isLogin;
    errorMsg.textContent = '';
    
    if (isLogin) {
      formTitle.innerHTML = 'üí¨ ŸÖÿ±ÿ≠ÿ®ÿßŸã ÿ®ŸÉ ŸÅŸä ChatPro';
      submitBtn.textContent = 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ';
      toggleFormBtn.textContent = 'ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ';
      usernameInput.style.display = 'none';
      statusInput.style.display = 'none';
    } else {
      formTitle.innerHTML = 'üöÄ ÿßŸÜÿ∂ŸÖ ÿ•ŸÑŸâ ChatPro';
      submitBtn.textContent = 'ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®';
      toggleFormBtn.textContent = 'ŸÑÿØŸä ÿ≠ÿ≥ÿßÿ® ÿ®ÿßŸÑŸÅÿπŸÑ';
      usernameInput.style.display = 'block';
      statusInput.style.display = 'block';
    }
  });

  // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ/ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®
  submitBtn.addEventListener('click', async () => {
    errorMsg.textContent = '';
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    const username = usernameInput.value.trim();
    const status = statusInput.value.trim() || "ŸÖÿ™ÿßÿ≠ ŸÑŸÑÿØÿ±ÿØÿ¥ÿ© üí¨";

    if (!email || !password || (!isLogin && !username)) {
      errorMsg.textContent = '‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ™ÿπÿ®ÿ¶ÿ© ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©';
      return;
    }

    try {
      submitBtn.innerHTML = '<div class="loading-spinner"></div>';
      
      if (isLogin) {
        await signInWithEmailAndPassword(auth, email, password);
      } else {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        await setDoc(doc(db, "users", user.uid), {
          email: user.email,
          username,
          status,
          photoURL: `https://ui-avatars.com/api/?name=${encodeURIComponent(username)}&background=6a11cb&color=fff&rounded=true&size=128`,
          online: true,
          lastSeen: serverTimestamp(),
          createdAt: serverTimestamp(),
          blockedUsers: []
        });
      }
    } catch (error) {
      errorMsg.textContent = getErrorMessage(error.code);
      submitBtn.textContent = isLogin ? 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ' : 'ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®';
    }
  });

  // ÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿÆÿ∑ÿ£ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ©
  function getErrorMessage(errorCode) {
    const errors = {
      'auth/email-already-in-use': 'üìß Ÿáÿ∞ÿß ÿßŸÑÿ®ÿ±ŸäÿØ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ≥ÿ®ŸÇÿßŸã',
      'auth/weak-password': 'üîí ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∂ÿπŸäŸÅÿ© (6 ÿ£ÿ≠ÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ)',
      'auth/user-not-found': 'üë§ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ',
      'auth/wrong-password': 'üîí ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿÆÿßÿ∑ÿ¶ÿ©',
      'auth/invalid-email': 'üìß ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠',
      'auth/too-many-requests': '‚è∞ ŸÖÿ≠ÿßŸàŸÑÿßÿ™ ŸÉÿ´Ÿäÿ±ÿ©ÿå ÿ≠ÿßŸàŸÑ ŸÑÿßÿ≠ŸÇÿßŸã'
    };
    return errors[errorCode] || '‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ÿå ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ';
  }

  // ŸÖÿ±ÿßŸÇÿ®ÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿµÿßÿØŸÇÿ©
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      await initializeApp_();
      updateUserPresence(true);
      requestNotificationPermission();
    } else {
      currentUser = null;
      showAuthScreen();
      cleanupSubscriptions();
    }
  });

  // ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™
  function cleanupSubscriptions() {
    if (unsubscribeMessages) {
      unsubscribeMessages();
      unsubscribeMessages = null;
    }
    if (unsubscribeUsers) {
      unsubscribeUsers();
      unsubscribeUsers = null;
    }
    if (unsubscribePresence) {
      unsubscribePresence();
      unsubscribePresence = null;
    }
  }

  // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
  async function initializeApp_() {
    authContainer.style.display = 'none';
    app_div.style.display = 'flex';
    
    // ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ≠ÿßŸÑŸä
    const userDoc = await getDoc(doc(db, "users", currentUser.uid));
    if (userDoc.exists()) {
      const userData = userDoc.data();
      document.getElementById('currentUsername').textContent = userData.username;
      document.getElementById('currentUserStatus').textContent = userData.status;
      document.getElementById('userAvatar').src = userData.photoURL;
      
      // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ
      await updateDoc(doc(db, "users", currentUser.uid), {
        online: true,
        lastSeen: serverTimestamp()
      });
    }

    loadUsers();
    loadBlockedUsers();
    setupNotificationSettings();
  }

  // ÿ•ÿ∏Ÿáÿßÿ± ÿ¥ÿßÿ¥ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
  function showAuthScreen() {
    authContainer.style.display = 'block';
    app_div.style.display = 'none';
    chatContainer.classList.remove('fullscreen');
  }

  // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
  function loadUsers() {
    if (unsubscribeUsers) unsubscribeUsers();
    
    const usersRef = collection(db, "users");
    unsubscribeUsers = onSnapshot(usersRef, (snapshot) => {
      const welcomeMessage = usersList.querySelector('.welcome-message');
      if (welcomeMessage) welcomeMessage.remove();
      
      // ŸÖÿ≥ÿ≠ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©
      const existingCards = usersList.querySelectorAll('.user-card');
      existingCards.forEach(card => card.remove());
      
      snapshot.forEach((doc) => {
        const userData = { uid: doc.id, ...doc.data() };
        if (userData.email !== currentUser.email) {
          createUserCard(userData);
        }
      });

      // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ŸÖÿπ ŸÑÿπÿØÿßÿØ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ ÿ∫Ÿäÿ± ÿßŸÑŸÖŸÇÿ±Ÿàÿ°ÿ©
      listenForUnreadMessages();
    });
  }

  // ÿ•ŸÜÿ¥ÿßÿ° ÿ®ÿ∑ÿßŸÇÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ
  function createUserCard(userData) {
    const userCard = document.createElement('div');
    userCard.className = 'user-card fade-in';
    userCard.dataset.email = userData.email;
    userCard.dataset.uid = userData.uid;
    
    if (blockedUsers.has(userData.email)) {
      userCard.classList.add('blocked');
    }

    const isOnline = userData.online;
    const lastSeen = userData.lastSeen ? 
      (userData.lastSeen.toDate ? userData.lastSeen.toDate() : new Date(userData.lastSeen)) : 
      new Date();
    
    userCard.innerHTML = `
      <div class="user-avatar-container">
        <img class="user-avatar" src="${userData.photoURL}" alt="${userData.username}" />
        <div class="online-indicator ${isOnline ? 'online' : ''}"></div>
      </div>
      <div class="user-info">
        <h4>${userData.username}</h4>
        <div class="user-status">${userData.status}</div>
        ${!isOnline ? `<div class="last-seen">ÿ¢ÿÆÿ± ÿ∏ŸáŸàÿ±: ${formatLastSeen(lastSeen)}</div>` : ''}
      </div>
      <div class="unread-count" id="unread-${userData.email}">0</div>
    `;

    userCard.addEventListener('click', () => {
      if (!blockedUsers.has(userData.email)) {
        openChat(userData);
      }
    });

    usersList.appendChild(userCard);
  }

  // ÿ™ŸÜÿ≥ŸäŸÇ ÿ¢ÿÆÿ± ÿ∏ŸáŸàÿ±
  function formatLastSeen(date) {
    const now = new Date();
    const diff = now - date;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);

    if (minutes < 1) return 'ÿßŸÑÿ¢ŸÜ';
    if (minutes < 60) return `ŸÖŸÜÿ∞ ${minutes} ÿØŸÇŸäŸÇÿ©`;
    if (hours < 24) return `ŸÖŸÜÿ∞ ${hours} ÿ≥ÿßÿπÿ©`;
    return `ŸÖŸÜÿ∞ ${days} ŸäŸàŸÖ`;
  }

  // ŸÅÿ™ÿ≠ ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ©
  function openChat(userData) {
    currentChatUser = userData;
    
    // ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ©
    document.getElementById('chatHeader').style.display = 'flex';
    document.getElementById('inputContainer').style.display = 'flex';
    
    // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑŸÅÿßÿ±ÿ∫ÿ©
    const emptyState = messagesArea.querySelector('.empty-state');
    if (emptyState) emptyState.style.display = 'none';
    
    // ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ©
    document.getElementById('chatUserName').textContent = userData.username;
    document.getElementById('chatUserAvatar').src = userData.photoURL;
    
    // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ
    updateChatUserStatus(userData);
    
    // ÿ•ÿ∏Ÿáÿßÿ± ÿ≤ÿ± ÿßŸÑÿ±ÿ¨Ÿàÿπ ŸÅŸä ÿßŸÑÿ¨ŸàÿßŸÑ
    if (window.innerWidth <= 768) {
      document.getElementById('backBtn').style.display = 'block';
      chatContainer.classList.add('fullscreen');
      usersListContainer.classList.add('hidden');
    }
    
    // ÿ™ÿ≠ÿØŸäÿ´ ÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÜÿ¥ÿ∑ÿ©
    document.querySelectorAll('.user-card').forEach(card => {
      card.classList.remove('active');
    });
    document.querySelector(`[data-email="${userData.email}"]`).classList.add('active');
    
    // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ
    loadMessages();
    
    // ŸÖÿ≥ÿ≠ ÿπÿØÿßÿØ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ ÿ∫Ÿäÿ± ÿßŸÑŸÖŸÇÿ±Ÿàÿ°ÿ©
    clearUnreadCount(userData.email);
    
    // ÿßŸÑÿßÿ≥ÿ™ŸÖÿßÿπ ŸÑÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
    listenToUserPresence(userData.uid);
  }

  // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸä ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ©
  function updateChatUserStatus(userData) {
    const statusElement = document.getElementById('chatUserStatus');
    const nameElement = document.getElementById('chatUserName');
    
    if (userData.online) {
      statusElement.innerHTML = 'üü¢ ŸÖÿ™ÿµŸÑ ÿßŸÑÿ¢ŸÜ';
      nameElement.innerHTML = `${userData.username} <span style="color: #28a745;">‚óè</span>`;
    } else {
      const lastSeen = userData.lastSeen ? 
        (userData.lastSeen.toDate ? userData.lastSeen.toDate() : new Date(userData.lastSeen)) : 
        new Date();
      statusElement.textContent = `ÿ¢ÿÆÿ± ÿ∏ŸáŸàÿ±: ${formatLastSeen(lastSeen)}`;
      nameElement.textContent = userData.username;
    }
  }

  // ÿßŸÑÿßÿ≥ÿ™ŸÖÿßÿπ ŸÑÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
  function listenToUserPresence(uid) {
    if (unsubscribePresence) unsubscribePresence();
    
    const userRef = doc(db, "users", uid);
    unsubscribePresence = onSnapshot(userRef, (doc) => {
      if (doc.exists()) {
        const userData = doc.data();
        updateChatUserStatus(userData);
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸä ÿßŸÑŸÇÿßÿ¶ŸÖÿ©
        const userCard = document.querySelector(`[data-uid="${uid}"]`);
        if (userCard) {
          const onlineIndicator = userCard.querySelector('.online-indicator');
          const lastSeenElement = userCard.querySelector('.last-seen');
          
          if (userData.online) {
            onlineIndicator.classList.add('online');
            if (lastSeenElement) lastSeenElement.remove();
          } else {
            onlineIndicator.classList.remove('online');
            if (!lastSeenElement) {
              const userInfo = userCard.querySelector('.user-info');
              const lastSeenDiv = document.createElement('div');
              lastSeenDiv.className = 'last-seen';
              const lastSeen = userData.lastSeen ? 
                (userData.lastSeen.toDate ? userData.lastSeen.toDate() : new Date(userData.lastSeen)) : 
                new Date();
              lastSeenDiv.textContent = `ÿ¢ÿÆÿ± ÿ∏ŸáŸàÿ±: ${formatLastSeen(lastSeen)}`;
              userInfo.appendChild(lastSeenDiv);
            }
          }
        }
      }
    });
  }

  // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ
  function loadMessages() {
    if (unsubscribeMessages) unsubscribeMessages();
    
    // ŸÖÿ≥ÿ≠ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿ≠ÿßŸÑŸäÿ©
    const messages = messagesArea.querySelectorAll('.message-wrapper');
    messages.forEach(msg => msg.remove());
    
    const messagesRef = collection(db, "messages");
    const messagesQuery = query(
      messagesRef,
      orderBy("timestamp")
    );

    unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
      snapshot.docChanges().forEach((change) => {
        const messageData = change.doc.data();
        const messageId = change.doc.id;
        
        if (isMessageBetweenUsers(messageData, currentUser.email, currentChatUser.email)) {
          if (change.type === 'added') {
            displayMessage(messageData, messageId);
            
            // ÿ™ÿ¥ÿ∫ŸäŸÑ ÿµŸàÿ™ ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ŸÑŸÑÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑŸàÿßÿ±ÿØÿ©
            if (messageData.to === currentUser.email && 
                messageData.from !== currentUser.email && 
                soundsEnabled) {
              setTimeout(() => {
                notificationSound.currentTime = 0;
                notificationSound.play().catch(() => {});
              }, 100);
            }
            
            // Ÿàÿ≥ŸÖ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ŸÉŸÖŸÇÿ±Ÿàÿ°ÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ Ÿàÿßÿ±ÿØÿ©
            if (messageData.to === currentUser.email && !messageData.read) {
              markMessageAsRead(messageId);
            }
          } else if (change.type === 'removed') {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageElement) {
              messageElement.remove();
            }
          }
        }
      });
      
      scrollToBottom();
    });
  }

  // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ÿ®ŸäŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
  function isMessageBetweenUsers(message, user1, user2) {
    return (message.from === user1 && message.to === user2) ||
           (message.from === user2 && message.to === user1);
  }

  // ÿπÿ±ÿ∂ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©
  function displayMessage(messageData, messageId) {
    const messageWrapper = document.createElement('div');
    messageWrapper.className = `message-wrapper ${messageData.from === currentUser.email ? 'sent' : 'received'} slide-up`;
    messageWrapper.dataset.messageId = messageId;
    
    const message = document.createElement('div');
    message.className = `message ${messageData.from === currentUser.email ? 'sent' : 'received'}`;
    
    // ÿ•ÿ∂ÿßŸÅÿ© ÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©
    const messageOptions = document.createElement('div');
    messageOptions.className = 'message-options';
    messageOptions.innerHTML = `
      <button class="message-option" onclick="showDeleteMessageModal('${messageId}', ${messageData.from === currentUser.email})" title="ÿ≠ÿ∞ŸÅ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©">üóëÔ∏è</button>
    `;
    messageWrapper.appendChild(messageOptions);

    // ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©
    const messageContent = document.createElement('div');
    messageContent.className = 'message-content';
    
    if (messageData.deleted) {
      messageContent.innerHTML = '<em style="opacity: 0.6;">ÿ™ŸÖ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©</em>';
    } else if (messageData.type === 'image' && messageData.mediaURL) {
      messageContent.innerHTML = `
        <div class="message-media">
          <img src="${messageData.mediaURL}" alt="ÿµŸàÿ±ÿ©" onclick="showMediaPreview('${messageData.mediaURL}', 'image')" />
        </div>
        ${messageData.text ? `<div>${messageData.text}</div>` : ''}
      `;
    } else if (messageData.type === 'video' && messageData.mediaURL) {
      messageContent.innerHTML = `
        <div class="message-media">
          <video src="${messageData.mediaURL}" controls onclick="showMediaPreview('${messageData.mediaURL}', 'video')"></video>
        </div>
        ${messageData.text ? `<div>${messageData.text}</div>` : ''}
      `;
    } else {
      messageContent.textContent = messageData.text || '';
    }
    
    message.appendChild(messageContent);
    
    // ÿßŸÑŸàŸÇÿ™
    const timestamp = messageData.timestamp ? 
      (messageData.timestamp.toDate ? messageData.timestamp.toDate() : new Date(messageData.timestamp)) : 
      new Date();
    
    const messageTime = document.createElement('div');
    messageTime.className = 'message-time';
    messageTime.textContent = formatTime(timestamp);
    message.appendChild(messageTime);
    
    messageWrapper.appendChild(message);
    messagesArea.appendChild(messageWrapper);
  }

  // ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑŸàŸÇÿ™
  function formatTime(date) {
    return date.toLocaleTimeString('ar-EG', {
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  // ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ŸÑŸÑÿ£ÿ≥ŸÅŸÑ
  function scrollToBottom() {
    messagesArea.scrollTop = messagesArea.scrollHeight;
  }

  // Ÿàÿ≥ŸÖ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ŸÉŸÖŸÇÿ±Ÿàÿ°ÿ©
  async function markMessageAsRead(messageId) {
    try {
      const messageRef = doc(db, "messages", messageId);
      await updateDoc(messageRef, { read: true });
    } catch (error) {
      console.error('ÿÆÿ∑ÿ£ ŸÅŸä Ÿàÿ≥ŸÖ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ŸÉŸÖŸÇÿ±Ÿàÿ°ÿ©:', error);
    }
  }

  // ÿßŸÑÿßÿ≥ÿ™ŸÖÿßÿπ ŸÑŸÑÿ±ÿ≥ÿßÿ¶ŸÑ ÿ∫Ÿäÿ± ÿßŸÑŸÖŸÇÿ±Ÿàÿ°ÿ©
  function listenForUnreadMessages() {
    const messagesRef = collection(db, "messages");
    const unreadQuery = query(
      messagesRef,
      where("to", "==", currentUser.email),
      where("read", "==", false)
    );

    onSnapshot(unreadQuery, (snapshot) => {
      const unreadCounts = {};
      
      snapshot.forEach((doc) => {
        const messageData = doc.data();
        if (!blockedUsers.has(messageData.from)) {
          unreadCounts[messageData.from] = (unreadCounts[messageData.from] || 0) + 1;
        }
      });

      // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿØÿßÿØÿßÿ™ ŸÅŸä Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
      document.querySelectorAll('.user-card').forEach(card => {
        const email = card.dataset.email;
        const unreadElement = card.querySelector('.unread-count');
        
        if (unreadCounts[email]) {
          unreadElement.textContent = unreadCounts[email];
          unreadElement.classList.add('show');
        } else {
          unreadElement.classList.remove('show');
        }
      });
    });
  }

  // ŸÖÿ≥ÿ≠ ÿπÿØÿßÿØ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ ÿ∫Ÿäÿ± ÿßŸÑŸÖŸÇÿ±Ÿàÿ°ÿ©
  function clearUnreadCount(userEmail) {
    const unreadElement = document.getElementById(`unread-${userEmail}`);
    if (unreadElement) {
      unreadElement.classList.remove('show');
      unreadElement.textContent = '0';
    }
  }

  // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© ŸÜÿµŸäÿ©
  async function sendMessage(text = '', type = 'text', mediaURL = '') {
    if ((!text.trim() && !mediaURL) || !currentChatUser) return;
    
    const messageData = {
      from: currentUser.email,
      to: currentChatUser.email,
      text: text.trim(),
      type,
      timestamp: serverTimestamp(),
      read: false,
      deleted: false
    };
    
    if (mediaURL) {
      messageData.mediaURL = mediaURL;
    }
    
    try {
      await addDoc(collection(db, "messages"), messageData);
      messageInput.value = '';
      autoResizeTextarea(messageInput);
      
      // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ ÿ£Ÿà ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ŸÅŸä ÿßŸÑÿÆŸÑŸÅŸäÿ©
      if (notificationsEnabled && (!currentChatUser.online || document.hidden)) {
        sendNotification(currentChatUser.username, text || 'Ÿàÿ≥ÿßÿ¶ÿ∑');
      }
      
    } catch (error) {
      console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©:', error);
    }
  }

  // ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸÖÿπ ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ŸÇÿØŸÖ
  async function uploadFile(file) {
    return new Promise((resolve, reject) => {
      const fileRef = ref(storage, `media/${Date.now()}_${file.name}`);
      const uploadTask = uploadBytesResumable(fileRef, file);
      
      // ÿ•ŸÜÿ¥ÿßÿ° ÿ±ÿ≥ÿßŸÑÿ© ŸÖÿ§ŸÇÿ™ÿ© ŸÖÿπ ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
      const tempMessageWrapper = document.createElement('div');
      tempMessageWrapper.className = 'message-wrapper sent slide-up';
      
      const tempMessage = document.createElement('div');
      tempMessage.className = 'message sent';
      
      const mediaContainer = document.createElement('div');
      mediaContainer.className = 'message-media';
      
      if (file.type.startsWith('image/')) {
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        img.alt = 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ±ŸÅÿπ...';
        mediaContainer.appendChild(img);
      } else if (file.type.startsWith('video/')) {
        const video = document.createElement('video');
        video.src = URL.createObjectURL(file);
        video.controls = false;
        video.muted = true;
        mediaContainer.appendChild(video);
      }
      
      const loadingOverlay = document.createElement('div');
      loadingOverlay.className = 'media-loading';
      loadingOverlay.innerHTML = '<div class="loading-spinner"></div>';
      mediaContainer.appendChild(loadingOverlay);
      
      tempMessage.appendChild(mediaContainer);
      
      const timeElement = document.createElement('div');
      timeElement.className = 'message-time';
      timeElement.textContent = 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ±ŸÅÿπ...';
      tempMessage.appendChild(timeElement);
      
      tempMessageWrapper.appendChild(tempMessage);
      messagesArea.appendChild(tempMessageWrapper);
      scrollToBottom();
      
      uploadTask.on('state_changed',
        (snapshot) => {
          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          timeElement.textContent = `${Math.round(progress)}%`;
        },
        (error) => {
          console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ:', error);
          tempMessageWrapper.remove();
          reject(error);
        },
        async () => {
          try {
            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
            tempMessageWrapper.remove();
            resolve(downloadURL);
          } catch (error) {
            tempMessageWrapper.remove();
            reject(error);
          }
        }
      );
    });
  }

  // ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑŸàÿ≥ÿßÿ¶ÿ∑ ŸÇÿ®ŸÑ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ
  function showMediaPreview(file, type) {
    selectedMedia = { file, type };
    const previewMedia = document.getElementById('previewMedia');
    
    if (type === 'image') {
      previewMedia.innerHTML = `<img src="${URL.createObjectURL(file)}" alt="ŸÖÿπÿßŸäŸÜÿ©" />`;
    } else if (type === 'video') {
      previewMedia.innerHTML = `<video src="${URL.createObjectURL(file)}" controls></video>`;
    }
    
    document.getElementById('mediaPreview').style.display = 'flex';
  }

  // ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑŸàÿ≥ÿßÿ¶ÿ∑ ŸÅŸä Ÿàÿ∂ÿπ ŸÖŸÑÿ° ÿßŸÑÿ¥ÿßÿ¥ÿ©
  window.showMediaPreview = function(url, type) {
    const previewMedia = document.getElementById('previewMedia');
    
    if (type === 'image') {
      previewMedia.innerHTML = `<img src="${url}" alt="ÿµŸàÿ±ÿ©" />`;
    } else if (type === 'video') {
      previewMedia.innerHTML = `<video src="${url}" controls></video>`;
    }
    
    document.getElementById('mediaPreview').style.display = 'flex';
    
    // ÿ•ÿÆŸÅÿßÿ° ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ÿ≠ŸÉŸÖ
    document.querySelector('.preview-controls').style.display = 'none';
    
    // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÖÿπÿßŸäŸÜÿ© ÿπŸÜÿØ ÿßŸÑŸÜŸÇÿ± ÿπŸÑŸâ ÿßŸÑÿÆŸÑŸÅŸäÿ©
    document.getElementById('mediaPreview').onclick = (e) => {
      if (e.target === e.currentTarget) {
        document.getElementById('mediaPreview').style.display = 'none';
        document.querySelector('.preview-controls').style.display = 'flex';
      }
    };
  };

  // ÿπÿ±ÿ∂ ŸÖŸàÿØÿßŸÑ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©
  window.showDeleteMessageModal = function(messageId, isOwner) {
    messageToDelete = messageId;
    
    const deleteForAllBtn = document.getElementById('deleteForAllBtn');
    if (isOwner) {
      deleteForAllBtn.style.display = 'block';
    } else {
      deleteForAllBtn.style.display = 'none';
    }
    
    document.getElementById('deleteMessageModal').style.display = 'flex';
  };

  // ÿ≠ÿ∞ŸÅ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©
  async function deleteMessage(messageId, deleteType) {
    try {
      if (deleteType === 'all') {
        await updateDoc(doc(db, "messages", messageId), {
          deleted: true,
          text: null,
          mediaURL: null
        });
      } else {
        // ÿ≠ÿ∞ŸÅ ŸÖÿ≠ŸÑŸä - ŸäŸÖŸÉŸÜ ÿ™ÿ≠ÿ≥ŸäŸÜŸá ŸÑÿßÿ≠ŸÇÿßŸã
        const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
        if (messageElement) {
          messageElement.style.display = 'none';
        }
      }
    } catch (error) {
      console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©:', error);
    }
  }

  // ÿ∑ŸÑÿ® ÿ•ÿ∞ŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
  async function requestNotificationPermission() {
    if ('Notification' in window && 'serviceWorker' in navigator) {
      const permission = await Notification.requestPermission();
      notificationsEnabled = permission === 'granted';
      localStorage.setItem('notificationsEnabled', notificationsEnabled);
      
      if (notificationsEnabled) {
        // ÿ™ÿ≥ÿ¨ŸäŸÑ Service Worker ŸÑŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
        try {
          await navigator.serviceWorker.register('/firebase-messaging-sw.js');
        } catch (error) {
          console.log('Service Worker ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ± ŸÑŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™');
        }
      }
    }
  }

  // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ±
  function sendNotification(title, body) {
    if (notificationsEnabled && 'Notification' in window) {
      try {
        new Notification(`üí¨ ${title}`, {
          body: body,
          icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQwIiBoZWlnaHQ9IjI0MCIgdmlld0JveD0iMCAwIDI0MCAyNDAiIGZpbGw9IiM2YTExY2IiPjxyZWN0IHdpZHRoPSIyNDAiIGhlaWdodD0iMjQwIiBmaWxsPSJ3aGl0ZSIvPjx0ZXh0IHg9IjEyMCIgeT0iMTIwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMzAiIGZpbGw9IiM2YTExY2IiPiBDaGF0UHJvPC90ZXh0Pjwvc3ZnPg==',
          badge: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQwIiBoZWlnaHQ9IjI0MCIgdmlld0JveD0iMCAwIDI0MCAyNDAiIGZpbGw9IiM2YTExY2IiPjxyZWN0IHdpZHRoPSIyNDAiIGhlaWdodD0iMjQwIiBmaWxsPSJ3aGl0ZSIvPjx0ZXh0IHg9IjEyMCIgeT0iMTIwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMzAiIGZpbGw9IiM2YTExY2IiPiBDaGF0UHJvPC90ZXh0Pjwvc3ZnPg=='
        });
      } catch (error) {
        console.log('ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±:', error);
      }
    }
  }

  // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÑŸÖÿ≠ÿ∏Ÿàÿ±ŸäŸÜ
  async function loadBlockedUsers() {
    try {
      const userDoc = await getDoc(doc(db, "users", currentUser.uid));
      if (userDoc.exists() && userDoc.data().blockedUsers) {
        blockedUsers = new Set(userDoc.data().blockedUsers);
      }
    } catch (error) {
      console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÑŸÖÿ≠ÿ∏Ÿàÿ±ŸäŸÜ:', error);
    }
  }

  // ÿ≠ÿ∏ÿ±/ÿ•ŸÑÿ∫ÿßÿ° ÿ≠ÿ∏ÿ± ŸÖÿ≥ÿ™ÿÆÿØŸÖ
  async function toggleBlockUser(userEmail) {
    try {
      const userRef = doc(db, "users", currentUser.uid);
      
      if (blockedUsers.has(userEmail)) {
        blockedUsers.delete(userEmail);
      } else {
        blockedUsers.add(userEmail);
      }
      
      await updateDoc(userRef, {
        blockedUsers: Array.from(blockedUsers)
      });
      
      loadUsers();
    } catch (error) {
      console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∏ÿ±/ÿ•ŸÑÿ∫ÿßÿ° ÿ≠ÿ∏ÿ± ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:', error);
    }
  }

  // ÿ•ÿπÿØÿßÿØ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
  function setupNotificationSettings() {
    document.getElementById('enableNotifications').checked = notificationsEnabled;
    document.getElementById('enableSounds').checked = soundsEnabled;
  }

  // ÿ™ÿ∫ŸäŸäÿ± ÿ≠ÿ¨ŸÖ textarea ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
  function autoResizeTextarea(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
  }

  // ÿßŸÑÿ£ÿ≠ÿØÿßÿ´ - ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ
  sendBtn.addEventListener('click', () => sendMessage(messageInput.value));
  
  messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage(messageInput.value);
    }
  });

  messageInput.addEventListener('input', () => {
    autoResizeTextarea(messageInput);
  });

  // ÿ£ÿ≠ÿØÿßÿ´ ÿßŸÑŸàÿ≥ÿßÿ¶ÿ∑
  document.getElementById('galleryBtn').addEventListener('click', () => {
    document.getElementById('imageInput').click();
  });

  document.getElementById('videoBtn').addEventListener('click', () => {
    document.getElementById('videoInput').click();
  });

  document.getElementById('cameraBtn').addEventListener('click', () => {
    document.getElementById('cameraInput').click();
  });

  // ŸÖÿπÿßŸÑÿ¨ÿ© ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖŸÑŸÅÿßÿ™
  document.getElementById('imageInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      showMediaPreview(file, 'image');
    }
  });

  document.getElementById('videoInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      showMediaPreview(file, 'video');
    }
  });

  document.getElementById('cameraInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      showMediaPreview(file, 'image');
    }
  });

  // ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸàÿ≥ÿßÿ¶ÿ∑
  document.getElementById('sendMediaBtn').addEventListener('click', async () => {
    if (selectedMedia) {
      try {
        document.getElementById('sendMediaBtn').innerHTML = '<div class="loading-spinner"></div>';
        
        const mediaURL = await uploadFile(selectedMedia.file);
        await sendMessage('', selectedMedia.type, mediaURL);
        
        document.getElementById('mediaPreview').style.display = 'none';
        selectedMedia = null;
      } catch (error) {
        alert('ŸÅÿ¥ŸÑ ŸÅŸä ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ');
        console.error(error);
      }
      
      document.getElementById('sendMediaBtn').innerHTML = 'üì§ ÿ•ÿ±ÿ≥ÿßŸÑ';
    }
  });

  // ÿ•ŸÑÿ∫ÿßÿ° ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑŸàÿ≥ÿßÿ¶ÿ∑
  document.getElementById('cancelMediaBtn').addEventListener('click', () => {
    document.getElementById('mediaPreview').style.display = 'none';
    selectedMedia = null;
  });

  // ÿ≤ÿ± ÿßŸÑÿ±ÿ¨Ÿàÿπ
  backBtn.addEventListener('click', () => {
    chatContainer.classList.remove('fullscreen');
    usersListContainer.classList.remove('hidden');
    document.getElementById('backBtn').style.display = 'none';
    
    // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ©
    currentChatUser = null;
    if (unsubscribeMessages) unsubscribeMessages();
    if (unsubscribePresence) unsubscribePresence();
    
    // ÿ•ÿÆŸÅÿßÿ° Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ©
    document.getElementById('chatHeader').style.display = 'none';
    document.getElementById('inputContainer').style.display = 'none';
    
    // ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑŸÅÿßÿ±ÿ∫ÿ©
    messagesArea.innerHTML = `
      <div class="empty-state">
        <div class="icon">üí¨</div>
        <p>ÿßÿÆÿ™ÿ± ŸÖÿ≠ÿßÿØÿ´ÿ© ŸÑÿ®ÿØÿ° ÿßŸÑÿØÿ±ÿØÿ¥ÿ©</p>
      </div>
    `;
    
    // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿØ ŸÖŸÜ ÿ®ÿ∑ÿßŸÇÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
    document.querySelectorAll('.user-card').forEach(card => {
      card.classList.remove('active');
    });
  });

  // ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÜÿ≥ÿØŸÑÿ©
  menuBtn.addEventListener('click', () => {
    dropdownMenu.style.display = dropdownMenu.style.display === 'flex' ? 'none' : 'flex';
  });

  // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿπŸÜÿØ ÿßŸÑŸÜŸÇÿ± ÿÆÿßÿ±ÿ¨Ÿáÿß
  document.addEventListener('click', (e) => {
    if (!menuBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
      dropdownMenu.style.display = 'none';
    }
  });

  // ÿßŸÑÿ®ÿ≠ÿ´
  searchInput.addEventListener('input', (e) => {
    const searchTerm = e.target.value.toLowerCase();
    const userCards = document.querySelectorAll('.user-card');
    
    userCards.forEach(card => {
      const username = card.querySelector('h4').textContent.toLowerCase();
      const userStatus = card.querySelector('.user-status').textContent.toLowerCase();
      
      if (username.includes(searchTerm) || userStatus.includes(searchTerm)) {
        card.style.display = 'flex';
      } else {
        card.style.display = 'none';
      }
    });
  });

  // ÿ£ÿ≠ÿØÿßÿ´ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÜÿ≥ÿØŸÑÿ©
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    if (confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ÿü')) {
      updateUserPresence(false);
      await signOut(auth);
    }
  });

  document.getElementById('deleteAccountBtn').addEventListener('click', async () => {
    if (confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ ÿ≠ÿ≥ÿßÿ®ŸÉ ŸÜŸáÿßÿ¶ŸäÿßŸãÿü ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜ Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°.')) {
      try {
        await deleteDoc(doc(db, "users", currentUser.uid));
        await deleteUser(currentUser);
      } catch (error) {
        alert('ŸÅÿ¥ŸÑ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≠ÿ≥ÿßÿ®. ŸÇÿØ ÿ™ÿ≠ÿ™ÿßÿ¨ ÿ•ŸÑŸâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.');
      }
    }
  });

  document.getElementById('blockUserBtn').addEventListener('click', () => {
    if (currentChatUser) {
      const isBlocked = blockedUsers.has(currentChatUser.email);
      const action = isBlocked ? 'ÿ•ŸÑÿ∫ÿßÿ° ÿ≠ÿ∏ÿ±' : 'ÿ≠ÿ∏ÿ±';
      
      if (confirm(`ŸáŸÑ ÿ™ÿ±ŸäÿØ ${action} ${currentChatUser.username}ÿü`)) {
        toggleBlockUser(currentChatUser.email);
        
        if (!isBlocked) {
          // ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© ÿ®ÿπÿØ ÿßŸÑÿ≠ÿ∏ÿ±
          backBtn.click();
        }
      }
    }
  });

  // ŸÖŸàÿØÿßŸÑ ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä
  document.getElementById('editProfileBtn').addEventListener('click', async () => {
    try {
      const userDoc = await getDoc(doc(db, "users", currentUser.uid));
      if (userDoc.exists()) {
        const userData = userDoc.data();
        document.getElementById('editUsername').value = userData.username || '';
        document.getElementById('editStatus').value = userData.status || '';
        document.getElementById('editProfileModal').style.display = 'flex';
      }
    } catch (error) {
      console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:', error);
    }
  });

  document.getElementById('saveProfileBtn').addEventListener('click', async () => {
    const newUsername = document.getElementById('editUsername').value.trim();
    const newStatus = document.getElementById('editStatus').value.trim();

    if (!newUsername) {
      alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ');
      return;
    }

    try {
      const userRef = doc(db, "users", currentUser.uid);
      await updateDoc(userRef, {
        username: newUsername,
        status: newStatus,
        photoURL: `https://ui-avatars.com/api/?name=${encodeURIComponent(newUsername)}&background=6a11cb&color=fff&rounded=true&size=128`
      });

      // ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
      document.getElementById('currentUsername').textContent = newUsername;
      document.getElementById('currentUserStatus').textContent = newStatus;
      document.getElementById('userAvatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(newUsername)}&background=6a11cb&color=fff&rounded=true&size=128`;

      document.getElementById('editProfileModal').style.display = 'none';
      
      // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
      loadUsers();
    } catch (error) {
      alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
      console.error(error);
    }
  });

  document.getElementById('cancelProfileBtn').addEventListener('click', () => {
    document.getElementById('editProfileModal').style.display = 'none';
  });

  // ŸÖŸàÿØÿßŸÑ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
  document.getElementById('notificationSettingsBtn').addEventListener('click', () => {
    document.getElementById('notificationModal').style.display = 'flex';
  });

  document.getElementById('saveNotificationBtn').addEventListener('click', () => {
    notificationsEnabled = document.getElementById('enableNotifications').checked;
    soundsEnabled = document.getElementById('enableSounds').checked;
    
    localStorage.setItem('notificationsEnabled', notificationsEnabled);
    localStorage.setItem('soundsEnabled', soundsEnabled);
    
    if (notificationsEnabled) {
      requestNotificationPermission();
    }
    
    document.getElementById('notificationModal').style.display = 'none';
  });

  document.getElementById('cancelNotificationBtn').addEventListener('click', () => {
    document.getElementById('notificationModal').style.display = 'none';
  });

  // ŸÖŸàÿØÿßŸÑ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©
  document.getElementById('deleteForMeBtn').addEventListener('click', () => {
    if (messageToDelete) {
      deleteMessage(messageToDelete, 'me');
      document.getElementById('deleteMessageModal').style.display = 'none';
      messageToDelete = null;
    }
  });

  document.getElementById('deleteForAllBtn').addEventListener('click', () => {
    if (messageToDelete) {
      deleteMessage(messageToDelete, 'all');
      document.getElementById('deleteMessageModal').style.display = 'none';
      messageToDelete = null;
    }
  });

  document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
    document.getElementById('deleteMessageModal').style.display = 'none';
    messageToDelete = null;
  });

  // ÿ≤ÿ± "ÿπŸÜ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ"
  document.getElementById('aboutBtn').addEventListener('click', () => {
    alert(`üí¨ ChatPro - ÿ™ÿ∑ÿ®ŸäŸÇ ÿØÿ±ÿØÿ¥ÿ© ŸÅŸàÿ±Ÿäÿ©

‚ú® ÿßŸÑŸÖŸäÿ≤ÿßÿ™:
‚Ä¢ ÿØÿ±ÿØÿ¥ÿ© ŸÅŸàÿ±Ÿäÿ© ŸÖÿπ ÿßŸÑÿ£ÿµÿØŸÇÿßÿ°
‚Ä¢ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿµŸàÿ± ŸàÿßŸÑŸÅŸäÿØŸäŸàŸáÿßÿ™
‚Ä¢ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÅŸàÿ±Ÿäÿ©
‚Ä¢ ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±ÿ©
‚Ä¢ ÿ≠ÿ∏ÿ± ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
‚Ä¢ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ

üöÄ ÿ™ŸÖ ÿ™ÿ∑ŸàŸäÿ±Ÿá ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ:
‚Ä¢ Firebase (ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸàÿßŸÑŸÖÿµÿßÿØŸÇÿ©)
‚Ä¢ JavaScript ÿßŸÑÿ≠ÿØŸäÿ´
‚Ä¢ ÿ™ÿµŸÖŸäŸÖ ŸÖÿ™ÿ¨ÿßŸàÿ®

üíù ÿ™ŸÖ ÿ™ÿ∑ŸàŸäÿ±Ÿá ÿÆÿµŸäÿµÿßŸã ŸÑŸÖÿ±ŸàÿßŸÜ`);
  });

  // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÖŸàÿØÿßŸÑÿßÿ™ ÿπŸÜÿØ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿÆŸÑŸÅŸäÿ™Ÿáÿß
  document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    });
  });

  // ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© ŸÑŸÑÿ™ÿ¨ÿ±ÿ®ÿ©
  
  // ÿ•ÿ¥ÿπÿßÿ± ÿπŸÜÿØ ÿßÿ™ÿµÿßŸÑ/ŸÇÿ∑ÿπ ÿßŸÑÿßÿ™ÿµÿßŸÑ
  window.addEventListener('online', () => {
    if (currentUser) {
      updateUserPresence(true);
    }
  });

  window.addEventListener('offline', () => {
    if (currentUser) {
      updateUserPresence(false);
    }
  });

  // ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ© ŸÑŸÑÿ¨ŸàÿßŸÑ
  window.addEventListener('resize', () => {
    if (window.innerWidth > 768 && chatContainer.classList.contains('fullscreen')) {
      chatContainer.classList.remove('fullscreen');
      usersListContainer.classList.remove('hidden');
      document.getElementById('backBtn').style.display = 'none';
    }
  });

  console.log('üí¨ ChatPro ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑŸá ÿ®ŸÜÿ¨ÿßÿ≠!');
</script>

</body>
</html>
